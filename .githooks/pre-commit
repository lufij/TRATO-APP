#!/bin/sh
# Lightweight pre-commit hook that runs the PowerShell secret checker on Windows or a basic grep on other systems.
echo "Running local secret checks..."
if command -v pwsh >/dev/null 2>&1; then
  pwsh -NoProfile -NonInteractive -Command "& './scripts/check-secrets.ps1'"
  status=$?
  if [ $status -ne 0 ]; then
    echo "Secret check failed. Aborting commit." >&2
    exit $status
  fi
else
  # Fallback: grep for common secret patterns
  if git diff --cached --name-only | xargs grep -E "eyJ[A-Za-z0-9_\-\.]{20,}|SUPABASE_SERVICE_ROLE_KEY|VITE_SUPABASE_ANON_KEY" >/dev/null 2>&1; then
    echo "Potential secret found in staged files. Aborting commit." >&2
    exit 1
  fi
fi
exit 0
