<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <link rel="manifest" href="/manifest.json" />
    <meta name="theme-color" content="#f97316" />
    <link rel="icon" type="image/png" href="/assets/trato-logo.png" />
    <link rel="apple-touch-icon" href="/assets/trato-logo.png" />
    <title>TRATO - Mercado Local GualÃ¡n</title>
    <!-- Estilos mÃ³viles optimizados -->
    <!-- Estilos para formularios -->
    <link rel="stylesheet" href="/form-styles.css" />
    <script type="module" crossorigin src="/assets/index-CMQSa8yz.js"></script>
    <link rel="stylesheet" crossorigin href="/assets/index-DliYcsXx.css">
  </head>
  <body>
    <div id="root"></div>
    
    <!-- Google Maps API -->
    <script>
      window.googleMapsConfig = {
        apiKey: 'CLAVE_SERA_CARGADA_DESDE_ENV',
        libraries: ['geometry', 'places']
      };
    </script>
    <script async defer 
      src="https://maps.googleapis.com/maps/api/js?key=DYNAMIC_KEY&libraries=geometry,places&callback=initGoogleMaps">
    </script>
    <script>
      window.initGoogleMaps = function() {
        window.googleMapsLoaded = true;
        // Dispatch event for React components
        window.dispatchEvent(new Event('google-maps-loaded'));
      };
    </script>
    
    
    <!-- TRATO Service Worker Avanzado -->
    <script>
      // ðŸš€ TRATO PWA y Notificaciones Setup
      (function() {
        console.log('ðŸ”§ TRATO: Inicializando PWA...');
        
        // Verificar soporte de Service Worker
        if (!('serviceWorker' in navigator)) {
          console.warn('âš ï¸ Service Worker no soportado en este navegador');
          return;
        }

        // Registrar Service Worker
        window.addEventListener('load', async () => {
          try {
            // Registrar SW (funciona en desarrollo y producciÃ³n)
            const registration = await navigator.serviceWorker.register('/sw.js', {
              scope: '/',
              updateViaCache: 'none' // Forzar actualizaciones
            });
            
            console.log('âœ… TRATO SW: Registrado exitosamente', registration.scope);
            
            // Configurar notificaciones push
            await setupPushNotifications(registration);
            
            // Manejar actualizaciones del SW
            registration.addEventListener('updatefound', () => {
              const newWorker = registration.installing;
              console.log('ðŸ”„ TRATO SW: Nueva versiÃ³n encontrada');
              
              newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  // Nueva versiÃ³n disponible
                  if (confirm('ðŸ†• Nueva versiÃ³n de TRATO disponible. Â¿Recargar ahora?')) {
                    newWorker.postMessage({ type: 'SKIP_WAITING' });
                    window.location.reload();
                  }
                }
              });
            });
            
            // Escuchar mensajes del SW
            navigator.serviceWorker.addEventListener('message', (event) => {
              console.log('ðŸ’¬ Mensaje del SW:', event.data);
              
              if (event.data.type === 'NOTIFICATION_CLICK') {
                // Navegar cuando se hace click en notificaciÃ³n
                window.location.href = event.data.url;
              } else if (event.data.type === 'PLAY_NOTIFICATION_SOUND') {
                // Reproducir sonido de notificaciÃ³n
                playNotificationSound(event.data.soundType);
              }
            });
            
          } catch (error) {
            console.error('âŒ TRATO SW: Error en registro:', error);
          }
        });

        // ðŸ”” Configurar notificaciones push
        async function setupPushNotifications(registration) {
          try {
            // Verificar soporte de notificaciones
            if (!('Notification' in window) || !('PushManager' in window)) {
              console.warn('âš ï¸ Notificaciones push no soportadas');
              return;
            }

            // Solicitar permisos de notificaciÃ³n
            let permission = Notification.permission;
            if (permission === 'default') {
              permission = await Notification.requestPermission();
              console.log('ðŸ”” Permiso de notificaciones:', permission);
            }

            if (permission === 'granted') {
              console.log('âœ… TRATO: Notificaciones habilitadas');
              
              // Configurar suscripciÃ³n push (opcional - requiere servidor VAPID)
              try {
                const subscription = await registration.pushManager.getSubscription();
                if (!subscription) {
                  console.log('ðŸ“ TRATO: Configurando suscripciÃ³n push...');
                  // AquÃ­ irÃ­an las claves VAPID del servidor
                }
              } catch (pushError) {
                console.log('â„¹ï¸ Push notifications requieren configuraciÃ³n del servidor');
              }
            } else {
              console.warn('âš ï¸ TRATO: Notificaciones denegadas por el usuario');
            }
          } catch (error) {
            console.error('âŒ Error configurando notificaciones:', error);
          }
        }

        // ðŸ”Š Reproducir sonidos de notificaciÃ³n
        function playNotificationSound(type = 'default') {
          try {
            // Crear contexto de audio para sonidos
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            // Diferentes tonos segÃºn el tipo
            const frequencies = {
              'new_order': [800, 1000, 1200], // Ascendente
              'order_ready': [1200, 800], // Descendente
              'order_delivered': [600, 800, 1000, 800], // Campana
              'default': [800, 1000]
            };
            
            const notes = frequencies[type] || frequencies.default;
            let delay = 0;
            
            notes.forEach((freq, index) => {
              setTimeout(() => {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(freq, audioContext.currentTime);
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
              }, delay);
              
              delay += 200; // 200ms entre notas
            });
            
            console.log('ðŸ”Š TRATO: Sonido reproducido:', type);
          } catch (error) {
            console.log('ðŸ”‡ Audio no disponible:', error.message);
          }
        }

        // ðŸ“± Detectar instalaciÃ³n PWA
        window.addEventListener('beforeinstallprompt', (event) => {
          console.log('ðŸ“± TRATO PWA: Prompt de instalaciÃ³n disponible');
          event.preventDefault();
          
          // Guardar evento para mostrarlo despuÃ©s
          window.deferredPrompt = event;
          
          // Mostrar botÃ³n de instalaciÃ³n personalizado
          showInstallButton();
        });

        // Mostrar botÃ³n de instalaciÃ³n
        function showInstallButton() {
          // Crear botÃ³n de instalaciÃ³n dinÃ¡mico
          const installButton = document.createElement('button');
          installButton.innerHTML = 'ðŸ“± Instalar TRATO';
          installButton.style.cssText = `
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #f97316;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(249, 115, 22, 0.4);
            cursor: pointer;
            z-index: 9999;
            font-size: 14px;
            transition: transform 0.2s;
          `;
          
          installButton.addEventListener('mousedown', () => {
            installButton.style.transform = 'scale(0.95)';
          });
          
          installButton.addEventListener('mouseup', () => {
            installButton.style.transform = 'scale(1)';
          });
          
          installButton.addEventListener('click', async () => {
            if (window.deferredPrompt) {
              window.deferredPrompt.prompt();
              const { outcome } = await window.deferredPrompt.userChoice;
              console.log('ðŸ“± TRATO PWA: InstalaciÃ³n', outcome);
              window.deferredPrompt = null;
              installButton.remove();
            }
          });
          
          document.body.appendChild(installButton);
          
          // Auto-ocultar despuÃ©s de 10 segundos
          setTimeout(() => {
            if (installButton.parentNode) {
              installButton.style.opacity = '0.5';
              setTimeout(() => installButton.remove(), 5000);
            }
          }, 10000);
        }

        // ðŸŒ Monitorear conectividad
        function updateOnlineStatus() {
          const status = navigator.onLine ? 'online' : 'offline';
          console.log('ðŸŒ TRATO: Estado de conexiÃ³n:', status);
          
          if (!navigator.onLine) {
            // Mostrar mensaje de offline
            showOfflineMessage();
          }
        }

        function showOfflineMessage() {
          if (document.getElementById('offline-banner')) return;
          
          const banner = document.createElement('div');
          banner.id = 'offline-banner';
          banner.innerHTML = 'ðŸ“¡ Sin conexiÃ³n - Funcionalidad limitada';
          banner.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #ef4444;
            color: white;
            text-align: center;
            padding: 10px;
            z-index: 10000;
            font-size: 14px;
            font-weight: bold;
          `;
          
          document.body.appendChild(banner);
          
          // Ocultar cuando vuelva la conexiÃ³n
          const hideWhenOnline = () => {
            if (navigator.onLine) {
              banner.remove();
              window.removeEventListener('online', hideWhenOnline);
            }
          };
          
          window.addEventListener('online', hideWhenOnline);
        }

        // Escuchar cambios de conectividad
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
        
        // Estado inicial
        updateOnlineStatus();
        
        console.log('ðŸŽ‰ TRATO PWA: InicializaciÃ³n completa');
      })();
    </script>
    
    <!-- ðŸ”” SISTEMA CRÃTICO DE NOTIFICACIONES -->
    <script src="/notification-power-system.js"></script>
    
  </body>
</html>
