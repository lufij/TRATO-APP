import{u as N,r as a,s as u,j as e}from"./index-BTyKdRD7.js";import{u as A,N as T,F as w}from"./FloatingNotifications-Bvy8cVfj.js";import"./volume-2-BMej0IbQ.js";import"./triangle-alert-O3EMxmTl.js";import"./shopping-bag-CcHcjL33.js";import"./clock-DJp80oyB.js";function C(){const{user:n}=N(),[d,f]=a.useState([]),[s,l]=a.useState(!1),{notifications:m,addNotification:c,removeNotification:x}=A(),p=a.useCallback(async()=>{try{const o=new(window.AudioContext||window.webkitAudioContext);o.state==="suspended"&&await o.resume();const t=o.createOscillator(),i=o.createOscillator(),r=o.createGain();t.connect(r),i.connect(r),r.connect(o.destination),t.frequency.setValueAtTime(800,o.currentTime),t.frequency.exponentialRampToValueAtTime(600,o.currentTime+.3),t.type="sine",i.frequency.setValueAtTime(1200,o.currentTime),i.frequency.exponentialRampToValueAtTime(900,o.currentTime+.3),i.type="triangle",r.gain.setValueAtTime(0,o.currentTime),r.gain.linearRampToValueAtTime(.4,o.currentTime+.1),r.gain.exponentialRampToValueAtTime(.01,o.currentTime+1.2),t.start(o.currentTime),t.stop(o.currentTime+1.2),i.start(o.currentTime+.1),i.stop(o.currentTime+1),console.log("🔊 Sonido mejorado reproducido")}catch(o){console.log("⚠️ Error con sonido:",o);try{new Audio("data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhDSmG0fPTgjMGHm7A7+OZSA0PVqzn77BdGAg+ltryxnkpBSuBzvLZiTYIG2m98+OdTgwOUarm9LRjHgU4kNbyz3wtBSN2yO/eizELElyx6+SjUhQKQ5zd8sFuIAwnhM/z2YYzBiJwwO/kmEoODlOq5O+zYBoGPJPY88p9KwUme8rx4I4yDBhivO3lm0sMDUqt6O2tVxkLPpnb88F9Lgopen+1+LdaFwoCUKjx7rhiHgU3kNbyzHspBCp+zOzelC0KEFRS8lPzUoGkzY4PBNd8t5iNgRUEfKXGqKNbDgEfMgvzVzPH1fhUtaBOK53G33mOH4vMvdnG7Pj8P/+XjC9LLsrjNhwT+LGPRlNLvOOgV5kXLZsL5wLvOLKfWyfrTr0+sWpwjJfUnI6Z9W5p5+aqUJgEa3Nxdm7eCFy3Oo/oPjzPqGEfgRZzDZJnUKfEhF4YP2p8FKXY").play()}catch{console.log("⚠️ También falló el sonido de respaldo")}}},[]);a.useEffect(()=>{if(!(n!=null&&n.id))return;console.log("🔄 Iniciando sistema mejorado de notificaciones..."),l(!0);const o=u.channel("enhanced-orders").on("postgres_changes",{event:"INSERT",schema:"public",table:"orders",filter:`seller_id=eq.${n.id}`},t=>{console.log("🎯 Nueva orden mejorada:",t.new);const i=t.new,r=parseFloat(i.total||"0").toFixed(2),b={id:Date.now(),message:`Nueva orden: Q${r}`,timestamp:new Date().toISOString(),orderData:i};if(f(g=>[b,...g.slice(0,9)]),c({title:"🛒 Nuevo Pedido TRATO",message:`Orden por Q${r} - ${i.notes||"Sin notas"}`,orderData:i,duration:6e3}),p(),Notification.permission==="granted"){const g=new Notification("🛒 Nuevo Pedido TRATO",{body:`Orden por Q${r}${i.notes?` - ${i.notes}`:""}`,icon:"/favicon.ico",tag:"trato-order-"+i.id,requireInteraction:!0,actions:[{action:"view",title:"Ver Pedido"},{action:"dismiss",title:"Cerrar"}]});setTimeout(()=>{g.close()},8e3)}}).subscribe(t=>{console.log("📡 Status mejorado:",t),t==="SUBSCRIBED"?console.log("✅ Sistema de notificaciones activo"):(t==="CHANNEL_ERROR"||t==="TIMED_OUT")&&(console.log("❌ Error de conexión:",t),l(!1))});return()=>{console.log("🔄 Limpiando suscripción mejorada"),u.removeChannel(o),l(!1)}},[n==null?void 0:n.id,c,p]),a.useEffect(()=>{const o=localStorage.getItem("trato_permissions");Notification.permission==="default"&&!o?(console.log("📱 Solicitando permisos automáticamente..."),Notification.requestPermission().then(t=>{console.log("📱 Permiso de notificaciones:",t),t==="granted"&&(localStorage.setItem("trato_permissions","granted"),localStorage.setItem("trato_permissions_date",new Date().toISOString()))})):o==="granted"&&Notification.permission!=="granted"&&(localStorage.removeItem("trato_permissions"),localStorage.removeItem("trato_permissions_date"))},[]);const h=async()=>{if(n!=null&&n.id){console.log("🧪 Creando orden de prueba mejorada...");try{const o={buyer_id:"11111111-1111-1111-1111-111111111111",seller_id:n.id,total:(Math.floor(Math.random()*100)+25).toFixed(2),status:"pending",notes:`Orden de prueba - ${new Date().toLocaleTimeString()} - Cliente: Juan Pérez`},{data:t,error:i}=await u.from("orders").insert(o).select();i?(console.error("❌ Error:",i),alert("Error: "+i.message)):(console.log("✅ Orden de prueba creada:",t[0]),c({title:"🧪 Orden de Prueba Creada",message:`Orden por Q${o.total} generada exitosamente`,orderData:t[0],duration:4e3}))}catch(o){console.error("❌ Excepción:",o),alert("Error: "+o.message)}}},j=()=>{c({title:"🔔 Prueba de Sistema",message:"Esta es una notificación flotante de prueba con sonido",duration:5e3}),p(),Notification.permission==="granted"&&new Notification("🔔 Prueba TRATO",{body:"Sistema de notificaciones funcionando correctamente",icon:"/favicon.ico",tag:"test-notification"})};return e.jsxs(e.Fragment,{children:[e.jsx(T,{}),e.jsx(w,{notifications:m,onRemove:x}),e.jsxs("div",{style:{padding:"20px",maxWidth:"800px",margin:"0 auto"},children:[e.jsx("h2",{children:"🧪 Test Mejorado de Notificaciones"}),e.jsxs("div",{style:{padding:"15px",backgroundColor:s?"#d4edda":"#f8d7da",border:`1px solid ${s?"#c3e6cb":"#f5c6cb"}`,borderRadius:"5px",marginBottom:"20px"},children:[e.jsx("strong",{children:"Estado:"})," ",s?"✅ Sistema Activo":"❌ Desconectado",e.jsx("br",{}),e.jsx("strong",{children:"Usuario:"})," ",(n==null?void 0:n.email)||"No autenticado",e.jsx("br",{}),e.jsx("strong",{children:"Permisos Navegador:"})," ",Notification.permission,e.jsx("br",{}),e.jsx("strong",{children:"Permisos Guardados:"})," ",localStorage.getItem("trato_permissions")||"No guardados",e.jsx("br",{}),e.jsx("strong",{children:"Notificaciones Flotantes:"})," ",m.length," activas"]}),e.jsxs("div",{style:{display:"flex",gap:"10px",marginBottom:"20px",flexWrap:"wrap"},children:[e.jsx("button",{onClick:h,style:{padding:"10px 20px",backgroundColor:"#007bff",color:"white",border:"none",borderRadius:"5px",cursor:"pointer"},children:"🧪 Crear Orden de Prueba"}),e.jsx("button",{onClick:j,style:{padding:"10px 20px",backgroundColor:"#28a745",color:"white",border:"none",borderRadius:"5px",cursor:"pointer"},children:"🔔 Probar Notificación + Sonido"})]}),e.jsxs("h3",{children:["📋 Historial de Notificaciones (",d.length,")"]}),d.length===0?e.jsx("p",{style:{color:"#666",fontStyle:"italic"},children:"No hay notificaciones aún. Crea una orden de prueba para verificar."}):e.jsx("div",{children:d.map((o,t)=>{var i;return e.jsxs("div",{style:{padding:"10px",backgroundColor:t===0?"#fff3cd":"#f8f9fa",border:"1px solid #dee2e6",borderRadius:"5px",marginBottom:"10px"},children:[e.jsx("strong",{children:o.message}),e.jsx("br",{}),e.jsx("small",{style:{color:"#666"},children:new Date(o.timestamp).toLocaleTimeString()}),((i=o.orderData)==null?void 0:i.notes)&&e.jsxs(e.Fragment,{children:[e.jsx("br",{}),e.jsx("small",{children:o.orderData.notes})]})]},o.id)})}),e.jsxs("div",{style:{marginTop:"30px",padding:"15px",backgroundColor:"#e9ecef",borderRadius:"5px"},children:[e.jsx("h4",{children:"🔧 Debug Info"}),e.jsxs("p",{children:[e.jsx("strong",{children:"Realtime conectado:"})," ",s?"Sí":"No"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Audio Context:"})," ",typeof AudioContext<"u"?"Disponible":"No disponible"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Notificaciones Flotantes:"})," ",m.length," activas"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Permisos Persistentes:"})," ",localStorage.getItem("trato_permissions")||"No configurados"]})]})]})]})}export{C as SimpleNotificationTest};
