import{g as m,s as l,r as y,j as _,f as v}from"./index-BwL7zrtX.js";import{T as $}from"./truck-CO_gqk1y.js";import{U as b}from"./users-CQFYTE7w.js";/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const N=[["path",{d:"M3.85 8.62a4 4 0 0 1 4.78-4.77 4 4 0 0 1 6.74 0 4 4 0 0 1 4.78 4.78 4 4 0 0 1 0 6.74 4 4 0 0 1-4.77 4.78 4 4 0 0 1-6.75 0 4 4 0 0 1-4.78-4.77 4 4 0 0 1 0-6.76Z",key:"3c2336"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]],z=m("badge-check",N);/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const q=[["path",{d:"M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z",key:"96xj49"}]],B=m("flame",q);/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const w=[["path",{d:"M15 21v-8a1 1 0 0 0-1-1h-4a1 1 0 0 0-1 1v8",key:"5wwlr5"}],["path",{d:"M3 10a2 2 0 0 1 .709-1.528l7-5.999a2 2 0 0 1 2.582 0l7 5.999A2 2 0 0 1 21 10v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z",key:"1d0kgt"}]],R=m("house",w);/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const x=[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"M12 5v14",key:"s699le"}]],A=m("plus",x);/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const D=[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}]],j=m("rotate-ccw",D);/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const E=[["path",{d:"M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7",key:"1m0v6g"}],["path",{d:"M18.375 2.625a1 1 0 0 1 3 3l-9.013 9.014a2 2 0 0 1-.853.505l-2.873.84a.5.5 0 0 1-.62-.62l.84-2.873a2 2 0 0 1 .506-.852z",key:"ohrbg2"}]],M=m("square-pen",E);/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const S=[["line",{x1:"10",x2:"14",y1:"2",y2:"2",key:"14vaq8"}],["line",{x1:"12",x2:"15",y1:"14",y2:"11",key:"17fdiu"}],["circle",{cx:"12",cy:"14",r:"8",key:"1e1u0o"}]],U=m("timer",S);async function L(s,a){if(console.log("üîÑ Iniciando actualizaci√≥n de stock para orden:",a),console.log("üì¶ Items a procesar:",s.length),s.forEach((t,o)=>{console.log(`   ${o+1}. ${t.product_name}`),console.log(`      - Cantidad: ${t.quantity}`),console.log(`      - Tipo: ${t.product_type||"regular"}`),console.log(`      - Product ID: ${t.product_id}`),console.log(`      - Daily Product ID: ${t.daily_product_id||"N/A"}`)}),!s||s.length===0)return console.log("‚ö†Ô∏è No hay items para procesar"),{success:!1,message:"No hay items para actualizar stock"};try{const t=[];for(const o of s){console.log(`üîç Procesando producto, cantidad: ${o.quantity}, tipo: ${o.product_type||"regular"}`),console.log(`    Product ID: ${o.product_id}, Daily Product ID: ${o.daily_product_id}`);const r=o.product_type==="daily"||!!o.daily_product_id,u=r?"daily_products":"products";let e=null,n=null;if(r&&o.product_id){console.log(`üîç OPCI√ìN 1: Buscando producto del d√≠a por product_id: ${o.product_id}`);const{data:i,error:c}=await l.from("daily_products").select("id, name, stock_quantity, is_available").eq("id",o.product_id).single();!c&&i?(e=i,console.log(`‚úÖ ENCONTRADO por product_id en daily_products: ${e.name}`)):console.log("‚ùå No encontrado por product_id en daily_products:",c==null?void 0:c.message)}if(!e&&r&&o.daily_product_id){console.log(`üîç OPCI√ìN 2: Buscando por daily_product_id (legacy): ${o.daily_product_id}`);const{data:i,error:c}=await l.from("daily_products").select("id, name, stock_quantity, is_available").eq("id",o.daily_product_id).single();!c&&i?(e=i,console.log(`‚úÖ ENCONTRADO por daily_product_id: ${e.name}`)):console.log("‚ùå No encontrado por daily_product_id:",c==null?void 0:c.message)}if(!e&&!r&&o.product_id){console.log(`üîç OPCI√ìN 3: Buscando producto regular por product_id: ${o.product_id}`);const{data:i,error:c}=await l.from("products").select("id, name, stock_quantity, is_available").eq("id",o.product_id).single();!c&&i?(e=i,console.log(`‚úÖ ENCONTRADO por product_id en products: ${e.name}`)):console.log("‚ùå No encontrado por product_id en products:",c==null?void 0:c.message)}if(!e&&r&&o.product_name){console.log(`üîç OPCI√ìN 4: Buscando por nombre en daily_products: ${o.product_name}`);const{data:i,error:c}=await l.from("daily_products").select("id, name, stock_quantity, is_available, expires_at").eq("name",o.product_name).gte("expires_at",new Date().toISOString()).order("created_at",{ascending:!1}).limit(1);!c&&i&&i.length>0?(e=i[0],console.log(`‚úÖ ENCONTRADO por nombre: ${e.name}`)):console.log("‚ùå No encontrado por nombre:",c==null?void 0:c.message)}if(!e&&!r&&o.product_name){console.log(`üîç OPCI√ìN 5: Buscando por nombre en products: ${o.product_name}`);const{data:i,error:c}=await l.from("products").select("id, name, stock_quantity, is_available").eq("name",o.product_name).limit(1);!c&&i&&i.length>0?(e=i[0],console.log(`‚úÖ ENCONTRADO por nombre: ${e.name}`)):console.log("‚ùå No encontrado por nombre:",c==null?void 0:c.message)}if(!e)return console.log("‚ùå PRODUCTO NO ENCONTRADO EN NINGUNA B√öSQUEDA"),console.log("üîç Detalles del item:",{product_id:o.product_id,daily_product_id:o.daily_product_id,product_name:o.product_name,product_type:o.product_type,isDaily:r,tableName:u}),{success:!1,message:`Error al obtener informaci√≥n del producto ${o.product_name}. Producto no encontrado en ninguna tabla.`};const d=e.stock_quantity,p=d-o.quantity;if(console.log(`üìä ${r?"Producto del d√≠a":"Producto regular"} "${e.name}": ${d} ‚Üí ${p} (vendido: ${o.quantity})`),d<o.quantity)return console.error(`‚ùå Stock insuficiente para ${e.name}: tiene ${d}, necesita ${o.quantity}`),{success:!1,message:`Stock insuficiente para ${e.name}. Solo quedan ${d} unidades.`};const g=r?"daily_products":"products";console.log(`üîÑ Actualizando en tabla: ${g}, ID: ${e.id}`);const f={stock_quantity:p,updated_at:new Date().toISOString()};r||(f.is_available=p>0&&e.is_available);const{error:k}=await l.from(g).update(f).eq("id",e.id);if(k)return console.error(`‚ùå Error actualizando stock para ${e.id}:`,k),await O(t,a),{success:!1,message:`Error al actualizar el stock del producto ${e.name}`};t.push({product_id:e.id,old_stock:d,new_stock:p,quantity_sold:o.quantity,product_type:o.product_type||"regular"}),console.log(`‚úÖ Stock actualizado exitosamente para "${e.name}" (${r?"producto del d√≠a":"producto regular"})`)}return await h(a,"stock_decrease",t),console.log("üéâ Actualizaci√≥n de stock completada exitosamente"),{success:!0,message:"Stock actualizado correctamente",updatedProducts:t}}catch(t){return console.error("‚ùå Error inesperado actualizando stock:",t),{success:!1,message:"Error inesperado al actualizar el inventario"}}}async function O(s,a){console.log("üîÑ Iniciando rollback de stock para orden:",a);for(const t of s)try{const o=t.product_type==="daily",r=o?"daily_products":"products";await l.from(r).update({stock_quantity:t.old_stock,updated_at:new Date().toISOString()}).eq("id",t.product_id),console.log(`‚úÖ Rollback exitoso para ${o?"producto del d√≠a":"producto regular"} ${t.product_id}: ${t.new_stock} ‚Üí ${t.old_stock}`)}catch(o){console.error(`‚ùå Error en rollback para producto ${t.product_id}:`,o)}}async function F(s,a){console.log("üîÑ Iniciando restauraci√≥n de stock para orden cancelada:",a);try{const t=[];for(const o of s){const r=o.product_type==="daily",u=r?"daily_products":"products",{data:e,error:n}=await l.from(u).select("id, name, stock_quantity, is_available").eq("id",o.product_id).single();if(n||!e){console.error(`‚ùå Error obteniendo ${r?"producto del d√≠a":"producto regular"} para restaurar ${o.product_id}:`,n);continue}const d=e.stock_quantity,p=d+o.quantity,g={stock_quantity:p,updated_at:new Date().toISOString()};r||(g.is_available=!0);const{error:f}=await l.from(u).update(g).eq("id",o.product_id);if(f){console.error(`‚ùå Error restaurando stock para ${o.product_id}:`,f);continue}t.push({product_id:o.product_id,old_stock:d,new_stock:p,quantity_sold:-o.quantity,product_type:o.product_type||"regular"}),console.log(`‚úÖ Stock restaurado para "${e.name}" (${r?"producto del d√≠a":"producto regular"}): ${d} ‚Üí ${p}`)}return await h(a,"stock_restore",t),{success:!0,message:"Stock restaurado correctamente",updatedProducts:t}}catch(t){return console.error("‚ùå Error inesperado restaurando stock:",t),{success:!1,message:"Error inesperado al restaurar el inventario"}}}async function h(s,a,t){try{console.log("üìù Log de transacci√≥n de stock:",{orderId:s,type:a,timestamp:new Date().toISOString(),products:t})}catch(o){console.warn("‚ö†Ô∏è Error registrando log de stock (no cr√≠tico):",o)}}async function H(s){console.log("üîç Validando stock antes de crear orden");try{const a=[];for(const t of s){const{data:o,error:r}=await l.from("products").select("id, name, stock_quantity, is_available").eq("id",t.product_id).single();if(r||!o){a.push({product_id:t.product_id,product_name:t.product_name||"Producto desconocido",requested:t.quantity,available:0});continue}(!o.is_available||o.stock_quantity<t.quantity)&&a.push({product_id:t.product_id,product_name:o.name,requested:t.quantity,available:o.stock_quantity})}return a.length>0?{isValid:!1,message:`Stock insuficiente: ${a.map(o=>`${o.product_name}: solicitas ${o.requested}, disponibles ${o.available}`).join("; ")}`,invalidItems:a}:{isValid:!0,message:"Stock suficiente para todos los productos"}}catch(a){return console.error("‚ùå Error validando stock:",a),{isValid:!1,message:"Error al validar disponibilidad de productos"}}}function P(s){const a=new Date(s),t=-6;return new Date(a.getTime()+t*60*60*1e3)}function V(s){return P(s).toLocaleTimeString("es-ES",{hour:"2-digit",minute:"2-digit",hour12:!0})}function G(s){const a=new Date,o=new Date(s).getTime()-a.getTime();if(o<=0)return{isExpired:!0,formattedTime:"Expirado",hours:0,minutes:0};const r=Math.floor(o/(1e3*60*60)),u=Math.floor(o%(1e3*60*60)/(1e3*60));return{isExpired:!1,formattedTime:`${r}h ${u}m`,hours:r,minutes:u}}function Q({className:s=""}){const[a,t]=y.useState(0),[o,r]=y.useState(!0);y.useEffect(()=>{u();const e=l.channel("online-drivers-changes").on("postgres_changes",{event:"*",schema:"public",table:"drivers"},d=>{console.log("üîÑ Driver status change detected:",d),u()}).subscribe(),n=setInterval(()=>{console.log("‚è∞ Actualizando conteo de repartidores (intervalo)"),u()},15e3);return()=>{e.unsubscribe(),clearInterval(n)}},[]);const u=async()=>{try{console.log("üîç Cargando cantidad de repartidores en l√≠nea...");try{const{data:e,error:n}=await l.rpc("get_online_drivers_count");if(!n&&typeof e=="number"){console.log("‚úÖ Drivers online (funci√≥n RPC):",e),t(e);return}else console.warn("‚ö†Ô∏è Funci√≥n RPC fall√≥:",n==null?void 0:n.message)}catch(e){console.warn("‚ö†Ô∏è Error en RPC:",e)}try{const{count:e,error:n}=await l.from("drivers").select("*",{count:"exact",head:!0}).eq("is_online",!0).eq("is_active",!0).eq("is_verified",!0);if(n)console.warn("‚ö†Ô∏è Consulta directa fall√≥:",n.message);else{console.log("‚úÖ Drivers disponibles (consulta directa):",e),t(e||0);return}}catch(e){console.warn("‚ö†Ô∏è Error en consulta directa:",e)}try{const{data:e,error:n}=await l.from("drivers").select("is_online, is_active, is_verified").limit(50);if(!n&&e){const d=e.filter(p=>p.is_online&&p.is_active&&p.is_verified).length;console.log("‚úÖ Drivers disponibles (fallback):",d),t(d);return}else console.error("‚ùå Fallback tambi√©n fall√≥:",n==null?void 0:n.message)}catch(e){console.error("‚ùå Error en fallback:",e)}console.error("‚ùå Todos los m√©todos fallaron, mostrando 0"),t(0)}catch(e){console.error("‚ùå Error general:",e),t(0)}finally{r(!1)}};return o?null:_.jsx("div",{className:"fixed top-16 right-4 z-50",children:_.jsxs("div",{className:"flex flex-col gap-1",children:[_.jsxs(v,{variant:"default",className:"bg-green-600 hover:bg-green-700 text-white px-2 py-1 shadow-md flex items-center gap-1.5 text-xs font-medium cursor-pointer transition-all duration-200 hover:scale-105",onClick:u,children:[_.jsxs("div",{className:"flex items-center gap-0.5",children:[_.jsx($,{className:"w-3 h-3"}),_.jsx(b,{className:"w-3 h-3"})]}),_.jsxs("span",{className:"text-xs leading-tight",children:[a," disponible",a!==1?"s":""]}),a>0&&_.jsx("div",{className:"w-1.5 h-1.5 bg-green-300 rounded-full animate-pulse ml-0.5"})]}),!1]})})}export{z as B,B as F,R as H,Q as O,A as P,j as R,M as S,U as T,V as f,G as g,F as r,L as u,H as v};
