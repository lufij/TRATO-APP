import{u as S,r as n,s as d,j as t}from"./index-9d4LIYkQ.js";import{M as j}from"./map-pin-Ctpb2SRl.js";import{N as C,M as D,P as R}from"./CriticalNotifications-ol96pFnl.js";import{C as A}from"./clock-BLcblUBq.js";function L({orderId:c,onLocationUpdate:m}){const{user:e}=S(),[u,h]=n.useState(null),[N,g]=n.useState(!1),[p,f]=n.useState(null),[y,w]=n.useState(null),[v,b]=n.useState(null),M=n.useCallback(()=>{if(!e||e.role!=="repartidor"||!navigator.geolocation){console.warn("Geolocation not supported or user not a driver");return}const a={enableHighAccuracy:!0,timeout:1e4,maximumAge:3e4},i=async l=>{const s={latitude:l.coords.latitude,longitude:l.coords.longitude,timestamp:new Date().toISOString(),accuracy:l.coords.accuracy,driver_id:e.id,order_id:c};h(s),m==null||m(s.latitude,s.longitude);try{await d.from("driver_locations").upsert({driver_id:e.id,order_id:c,latitude:s.latitude,longitude:s.longitude,timestamp:s.timestamp,accuracy:s.accuracy}),await k(s)}catch(x){console.error("Error saving location:",x)}},r=l=>{console.error("Location error:",l),g(!1)},o=navigator.geolocation.watchPosition(i,r,a);f(o),g(!0)},[e,c,m]),k=async a=>{try{const{data:i}=await d.from("orders").select("delivery_latitude, delivery_longitude, buyer_id, customer_name").eq("id",c).single();if(!i||!i.delivery_latitude||!i.delivery_longitude)return;const r=E(a.latitude,a.longitude,i.delivery_latitude,i.delivery_longitude);if(w(r),r<=.5&&r>.3)try{await d.from("notifications").insert({recipient_id:i.buyer_id,type:"driver_nearby",title:"Repartidor cerca",message:"Tu repartidor está a menos de 500 metros de tu ubicación",data:{order_id:c,distance:Math.round(r*1e3),driver_id:e==null?void 0:e.id}}),console.log("🔔 Notificación enviada: Repartidor cerca")}catch(o){console.error("Error sending proximity notification:",o)}if(r<=.1)try{await d.from("notifications").insert({recipient_id:i.buyer_id,type:"driver_arrived",title:"Repartidor llegó",message:"Tu repartidor ha llegado a tu ubicación",data:{order_id:c,driver_id:e==null?void 0:e.id}}),console.log("🔔 Notificación enviada: Repartidor llegó")}catch(o){console.error("Error sending arrival notification:",o)}if(r>.1){const l=r/25,s=Math.ceil(l*60);b(`${s} min`)}else b("Llegando...")}catch(i){console.error("Error checking proximity:",i)}},E=(a,i,r,o)=>{const s=(r-a)*Math.PI/180,x=(o-i)*Math.PI/180,_=Math.sin(s/2)*Math.sin(s/2)+Math.cos(a*Math.PI/180)*Math.cos(r*Math.PI/180)*Math.sin(x/2)*Math.sin(x/2);return 6371*(2*Math.atan2(Math.sqrt(_),Math.sqrt(1-_)))},P=n.useCallback(()=>{p!==null&&(navigator.geolocation.clearWatch(p),f(null),g(!1))},[p]),T=n.useCallback(async()=>{if(e)try{const{data:a}=await d.from("orders").select("buyer_id, seller_id, customer_name").eq("id",c).single();a&&(await d.from("notifications").insert({recipient_id:a.buyer_id,type:"delivery_issue",title:"Problema con la entrega",message:"El repartidor reportó dificultades para encontrar tu ubicación",data:{order_id:c,driver_id:e.id,issue_type:"location_not_found"}}),await d.from("notifications").insert({recipient_id:a.seller_id,type:"delivery_issue",title:"Problema de entrega",message:`Problema reportado en entrega para ${a.customer_name}`,data:{order_id:c,driver_id:e.id,issue_type:"location_not_found"}}),console.log("🔔 Problema de ubicación reportado"))}catch(a){console.error("Error reporting location issue:",a)}},[e,c]);return n.useEffect(()=>((e==null?void 0:e.role)==="repartidor"&&M(),()=>{P()}),[e==null?void 0:e.role,e==null?void 0:e.id]),n.useEffect(()=>{if(!e||e.role==="repartidor")return;const a=d.channel("location-updates").on("postgres_changes",{event:"INSERT",schema:"public",table:"driver_locations",filter:`order_id=eq.${c}`},i=>{const r=i.new;h(r),m==null||m(r.latitude,r.longitude)}).subscribe();return()=>{a.unsubscribe()}},[e==null?void 0:e.role,c]),(e==null?void 0:e.role)!=="repartidor"&&!u?t.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:t.jsxs("div",{className:"flex items-center space-x-3",children:[t.jsx(j,{className:"w-5 h-5 text-blue-600"}),t.jsxs("div",{children:[t.jsx("p",{className:"text-sm font-medium text-blue-900",children:"Esperando ubicación del repartidor..."}),t.jsx("p",{className:"text-xs text-blue-600",children:"Te notificaremos cuando tu pedido esté en camino"})]})]})}):t.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-4 space-y-4",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Tracking en vivo"}),(e==null?void 0:e.role)==="repartidor"&&t.jsx("div",{className:"flex items-center space-x-2",children:N?t.jsxs("div",{className:"flex items-center space-x-1 text-green-600",children:[t.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full animate-pulse"}),t.jsx("span",{className:"text-xs font-medium",children:"Activo"})]}):t.jsx("span",{className:"text-xs text-gray-500",children:"Inactivo"})})]}),u&&t.jsxs("div",{className:"space-y-3",children:[t.jsxs("div",{className:"flex items-center space-x-3",children:[t.jsx(C,{className:"w-4 h-4 text-blue-600"}),t.jsxs("div",{children:[t.jsx("p",{className:"text-sm font-medium text-gray-900",children:"Ubicación actual"}),t.jsxs("p",{className:"text-xs text-gray-600",children:[u.latitude.toFixed(6),", ",u.longitude.toFixed(6)]}),u.accuracy&&t.jsxs("p",{className:"text-xs text-gray-500",children:["Precisión: ±",Math.round(u.accuracy),"m"]})]})]}),y!==null&&t.jsxs("div",{className:"flex items-center space-x-3",children:[t.jsx(j,{className:"w-4 h-4 text-orange-600"}),t.jsxs("div",{children:[t.jsxs("p",{className:"text-sm font-medium text-gray-900",children:["Distancia: ",y.toFixed(2)," km"]}),v&&t.jsxs("p",{className:"text-xs text-gray-600",children:["Tiempo estimado: ",v]})]})]}),t.jsxs("div",{className:"flex items-center space-x-3",children:[t.jsx(A,{className:"w-4 h-4 text-gray-600"}),t.jsx("div",{children:t.jsxs("p",{className:"text-xs text-gray-600",children:["Última actualización: ",new Date(u.timestamp).toLocaleTimeString()]})})]})]}),(e==null?void 0:e.role)==="repartidor"&&t.jsx("div",{className:"border-t pt-3 space-y-2",children:t.jsxs("div",{className:"flex space-x-2",children:[t.jsxs("button",{onClick:T,className:"flex-1 flex items-center justify-center space-x-1 px-3 py-2 bg-orange-100 text-orange-700 rounded-lg hover:bg-orange-200 transition-colors",children:[t.jsx(D,{className:"w-4 h-4"}),t.jsx("span",{className:"text-sm",children:"Reportar problema"})]}),t.jsxs("button",{onClick:()=>{},className:"flex-1 flex items-center justify-center space-x-1 px-3 py-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition-colors",children:[t.jsx(R,{className:"w-4 h-4"}),t.jsx("span",{className:"text-sm",children:"Llamar cliente"})]})]})})]})}export{L as D};
