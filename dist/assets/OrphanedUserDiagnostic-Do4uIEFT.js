import{u as S,r as m,s as l,j as e,D as g,B as u,C as o,c as d,e as b,R as C,a as j,b as f,L as N,f as x}from"./index-BwL7zrtX.js";import{U as P}from"./user-BHxFeikJ.js";import{C as y}from"./circle-x-D61qsfBL.js";import{T as v}from"./triangle-alert-BSU5RPvi.js";import{E as L}from"./external-link-D_g01Fw4.js";function I(){const{orphanedUser:i,signOut:w}=S(),[n,E]=m.useState([]),[c,h]=m.useState(!0);m.useEffect(()=>{p()},[]);const p=async()=>{h(!0);const s=[];try{try{const{error:a}=await l.from("users").select("count",{count:"exact",head:!0});a?a.code==="PGRST205"?s.push({name:"Tabla users",status:"error",message:"La tabla users no existe",details:"Necesitas ejecutar el script de configuración de la base de datos"}):s.push({name:"Tabla users",status:"error",message:"Error accediendo a la tabla users",details:a.message}):s.push({name:"Tabla users",status:"success",message:"La tabla users existe y es accesible"})}catch(a){s.push({name:"Tabla users",status:"error",message:"Error de conexión con la base de datos",details:a.message})}try{const{error:a}=await l.from("sellers").select("count",{count:"exact",head:!0});a?a.code==="PGRST205"?s.push({name:"Tabla sellers",status:"error",message:"La tabla sellers no existe",details:"Tabla necesaria para vendedores"}):s.push({name:"Tabla sellers",status:"warning",message:"Problema accediendo a la tabla sellers",details:a.message}):s.push({name:"Tabla sellers",status:"success",message:"La tabla sellers existe"})}catch{}try{const{error:a}=await l.from("drivers").select("count",{count:"exact",head:!0});a?a.code==="PGRST205"?s.push({name:"Tabla drivers",status:"error",message:"La tabla drivers no existe",details:"Tabla necesaria para repartidores"}):s.push({name:"Tabla drivers",status:"warning",message:"Problema accediendo a la tabla drivers",details:a.message}):s.push({name:"Tabla drivers",status:"success",message:"La tabla drivers existe"})}catch{}if(i){s.push({name:"Usuario autenticado",status:"success",message:`Usuario ${i.email} está autenticado en Supabase Auth`,details:`ID: ${i.id}`});try{const{data:a,error:r}=await l.from("users").select("*").eq("id",i.id).single();r?r.code==="PGRST116"?s.push({name:"Perfil de usuario",status:"error",message:"El usuario no tiene perfil en la tabla users",details:"Esta es la causa del problema de usuario huérfano"}):s.push({name:"Perfil de usuario",status:"error",message:"Error al buscar el perfil del usuario",details:r.message}):a&&s.push({name:"Perfil de usuario",status:"warning",message:"El usuario SÍ tiene perfil (inconsistencia detectada)",details:`Rol: ${a.role}, Nombre: ${a.name}`})}catch(a){s.push({name:"Perfil de usuario",status:"error",message:"Error verificando perfil del usuario",details:a.message})}}else s.push({name:"Usuario autenticado",status:"error",message:"No hay usuario huérfano detectado",details:"Esto es extraño, debería haber un usuario autenticado"});try{const{data:a,error:r}=await l.from("pg_policies").select("*").eq("schemaname","public").eq("tablename","users");r?s.push({name:"Políticas RLS",status:"warning",message:"No se pudieron verificar las políticas RLS",details:"Esto podría afectar el acceso a los datos"}):s.push({name:"Políticas RLS",status:"success",message:"Políticas RLS verificadas"})}catch{}}catch(a){s.push({name:"Conexión general",status:"error",message:"Error general de conexión",details:a.message})}E(s),h(!1)},T=s=>{switch(s){case"success":return e.jsx(b,{className:"w-5 h-5 text-green-600"});case"error":return e.jsx(y,{className:"w-5 h-5 text-red-600"});case"warning":return e.jsx(v,{className:"w-5 h-5 text-yellow-600"})}},R=s=>{switch(s){case"success":return e.jsx(x,{className:"bg-green-100 text-green-800",children:"OK"});case"error":return e.jsx(x,{variant:"destructive",children:"ERROR"});case"warning":return e.jsx(x,{variant:"secondary",className:"bg-yellow-100 text-yellow-800",children:"ADVERTENCIA"})}},t=(()=>{const s=n.some(r=>r.name.includes("Tabla")&&r.status==="error"),a=n.some(r=>r.name==="Perfil de usuario"&&r.status==="error");return s?{title:"Base de datos no configurada",message:"Necesitas configurar las tablas en Supabase",action:"Configurar Base de Datos",priority:"high"}:a?{title:"Perfil de usuario faltante",message:"El usuario está autenticado pero no tiene perfil",action:"Recuperar Perfil",priority:"medium"}:{title:"Todo parece estar bien",message:"Los diagnósticos no muestran problemas evidentes",action:"Recargar Aplicación",priority:"low"}})();return e.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 to-purple-50",children:[e.jsx("div",{className:"bg-white border-b border-gray-200 shadow-sm",children:e.jsx("div",{className:"container mx-auto px-4 py-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"bg-gradient-to-r from-blue-500 to-purple-500 p-2 rounded-lg",children:e.jsx(g,{className:"w-6 h-6 text-white"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-xl font-semibold text-gray-900",children:"Diagnóstico de Usuario Huérfano"}),e.jsx("p",{className:"text-sm text-gray-600",children:"Analizando el problema de autenticación"})]})]}),e.jsx(u,{variant:"outline",onClick:w,children:"Cerrar Sesión"})]})})}),e.jsxs("div",{className:"container mx-auto px-4 py-6 max-w-4xl",children:[i&&e.jsx(o,{className:"mb-6",children:e.jsx(d,{className:"p-6",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"bg-blue-100 p-3 rounded-full",children:e.jsx(P,{className:"w-6 h-6 text-blue-600"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-900",children:"Usuario Detectado"}),e.jsxs("p",{className:"text-gray-600",children:["Email: ",e.jsx("strong",{children:i.email})]}),e.jsxs("p",{className:"text-sm text-gray-500",children:["ID: ",i.id]})]})]})})}),e.jsx(o,{className:`mb-6 border-2 ${t.priority==="high"?"border-red-300":t.priority==="medium"?"border-yellow-300":"border-green-300"}`,children:e.jsx(d,{className:"p-6",children:e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsx("div",{className:`p-3 rounded-full ${t.priority==="high"?"bg-red-100":t.priority==="medium"?"bg-yellow-100":"bg-green-100"}`,children:t.priority==="high"?e.jsx(y,{className:"w-6 h-6 text-red-600"}):t.priority==="medium"?e.jsx(v,{className:"w-6 h-6 text-yellow-600"}):e.jsx(b,{className:"w-6 h-6 text-green-600"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"font-semibold text-gray-900 mb-2",children:t.title}),e.jsx("p",{className:"text-gray-700 mb-4",children:t.message}),e.jsxs("div",{className:"flex gap-3",children:[t.priority==="high"&&e.jsx(u,{asChild:!0,children:e.jsxs("a",{href:"https://supabase.com/dashboard",target:"_blank",rel:"noopener noreferrer",className:"flex items-center gap-2",children:[e.jsx(L,{className:"w-4 h-4"}),"Ir a Supabase Dashboard"]})}),e.jsxs(u,{variant:"outline",onClick:p,disabled:c,children:[e.jsx(C,{className:`w-4 h-4 mr-2 ${c?"animate-spin":""}`}),"Volver a Diagnosticar"]})]})]})]})})}),e.jsxs(o,{children:[e.jsx(j,{children:e.jsxs(f,{className:"flex items-center gap-2",children:[e.jsx(g,{className:"w-5 h-5"}),"Resultados del Diagnóstico",c&&e.jsx(N,{className:"w-4 h-4 animate-spin"})]})}),e.jsx(d,{children:c?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(N,{className:"w-8 h-8 animate-spin mx-auto mb-4 text-gray-400"}),e.jsx("p",{className:"text-gray-600",children:"Ejecutando diagnósticos..."})]}):e.jsxs("div",{className:"space-y-4",children:[n.map((s,a)=>e.jsxs("div",{className:"flex items-start gap-4 p-4 border border-gray-200 rounded-lg",children:[e.jsx("div",{className:"flex-shrink-0",children:T(s.status)}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("h4",{className:"font-medium text-gray-900",children:s.name}),R(s.status)]}),e.jsx("p",{className:"text-gray-700 text-sm mb-1",children:s.message}),s.details&&e.jsx("p",{className:"text-xs text-gray-500",children:s.details})]})]},a)),n.length===0&&e.jsx("div",{className:"text-center py-8 text-gray-500",children:"No se pudieron ejecutar los diagnósticos"})]})})]}),t.priority==="high"&&e.jsxs(o,{className:"mt-6 border-red-200",children:[e.jsx(j,{children:e.jsx(f,{className:"text-red-800",children:"Pasos para Solucionar"})}),e.jsx(d,{children:e.jsxs("div",{className:"space-y-3 text-sm",children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("span",{className:"bg-red-100 text-red-800 font-medium px-2 py-1 rounded text-xs",children:"1"}),e.jsxs("p",{children:["Ve a ",e.jsx("strong",{children:"Supabase Dashboard"})," → ",e.jsx("strong",{children:"SQL Editor"})]})]}),e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("span",{className:"bg-red-100 text-red-800 font-medium px-2 py-1 rounded text-xs",children:"2"}),e.jsxs("p",{children:["Ejecuta el script completo de ",e.jsx("code",{className:"bg-gray-100 px-1 rounded",children:"/database/fix_setup.sql"})]})]}),e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("span",{className:"bg-red-100 text-red-800 font-medium px-2 py-1 rounded text-xs",children:"3"}),e.jsxs("p",{children:["Ve a ",e.jsx("strong",{children:"Authentication → Settings"})," y desactiva email confirmations"]})]}),e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("span",{className:"bg-red-100 text-red-800 font-medium px-2 py-1 rounded text-xs",children:"4"}),e.jsx("p",{children:"Recarga esta página y prueba nuevamente"})]})]})})]})]})]})}export{I as OrphanedUserDiagnostic};
