import{g as Ne,u as ke,h as Te,r as x,s as R,j as e,B as L,f as Z,R as qe,X as Ge,C as Q,c as H,a as ee,b as se,i as ms,t as V,e as oe,P as zs,d as Ee,S as je,k as us,l as $e,m as ja,n as Ms,o as Ue,p as Qe,q as ns,v as va,w as ya,x as ba,y as Ls,z as os,A as Na,E as _a,L as wa,Z as ka}from"./index-4-AwG29v.js";import{P as xe,T as es,a as ss,b as _e,c as He,d as ve,D as Sa,e as Bs,R as Ca,I as Ea,f as Ta}from"./MobileToastNotifications-3ugepJgb.js";import{r as Ns,v as Pa,g as Ia,I as ye,F as Ie,P as Se,B as Us,R as Oa,S as Ra,T as qa,H as _s,O as Da}from"./OnlineDriversIndicator-HNvYW-T_.js";import{S as we}from"./shopping-cart-BOO1-4Of.js";import{S as ze,M as We}from"./search-DnUSyTpP.js";import{I as be}from"./input-CpumT4jH.js";import{S as Aa,a as $a,b as Fa,c as za,d as ws}from"./select-8vWsytcu.js";import{S as de}from"./store-QTE8zrRl.js";import{S as le}from"./star-y3UgyW1L.js";import{M as Oe}from"./map-pin-Bq09d-Wk.js";import{C as me}from"./clock-B_Z9HJ2h.js";import{C as De}from"./circle-x-DX92_EAG.js";import{E as xs}from"./eye-BWSEqSXu.js";import{T as ue}from"./truck-B1XgDIDQ.js";import{T as Ke}from"./textarea-CEdelz7N.js";import{A as Ma,a as La}from"./alert-DOpAQqM1.js";import{A as Ba,a as Ua,b as Va,c as Ga,d as Qa,e as Ha,f as Wa,g as Ka,h as Xa}from"./alert-dialog-DqFszWiM.js";import{T as Xe}from"./trash-2-CcfDt0bH.js";import{T as Ze}from"./triangle-alert-Bssc8toj.js";import{C as Me,a as Za,P as cs}from"./phone-CTix1mOX.js";import{L as pe}from"./label-CC14d3iK.js";import{M as Ya}from"./mail-C1svvPKY.js";import{S as ks}from"./shield-B1QbiO4P.js";import{U as Ae}from"./user-B48tUNjl.js";import{S as Ss}from"./save-D0EZY3Mz.js";import{S as Ja}from"./shopping-bag-DWBhS1Jd.js";import{L as er}from"./lock-CZ-3tcfC.js";import{A as Be}from"./arrow-left-ZRY0wD5A.js";import{u as sr,N as ar}from"./NotificationSystem-VYBd2MnA.js";import{I as Cs}from"./info-pXAA3aog.js";import{C as rr,D as tr}from"./DeliveryTracking-Z9czLW8M.js";import{L as ir}from"./log-out-Bo3w5xDE.js";import"./users-lsPUPacr.js";/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const nr=[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"m12 5 7 7-7 7",key:"xquz4c"}]],Vs=Ne("arrow-right",nr);/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const lr=[["rect",{width:"20",height:"12",x:"2",y:"6",rx:"2",key:"9lu3g6"}],["circle",{cx:"12",cy:"12",r:"2",key:"1c9p78"}],["path",{d:"M6 12h.01M18 12h.01",key:"113zkx"}]],or=Ne("banknote",lr);/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const cr=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]],dr=Ne("circle",cr);/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const mr=[["rect",{width:"20",height:"14",x:"2",y:"5",rx:"2",key:"ynyp8z"}],["line",{x1:"2",x2:"22",y1:"10",y2:"10",key:"1b3vmo"}]],Le=Ne("credit-card",mr);/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ur=[["path",{d:"M10 20a1 1 0 0 0 .553.895l2 1A1 1 0 0 0 14 21v-7a2 2 0 0 1 .517-1.341L21.74 4.67A1 1 0 0 0 21 3H3a1 1 0 0 0-.742 1.67l7.225 7.989A2 2 0 0 1 10 14z",key:"sc7q7i"}]],xr=Ne("funnel",ur);/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const gr=[["path",{d:"M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z",key:"c3ymky"}]],Ye=Ne("heart",gr);/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const hr=[["circle",{cx:"18",cy:"5",r:"3",key:"gq8acd"}],["circle",{cx:"6",cy:"12",r:"3",key:"w7nqdw"}],["circle",{cx:"18",cy:"19",r:"3",key:"1xt0gg"}],["line",{x1:"8.59",x2:"15.42",y1:"13.51",y2:"17.49",key:"47mynk"}],["line",{x1:"15.41",x2:"8.59",y1:"6.51",y2:"10.49",key:"1n3mei"}]],pr=Ne("share-2",hr);/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const fr=[["path",{d:"M7 10v12",key:"1qc93n"}],["path",{d:"M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2a3.13 3.13 0 0 1 3 3.88Z",key:"emmmcr"}]],jr=Ne("thumbs-up",fr);/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const vr=[["path",{d:"m16 2-2.3 2.3a3 3 0 0 0 0 4.2l1.8 1.8a3 3 0 0 0 4.2 0L22 8",key:"n7qcjb"}],["path",{d:"M15 15 3.3 3.3a4.2 4.2 0 0 0 0 6l7.3 7.3c.7.7 2 .7 2.8 0L15 15Zm0 0 7 7",key:"d0u48b"}],["path",{d:"m2.1 21.8 6.4-6.3",key:"yn04lh"}],["path",{d:"m19 5-7 7",key:"194lzd"}]],yr=Ne("utensils-crossed",vr);/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const br=[["path",{d:"M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2",key:"cjf0a3"}],["path",{d:"M7 2v20",key:"1473qp"}],["path",{d:"M21 15V2a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7",key:"j28e5"}]],Gs=Ne("utensils",br);/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Nr=[["path",{d:"M19 7V4a1 1 0 0 0-1-1H5a2 2 0 0 0 0 4h15a1 1 0 0 1 1 1v4h-3a2 2 0 0 0 0 4h3a1 1 0 0 0 1-1v-2a1 1 0 0 0-1-1",key:"18etb6"}],["path",{d:"M3 5v14a2 2 0 0 0 2 2h15a1 1 0 0 0 1-1v-4",key:"xoc0q4"}]],_r=Ne("wallet",Nr),Qs=x.createContext(void 0);function Es({children:s}){const{user:r}=ke(),{clearCart:n}=Te(),[h,m]=x.useState([]),[c,p]=x.useState(!1),[d,g]=x.useState(null),[_,D]=x.useState(null),l=async()=>{if(!r){m([]);return}try{p(!0),g(null);const{error:t}=await R.from("orders").select("count",{count:"exact",head:!0});if((t==null?void 0:t.code)==="PGRST205"){console.log("Orders table does not exist yet"),m([]);return}let k=R.from("orders").select(`
          *,
          order_items (*)
        `);switch(r.role){case"comprador":k=k.eq("buyer_id",r.id);break;case"vendedor":k=k.eq("seller_id",r.id);break;case"repartidor":k=k.or(`driver_id.eq.${r.id},status.eq.ready,status.eq.assigned`);break}const{data:i,error:a}=await k.order("created_at",{ascending:!1});if(a){console.error("Error fetching orders:",a),g("Error al cargar las √≥rdenes");return}const u=await Promise.all((i||[]).map(async v=>{let N="",o="";if(v.seller_id){const{data:C}=await R.from("users").select("name").eq("id",v.seller_id).single();N=(C==null?void 0:C.name)||""}if(v.driver_id){const{data:C}=await R.from("users").select("name").eq("id",v.driver_id).single();o=(C==null?void 0:C.name)||""}return{...v,items:v.order_items||[],seller_name:N,driver_name:o}}));m(u)}catch(t){console.error("Unexpected error fetching orders:",t),g("Error inesperado al cargar las √≥rdenes")}finally{p(!1)}},T=async t=>{if(!r)return{success:!1,message:"Debes iniciar sesi√≥n para crear una orden"};try{p(!0),g(null);const{data:k,error:i}=await R.from("cart_items").select(`
          *,
          products!inner (
            id,
            name,
            price,
            seller_id,
            is_public
          )
        `).eq("user_id",r.id);if(i)return console.error("Error fetching cart items:",i),{success:!1,message:"Error al obtener los productos del carrito"};if(!k||k.length===0)return{success:!1,message:"El carrito est√° vac√≠o"};const a=k.filter(U=>U.products?U.products.is_public?!0:(console.warn(`Product ${U.product_id} is not public`),!1):(console.warn(`Cart item ${U.id} has no associated product`),!1));if(a.length===0)return{success:!1,message:"No hay productos v√°lidos en el carrito"};if(a.length!==k.length)return{success:!1,message:"Algunos productos en tu carrito ya no est√°n disponibles. Por favor actualiza tu carrito."};const u=[...new Set(a.map(U=>U.products.seller_id))];if(u.length>1)return{success:!1,message:"Todos los productos deben ser del mismo vendedor"};const v=u[0];if(!v)return{success:!1,message:"Error: productos sin vendedor asignado"};const N=a.reduce((U,X)=>{const te=X.products.price||X.product_price||0;return U+te*X.quantity},0);let o=0;t.delivery_type==="delivery"&&(o=15);const C=N+o;console.log("üõ°Ô∏è Validando disponibilidad de stock antes de crear orden...");const F=await Pa(a.map(U=>({product_id:U.product_id,quantity:U.quantity,product_name:U.products.name})));if(!F.isValid)return console.warn("‚ö†Ô∏è Stock insuficiente:",F.message),{success:!1,message:F.message};console.log("‚úÖ Stock validado correctamente, procediendo con la orden");const b={buyer_id:r.id,seller_id:v,subtotal:N,delivery_fee:o,total:C,delivery_type:t.delivery_type,delivery_address:t.delivery_address,customer_notes:t.customer_notes,phone_number:t.phone_number,customer_name:t.customer_name,status:"pending",estimated_time:30};t.delivery_location?(b.delivery_latitude=t.delivery_location.latitude,b.delivery_longitude=t.delivery_location.longitude,(t.delivery_location.address_id||t.delivery_location.delivery_instructions||t.delivery_location.landmark)&&(b.delivery_location=t.delivery_location)):(b.delivery_latitude=t.delivery_latitude,b.delivery_longitude=t.delivery_longitude);const{data:O,error:P}=await R.from("orders").insert(b).select().single();if(P||!O)return console.error("Error creating order:",P),{success:!1,message:"Error al crear la orden"};const J=a.map(U=>{const X=U.products.price||U.product_price||0,te=U.product_type==="daily";return{order_id:O.id,product_id:te?null:U.product_id,daily_product_id:te?U.product_id:null,product_name:U.products.name||U.product_name||"",product_image:U.product_image,price:X,quantity:U.quantity,product_type:U.product_type||"regular",notes:""}}),{error:ie}=await R.from("order_items").insert(J);if(ie)return console.error("Error creating order items:",ie),await R.from("orders").delete().eq("id",O.id),ie.code==="23503"?{success:!1,message:"Error: algunos productos ya no est√°n disponibles"}:{success:!1,message:"Error al crear los items de la orden"};console.log("üì¶ Orden creada exitosamente. Stock se actualizar√° cuando se marque como entregado.");try{await R.from("notifications").insert({recipient_id:v,type:"new_order",title:"Nueva Orden",message:`Nueva orden por Q${C.toFixed(2)} - ${t.delivery_type}`,data:{order_id:O.id}})}catch(U){console.warn("Failed to create notification:",U)}try{await n()}catch(U){console.warn("Failed to clear cart:",U)}return D(O),await l(),{success:!0,message:"Orden creada exitosamente",orderId:O.id}}catch(k){return console.error("Unexpected error creating order:",k),{success:!1,message:"Error inesperado al crear la orden"}}finally{p(!1)}},w=async(t,k,i)=>{if(!r)return{success:!1,message:"Debes iniciar sesi√≥n"};try{p(!0);const a={status:k,updated_at:new Date().toISOString()};switch(k){case"accepted":a.accepted_at=new Date().toISOString();break;case"ready":a.ready_at=new Date().toISOString();break;case"picked_up":a.picked_up_at=new Date().toISOString();break;case"delivered":a.delivered_at=new Date().toISOString();break;case"completed":a.completed_at=new Date().toISOString();break;case"rejected":a.rejection_reason=i||"Sin raz√≥n especificada";break}const{error:u}=await R.from("orders").update(a).eq("id",t);if(u)return console.error("Error updating order status:",u),{success:!1,message:"Error al actualizar el estado de la orden"};if(k==="cancelled"||k==="rejected")try{const{data:N,error:o}=await R.from("order_items").select("product_id, quantity, product_name").eq("order_id",t);if(!o&&N&&N.length>0){console.log(`üì¶ Restaurando stock para orden ${k}...`);for(const C of N){const F=await Ns(C.product_id,C.quantity);F.success?console.log(`‚úÖ Stock restaurado: ${C.product_name} - Cantidad devuelta: ${C.quantity}`):console.warn(`‚ö†Ô∏è No se pudo restaurar stock para ${C.product_name}:`,F.message)}console.log("üéâ Stock restaurado exitosamente")}}catch(N){console.error("‚ùå Error restaurando stock:",N)}const{data:v}=await R.from("orders").select("*, order_items(*)").eq("id",t).single();if(v){const N=[];switch(k){case"accepted":N.push({recipient_id:v.buyer_id,type:"order_accepted",title:"Orden Aceptada",message:`Tu orden ha sido aceptada y ser√° preparada en ${v.estimated_time} minutos`,data:{order_id:t}});break;case"ready":if(N.push({recipient_id:v.buyer_id,type:"order_ready",title:"Orden Lista",message:v.delivery_type==="pickup"?"Tu orden est√° lista para recoger":"Tu orden est√° lista para entrega",data:{order_id:t}}),v.delivery_type==="delivery"){const{data:o}=await R.from("users").select("id").eq("role","repartidor").eq("is_available",!0);o&&o.forEach(C=>{N.push({recipient_id:C.id,type:"delivery_available",title:"Entrega Disponible",message:`Nueva entrega disponible - Q${v.delivery_fee.toFixed(2)}`,data:{order_id:t}})})}break;case"delivered":N.push({recipient_id:v.buyer_id,type:"order_delivered",title:"Orden Entregada",message:"Tu orden ha sido entregada exitosamente",data:{order_id:t}});break}if(N.length>0)try{await R.from("notifications").insert(N)}catch(o){console.warn("Failed to create notifications:",o)}}return await l(),{success:!0,message:"Estado actualizado exitosamente"}}catch(a){return console.error("Unexpected error updating order status:",a),{success:!1,message:"Error inesperado al actualizar el estado"}}finally{p(!1)}},q=async(t,k)=>{if(!r)return{success:!1,message:"Debes iniciar sesi√≥n"};try{const{error:i}=await R.from("orders").update({driver_id:k,status:"assigned",updated_at:new Date().toISOString()}).eq("id",t);if(i)return console.error("Error assigning driver:",i),{success:!1,message:"Error al asignar repartidor"};const{data:a}=await R.from("orders").select("buyer_id, seller_id").eq("id",t).single();if(a){const u=[{recipient_id:a.buyer_id,type:"driver_assigned",title:"Repartidor Asignado",message:"Un repartidor ha sido asignado a tu orden",data:{order_id:t}},{recipient_id:k,type:"delivery_assigned",title:"Entrega Asignada",message:"Se te ha asignado una nueva entrega",data:{order_id:t}}];try{await R.from("notifications").insert(u)}catch(v){console.warn("Failed to create assignment notifications:",v)}}return await l(),{success:!0,message:"Repartidor asignado exitosamente"}}catch(i){return console.error("Unexpected error assigning driver:",i),{success:!1,message:"Error inesperado al asignar repartidor"}}},f=async(t,k,i,a)=>{if(!r)return{success:!1,message:"Debes iniciar sesi√≥n"};try{console.log("üåü Enviando calificaci√≥n:",{orderId:t,rating:k,type:i,comment:a});const{data:u}=await R.from("orders").select("buyer_id, seller_id, driver_id, status").eq("id",t).single();if(!u)return{success:!1,message:"Orden no encontrada"};const v=i==="seller"?u.seller_id:u.driver_id;if(!v)return{success:!1,message:`No hay ${i==="seller"?"vendedor":"repartidor"} asignado`};let N;if(r.id===u.buyer_id)N=i==="seller"?"buyer_to_seller":"buyer_to_driver";else if(r.id===u.seller_id)N=i==="seller"?"seller_to_buyer":"seller_to_driver";else return{success:!1,message:"No tienes permisos para calificar esta orden"};if(console.log("üéØ Tipo de calificaci√≥n:",N),u.status!=="delivered")return{success:!1,message:"Solo se pueden calificar √≥rdenes entregadas"};const{data:o}=await R.from("ratings").select("id").eq("order_id",t).eq("rater_id",r.id).eq("rated_id",v).eq("rating_type",N).eq("status","completed").single();if(o)return{success:!1,message:"Ya has calificado esta orden"};let C;const{data:F}=await R.from("ratings").select("id").eq("order_id",t).eq("rater_id",r.id).eq("rated_id",v).eq("rating_type",N).eq("status","pending").single();if(F)C=F.id;else{const{data:P,error:J}=await R.from("ratings").insert({order_id:t,rater_id:r.id,rated_id:v,rating_type:N,status:"pending"}).select("id").single();if(J)return console.error("Error creating rating:",J),{success:!1,message:"Error al crear la calificaci√≥n: "+J.message};if(!P)return{success:!1,message:"No se pudo crear la calificaci√≥n"};C=P.id}const{data:b,error:O}=await R.rpc("complete_rating",{p_rating_id:C,p_user_id:r.id,p_rating:k,p_comment:a||null});return O?(console.error("Error completing rating:",O),{success:!1,message:"Error al enviar la calificaci√≥n: "+O.message}):b?(console.log("‚úÖ Calificaci√≥n enviada exitosamente"),{success:!0,message:"¬°Calificaci√≥n enviada exitosamente!"}):{success:!1,message:"No se pudo completar la calificaci√≥n"}}catch(u){return console.error("Unexpected error rating order:",u),{success:!1,message:"Error inesperado al enviar la calificaci√≥n"}}},E=async t=>{try{const{data:k,error:i}=await R.from("orders").select(`
          *,
          order_items (*)
        `).eq("id",t).single();return i||!k?(console.error("Error fetching order:",i),null):{...k,items:k.order_items||[]}}catch(k){return console.error("Unexpected error fetching order:",k),null}},z=async(t,k)=>r?await w(t,"cancelled",k):{success:!1,message:"Debes iniciar sesi√≥n"},G=async t=>{if(!r||r.role!=="comprador")return{success:!1,message:"Solo los compradores pueden eliminar pedidos no confirmados"};try{p(!0);const{data:k,error:i}=await R.from("orders").select("status, buyer_id, seller_id, total").eq("id",t).single();if(i||!k)return{success:!1,message:"Orden no encontrada"};if(k.buyer_id!==r.id)return{success:!1,message:"No tienes permisos para eliminar esta orden"};if(k.status!=="pending")return{success:!1,message:"Solo se pueden eliminar pedidos pendientes"};const{data:a,error:u}=await R.from("order_items").select("product_id, quantity, product_name").eq("order_id",t);u&&console.error("Error fetching order items for stock restoration:",u);const{error:v}=await R.from("order_items").delete().eq("order_id",t);if(v)return console.error("Error deleting order items:",v),{success:!1,message:"Error al eliminar los items del pedido"};const{error:N}=await R.from("orders").delete().eq("id",t);if(N)return console.error("Error deleting order:",N),{success:!1,message:"Error al eliminar el pedido"};if(a&&a.length>0){console.log("üì¶ Restaurando stock despu√©s de eliminar orden...");try{for(const o of a){const C=await Ns(o.product_id,o.quantity);C.success?console.log(`‚úÖ Stock restaurado: ${o.product_name} - Cantidad devuelta: ${o.quantity}`):console.warn(`‚ö†Ô∏è No se pudo restaurar stock para ${o.product_name}:`,C.message)}console.log("üéâ Stock restaurado exitosamente")}catch(o){console.error("‚ùå Error restaurando stock:",o)}}if(k.seller_id)try{await R.from("notifications").insert({recipient_id:k.seller_id,type:"order_cancelled",title:"Pedido Eliminado",message:`Un pedido por Q${k.total.toFixed(2)} fue eliminado por el cliente`,data:{order_id:t,deleted:!0}})}catch(o){console.warn("Failed to create cancellation notification:",o)}return m(o=>o.filter(C=>C.id!==t)),{success:!0,message:"Pedido eliminado exitosamente"}}catch(k){return console.error("Unexpected error deleting order:",k),{success:!1,message:"Error inesperado al eliminar el pedido"}}finally{p(!1)}},M=async()=>{await l()},y=t=>h.filter(k=>k.status===t),j=()=>h.filter(t=>!["completed","cancelled","rejected"].includes(t.status));x.useEffect(()=>{l()},[r]),x.useEffect(()=>{if(!r)return;const t=R.channel("orders").on("postgres_changes",{event:"*",schema:"public",table:"orders",filter:r.role==="comprador"?`buyer_id=eq.${r.id}`:r.role==="vendedor"?`seller_id=eq.${r.id}`:`driver_id=eq.${r.id}`},()=>{l()}).subscribe();return()=>{t.unsubscribe()}},[r]);const I={orders:h,loading:c,error:d,currentOrder:_,createOrder:T,updateOrderStatus:w,assignDriver:q,rateOrder:f,getOrderById:E,refreshOrders:M,getOrdersByStatus:y,getActiveOrders:j,cancelOrder:z,deleteUnconfirmedOrder:G};return e.jsx(Qs.Provider,{value:I,children:s})}function gs(){const s=x.useContext(Qs);if(s===void 0)throw new Error("useOrder must be used within an OrderProvider");return s}function Je(s){if(s){if(s.startsWith("http://")||s.startsWith("https://"))return s;if(s.startsWith("business-logos/")||s.startsWith("avatars/")||s.startsWith("products/")){const r=s.startsWith("business-logos/")?"business-logos":s.startsWith("avatars/")?"avatars":"products",{data:n}=R.storage.from(r).getPublicUrl(s);return n.publicUrl}if(!s.includes("/")){const{data:r}=R.storage.from("business-logos").getPublicUrl(s);return r.publicUrl}return s}}function Ts(s){var r;if(s.logo_url)return Je(s.logo_url);if((r=s.user)!=null&&r.avatar_url)return Je(s.user.avatar_url)}function Ps(s){if(s.image_url)return Je(s.image_url)}function Hs(s){return Je(s)}function Ve(s){if(!s)return!1;try{const r=JSON.parse(s),n=new Date,m=["sunday","monday","tuesday","wednesday","thursday","friday","saturday"][n.getDay()],c=n.toLocaleTimeString("es-ES",{hour:"2-digit",minute:"2-digit"}),p=r[m];if(!p||!p.open||!p.close)return!1;const d=ls(c),g=ls(p.open),_=ls(p.close);return _<g?d>=g||d<=_:d>=g&&d<=_}catch(r){return console.error("Error checking business hours:",r),!1}}function ls(s){const[r,n]=s.split(":").map(Number);return r*60+n}const wr=()=>{const[s,r]=x.useState(()=>typeof document<"u"?!document.hidden:!0);return x.useEffect(()=>{if(typeof document>"u")return;const n=()=>{r(!document.hidden)};return document.addEventListener("visibilitychange",n),()=>document.removeEventListener("visibilitychange",n)},[]),s};function Ws(){const[s,r]=x.useState([]),[n,h]=x.useState([]),[m,c]=x.useState([]),[p,d]=x.useState({products:!1,dailyProducts:!1,businesses:!1}),g=wr(),_=async y=>{var j,I;try{d(a=>({...a,products:!0}));let t=R.from("products").select(`
          *,
          seller:sellers(
            id,
            business_name,
            business_description,
            logo_url,
            is_verified,
            is_open_now,
            is_active,
            weekly_hours,
            user:users(name, avatar_url)
          )
        `).eq("is_public",!0).eq("is_available",!0).gt("stock_quantity",0).eq("seller.is_active",!0);y!=null&&y.search&&(t=t.or(`name.ilike.%${y.search}%,description.ilike.%${y.search}%`)),y!=null&&y.category&&y.category!=="all"&&(t=t.eq("category",y.category)),y!=null&&y.limit&&(t=t.limit(y.limit));let{data:k,error:i}=await t.order("created_at",{ascending:!1});if(i){const a=(i==null?void 0:i.code)||"",u=((I=(j=i==null?void 0:i.message)==null?void 0:j.toLowerCase)==null?void 0:I.call(j))||"";if(a==="PGRST201"||a==="PGRST200"||a==="42P01"||a==="42703"||u.includes("relationship")||u.includes("column")||u.includes("relation")){let N=R.from("products").select("*").eq("is_public",!0).eq("is_available",!0).gt("stock_quantity",0);y!=null&&y.search&&(N=N.or(`name.ilike.%${y.search}%,description.ilike.%${y.search}%`)),y!=null&&y.category&&y.category!=="all"&&(N=N.eq("category",y.category)),y!=null&&y.limit&&(N=N.limit(y.limit));const o=await N.order("created_at",{ascending:!1});k=o.data,i=o.error}}if(i)console.error("Error fetching products:",i),r([]);else{const a=k||[],u=a.filter(v=>{if(!v.seller)return!0;const N=v.seller.weekly_hours?Ve(v.seller.weekly_hours):!0,o=(v.seller.is_open_now??!0)&&N;return console.log(`üõçÔ∏è Producto "${v.name}" de ${v.seller.business_name}:`,{manual:v.seller.is_open_now,schedule:N,final:o}),o});console.log(`üéØ PRODUCTOS FILTRADOS: ${a.length} total ‚Üí ${u.length} de negocios abiertos`),r(u)}}catch(t){console.error("Error fetching products:",t)}finally{d(t=>({...t,products:!1}))}},D=async()=>{var y,j;try{d(a=>({...a,dailyProducts:!0}));const I=new Date,t=new Date(I);t.setHours(23,59,59,999);let{data:k,error:i}=await R.from("daily_products").select(`
          *,
          seller:sellers(
            id,
            business_name,
            logo_url,
            is_verified,
            is_open_now,
            is_active,
            weekly_hours,
            user:users(name, avatar_url)
          )
        `).gt("stock_quantity",0).gte("expires_at",new Date().toISOString()).lte("expires_at",t.toISOString()).order("created_at",{ascending:!1});if(i){const a=(i==null?void 0:i.code)||"",u=((j=(y=i==null?void 0:i.message)==null?void 0:y.toLowerCase)==null?void 0:j.call(y))||"";if(a==="PGRST205"){console.log("daily_products table does not exist yet"),h([]);return}if(a==="PGRST201"||a==="PGRST200"||a==="42P01"||a==="42703"||u.includes("relationship")||u.includes("relation")||u.includes("column")){const N=await R.from("daily_products").select(`
              *,
              seller:sellers(
                id,
                business_name,
                logo_url,
                is_verified,
                is_open_now,
                is_active,
                weekly_hours
              )
            `).gt("stock_quantity",0).gte("expires_at",new Date().toISOString()).lte("expires_at",t.toISOString()).order("created_at",{ascending:!1});if(N.error){const o=await R.from("daily_products").select("*").gt("stock_quantity",0).gte("expires_at",new Date().toISOString()).lte("expires_at",t.toISOString()).order("created_at",{ascending:!1});k=o.data,i=o.error}else k=N.data,i=N.error}}if(i)console.error("Error fetching daily products:",i),h([]);else{const a=k?k.filter((v,N,o)=>N===o.findIndex(C=>C.name===v.name)):[],u=a.filter(v=>{if(!v.seller)return!0;const N=v.seller.weekly_hours?Ve(v.seller.weekly_hours):!0,o=(v.seller.is_open_now??!0)&&N;return console.log(`üì¶ Producto del d√≠a "${v.name}" de ${v.seller.business_name}:`,{manual:v.seller.is_open_now,schedule:N,final:o}),o});console.log(`üéØ PRODUCTOS DEL D√çA FILTRADOS: ${a.length} total ‚Üí ${u.length} de negocios abiertos`),h(u)}}catch(I){console.error("Error fetching daily products:",I)}finally{d(I=>({...I,dailyProducts:!1}))}},l=async()=>{var y,j;try{d(o=>({...o,businesses:!0}));let{data:I,error:t}=await R.from("sellers").select(`
          id,
          business_name,
          business_description,
          business_address,
          business_phone,
          phone,
          address,
          business_logo,
          cover_image_url,
          logo_url,
          is_verified,
          is_open_now,
          weekly_hours,
          user:users(name, phone, email, address, avatar_url)
        `).not("business_name","is",null).eq("is_active",!0).order("is_verified",{ascending:!1});if(t){const o=(t==null?void 0:t.code)||"",C=((j=(y=t==null?void 0:t.message)==null?void 0:y.toLowerCase)==null?void 0:j.call(y))||"";if(o==="PGRST201"||o==="PGRST200"||o==="42P01"||o==="42703"||C.includes("relationship")||C.includes("column")||C.includes("relation")){const b=await R.from("sellers").select("id,business_name,business_description,business_address,business_phone,phone,address,business_logo,cover_image_url,logo_url,is_verified,is_open_now,weekly_hours").not("business_name","is",null).eq("is_active",!0).order("is_verified",{ascending:!1});I=b.data,t=b.error}}if(t){console.error("Error fetching businesses:",t),c([]);return}const k=I||[],i=k.map(o=>o.id);let a=new Map,u=new Map;if(i.length>0){try{const{data:o,error:C}=await R.from("products").select("seller_id").in("seller_id",i).eq("is_public",!0);C?console.error("Error fetching products for counts:",C):a=(o==null?void 0:o.reduce((F,b)=>(F.set(b.seller_id,(F.get(b.seller_id)||0)+1),F),new Map))??new Map}catch(o){console.error("Error aggregating product counts:",o)}try{const{data:o,error:C}=await R.from("seller_ratings_view").select("seller_id, average_rating").in("seller_id",i);C?console.error("Error fetching ratings:",C):u=(o==null?void 0:o.reduce((F,b)=>(F.set(b.seller_id,b.average_rating||0),F),new Map))??new Map}catch(o){console.error("Error aggregating ratings:",o)}}const v=k.map(o=>{var U,X,te,ge,B,A;const C=o.cover_image_url||o.business_logo||o.logo_url,F=o.business_logo||o.logo_url,b=Ts({logo_url:F??void 0,user:o.user?{avatar_url:o.user.avatar_url}:void 0});console.log("üî• BUSINESS DATA:",{id:o.id,name:o.business_name,cover_image_url:o.cover_image_url,business_logo:o.business_logo,logo_url:o.logo_url,final_cover:C,final_logo:F});const O=a.get(o.id)||0,P=u.get(o.id)||0,J=o.weekly_hours?Ve(o.weekly_hours):!0,ie=(o.is_open_now??!0)&&J;return console.log(`üè™ ${o.business_name}:`,{manual:o.is_open_now,schedule:J,final:ie}),{id:o.id,business_name:o.business_name,business_description:o.business_description??void 0,business_address:o.business_address??void 0,business_phone:o.business_phone??void 0,logo_url:F??void 0,cover_image_url:C??void 0,is_verified:o.is_verified,products_count:O,rating:P,phone:o.phone??void 0,address:o.address??void 0,user:{name:((U=o.user)==null?void 0:U.name)??"Usuario",phone:((X=o.user)==null?void 0:X.phone)??void 0,email:((te=o.user)==null?void 0:te.email)??void 0,address:((ge=o.user)==null?void 0:ge.address)??void 0,avatar_url:((B=o.user)==null?void 0:B.avatar_url)??void 0},cover_image:C??void 0,category:"General",phone_number:o.phone||o.business_phone||((A=o.user)==null?void 0:A.phone)||void 0,is_open_now:ie}}),N=v.filter(o=>o.is_open_now);console.log(`üéØ NEGOCIOS FILTRADOS: ${v.length} total ‚Üí ${N.length} abiertos`),c(N)}catch(I){console.error("Error fetching businesses:",I)}finally{d(I=>({...I,businesses:!1}))}},T=async y=>{var j,I;try{const{data:t,error:k}=await R.from("sellers").select("is_open_now, weekly_hours, business_name").eq("id",y).eq("is_active",!0).single();if(k||!t)return console.log(`‚ùå Negocio ${y} no encontrado o inactivo`),[];const i=t.weekly_hours?Ve(t.weekly_hours):!0;if(!((t.is_open_now??!0)&&i))return console.log(`üî¥ Negocio ${t.business_name} est√° cerrado - No mostrar productos`),[];let u=R.from("products").select(`
          *,
          seller:sellers(
            id,
            business_name,
            logo_url,
            is_verified
          )
        `).eq("seller_id",y).eq("is_public",!0).eq("is_available",!0).gt("stock_quantity",0).order("created_at",{ascending:!1}),{data:v,error:N}=await u;if(N){const C=(N==null?void 0:N.code)||"",F=((I=(j=N==null?void 0:N.message)==null?void 0:j.toLowerCase)==null?void 0:I.call(j))||"";if(C==="PGRST201"||C==="PGRST200"||C==="42P01"||C==="42703"||F.includes("relationship")||F.includes("column")||F.includes("relation")){const O=await R.from("products").select("*").eq("seller_id",y).eq("is_public",!0).eq("is_available",!0).gt("stock_quantity",0).order("created_at",{ascending:!1});v=O.data,N=O.error}}if(N)return console.error("Error fetching business products:",N),[];const o=(v==null?void 0:v.map(C=>({...C,is_actually_available:C.is_available&&C.stock_quantity>0,stock_info:{has_stock:C.stock_quantity>0,is_low_stock:C.stock_quantity<=5&&C.stock_quantity>0,is_last_units:C.stock_quantity<=3&&C.stock_quantity>0,count:C.stock_quantity}})))||[];return console.log("üì¶ Productos procesados (USANDO COLUMNA REAL):",{total:o.length,available:o.filter(C=>C.is_actually_available).length,with_stock:o.filter(C=>C.stock_info.has_stock).length,low_stock:o.filter(C=>C.stock_info.is_low_stock).length,products_sample:o.slice(0,3).map(C=>({name:C.name,is_available:C.is_available,stock_quantity:C.stock_quantity,is_actually_available:C.is_actually_available}))}),o}catch(t){return console.error("Error fetching business products:",t),[]}},w=async y=>{var j,I;try{const t=new Date,k=new Date(t);k.setHours(23,59,59,999);let{data:i,error:a}=await R.from("daily_products").select(`
          *,
          seller:sellers(
            id,
            business_name,
            logo_url,
            is_verified,
            user:users(name, avatar_url)
          )
        `).eq("seller_id",y).gt("stock_quantity",0).gte("expires_at",new Date().toISOString()).lte("expires_at",k.toISOString()).order("created_at",{ascending:!1});if(a){const u=a==null?void 0:a.code;if(u==="PGRST205")return console.log("daily_products table does not exist yet"),[];const v=((I=(j=a==null?void 0:a.message)==null?void 0:j.toLowerCase)==null?void 0:I.call(j))||"";if(u==="PGRST200"||u==="42P01"||u==="42703"||v.includes("relationship")||v.includes("column")||v.includes("relation")){const o=await R.from("daily_products").select("*").eq("seller_id",y).gt("stock_quantity",0).gte("expires_at",new Date().toISOString()).lte("expires_at",k.toISOString()).order("created_at",{ascending:!1});i=o.data,a=o.error}}return a?(console.error("Error fetching business daily products:",a),[]):i||[]}catch(t){return console.error("Error fetching business daily products:",t),[]}},q=async y=>{try{const{data:j,error:I}=await R.from("sellers").select(`
          id,
          business_name,
          business_description,
          business_address,
          business_phone,
          phone,
          address,
          business_logo,
          cover_image_url,
          logo_url,
          is_verified,
          rating_avg
        `).eq("id",y).single();if(I)return console.error("Error fetching business:",I),null;const{data:t,error:k}=await R.from("users").select("name, phone, email, address, avatar_url").eq("id",y).single();k&&console.error("Error fetching user data:",k);const{count:i}=await R.from("products").select("*",{count:"exact",head:!0}).eq("seller_id",y).eq("is_public",!0);let a=0;try{const{data:F,error:b}=await R.from("seller_ratings_view").select("average_rating").eq("seller_id",y).single();!b&&F&&(a=F.average_rating||0)}catch(F){console.error("Error fetching business rating:",F)}const u={...j,user:t||null,products_count:i||0,rating:a};console.log("üî• COMBINED DATA DEBUG:",{seller_data:{phone:j.phone,address:j.address,business_phone:j.business_phone,business_address:j.business_address},user_data:t,combined_user:u.user});const v=(j==null?void 0:j.cover_image_url)||(j==null?void 0:j.business_logo)||(j==null?void 0:j.logo_url),N=(j==null?void 0:j.business_logo)||(j==null?void 0:j.logo_url),o=Ts({logo_url:N??void 0,user:j!=null&&j.user?{avatar_url:j.user.avatar_url}:void 0});console.log("üî• getBusinessById DATA:",{id:j==null?void 0:j.id,name:j==null?void 0:j.business_name,cover_image_url:j==null?void 0:j.cover_image_url,business_logo:j==null?void 0:j.business_logo,logo_url:j==null?void 0:j.logo_url,final_cover:v,final_logo:N});const C=j;return{id:u.id,business_name:u.business_name,business_description:u.business_description??void 0,business_address:u.business_address??void 0,business_phone:u.business_phone??void 0,logo_url:N??void 0,cover_image_url:v??void 0,is_verified:u.is_verified,products_count:u.products_count,rating:u.rating,phone:u.phone,address:u.address,user:u.user?{name:u.user.name,phone:u.user.phone,email:u.user.email,address:u.user.address,avatar_url:u.user.avatar_url}:void 0,cover_image:v??void 0,category:"General",is_open_now:!0}}catch(j){return console.error("Error fetching business by ID:",j),null}},f=async y=>{await Promise.all([_({search:y})])},E=async(y=8)=>{try{const{data:j,error:I}=await R.from("products").select(`
          *,
          seller:sellers(
            id,
            business_name,
            logo_url,
            is_verified,
            user:users(name, avatar_url)
          )
        `).eq("is_public",!0).gt("stock_quantity",0).order("created_at",{ascending:!1}).limit(y);return I?(console.error("Error fetching featured products:",I),[]):j||[]}catch(j){return console.error("Error fetching featured products:",j),[]}},z=y=>{const j=new Date,t=new Date(y).getTime()-j.getTime();if(t<=0)return"Expirado";const k=Math.floor(t/(1e3*60*60)),i=Math.floor(t%(1e3*60*60)/(1e3*60));return k>0?`${k}h ${i}m restantes`:`${i}m restantes`};x.useEffect(()=>{_(),D(),l();const y=setInterval(()=>{g?(console.log("üî• Actualizando productos del d√≠a autom√°ticamente..."),D()):console.log("‚è∏Ô∏è App en background - pausando actualizaci√≥n de productos del d√≠a")},5*60*1e3),j=setInterval(()=>{g?(console.log("üîÑ Actualizando productos autom√°ticamente (stock en tiempo real)..."),_()):console.log("‚è∏Ô∏è App en background - pausando actualizaci√≥n de productos")},30*1e3),I=setInterval(()=>{g?(console.log("üè™ Actualizando negocios autom√°ticamente..."),l()):console.log("‚è∏Ô∏è App en background - pausando actualizaci√≥n de negocios")},10*60*1e3);return()=>{clearInterval(y),clearInterval(j),clearInterval(I)}},[g]),x.useEffect(()=>{g&&(console.log("üì± App volvi√≥ a primer plano - refrescando datos..."),_(),D())},[g]),x.useEffect(()=>{const y=j=>{console.log("üö® Stock actualizado - refrescando datos:",j.detail),M(),D()};return window.addEventListener("stockUpdated",y),()=>{window.removeEventListener("stockUpdated",y)}},[]);const G=async()=>{console.log("üîÑ Refrescando todos los datos manualmente..."),await Promise.all([_(),D(),l()])},M=async()=>{console.log("üé≤ Mezclando productos para mostrar nuevos...");try{d(a=>({...a,products:!0,dailyProducts:!0}));const{data:y,error:j}=await R.from("products").select("*").eq("is_public",!0).gt("stock_quantity",0).order("created_at",{ascending:!1});if(j)console.error("‚ùå Error al obtener productos:",j);else{const a=y?[...y].sort(()=>Math.random()-.5):[];console.log("‚úÖ Productos mezclados:",(a==null?void 0:a.length)||0),r(a||[])}const I=new Date,t=new Date(I);t.setHours(23,59,59,999);const{data:k,error:i}=await R.from("daily_products").select("*").gt("stock_quantity",0).gte("expires_at",new Date().toISOString()).lte("expires_at",t.toISOString()).order("created_at",{ascending:!1});if(i&&i.code!=="PGRST205")console.error("‚ùå Error al obtener productos del d√≠a:",i);else{const u=(k?[...k].sort(()=>Math.random()-.5):[]).filter((v,N,o)=>N===o.findIndex(C=>C.name===v.name));console.log("‚úÖ Productos del d√≠a mezclados:",(u==null?void 0:u.length)||0),h(u)}}catch(y){console.error("‚ùå Error cr√≠tico al mezclar productos:",y)}finally{d(y=>({...y,products:!1,dailyProducts:!1}))}console.log("‚úÖ Productos nuevos listos para descubrir")};return{products:s,dailyProducts:n,businesses:m,loading:p,isPageVisible:g,fetchProducts:_,fetchDailyProducts:D,fetchBusinesses:l,refreshAllData:G,refreshProductStock:M,getBusinessProducts:T,getBusinessDailyProducts:w,getBusinessById:q,searchAll:f,getFeaturedProducts:E,getTimeRemaining:z}}function hs({onCartClick:s}){const{items:r,getCartItemCount:n,getCartTotal:h}=Te(),m=n(),c=h();return m===0?null:e.jsx("div",{className:"fixed bottom-4 right-4 z-50",children:e.jsxs(L,{onClick:()=>{console.log("FloatingCart clicked!"),s?s():alert(`Carrito: ${m} productos - Q${c.toFixed(2)}`)},className:"relative h-16 w-16 rounded-full bg-orange-500 hover:bg-orange-600 shadow-xl",children:[e.jsx(we,{className:"w-6 h-6 text-white"}),e.jsx(Z,{className:"absolute -top-2 -right-2 h-6 w-6 rounded-full bg-red-500 text-white text-xs font-bold flex items-center justify-center",children:m})]})})}function kr({viewMode:s,setViewMode:r,onRefreshStock:n,onRefreshAll:h,isLoading:m,isRefreshing:c,lastUpdated:p,searchQuery:d,selectedCategory:g}){return e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-800",children:"Explorar Productos"}),e.jsxs("div",{className:"flex items-center gap-4 text-sm text-gray-500 mt-1",children:[e.jsxs("span",{children:["Actualizado: ",p.toLocaleTimeString()]}),(d||g!=="all")&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ze,{className:"w-3 h-3"}),e.jsxs("span",{className:"text-orange-600 font-medium",children:[d&&`"${d}"`,d&&g!=="all"&&" ‚Ä¢ ",g!=="all"&&g]})]})]})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs(L,{onClick:n,disabled:c,size:"sm",variant:"outline",className:"gap-2 border-green-300 text-green-600 hover:bg-green-50 bg-green-50",children:[e.jsx(qe,{className:`w-4 h-4 ${c?"animate-spin":""}`}),"Descubrir"]})})]})})}function Sr({searchQuery:s,setSearchQuery:r,selectedCategory:n,setSelectedCategory:h,categories:m,onSearch:c,isLoading:p}){const[d,g]=x.useState(!1),_=x.useRef(null);x.useEffect(()=>{d&&_.current&&_.current.focus()},[d]),x.useEffect(()=>{const T=w=>{w.key==="Escape"&&d&&g(!1)};return document.addEventListener("keydown",T),()=>document.removeEventListener("keydown",T)},[d]);const D=()=>{c(),g(!1)},l=()=>{r(""),h("all"),g(!1)};return e.jsxs(e.Fragment,{children:[d&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-20 backdrop-blur-sm z-40",onClick:()=>g(!1)}),!d&&e.jsx(L,{onClick:()=>g(!0),className:"fixed bottom-24 right-4 z-50 w-14 h-14 rounded-full bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 shadow-lg hover:shadow-xl transition-all duration-300 border-2 border-white",size:"sm",children:e.jsx(ze,{className:"w-6 h-6 text-white"})}),d&&e.jsx("div",{className:"fixed bottom-24 left-4 right-4 z-50 max-w-md mx-auto",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl border border-gray-200 p-4 space-y-4 animate-in slide-in-from-bottom-2 duration-300",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ze,{className:"w-5 h-5 text-orange-500"}),e.jsx("span",{className:"font-semibold text-gray-800",children:"Buscar productos"})]}),e.jsx(L,{variant:"ghost",size:"sm",onClick:()=>g(!1),className:"h-8 w-8 p-0 hover:bg-gray-100",children:e.jsx(Ge,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"relative",children:[e.jsx(ze,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"}),e.jsx(be,{ref:_,placeholder:"¬øQu√© est√°s buscando?",value:s,onChange:T=>r(T.target.value),className:"pl-10 h-12 border-gray-200 focus:border-orange-300 focus:ring-orange-200",onKeyPress:T=>{T.key==="Enter"&&D()}})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(xr,{className:"w-4 h-4 text-gray-500"}),e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Categor√≠a"})]}),e.jsxs(Aa,{value:n,onValueChange:h,children:[e.jsx($a,{className:"h-10 border-gray-200",children:e.jsx(Fa,{placeholder:"Todas las categor√≠as"})}),e.jsxs(za,{children:[e.jsx(ws,{value:"all",children:"Todas las categor√≠as"}),m.map(T=>e.jsx(ws,{value:T,children:T},T))]})]})]}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx(L,{variant:"outline",onClick:l,className:"flex-1 h-10",disabled:p,children:"Limpiar"}),e.jsx(L,{onClick:D,disabled:p,className:"flex-1 h-10 bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700",children:p?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"}),"Buscando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ze,{className:"w-4 h-4 mr-2"}),"Buscar"]})})]}),(s||n!=="all")&&e.jsx("div",{className:"pt-2 border-t border-gray-100",children:e.jsxs("div",{className:"flex flex-wrap gap-2",children:[s&&e.jsxs("div",{className:"inline-flex items-center gap-1 px-2 py-1 bg-orange-100 text-orange-700 rounded-full text-xs",children:[e.jsxs("span",{children:['"',s,'"']}),e.jsx("button",{onClick:()=>r(""),className:"hover:text-orange-900",children:e.jsx(Ge,{className:"w-3 h-3"})})]}),n!=="all"&&e.jsxs("div",{className:"inline-flex items-center gap-1 px-2 py-1 bg-blue-100 text-blue-700 rounded-full text-xs",children:[e.jsx("span",{children:n}),e.jsx("button",{onClick:()=>h("all"),className:"hover:text-blue-900",children:e.jsx(Ge,{className:"w-3 h-3"})})]})]})})]})})]})}function Cr(s,r="regular"){const[n,h]=x.useState({stock_quantity:0,sold_quantity:0,available_stock:0,loading:!0,error:null});return x.useEffect(()=>{if(!s)return;const m=async()=>{try{if(h(p=>({...p,loading:!0,error:null})),r==="daily"){const{data:p,error:d}=await R.from("daily_products").select("stock_quantity").eq("id",s).single();if(d)throw d;const{data:g,error:_}=await R.from("order_items").select(`
              quantity,
              orders!inner (
                status
              )
            `).eq("product_id",s).eq("product_type","daily").in("orders.status",["confirmed","preparing","ready","out_for_delivery","delivered"]);_&&console.warn("Error fetching sold quantity:",_);const D=(g==null?void 0:g.reduce((w,q)=>w+(q.quantity||0),0))||0,l=p.stock_quantity||0,T=Math.max(0,l-D);h({stock_quantity:l,sold_quantity:D,available_stock:T,loading:!1,error:null})}else{const{data:p,error:d}=await R.from("products").select("stock_quantity").eq("id",s).single();if(d)throw d;const g=p.stock_quantity||0;h({stock_quantity:g,sold_quantity:0,available_stock:g,loading:!1,error:null})}}catch(p){console.error("Error fetching real-time stock:",p),h(d=>({...d,loading:!1,error:p.message||"Error loading stock"}))}};m();const c=setInterval(m,3e4);return()=>clearInterval(c)},[s,r]),n}function Er(s){const[r,n]=x.useState({average_rating:0,total_reviews:0,loading:!0});return x.useEffect(()=>{if(!s)return;(async()=>{try{const{data:m,error:c}=await R.from("seller_ratings_view").select("average_rating, total_reviews").eq("seller_id",s).single();if(c){console.warn("No rating found for seller:",s),n({average_rating:0,total_reviews:0,loading:!1});return}n({average_rating:m.average_rating||0,total_reviews:m.total_reviews||0,loading:!1})}catch(m){console.error("Error fetching seller rating:",m),n({average_rating:0,total_reviews:0,loading:!1})}})()},[s]),r}function Tr(s){const[r,n]=x.useState({hours:0,minutes:0,isExpired:!0,formattedTime:"Expirado"});return x.useEffect(()=>{if(!s)return;const h=()=>{const c=Ia(s);n({hours:c.hours,minutes:c.minutes,isExpired:c.isExpired,formattedTime:c.isExpired?"Expirado":c.hours>0?`${c.hours}h ${c.minutes}m restantes`:`${c.minutes}m restantes`})};h();const m=setInterval(h,6e4);return()=>clearInterval(m)},[s]),r}function ds({product:s,viewMode:r,cartQuantity:n,onAddToCart:h,onUpdateQuantity:m,onImageClick:c,onBusinessClick:p,addingToCart:d,editingQuantity:g,tempQuantity:_,onQuantityClick:D,onQuantityChange:l,onQuantitySubmit:T,onQuantityKeyDown:w}){var N,o,C;const[q,f]=x.useState(!1),E="expires_at"in s,z=s.image_url||"",G=((N=s.seller)==null?void 0:N.name)||"Tienda",{available_stock:M,stock_quantity:y,sold_quantity:j,loading:I}=Cr(s.id,E?"daily":"regular"),{average_rating:t,total_reviews:k,loading:i}=Er(s.seller_id||""),a=Tr(E&&"expires_at"in s?s.expires_at:void 0),u=I?s.stock_quantity||0:M,v=()=>{f(!q)};return r==="list"?e.jsx(Q,{className:"mb-4 overflow-hidden hover:shadow-lg transition-all duration-200 border-gray-200",children:e.jsx(H,{className:"p-0",children:e.jsxs("div",{className:"flex",children:[e.jsxs("div",{className:"w-32 h-32 flex-shrink-0 relative",children:[e.jsx(ye,{src:z,alt:s.name,className:"w-full h-full object-cover cursor-pointer",onClick:()=>z&&c(z)}),E&&e.jsx(Z,{className:"absolute top-2 left-2 bg-red-500 text-white text-xs",children:"Del d√≠a"}),e.jsx(L,{size:"sm",variant:"ghost",className:"absolute top-2 right-2 h-8 w-8 p-0 bg-white/80 hover:bg-white",onClick:v,children:e.jsx(Ye,{className:`w-4 h-4 ${q?"fill-red-500 text-red-500":"text-gray-600"}`})})]}),e.jsxs("div",{className:"flex-1 p-4 flex flex-col justify-between",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-start justify-between mb-2",children:[e.jsx("h3",{className:"font-semibold text-lg text-gray-800 line-clamp-1",children:s.name}),e.jsx("div",{className:"text-right",children:e.jsxs("div",{className:"text-xl font-bold text-green-600",children:["Q",(o=s.price)==null?void 0:o.toFixed(2)]})})]}),e.jsx("p",{className:"text-sm text-gray-600 mb-3 line-clamp-2",children:s.description}),e.jsxs("div",{className:"flex items-center gap-4 text-xs text-gray-500 mb-3",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(de,{className:"w-3 h-3"}),e.jsx("button",{onClick:()=>p(s.seller_id),className:"hover:text-orange-600 hover:underline",children:G})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(le,{className:"w-3 h-3 fill-yellow-400 text-yellow-400"}),i?e.jsx("span",{className:"animate-pulse bg-gray-200 w-6 h-3 rounded"}):e.jsxs("span",{className:"font-medium",children:[t>0?t.toFixed(1):"0.0",k>0&&e.jsxs("span",{className:"text-gray-400 ml-1",children:["(",k,")"]})]})]}),E&&!a.isExpired&&e.jsxs("div",{className:"flex items-center gap-1 text-orange-600 font-medium",children:[e.jsx(Ie,{className:"w-3 h-3"}),e.jsx("span",{children:"Termina hoy"})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Oe,{className:"w-3 h-3"}),e.jsx("span",{children:"2.1 km"})]})]}),E&&!a.isExpired&&e.jsxs("div",{className:"flex items-center gap-2 text-xs text-orange-600 bg-orange-50 px-2 py-1 rounded-md mb-3",children:[e.jsx(me,{className:"w-3 h-3"}),e.jsx("span",{className:"font-medium",children:a.formattedTime})]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"flex items-center gap-1",children:u>0?e.jsxs(Z,{variant:"outline",className:"text-green-600 border-green-300",children:[e.jsx(xe,{className:"w-3 h-3 mr-1"}),I?e.jsx("span",{className:"animate-pulse",children:"Cargando..."}):e.jsxs(e.Fragment,{children:["Stock: ",u,E&&j>0&&e.jsxs("span",{className:"text-gray-500 ml-1",children:["(",y-j,"/",y,")"]})]})]}):e.jsxs(Z,{variant:"outline",className:"text-red-600 border-red-300",children:[e.jsx(De,{className:"w-3 h-3 mr-1"}),"Agotado"]})}),e.jsx("div",{className:"flex items-center gap-2",children:n>0?e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(L,{size:"sm",variant:"outline",onClick:()=>m(s.id,n-1),className:"h-8 w-8 p-0",children:e.jsx(We,{className:"w-3 h-3"})}),g?e.jsx(be,{type:"number",value:_,onChange:F=>l(F.target.value),onBlur:()=>T(s.id),onKeyDown:F=>w(F,s.id),className:"w-16 h-8 text-center text-sm",autoFocus:!0}):e.jsx("button",{onClick:()=>D(s.id,n),className:"w-16 h-8 text-sm font-medium bg-gray-100 rounded border hover:bg-gray-200",children:n}),e.jsx(L,{size:"sm",variant:"outline",onClick:()=>m(s.id,n+1),className:"h-8 w-8 p-0",disabled:n>=u,children:e.jsx(Se,{className:"w-3 h-3"})})]}):e.jsxs(L,{size:"sm",onClick:()=>h(s.id,E,s.name),disabled:d||u<=0,className:"bg-gradient-to-r from-orange-500 to-green-500 hover:from-orange-600 hover:to-green-600 text-white",children:[e.jsx(Se,{className:"w-3 h-3 mr-1"}),"Agregar"]})})]})]})]})})}):e.jsx(Q,{className:"overflow-hidden hover:shadow-lg transition-all duration-200 border-gray-200 h-full",children:e.jsxs(H,{className:"p-0",children:[e.jsxs("div",{className:"relative aspect-square",children:[e.jsx(ye,{src:z,alt:s.name,className:"w-full h-full object-cover cursor-pointer",onClick:()=>z&&c(z)}),e.jsxs("div",{className:"absolute top-2 left-2 flex flex-col gap-1",children:[E&&e.jsx(Z,{className:"bg-red-500 text-white text-xs",children:"Del d√≠a"}),u<=5&&u>0&&e.jsxs(Z,{variant:"outline",className:"bg-yellow-500 text-white text-xs border-yellow-500",children:["√öltimos ",u]})]}),e.jsx(L,{size:"sm",variant:"ghost",className:"absolute top-2 right-2 h-8 w-8 p-0 bg-white/80 hover:bg-white",onClick:v,children:e.jsx(Ye,{className:`w-4 h-4 ${q?"fill-red-500 text-red-500":"text-gray-600"}`})}),e.jsx("div",{className:"absolute bottom-2 left-2",children:u>0?e.jsxs(Z,{variant:"outline",className:"bg-white text-green-600 border-green-300 text-xs",children:[e.jsx(xe,{className:"w-3 h-3 mr-1"}),I?"...":u,E&&j>0&&e.jsxs("span",{className:"text-gray-500 ml-1",children:["/",y]})]}):e.jsxs(Z,{variant:"outline",className:"bg-white text-red-600 border-red-300 text-xs",children:[e.jsx(De,{className:"w-3 h-3 mr-1"}),"Agotado"]})}),E&&!a.isExpired&&e.jsx("div",{className:"absolute top-2 left-2",children:e.jsxs(Z,{className:"bg-orange-500 text-white text-xs font-semibold",children:[e.jsx(Ie,{className:"w-3 h-3 mr-1"}),"Del D√≠a"]})})]}),e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"mb-3",children:[e.jsx("h3",{className:"font-semibold text-base text-gray-800 line-clamp-2 mb-1",children:s.name}),e.jsx("p",{className:"text-sm text-gray-600 line-clamp-2 mb-2",children:s.description}),e.jsxs("div",{className:"flex items-center justify-between text-xs text-gray-500 mb-2",children:[e.jsxs("button",{onClick:()=>p(s.seller_id),className:"flex items-center gap-1 hover:text-orange-600 hover:underline",children:[e.jsx(de,{className:"w-3 h-3"}),G]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(le,{className:"w-3 h-3 fill-yellow-400 text-yellow-400"}),i?e.jsx("span",{className:"animate-pulse bg-gray-200 w-6 h-3 rounded"}):e.jsxs("span",{children:[t>0?t.toFixed(1):"0.0",k>0&&e.jsxs("span",{className:"text-gray-400 ml-1",children:["(",k,")"]})]})]})]}),E&&!a.isExpired&&e.jsxs("div",{className:"flex items-center gap-1 text-xs text-orange-600 bg-orange-50 px-2 py-1 rounded-md mb-2",children:[e.jsx(me,{className:"w-3 h-3"}),e.jsx("span",{className:"font-medium",children:a.formattedTime})]}),e.jsxs("div",{className:"text-xl font-bold text-green-600 mb-3",children:["Q",(C=s.price)==null?void 0:C.toFixed(2)]})]}),e.jsx("div",{className:"space-y-2",children:n>0?e.jsxs("div",{className:"flex items-center justify-center gap-1",children:[e.jsx(L,{size:"sm",variant:"outline",onClick:()=>m(s.id,n-1),className:"h-8 w-8 p-0",children:e.jsx(We,{className:"w-3 h-3"})}),g?e.jsx(be,{type:"number",value:_,onChange:F=>l(F.target.value),onBlur:()=>T(s.id),onKeyDown:F=>w(F,s.id),className:"w-16 h-8 text-center text-sm",autoFocus:!0}):e.jsx("button",{onClick:()=>D(s.id,n),className:"w-16 h-8 text-sm font-medium bg-gray-100 rounded border hover:bg-gray-200",children:n}),e.jsx(L,{size:"sm",variant:"outline",onClick:()=>m(s.id,n+1),className:"h-8 w-8 p-0",disabled:n>=u,children:e.jsx(Se,{className:"w-3 h-3"})})]}):e.jsxs(L,{onClick:()=>h(s.id,E,s.name),disabled:d||u<=0,className:"w-full bg-gradient-to-r from-orange-500 to-green-500 hover:from-orange-600 hover:to-green-600 text-white",children:[e.jsx(Se,{className:"w-4 h-4 mr-2"}),"Agregar al carrito"]})})]})]})})}function Pr({products:s,viewMode:r,cartItems:n,onAddToCart:h,onUpdateQuantity:m,onImageClick:c,onBusinessClick:p,addingToCart:d,editingQuantity:g,tempQuantity:_,onQuantityClick:D,onQuantityChange:l,onQuantitySubmit:T,onQuantityKeyDown:w,loading:q=!1}){const f=E=>{const z=n.find(G=>G.product_id===E);return(z==null?void 0:z.quantity)||0};return q?e.jsx("div",{className:"space-y-6",children:e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6",children:[...Array(8)].map((E,z)=>e.jsxs("div",{className:"animate-pulse",children:[e.jsx("div",{className:"bg-gray-200 aspect-square rounded-lg mb-4"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"h-4 bg-gray-200 rounded w-3/4"}),e.jsx("div",{className:"h-3 bg-gray-200 rounded w-1/2"}),e.jsx("div",{className:"h-6 bg-gray-200 rounded w-1/4"})]})]},z))})}):!s||s.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"text-gray-400 mb-4",children:e.jsx("svg",{className:"mx-auto h-12 w-12",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2 2v-5m16 0h-2M4 13h2m13-8l-8 8-4-4"})})}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"No se encontraron productos"}),e.jsx("p",{className:"text-gray-500",children:"Intenta cambiar los filtros de b√∫squeda o revisa m√°s tarde."})]}):e.jsxs("div",{className:"space-y-6",children:[r==="grid"?e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6",children:s.map(E=>e.jsx(ds,{product:E,viewMode:r,cartQuantity:f(E.id),onAddToCart:h,onUpdateQuantity:m,onImageClick:c,onBusinessClick:p,addingToCart:d===E.id,editingQuantity:g===E.id,tempQuantity:_,onQuantityClick:D,onQuantityChange:l,onQuantitySubmit:T,onQuantityKeyDown:w},E.id))}):e.jsx("div",{className:"space-y-4",children:s.map(E=>e.jsx(ds,{product:E,viewMode:r,cartQuantity:f(E.id),onAddToCart:h,onUpdateQuantity:m,onImageClick:c,onBusinessClick:p,addingToCart:d===E.id,editingQuantity:g===E.id,tempQuantity:_,onQuantityClick:D,onQuantityChange:l,onQuantitySubmit:T,onQuantityKeyDown:w},E.id))}),s.length>0&&s.length%20===0&&e.jsx("div",{className:"text-center pt-8",children:e.jsx("button",{className:"px-6 py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 font-medium",children:"Cargar m√°s productos"})})]})}function Ir({dailyProducts:s,cartItems:r,onAddToCart:n,onUpdateQuantity:h,onImageClick:m,onBusinessClick:c,addingToCart:p,editingQuantity:d,tempQuantity:g,onQuantityClick:_,onQuantityChange:D,onQuantitySubmit:l,onQuantityKeyDown:T,loading:w=!1}){const q=f=>{const E=r.find(z=>z.product_id===f);return(E==null?void 0:E.quantity)||0};return w?e.jsxs(Q,{className:"border-red-200 shadow-lg",children:[e.jsx(ee,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(se,{className:"flex items-center gap-2 text-red-600",children:[e.jsx(Ie,{className:"w-6 h-6"}),"Productos del D√≠a"]}),e.jsx("div",{className:"animate-pulse",children:e.jsx("div",{className:"h-4 bg-gray-200 rounded w-20"})})]})}),e.jsx(H,{children:e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4",children:[...Array(3)].map((f,E)=>e.jsxs("div",{className:"animate-pulse",children:[e.jsx("div",{className:"bg-gray-200 aspect-square rounded-lg mb-3"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"h-4 bg-gray-200 rounded w-3/4"}),e.jsx("div",{className:"h-3 bg-gray-200 rounded w-1/2"})]})]},E))})})]}):!s||s.length===0?e.jsxs(Q,{className:"border-red-200 shadow-lg",children:[e.jsx(ee,{children:e.jsxs(se,{className:"flex items-center gap-2 text-red-600",children:[e.jsx(Ie,{className:"w-6 h-6"}),"Productos del D√≠a"]})}),e.jsx(H,{children:e.jsxs("div",{className:"text-center py-8",children:[e.jsx(me,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-500",children:"No hay productos del d√≠a disponibles en este momento."}),e.jsx("p",{className:"text-sm text-gray-400 mt-2",children:"¬°Vuelve ma√±ana para ver las nuevas ofertas!"})]})})]}):e.jsxs(Q,{className:"border-red-200 shadow-lg",children:[e.jsxs(ee,{children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(se,{className:"flex items-center gap-2 text-red-600",children:[e.jsx(Ie,{className:"w-6 h-6"}),"Productos del D√≠a"]}),e.jsxs(Z,{variant:"destructive",className:"animate-pulse",children:[e.jsx(me,{className:"w-3 h-3 mr-1"}),"Oferta especial"]})]}),e.jsx("p",{className:"text-sm text-gray-600",children:"Ofertas especiales disponibles solo por hoy. ¬°No te las pierdas!"})]}),e.jsxs(H,{children:[e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4",children:s.map(f=>e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute top-2 left-2 z-10",children:e.jsxs(Z,{className:"bg-red-500 text-white text-xs font-semibold",children:[e.jsx(Ie,{className:"w-3 h-3 mr-1"}),"Oferta del d√≠a"]})}),e.jsx(ds,{product:f,viewMode:"grid",cartQuantity:q(f.id),onAddToCart:n,onUpdateQuantity:h,onImageClick:m,onBusinessClick:c,addingToCart:p===f.id,editingQuantity:d===f.id,tempQuantity:g,onQuantityClick:_,onQuantityChange:D,onQuantitySubmit:l,onQuantityKeyDown:T})]},f.id))}),s.length>3&&e.jsx("div",{className:"text-center mt-6",children:e.jsx("button",{className:"text-red-600 hover:text-red-700 font-medium text-sm hover:underline",children:"Ver todos los productos del d√≠a ‚Üí"})})]})]})}function Is({onBusinessClick:s,onShowCart:r}){const{user:n}=ke(),{items:h,addToCart:m,updateCartItem:c,removeFromCart:p}=Te(),{products:d,dailyProducts:g,businesses:_,loading:D,refreshProductStock:l,refreshAllData:T}=Ws(),{openImageModal:w}=ms(),[q,f]=x.useState(""),[E,z]=x.useState("all"),[G,M]=x.useState("grid"),[y,j]=x.useState(null),[I,t]=x.useState(!1),[k,i]=x.useState(new Date),[a,u]=x.useState(null),[v,N]=x.useState(""),[o,C]=x.useState([]),F=["Comida","Bebidas","Dulces","Panader√≠a","L√°cteos","Carnes","Verduras","Frutas","Limpieza","Cuidado Personal"],b=async()=>{const B=d.filter(A=>{var fe;const ae=!q||A.name.toLowerCase().includes(q.toLowerCase())||((fe=A.description)==null?void 0:fe.toLowerCase().includes(q.toLowerCase())),re=E==="all"||A.category===E;return ae&&re});C(B)};x.useEffect(()=>{b()},[d,q,E]),x.useEffect(()=>{C(d)},[d]);const O=async(B,A=!1,ae="Producto")=>{if(!n){V.error("Debes iniciar sesi√≥n para agregar productos");return}try{j(B);const re=await m(B,1,A?"daily":"regular");re!=null&&re.success?V.success("Agregado al carrito"):V.error(`‚ùå Error: ${(re==null?void 0:re.message)||"No se pudo agregar el producto"}`)}catch(re){console.error("Error adding to cart:",re),V.error("‚ùå Error al agregar producto al carrito")}finally{j(null)}},P=async(B,A)=>{const ae=h.find(re=>re.product_id===B);ae&&(A<=0?await p(ae.id):await c(ae.id,A))},J=(B,A)=>{u(B),N(A.toString())},ie=B=>{const A=parseInt(B);!isNaN(A)&&A>=0&&N(B)},U=async B=>{const A=parseInt(v);isNaN(A)||await P(B,A),u(null),N("")},X=async(B,A)=>{B.key==="Enter"?await U(A):B.key==="Escape"&&(u(null),N(""))},te=async()=>{if(!I)try{t(!0),await l(),i(new Date),V.success("‚úÖ Productos actualizados - Nuevos productos disponibles")}catch(B){console.error("‚ùå Error en refresco manual:",B),V.error("‚ùå Error al actualizar productos - Intenta de nuevo")}finally{t(!1)}};x.useEffect(()=>{d.length>0&&i(new Date)},[d]);const ge=B=>{s(B)};return e.jsxs("div",{className:"space-y-6",children:[e.jsx(kr,{searchQuery:q,setSearchQuery:f,selectedCategory:E,setSelectedCategory:z,viewMode:G,setViewMode:M,categories:F,onSearch:b,onRefreshStock:te,onRefreshAll:T,isLoading:Object.values(D).some(Boolean),isRefreshing:I,lastUpdated:k}),e.jsxs(es,{defaultValue:"products",className:"w-full",children:[e.jsxs(ss,{className:"grid w-full grid-cols-3",children:[e.jsxs(_e,{value:"products",className:"flex items-center gap-2",children:[e.jsx(He,{className:"w-4 h-4"}),"Productos"]}),e.jsxs(_e,{value:"daily",className:"flex items-center gap-2",children:[e.jsx(le,{className:"w-4 h-4"}),"Del D√≠a"]}),e.jsxs(_e,{value:"businesses",className:"flex items-center gap-2",children:[e.jsx(de,{className:"w-4 h-4"}),"Negocios"]})]}),e.jsx(ve,{value:"products",className:"space-y-6",children:e.jsxs(Q,{className:"border-orange-200 shadow-lg",children:[e.jsx(ee,{children:e.jsxs(se,{className:"flex items-center gap-2",children:[e.jsx(de,{className:"w-5 h-5 text-orange-500"}),"Todos los Productos"]})}),e.jsx(H,{children:e.jsx(Pr,{products:o,viewMode:G,cartItems:h,onAddToCart:O,onUpdateQuantity:P,onImageClick:w,onBusinessClick:ge,addingToCart:y,editingQuantity:a,tempQuantity:v,onQuantityClick:J,onQuantityChange:ie,onQuantitySubmit:U,onQuantityKeyDown:X,loading:D.products})})]})}),e.jsx(ve,{value:"daily",className:"space-y-6",children:e.jsx(Ir,{dailyProducts:g,cartItems:h,onAddToCart:O,onUpdateQuantity:P,onImageClick:w,onBusinessClick:ge,addingToCart:y,editingQuantity:a,tempQuantity:v,onQuantityClick:J,onQuantityChange:ie,onQuantitySubmit:U,onQuantityKeyDown:X,loading:D.dailyProducts})}),e.jsx(ve,{value:"businesses",className:"space-y-6",children:e.jsxs(Q,{className:"border-green-200 shadow-lg",children:[e.jsx(ee,{children:e.jsxs(se,{className:"flex items-center gap-2",children:[e.jsx(de,{className:"w-5 h-5 text-green-500"}),"Negocios Locales"]})}),e.jsx(H,{children:D.businesses?e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:[...Array(6)].map((B,A)=>e.jsxs("div",{className:"animate-pulse",children:[e.jsx("div",{className:"bg-gray-200 h-32 rounded-t-lg mb-4"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"h-4 bg-gray-200 rounded w-3/4"}),e.jsx("div",{className:"h-3 bg-gray-200 rounded w-1/2"})]})]},A))}):_&&_.length>0?e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:_.map(B=>{var re;const A=B.cover_image_url||B.cover_image,ae=B.logo_url;return e.jsxs(Q,{className:"cursor-pointer hover:shadow-xl transition-all duration-300 border-green-200",onClick:()=>ge(B.id),children:[e.jsxs("div",{className:"relative",children:[A?e.jsx(ye,{src:A,alt:`Portada de ${B.business_name}`,className:"w-full h-32 object-cover rounded-t-lg",expandable:!0,onExpand:w}):e.jsx("div",{className:"w-full h-32 bg-gradient-to-r from-orange-400 to-green-400 flex items-center justify-center rounded-t-lg",children:e.jsxs("div",{className:"text-center text-white",children:[e.jsx(de,{className:"w-8 h-8 mx-auto mb-1"}),e.jsx("p",{className:"text-sm font-semibold",children:B.business_name})]})}),B.is_verified&&e.jsxs(Z,{className:"absolute top-2 right-2 bg-blue-500 text-white",children:[e.jsx(Us,{className:"w-3 h-3 mr-1"}),"Verificado"]}),ae&&e.jsx("div",{className:"absolute bottom-2 left-2",children:e.jsx("div",{className:"w-12 h-12 rounded-full bg-white shadow-lg p-1",children:e.jsx(ye,{src:ae,alt:`Logo de ${B.business_name}`,className:"w-full h-full object-cover rounded-full",expandable:!0,onExpand:w})})})]}),e.jsxs(H,{className:"p-4",children:[e.jsx("h3",{className:"font-semibold text-lg mb-1",children:B.business_name}),e.jsx("p",{className:"text-gray-600 text-sm mb-2 line-clamp-2",children:B.business_description||"Comercio local en Gual√°n"}),e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(le,{className:"w-4 h-4 text-yellow-400 fill-current"}),e.jsx("span",{className:"text-sm text-gray-600 ml-1",children:B.rating&&B.rating>0?B.rating.toFixed(1):"Nuevo"})]}),e.jsx(Z,{variant:"outline",children:B.category||"General"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("span",{className:"text-sm text-gray-500 flex items-center",children:[e.jsx(Oe,{className:"w-3 h-3 mr-1"}),B.address||B.business_address||((re=B.user)==null?void 0:re.address)||"Gual√°n, Zacapa"]}),e.jsxs(L,{size:"sm",variant:"outline",children:[e.jsx(xs,{className:"w-3 h-3 mr-1"}),"Ver productos"]})]}),e.jsx("div",{className:"mt-3 pt-3 border-t border-gray-100",children:e.jsxs("span",{className:"text-xs text-gray-500",children:[B.products_count||0," productos disponibles"]})})]})]},B.id)})}):e.jsxs("div",{className:"text-center py-12",children:[e.jsx(de,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"No hay negocios disponibles"}),e.jsx("p",{className:"text-gray-500",children:"Los negocios aparecer√°n aqu√≠ cuando est√©n disponibles."})]})})]})})]}),e.jsx(hs,{onCartClick:()=>{r&&r()}}),e.jsx(Sr,{searchQuery:q,setSearchQuery:f,selectedCategory:E,setSelectedCategory:z,categories:F,onSearch:b,isLoading:D.products||D.dailyProducts||D.businesses})]})}const Os={pending:{label:"Pendiente",color:"bg-yellow-100 text-yellow-800",description:"Esperando confirmaci√≥n del vendedor"},accepted:{label:"Aceptado",color:"bg-blue-100 text-blue-800",description:"El vendedor est√° preparando tu pedido"},ready:{label:"Listo",color:"bg-green-100 text-green-800",description:"Tu pedido est√° listo"},assigned:{label:"Repartidor asignado",color:"bg-purple-100 text-purple-800",description:"Un repartidor fue asignado"},"picked-up":{label:"En camino",color:"bg-orange-100 text-orange-800",description:"El repartidor est√° en camino"},"in-transit":{label:"En tr√°nsito",color:"bg-indigo-100 text-indigo-800",description:"Tu pedido est√° siendo entregado"},delivered:{label:"Entregado",color:"bg-green-100 text-green-800",description:"Tu pedido fue entregado"},completed:{label:"Completado",color:"bg-gray-100 text-gray-800",description:"Pedido completado exitosamente"},cancelled:{label:"Cancelado",color:"bg-red-100 text-red-800",description:"El pedido fue cancelado"},rejected:{label:"Rechazado",color:"bg-red-100 text-red-800",description:"El vendedor rechaz√≥ tu pedido"}},Rs={pickup:{label:"Recoger en tienda",icon:e.jsx(de,{className:"w-4 h-4"}),color:"text-blue-600",description:"Recoge tu pedido en el establecimiento"},"dine-in":{label:"Comer en el lugar",icon:e.jsx(Gs,{className:"w-4 h-4"}),color:"text-purple-600",description:"Tu pedido ser√° servido en tu mesa"},delivery:{label:"Servicio a domicilio",icon:e.jsx(ue,{className:"w-4 h-4"}),color:"text-green-600",description:"Tu pedido ser√° entregado a tu direcci√≥n"}};function Or(s){return Os[s]||Os.pending}function Rr(s){return Rs[s]||Rs.pickup}function Ks(s){return new Date(s).toLocaleTimeString("es-GT",{hour:"2-digit",minute:"2-digit"})}function qr(s){return new Date(s).toLocaleDateString("es-GT")}function Dr(s){return s.status==="delivered"||s.status==="completed"}function Ar(s){switch(s){case"pickup":return"15-25 min";case"dine-in":return"20-30 min";case"delivery":return"30-45 min";default:return"20-30 min"}}function Xs(s){const r=[{key:"pending",label:"Pedido realizado",icon:e.jsx(xe,{className:"w-4 h-4"}),completed:!0,current:s.status==="pending",timestamp:s.created_at},{key:"accepted",label:"Pedido aceptado",icon:e.jsx(oe,{className:"w-4 h-4"}),completed:["accepted","ready","assigned","picked_up","in_transit","delivered","completed"].includes(s.status),current:s.status==="accepted",timestamp:s.accepted_at},{key:"ready",label:s.delivery_type==="pickup"?"Listo para recoger":"Pedido listo",icon:s.delivery_type==="pickup"?e.jsx(de,{className:"w-4 h-4"}):e.jsx(oe,{className:"w-4 h-4"}),completed:["ready","assigned","picked_up","in_transit","delivered","completed"].includes(s.status),current:s.status==="ready",timestamp:s.ready_at}];return s.delivery_type==="delivery"&&r.push({key:"assigned",label:"Repartidor asignado",icon:e.jsx(ue,{className:"w-4 h-4"}),completed:["assigned","picked_up","in_transit","delivered","completed"].includes(s.status),current:s.status==="assigned",timestamp:s.status==="assigned"?s.updated_at:void 0},{key:"picked_up",label:"Pedido recogido",icon:e.jsx(xe,{className:"w-4 h-4"}),completed:["picked_up","in_transit","delivered","completed"].includes(s.status),current:s.status==="picked_up",timestamp:s.picked_up_at},{key:"in_transit",label:"En camino",icon:e.jsx(ue,{className:"w-4 h-4"}),completed:["in_transit","delivered","completed"].includes(s.status),current:s.status==="in_transit",timestamp:s.status==="in_transit"?s.updated_at:void 0}),r.push({key:"delivered",label:s.delivery_type==="pickup"?"Recogido":"Entregado",icon:e.jsx(oe,{className:"w-4 h-4"}),completed:["delivered","completed"].includes(s.status),current:s.status==="delivered",timestamp:s.delivered_at}),r}function $r(s){const r=s.filter(n=>n.completed).length;return Math.round(r/s.length*100)}function Fr({order:s}){const r=Or(s.status),n=Rr(s.delivery_type),h=Xs(s),m=$r(h);return e.jsxs(Q,{children:[e.jsx(ee,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(se,{className:"flex items-center gap-2",children:[n.icon,"Estado del Pedido"]}),e.jsx(Z,{variant:r.color,children:r.label})]})}),e.jsxs(H,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm font-medium",children:"Progreso"}),e.jsxs("span",{className:"text-sm text-gray-600",children:[m,"%"]})]}),e.jsx(zs,{value:m,className:"h-3"})]}),e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[n.icon,e.jsx("span",{className:"font-medium",children:n.label})]}),e.jsx("p",{className:"text-sm text-gray-600",children:n.description}),s.estimated_time&&e.jsxs("div",{className:"flex items-center gap-2 mt-2 text-sm text-gray-600",children:[e.jsx(me,{className:"w-4 h-4"}),e.jsxs("span",{children:["Tiempo estimado: ",Ar(s.delivery_type)]})]})]}),(s.status==="rejected"||s.status==="cancelled")&&s.rejection_reason&&e.jsxs("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(Ee,{className:"w-4 h-4 text-red-600"}),e.jsx("span",{className:"font-medium text-red-800",children:s.status==="rejected"?"Raz√≥n del rechazo":"Raz√≥n de cancelaci√≥n"})]}),e.jsx("p",{className:"text-sm text-red-700",children:s.rejection_reason})]})]})]})}function zr({order:s}){const r=Xs(s);return e.jsxs(Q,{children:[e.jsx(ee,{children:e.jsx(se,{children:"Seguimiento del Pedido"})}),e.jsx(H,{children:e.jsx("div",{className:"space-y-4",children:r.map((n,h)=>e.jsxs("div",{className:"relative flex gap-4",children:[e.jsx("div",{className:`flex-shrink-0 w-8 h-8 rounded-full border-2 flex items-center justify-center ${n.completed?"bg-green-500 border-green-500 text-white":n.current?"bg-orange-500 border-orange-500 text-white animate-pulse":"border-gray-300 text-gray-400"}`,children:n.icon}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:`font-medium ${n.completed?"text-green-700":n.current?"text-orange-700":"text-gray-500"}`,children:n.label}),n.timestamp&&e.jsx("div",{className:"text-sm text-gray-600",children:Ks(n.timestamp)})]}),h<r.length-1&&e.jsx("div",{className:`absolute left-4 mt-8 w-0.5 h-4 ${n.completed?"bg-green-500":"bg-gray-300"}`,style:{marginLeft:"15px"}})]},n.key))})})]})}function Mr({orderId:s,type:r,onClose:n,onRatingSubmitted:h}){const{rateOrder:m}=gs(),[c,p]=x.useState(0),[d,g]=x.useState(0),[_,D]=x.useState(""),[l,T]=x.useState(!1),[w,q]=x.useState(null),[f,E]=x.useState(!1),z=async()=>{if(c===0){q("Por favor selecciona una calificaci√≥n");return}T(!0),q(null);try{const I=await m(s,c,r,_.trim()||void 0);I.success?(E(!0),setTimeout(()=>{h()},1500)):q(I.message)}catch(I){console.error("Error submitting rating:",I),q("Error inesperado al enviar la calificaci√≥n")}finally{T(!1)}},G=I=>{switch(I){case 1:return"Muy malo";case 2:return"Malo";case 3:return"Regular";case 4:return"Bueno";case 5:return"Excelente";default:return"Selecciona una calificaci√≥n"}},M=()=>r==="seller"?e.jsx(de,{className:"w-6 h-6"}):e.jsx(ue,{className:"w-6 h-6"}),y=()=>r==="seller"?"Calificar Vendedor":"Calificar Repartidor",j=()=>r==="seller"?"¬øC√≥mo fue tu experiencia con el vendedor y la calidad de los productos?":"¬øC√≥mo fue la experiencia con el servicio de entrega?";return f?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:e.jsx(Q,{className:"w-full max-w-md bg-white",children:e.jsxs(H,{className:"p-8 text-center bg-white",children:[e.jsx("div",{className:"bg-green-100 p-4 rounded-full w-16 h-16 mx-auto mb-4",children:e.jsx(oe,{className:"w-8 h-8 text-green-600"})}),e.jsx("h3",{className:"text-lg font-semibold mb-2 text-gray-900",children:"¬°Gracias por tu calificaci√≥n!"}),e.jsx("p",{className:"text-gray-600",children:"Tu opini√≥n nos ayuda a mejorar el servicio"})]})})}):e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:e.jsxs(Q,{className:"w-full max-w-md bg-white border border-gray-200 shadow-xl",children:[e.jsxs(ee,{className:"text-center bg-white",children:[e.jsx("div",{className:"bg-gradient-to-r from-orange-100 to-green-100 p-3 rounded-full w-16 h-16 mx-auto mb-4",children:e.jsx("div",{className:"text-orange-600",children:M()})}),e.jsx(se,{className:"text-gray-900",children:y()}),e.jsx("p",{className:"text-sm text-gray-600 font-normal",children:j()})]}),e.jsxs(H,{className:"space-y-6 bg-white",children:[w&&e.jsx(Ma,{variant:"destructive",children:e.jsx(La,{children:w})}),e.jsxs("div",{className:"text-center space-y-2",children:[e.jsx("div",{className:"flex justify-center gap-2",children:[1,2,3,4,5].map(I=>e.jsx("button",{className:"transition-all duration-200 hover:scale-110",onMouseEnter:()=>g(I),onMouseLeave:()=>g(0),onClick:()=>p(I),disabled:l,children:e.jsx(le,{className:`w-8 h-8 ${I<=(d||c)?"text-yellow-400 fill-current":"text-gray-300"}`})},I))}),e.jsx("p",{className:"text-sm text-gray-600",children:G(d||c)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Comentarios (opcional)"}),e.jsx(Ke,{placeholder:r==="seller"?"Cu√©ntanos sobre la calidad de los productos, el servicio al cliente, etc.":"Cu√©ntanos sobre la puntualidad, el trato, el estado de los productos, etc.",value:_,onChange:I=>D(I.target.value),rows:3,maxLength:500,disabled:l,className:"bg-white border border-gray-300"}),e.jsxs("div",{className:"text-xs text-gray-500 text-right",children:[_.length,"/500"]})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(L,{variant:"outline",onClick:n,disabled:l,className:"flex-1 bg-white border-gray-300 text-gray-700 hover:bg-gray-50",children:"Cancelar"}),e.jsx(L,{onClick:z,disabled:l||c===0,className:"flex-1 bg-gradient-to-r from-orange-500 to-green-500 hover:from-orange-600 hover:to-green-600 text-white",children:l?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent mr-2"}),"Enviando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(le,{className:"w-4 h-4 mr-2"}),"Enviar Calificaci√≥n"]})})]}),e.jsx("p",{className:"text-xs text-gray-500 text-center bg-white",children:"Tu calificaci√≥n ser√° visible para otros usuarios y ayudar√° a mejorar la calidad del servicio"})]})]})})}function Lr({order:s,onOrderUpdate:r}){var p;const[n,h]=x.useState(!1),[m,c]=x.useState("seller");return e.jsxs(e.Fragment,{children:[e.jsxs(Q,{className:"sticky top-4",children:[e.jsx(ee,{children:e.jsx(se,{children:"Resumen del Pedido"})}),e.jsxs(H,{className:"space-y-4",children:[e.jsx("div",{className:"space-y-3",children:(p=s.items)==null?void 0:p.map(d=>e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-12 h-12 rounded-lg overflow-hidden bg-gray-100 flex-shrink-0",children:e.jsx(ye,{src:Hs(d.product_image),alt:d.product_name,className:"w-full h-full object-cover"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"font-medium text-sm truncate",children:d.product_name}),e.jsxs("div",{className:"text-xs text-gray-600",children:[d.quantity," x Q",d.price.toFixed(2)]})]}),e.jsxs("div",{className:"text-sm font-medium",children:["Q",(d.price*d.quantity).toFixed(2)]})]},d.id))}),e.jsx(je,{}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Cliente:"}),e.jsx("span",{children:s.customer_name})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Tel√©fono:"}),e.jsx("span",{children:s.phone_number})]})]}),s.delivery_type==="delivery"&&s.delivery_address&&e.jsxs(e.Fragment,{children:[e.jsx(je,{}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"text-sm font-medium text-gray-700 flex items-center gap-2",children:[e.jsx(Oe,{className:"w-4 h-4"}),"Direcci√≥n de Entrega"]}),e.jsx("p",{className:"text-sm text-gray-600",children:s.delivery_address})]})]}),s.customer_notes&&e.jsxs(e.Fragment,{children:[e.jsx(je,{}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium text-gray-700",children:"Notas especiales:"}),e.jsx("p",{className:"text-sm text-gray-600 bg-gray-50 p-2 rounded",children:s.customer_notes})]})]}),e.jsx(je,{}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Subtotal"}),e.jsxs("span",{children:["Q",s.subtotal.toFixed(2)]})]}),s.delivery_fee>0&&e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Env√≠o"}),e.jsxs("span",{children:["Q",s.delivery_fee.toFixed(2)]})]}),e.jsx(je,{}),e.jsxs("div",{className:"flex justify-between font-semibold",children:[e.jsx("span",{children:"Total"}),e.jsxs("span",{children:["Q",s.total.toFixed(2)]})]})]}),Dr(s)&&e.jsxs(e.Fragment,{children:[e.jsx(je,{}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h4",{className:"font-medium text-sm",children:"Calificar experiencia"}),e.jsxs("div",{className:"space-y-2",children:[!s.seller_rating&&e.jsxs(L,{variant:"outline",size:"sm",className:"w-full justify-start",onClick:()=>{c("seller"),h(!0)},children:[e.jsx(le,{className:"w-4 h-4 mr-2"}),"Calificar Vendedor"]}),s.delivery_type==="delivery"&&s.driver_id&&!s.driver_rating&&e.jsxs(L,{variant:"outline",size:"sm",className:"w-full justify-start",onClick:()=>{c("driver"),h(!0)},children:[e.jsx(le,{className:"w-4 h-4 mr-2"}),"Calificar Repartidor"]})]}),(s.seller_rating||s.driver_rating)&&e.jsxs("div",{className:"space-y-1 text-xs text-gray-600",children:[s.seller_rating&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{children:"Vendedor:"}),e.jsx("div",{className:"flex",children:[...Array(5)].map((d,g)=>e.jsx(le,{className:`w-3 h-3 ${g<s.seller_rating?"text-yellow-400 fill-current":"text-gray-300"}`},g))})]}),s.driver_rating&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{children:"Repartidor:"}),e.jsx("div",{className:"flex",children:[...Array(5)].map((d,g)=>e.jsx(le,{className:`w-3 h-3 ${g<s.driver_rating?"text-yellow-400 fill-current":"text-gray-300"}`},g))})]})]})]})]})]})]}),n&&e.jsx(Mr,{orderId:s.id,type:m,onClose:()=>h(!1),onRatingSubmitted:()=>{h(!1),r==null||r()}})]})}function Zs({orderId:s,onBack:r}){const{getOrderById:n,refreshOrders:h,loading:m}=gs(),[c,p]=x.useState(null),[d,g]=x.useState(!1);x.useEffect(()=>{_()},[s]);const _=async()=>{const l=await n(s);p(l)},D=async()=>{g(!0),await h(),await _(),g(!1)};return m&&!c?e.jsx("div",{className:"max-w-4xl mx-auto p-4",children:e.jsxs("div",{className:"animate-pulse space-y-6",children:[e.jsx("div",{className:"h-8 bg-gray-200 rounded w-1/4"}),e.jsx("div",{className:"h-64 bg-gray-200 rounded"}),e.jsx("div",{className:"h-32 bg-gray-200 rounded"})]})}):c?e.jsxs("div",{className:"max-w-4xl mx-auto p-4 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(L,{variant:"outline",onClick:r,children:"‚Üê Volver"}),e.jsxs("div",{children:[e.jsxs("h1",{className:"text-2xl font-semibold",children:["Orden #",c.id.slice(-8).toUpperCase()]}),e.jsxs("p",{className:"text-gray-600",children:["Realizada el ",qr(c.created_at)," a las ",Ks(c.created_at)]})]})]}),e.jsxs(L,{variant:"outline",onClick:D,disabled:d,size:"sm",children:[e.jsx(qe,{className:`w-4 h-4 mr-2 ${d?"animate-spin":""}`}),d?"Actualizando...":"Actualizar"]})]}),e.jsxs("div",{className:"grid lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[e.jsx(Fr,{order:c}),e.jsx(zr,{order:c})]}),e.jsx("div",{className:"lg:col-span-1",children:e.jsx(Lr,{order:c,onOrderUpdate:_})})]})]}):e.jsxs("div",{className:"max-w-4xl mx-auto p-4 text-center",children:[e.jsx(Ee,{className:"w-16 h-16 mx-auto mb-4 text-gray-400"}),e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Orden no encontrada"}),e.jsx("p",{className:"text-gray-600 mb-4",children:"No se pudo cargar la informaci√≥n de la orden"}),e.jsx(L,{onClick:r,children:"Volver a mis √≥rdenes"})]})}function Br({order:s,isHistory:r=!1,onViewOrder:n,onDeleteOrder:h,onConfirmReceived:m,onReorderFn:c,deletingOrderId:p,confirmingOrderId:d}){var i;const g=a=>{const u={pending:{label:"Pendiente",color:"bg-yellow-100 text-yellow-800",icon:me,description:"Esperando confirmaci√≥n del vendedor"},accepted:{label:"Aceptado",color:"bg-blue-100 text-blue-800",icon:oe,description:"El vendedor est√° preparando tu pedido"},ready:{label:"Listo",color:"bg-green-100 text-green-800",icon:xe,description:"Tu pedido est√° listo"},assigned:{label:"Repartidor asignado",color:"bg-purple-100 text-purple-800",icon:ue,description:"Un repartidor fue asignado"},picked_up:{label:"En camino",color:"bg-orange-100 text-orange-800",icon:ue,description:"El repartidor est√° en camino"},"in-transit":{label:"En tr√°nsito",color:"bg-indigo-100 text-indigo-800",icon:ue,description:"Tu pedido est√° siendo entregado"},delivered:{label:"Entregado",color:"bg-green-100 text-green-800",icon:oe,description:"Tu pedido fue entregado"},completed:{label:"Completado",color:"bg-gray-100 text-gray-800",icon:jr,description:"Pedido completado exitosamente"},cancelled:{label:"Cancelado",color:"bg-red-100 text-red-800",icon:De,description:"El pedido fue cancelado"},rejected:{label:"Rechazado",color:"bg-red-100 text-red-800",icon:De,description:"El vendedor rechaz√≥ tu pedido"}};return u[a]||u.pending},_=a=>{const u={pickup:{label:"Recoger en tienda",icon:de,color:"text-blue-600"},"dine-in":{label:"Comer dentro",icon:Gs,color:"text-purple-600"},delivery:{label:"Servicio a domicilio",icon:ue,color:"text-green-600"}};return u[a]||u.pickup},D=a=>({pending:10,accepted:25,ready:50,assigned:60,picked_up:75,in_transit:85,delivered:95,completed:100,cancelled:0,rejected:0})[a]||0,l=a=>a==="pending",T=a=>a==="delivered",w=g(s.status),q=_(s.delivery_type),f=D(s.status),E=w.icon,z=q.icon,G=l(s.status),M=T(s.status),y=p===s.id,j=d===s.id,I=r?"border-gray-200 hover:shadow-md transition-shadow":"border-orange-200 shadow-lg hover:shadow-xl transition-shadow",t=r?"bg-gray-100":"bg-orange-100",k=r?"text-gray-600":"text-orange-600";return e.jsx(Q,{className:I,children:e.jsxs(H,{className:"p-6",children:[e.jsxs("div",{className:"flex items-start justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:`${t} p-2 rounded-lg`,children:e.jsx(E,{className:`w-5 h-5 ${k}`})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-lg",children:s.seller_name||"Vendedor"}),e.jsxs("p",{className:"text-sm text-gray-600",children:["Pedido #",s.id.slice(-8).toUpperCase()]})]})]}),e.jsxs("div",{className:"text-right flex flex-col items-end gap-2",children:[e.jsx(Z,{className:w.color,children:w.label}),e.jsx("p",{className:"text-sm text-gray-500",children:new Date(s.created_at).toLocaleDateString("es-GT")}),G&&h&&e.jsxs(Ba,{children:[e.jsx(Ua,{asChild:!0,children:e.jsx(L,{variant:"outline",size:"sm",className:"border-red-200 text-red-600 hover:bg-red-50 hover:border-red-300 h-8 px-2",disabled:y,title:"Eliminar pedido no confirmado",children:y?e.jsx(qe,{className:"w-3 h-3 animate-spin"}):e.jsx(Xe,{className:"w-3 h-3"})})}),e.jsxs(Va,{className:"bg-white",children:[e.jsxs(Ga,{children:[e.jsxs(Qa,{className:"flex items-center gap-2",children:[e.jsx(Ze,{className:"w-5 h-5 text-red-600"}),"¬øEliminar pedido no confirmado?"]}),e.jsxs(Ha,{children:["Est√°s a punto de eliminar tu pedido de ",e.jsx("strong",{children:s.seller_name})," por un total de ",e.jsxs("strong",{children:["Q",s.total.toFixed(2)]}),".",e.jsx("br",{}),e.jsx("br",{}),"Esta acci√≥n no se puede deshacer. El pedido ser√° eliminado permanentemente y no podr√°s recuperarlo.",e.jsx("br",{}),e.jsx("br",{}),e.jsx("span",{className:"text-yellow-600 font-medium",children:"üí° Tip:"})," Tambi√©n puedes esperar a que el vendedor responda a tu pedido."]})]}),e.jsxs(Wa,{children:[e.jsx(Ka,{children:"Mantener pedido"}),e.jsx(Xa,{onClick:()=>h(s.id,s.seller_name||"Vendedor"),className:"bg-red-600 hover:bg-red-700",disabled:y,children:y?e.jsxs(e.Fragment,{children:[e.jsx(qe,{className:"w-4 h-4 mr-2 animate-spin"}),"Eliminando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Xe,{className:"w-4 h-4 mr-2"}),"S√≠, eliminar pedido"]})})]})]})]})]})]}),e.jsxs("div",{className:"space-y-4",children:[!r&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600",children:w.description}),e.jsxs("span",{className:"font-medium",children:[f,"%"]})]}),e.jsx(zs,{value:f,className:"h-2"})]}),G&&e.jsxs("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-3 flex items-start gap-2",children:[e.jsx(Ze,{className:"w-4 h-4 text-yellow-600 mt-0.5 flex-shrink-0"}),e.jsxs("div",{className:"flex-1 text-sm",children:[e.jsx("p",{className:"text-yellow-700 font-medium",children:"Pedido pendiente de confirmaci√≥n"}),e.jsx("p",{className:"text-yellow-600 text-xs mt-1",children:"Si el vendedor no acepta tu pedido o demora mucho en responder, puedes eliminarlo usando el bot√≥n üóëÔ∏è arriba."})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 p-4 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(z,{className:`w-4 h-4 ${q.color}`}),e.jsx("span",{className:"text-sm font-medium",children:q.label})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(xe,{className:"w-4 h-4 text-gray-500"}),e.jsxs("span",{className:"text-sm",children:[((i=s.items)==null?void 0:i.length)||0," productos"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(me,{className:"w-4 h-4 text-gray-500"}),e.jsxs("span",{className:"text-sm",children:[s.estimated_time||30," min estimado"]})]})]}),s.items&&s.items.length>0&&e.jsxs("div",{className:"flex gap-2 overflow-x-auto",children:[s.items.slice(0,r?4:3).map(a=>{var u;return e.jsxs("div",{className:"flex-shrink-0 flex items-center gap-2 bg-white border rounded-lg p-2",children:[e.jsx("div",{className:"w-10 h-10 rounded overflow-hidden bg-gray-100",children:e.jsx(ye,{src:Hs(a.product_image)||"",alt:a.product_name,className:"w-full h-full object-cover"})}),e.jsxs("div",{className:"text-sm",children:[e.jsx("div",{className:"font-medium truncate w-24",children:a.product_name}),e.jsxs("div",{className:"text-gray-500",children:[a.quantity,"x Q",((u=a.price)==null?void 0:u.toFixed(2))||"0.00"]})]})]},a.id)}),s.items.length>(r?4:3)&&e.jsx("div",{className:"flex-shrink-0 flex items-center justify-center bg-gray-100 rounded-lg w-16 h-16",children:e.jsxs("span",{className:"text-sm text-gray-600",children:["+",s.items.length-(r?4:3)]})})]}),e.jsxs("div",{className:"flex items-center justify-between pt-2 border-t border-gray-100",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("span",{className:"text-lg font-semibold text-green-600",children:["Q",s.total.toFixed(2)]}),r&&(s.seller_rating||s.driver_rating)&&e.jsxs("div",{className:"flex items-center gap-2",children:[s.seller_rating&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(le,{className:"w-4 h-4 text-yellow-400 fill-current"}),e.jsx("span",{className:"text-sm",children:s.seller_rating})]}),s.driver_rating&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ue,{className:"w-4 h-4 text-blue-500"}),e.jsx(le,{className:"w-3 h-3 text-yellow-400 fill-current"}),e.jsx("span",{className:"text-sm",children:s.driver_rating})]})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(L,{variant:"outline",size:"sm",onClick:()=>n(s.id),children:[e.jsx(xs,{className:"w-4 h-4 mr-2"}),"Ver detalles"]}),M&&m&&e.jsx(L,{variant:"default",size:"sm",onClick:()=>m(s.id,s.seller_name||"Vendedor"),disabled:j,className:"bg-green-600 hover:bg-green-700",children:j?e.jsxs(e.Fragment,{children:[e.jsx(qe,{className:"w-4 h-4 mr-2 animate-spin"}),"Confirmando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(oe,{className:"w-4 h-4 mr-2"}),"Confirmar recibido"]})}),r&&c&&e.jsxs(L,{variant:"outline",size:"sm",onClick:()=>c(s.id),children:[e.jsx(Oa,{className:"w-4 h-4 mr-2"}),"Volver a pedir"]})]})]})]})]})})}function qs({orders:s,isHistory:r=!1,loading:n=!1,onViewOrder:h,onDeleteOrder:m,onConfirmReceived:c,onReorderFn:p,deletingOrderId:d,confirmingOrderId:g,emptyTitle:_,emptyDescription:D}){if(n)return e.jsx("div",{className:"space-y-4",children:[...Array(3)].map((l,T)=>e.jsx("div",{className:"animate-pulse",children:e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-6 shadow-sm",children:[e.jsxs("div",{className:"flex items-start justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"bg-gray-200 w-10 h-10 rounded-lg"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"bg-gray-200 h-5 w-32 rounded"}),e.jsx("div",{className:"bg-gray-200 h-4 w-24 rounded"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"bg-gray-200 h-6 w-20 rounded-full"}),e.jsx("div",{className:"bg-gray-200 h-4 w-16 rounded"})]})]}),!r&&e.jsxs("div",{className:"space-y-2 mb-4",children:[e.jsx("div",{className:"bg-gray-200 h-4 w-full rounded"}),e.jsx("div",{className:"bg-gray-200 h-2 w-full rounded"})]}),e.jsx("div",{className:"bg-gray-100 p-4 rounded-lg mb-4",children:e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsx("div",{className:"bg-gray-200 h-4 w-24 rounded"}),e.jsx("div",{className:"bg-gray-200 h-4 w-20 rounded"}),e.jsx("div",{className:"bg-gray-200 h-4 w-28 rounded"})]})}),e.jsx("div",{className:"flex gap-2 mb-4",children:[...Array(3)].map((w,q)=>e.jsxs("div",{className:"flex items-center gap-2 bg-gray-50 p-2 rounded-lg",children:[e.jsx("div",{className:"bg-gray-200 w-10 h-10 rounded"}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"bg-gray-200 h-3 w-20 rounded"}),e.jsx("div",{className:"bg-gray-200 h-3 w-12 rounded"})]})]},q))}),e.jsxs("div",{className:"flex items-center justify-between pt-2 border-t border-gray-100",children:[e.jsx("div",{className:"bg-gray-200 h-6 w-20 rounded"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("div",{className:"bg-gray-200 h-8 w-24 rounded"}),e.jsx("div",{className:"bg-gray-200 h-8 w-28 rounded"})]})]})]})},T))});if(s.length===0){const l=r?"No hay pedidos en el historial":"No tienes pedidos activos",T=r?"Tus pedidos completados, cancelados o rechazados aparecer√°n aqu√≠":"Tus pedidos en proceso aparecer√°n aqu√≠";return e.jsxs("div",{className:"flex flex-col items-center justify-center py-16 px-4",children:[e.jsx("div",{className:"bg-gray-100 rounded-full p-6 mb-6",children:e.jsx(we,{className:"w-16 h-16 text-gray-400"})}),e.jsx("h3",{className:"text-xl font-semibold text-gray-900 mb-2 text-center",children:_||l}),e.jsx("p",{className:"text-gray-500 text-center max-w-md",children:D||T}),!r&&e.jsx("div",{className:"mt-6 p-4 bg-orange-50 rounded-lg border border-orange-200",children:e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-orange-700 font-medium text-sm mb-2",children:"üí° ¬øQuieres hacer tu primer pedido?"}),e.jsx("p",{className:"text-orange-600 text-sm",children:"Explora los productos disponibles y agrega algunos al carrito"})]})})]})}return e.jsx("div",{className:"space-y-4",children:s.map(l=>e.jsx(Br,{order:l,isHistory:r,onViewOrder:h,onDeleteOrder:m,onConfirmReceived:c,onReorderFn:p,deletingOrderId:d,confirmingOrderId:g},l.id))})}function Ur({stats:s,loading:r=!1}){if(r)return e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:[...Array(4)].map((c,p)=>e.jsx(Q,{className:"animate-pulse",children:e.jsx(H,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"bg-gray-200 h-4 w-20 rounded"}),e.jsx("div",{className:"bg-gray-200 h-6 w-16 rounded"})]}),e.jsx("div",{className:"bg-gray-200 w-8 h-8 rounded"})]})})},p))});const n=[{title:"Total de Pedidos",value:s.totalOrders,icon:we,color:"text-blue-600",bgColor:"bg-blue-100",description:"Pedidos realizados"},{title:"Pedidos Activos",value:s.activeOrders,icon:me,color:"text-orange-600",bgColor:"bg-orange-100",description:"En proceso"},{title:"Completados",value:s.completedOrders,icon:oe,color:"text-green-600",bgColor:"bg-green-100",description:"Exitosos"},{title:"Total Gastado",value:`Q${s.totalSpent.toFixed(2)}`,icon:Sa,color:"text-purple-600",bgColor:"bg-purple-100",description:"Inversi√≥n total"}],h=[{label:"Promedio por pedido",value:`Q${s.averageOrderValue.toFixed(2)}`,icon:He,color:"text-green-600"},{label:"Calificaci√≥n promedio",value:s.averageRating>0?`${s.averageRating.toFixed(1)} ‚òÖ`:"Sin calificar",icon:le,color:"text-yellow-600"},{label:"Este mes",value:`${s.thisMonthOrders} pedidos`,icon:Me,color:"text-indigo-600"}],m=[{label:"A domicilio",value:s.deliveryOrders,icon:ue,color:"text-green-600",percentage:s.totalOrders>0?(s.deliveryOrders/s.totalOrders*100).toFixed(0):0},{label:"Recoger en tienda",value:s.pickupOrders,icon:xe,color:"text-blue-600",percentage:s.totalOrders>0?(s.pickupOrders/s.totalOrders*100).toFixed(0):0},{label:"Comer en lugar",value:s.dineInOrders,icon:xe,color:"text-purple-600",percentage:s.totalOrders>0?(s.dineInOrders/s.totalOrders*100).toFixed(0):0}];return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:n.map((c,p)=>{const d=c.icon;return e.jsx(Q,{className:"border-orange-200 shadow-lg hover:shadow-xl transition-shadow",children:e.jsx(H,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-sm font-medium text-gray-600",children:c.title}),e.jsx("p",{className:"text-2xl font-bold text-gray-900",children:c.value}),e.jsx("p",{className:"text-xs text-gray-500",children:c.description})]}),e.jsx("div",{className:`${c.bgColor} p-3 rounded-lg`,children:e.jsx(d,{className:`w-6 h-6 ${c.color}`})})]})})},p)})}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs(Q,{className:"border-orange-200 shadow-lg",children:[e.jsx(ee,{children:e.jsxs(se,{className:"flex items-center gap-2 text-lg",children:[e.jsx(He,{className:"w-5 h-5 text-orange-500"}),"M√©tricas Adicionales"]})}),e.jsx(H,{className:"space-y-4",children:h.map((c,p)=>{const d=c.icon;return e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(d,{className:`w-4 h-4 ${c.color}`}),e.jsx("span",{className:"text-sm font-medium text-gray-700",children:c.label})]}),e.jsx(Z,{variant:"outline",className:"font-medium",children:c.value})]},p)})})]}),e.jsxs(Q,{className:"border-orange-200 shadow-lg",children:[e.jsx(ee,{children:e.jsxs(se,{className:"flex items-center gap-2 text-lg",children:[e.jsx(ue,{className:"w-5 h-5 text-orange-500"}),"Tipos de Entrega"]})}),e.jsx(H,{className:"space-y-4",children:m.map((c,p)=>{const d=c.icon;return e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(d,{className:`w-4 h-4 ${c.color}`}),e.jsx("span",{className:"text-sm font-medium text-gray-700",children:c.label})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-sm font-bold text-gray-900",children:c.value}),e.jsxs(Z,{variant:"secondary",className:"text-xs",children:[c.percentage,"%"]})]})]}),e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-2",children:e.jsx("div",{className:`${c.color.replace("text-","bg-")} h-2 rounded-full transition-all duration-300`,style:{width:`${c.percentage}%`}})})]},p)})})]})]}),s.totalOrders>0&&e.jsx(Q,{className:"border-green-200 bg-green-50",children:e.jsx(H,{className:"p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"bg-green-100 p-2 rounded-lg",children:e.jsx(He,{className:"w-5 h-5 text-green-600"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-medium text-green-900 mb-1",children:"Resumen de tu actividad"}),e.jsxs("div",{className:"text-sm text-green-700 space-y-1",children:[e.jsxs("p",{children:["‚Ä¢ Has realizado ",e.jsx("strong",{children:s.totalOrders})," pedidos con un gasto total de ",e.jsxs("strong",{children:["Q",s.totalSpent.toFixed(2)]})]}),e.jsxs("p",{children:["‚Ä¢ Tu pedido promedio es de ",e.jsxs("strong",{children:["Q",s.averageOrderValue.toFixed(2)]})]}),s.cancelledOrders>0&&e.jsxs("p",{children:["‚Ä¢ Tasa de √©xito: ",e.jsxs("strong",{children:[(s.completedOrders/s.totalOrders*100).toFixed(0),"%"]}),"(",s.cancelledOrders," cancelados)"]}),s.averageRating>0&&e.jsxs("p",{children:["‚Ä¢ Calificaci√≥n promedio que das: ",e.jsxs("strong",{children:[s.averageRating.toFixed(1)," estrellas"]})]})]})]})]})})})]})}function Ds({onViewOrder:s}){const{orders:r,loading:n,refreshOrders:h,deleteUnconfirmedOrder:m}=gs(),{user:c}=ke(),[p,d]=x.useState("orders"),[g,_]=x.useState(null),[D,l]=x.useState(!1),[T,w]=x.useState(null),[q,f]=x.useState(null),E=t=>{_(t),s&&s(t)},z=async(t,k)=>{w(t);try{const i=await m(t);i.success?(V.success("Pedido eliminado",{description:`El pedido de ${k} ha sido eliminado exitosamente.`,duration:4e3}),await h()):V.error("Error",{description:i.message||"No se pudo eliminar el pedido.",duration:5e3})}catch(i){console.error("Error deleting order:",i),V.error("Error",{description:"Error inesperado al eliminar el pedido.",duration:5e3})}finally{w(null)}},G=async(t,k)=>{var i;if(c!=null&&c.id){f(t);try{const{error:a}=await R.from("orders").update({status:"completed",completed_at:new Date().toISOString(),updated_at:new Date().toISOString()}).eq("id",t);if(a)throw a;const{error:u}=await R.from("notifications").insert([{recipient_id:(i=(await R.from("orders").select("seller_id").eq("id",t).single()).data)==null?void 0:i.seller_id,type:"order_completed_by_buyer",title:"‚úÖ Comprador confirm√≥ recepci√≥n",message:`El comprador confirm√≥ que recibi√≥ su pedido #${t.slice(0,8)}. ¬°Pedido completado exitosamente!`,data:{order_id:t,buyer_id:c.id},created_at:new Date().toISOString()}]);u&&console.error("Error enviando notificaci√≥n:",u),V.success("¬°Orden confirmada!",{description:`Has confirmado que recibiste tu pedido de ${k}.`,duration:4e3}),await h()}catch(a){console.error("Error confirming order received:",a),V.error("Error",{description:"No se pudo confirmar la recepci√≥n de la orden.",duration:5e3})}finally{f(null)}}},M=async t=>{V.info("Funci√≥n en desarrollo",{description:"La funcionalidad de volver a pedir estar√° disponible pronto.",duration:3e3})},y=r.filter(t=>!["delivered","completed","cancelled","rejected"].includes(t.status)),j=r.filter(t=>["delivered","completed","cancelled","rejected"].includes(t.status)),I=x.useMemo(()=>{const t=r.length,k=r.filter(P=>!["delivered","completed","cancelled","rejected"].includes(P.status)).length,i=r.filter(P=>["delivered","completed"].includes(P.status)).length,a=r.filter(P=>["cancelled","rejected"].includes(P.status)).length,u=r.filter(P=>["delivered","completed"].includes(P.status)).reduce((P,J)=>P+J.total,0),v=i>0?u/i:0,N=0,o=new Date;o.setDate(1);const C=r.filter(P=>new Date(P.created_at)>=o).length,F=r.filter(P=>P.delivery_type==="delivery").length,b=r.filter(P=>P.delivery_type==="pickup").length,O=r.filter(P=>P.delivery_type==="dine-in").length;return{totalOrders:t,activeOrders:k,completedOrders:i,cancelledOrders:a,totalSpent:u,averageOrderValue:v,averageRating:N,thisMonthOrders:C,deliveryOrders:F,pickupOrders:b,dineInOrders:O}},[r]);return g?e.jsx(Zs,{orderId:g,onBack:()=>_(null)}):e.jsx("div",{className:"space-y-6",children:e.jsxs(es,{value:p,onValueChange:d,className:"space-y-6",children:[e.jsxs(ss,{className:"grid w-full grid-cols-3 lg:w-[400px] mx-auto bg-white border border-orange-200",children:[e.jsxs(_e,{value:"orders",className:"data-[state=active]:bg-orange-100 data-[state=active]:text-orange-700",children:["Pedidos (",y.length,")"]}),e.jsxs(_e,{value:"history",className:"data-[state=active]:bg-gray-100 data-[state=active]:text-gray-700",children:["Historial (",j.length,")"]}),e.jsx(_e,{value:"stats",className:"data-[state=active]:bg-blue-100 data-[state=active]:text-blue-700",children:"Estad√≠sticas"})]}),e.jsx(ve,{value:"orders",className:"space-y-4",children:e.jsx(qs,{orders:y,isHistory:!1,loading:n,onViewOrder:E,onDeleteOrder:z,onConfirmReceived:G,deletingOrderId:T,confirmingOrderId:q,emptyTitle:"No tienes pedidos activos",emptyDescription:"Tus pedidos en proceso aparecer√°n aqu√≠"})}),e.jsx(ve,{value:"history",className:"space-y-4",children:e.jsx(qs,{orders:j,isHistory:!0,loading:n,onViewOrder:E,onReorderFn:M,emptyTitle:"No hay pedidos en el historial",emptyDescription:"Tus pedidos completados, cancelados o rechazados aparecer√°n aqu√≠"})}),e.jsx(ve,{value:"stats",className:"space-y-6",children:e.jsx(Ur,{stats:I,loading:n})})]})})}var ps="Avatar",[Vr,Zt]=us(ps),[Gr,Ys]=Vr(ps),Js=x.forwardRef((s,r)=>{const{__scopeAvatar:n,...h}=s,[m,c]=x.useState("idle");return e.jsx(Gr,{scope:n,imageLoadingStatus:m,onImageLoadingStatusChange:c,children:e.jsx($e.span,{...h,ref:r})})});Js.displayName=ps;var ea="AvatarImage",sa=x.forwardRef((s,r)=>{const{__scopeAvatar:n,src:h,onLoadingStatusChange:m=()=>{},...c}=s,p=Ys(ea,n),d=Qr(h,c.referrerPolicy),g=ja(_=>{m(_),p.onImageLoadingStatusChange(_)});return Ms(()=>{d!=="idle"&&g(d)},[d,g]),d==="loaded"?e.jsx($e.img,{...c,ref:r,src:h}):null});sa.displayName=ea;var aa="AvatarFallback",ra=x.forwardRef((s,r)=>{const{__scopeAvatar:n,delayMs:h,...m}=s,c=Ys(aa,n),[p,d]=x.useState(h===void 0);return x.useEffect(()=>{if(h!==void 0){const g=window.setTimeout(()=>d(!0),h);return()=>window.clearTimeout(g)}},[h]),p&&c.imageLoadingStatus!=="loaded"?e.jsx($e.span,{...m,ref:r}):null});ra.displayName=aa;function Qr(s,r){const[n,h]=x.useState("idle");return Ms(()=>{if(!s){h("error");return}let m=!0;const c=new window.Image,p=d=>()=>{m&&h(d)};return h("loading"),c.onload=p("loaded"),c.onerror=p("error"),c.src=s,r&&(c.referrerPolicy=r),()=>{m=!1}},[s,r]),n}var Hr=Js,Wr=sa,Kr=ra;function Xr({className:s,...r}){return e.jsx(Hr,{"data-slot":"avatar",className:Ue("relative flex size-10 shrink-0 overflow-hidden rounded-full",s),...r})}function Zr({className:s,...r}){return e.jsx(Wr,{"data-slot":"avatar-image",className:Ue("aspect-square size-full",s),...r})}function Yr({className:s,...r}){return e.jsx(Kr,{"data-slot":"avatar-fallback",className:Ue("bg-muted flex size-full items-center justify-center rounded-full",s),...r})}function As({onShowCart:s}){const{user:r,updateProfile:n}=ke(),{getCartItemCount:h}=Te(),[m,c]=x.useState(null),[p,d]=x.useState(!1),[g,_]=x.useState(!1),[D,l]=x.useState(!1),[T,w]=x.useState(""),[q,f]=x.useState(""),E=x.useRef(null),[z,G]=x.useState({total_orders:0,completed_orders:0,total_spent:0,average_rating:0});x.useEffect(()=>{r&&(M(),I())},[r]);const M=async()=>{if(r)try{const{data:i,error:a}=await R.from("users").select("*").eq("id",r.id).single();if(a)throw a;c({...i,notification_preferences:i.notification_preferences||{order_updates:!0,promotions:!0,new_products:!1}})}catch(i){console.error("Error loading profile:",i)}},y=(i,a,u,v=.9)=>new Promise(N=>{const o=document.createElement("canvas"),C=o.getContext("2d"),F=new Image;F.onload=()=>{let{width:b,height:O}=F;b>O?b>a&&(O=O*a/b,b=a):O>u&&(b=b*u/O,O=u),o.width=b,o.height=O,C.drawImage(F,0,0,b,O),o.toBlob(N,"image/jpeg",v)},F.src=URL.createObjectURL(i)}),j=async i=>{var u;const a=(u=i.target.files)==null?void 0:u[0];if(!(!a||!r))try{l(!0),w(""),f("");const v=["image/jpeg","image/jpg","image/png","image/webp"],N=5*1024*1024;if(!v.includes(a.type.toLowerCase())){w("Solo se permiten im√°genes JPG, PNG o WebP");return}if(a.size>N){w("La imagen debe ser menor a 5MB");return}const o=await y(a,400,400,.85);if(!o){w("Error al procesar la imagen");return}const C=`${r.id}/avatar-${Date.now()}.jpg`,{error:F}=await R.storage.from("user-avatars").upload(C,o,{upsert:!0,contentType:"image/jpeg"});if(F){console.error("Upload error:",F),w(`Error subiendo imagen: ${F.message}`);return}const{data:b}=R.storage.from("user-avatars").getPublicUrl(C),{error:O}=await R.from("users").update({avatar_url:b.publicUrl,updated_at:new Date().toISOString()}).eq("id",r.id);if(O){w(`Error guardando en base de datos: ${O.message}`);return}c(P=>P?{...P,avatar_url:b.publicUrl}:null),await n({avatar_url:b.publicUrl}),f("‚úÖ Foto de perfil actualizada correctamente"),setTimeout(()=>f(""),3e3)}catch(v){console.error("Avatar upload error:",v),w(`Error: ${v.message||"Error desconocido"}`)}finally{l(!1),E.current&&(E.current.value="")}},I=async()=>{if(r)try{const{data:i,error:a}=await R.from("orders").select("total, status, seller_rating, created_at, delivery_type").eq("buyer_id",r.id);if(a){console.error("Error loading orders:",a);return}if(!i||i.length===0){G({total_orders:0,completed_orders:0,total_spent:0,average_rating:0});return}const u=i.reduce((N,o)=>{N.total_orders++;const C=Number(o.total)||0;return o.status==="completed"&&(N.completed_orders++,N.total_spent+=C),o.seller_rating&&o.seller_rating>0&&N.ratings.push(Number(o.seller_rating)),N},{total_orders:0,completed_orders:0,total_spent:0,ratings:[]}),v=u.ratings.length>0?u.ratings.reduce((N,o)=>N+o,0)/u.ratings.length:0;G({total_orders:u.total_orders,completed_orders:u.completed_orders,total_spent:u.total_spent,average_rating:Math.round(v*10)/10})}catch(i){console.error("Error loading order stats:",i),G({total_orders:0,completed_orders:0,total_spent:0,average_rating:0})}},t=async()=>{if(m){_(!0),w("");try{const{error:i}=await R.from("users").update({name:m.name,phone:m.phone,address:m.address,preferred_delivery_address:m.preferred_delivery_address}).eq("id",m.id);if(i)throw i;await n({name:m.name,phone:m.phone}),f("‚úÖ Perfil actualizado correctamente"),d(!1),setTimeout(()=>f(""),3e3)}catch(i){console.error("Error updating profile:",i),w("Error al actualizar perfil: "+i.message)}finally{_(!1)}}},k=(i,a)=>{m&&c({...m,notification_preferences:{...m.notification_preferences,[i]:a}})};return m?e.jsxs("div",{className:"space-y-4 sm:space-y-6 p-4 sm:p-0",children:[T&&e.jsx("div",{className:"bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg",children:e.jsx("p",{className:"break-words",children:T})}),q&&e.jsx("div",{className:"bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg",children:e.jsx("p",{className:"break-words",children:q})}),e.jsx(Q,{className:"border-orange-200 shadow-lg",children:e.jsx(H,{className:"p-4 sm:p-6",children:e.jsxs("div",{className:"flex flex-col sm:flex-row items-center gap-4 sm:gap-6",children:[e.jsxs("div",{className:"relative flex-shrink-0",children:[e.jsxs(Xr,{className:"w-20 h-20 sm:w-24 sm:h-24 border-4 border-white shadow-lg",children:[e.jsx(Zr,{src:m.avatar_url,className:"object-cover"}),e.jsx(Yr,{className:"text-xl sm:text-2xl bg-gradient-to-r from-orange-500 to-green-500 text-white",children:m.name.charAt(0).toUpperCase()})]}),e.jsx("input",{ref:E,type:"file",accept:"image/*",className:"hidden",onChange:j}),e.jsx(L,{size:"sm",variant:"outline",className:"absolute -bottom-2 -right-2 h-8 w-8 p-0 rounded-full bg-white shadow-lg hover:bg-orange-50 transition-colors",onClick:()=>{var i;return(i=E.current)==null?void 0:i.click()},disabled:D,children:D?e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-orange-500"}):e.jsx(Za,{className:"w-4 h-4 text-orange-600"})})]}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h2",{className:"text-2xl font-bold",children:m.name}),e.jsxs(L,{variant:"outline",size:"sm",onClick:()=>d(!p),children:[e.jsx(Ra,{className:"w-4 h-4 mr-2"}),p?"Cancelar":"Editar perfil"]})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:gap-4 text-sm text-gray-600 mb-3 space-y-2 sm:space-y-0",children:[e.jsxs("div",{className:"flex items-center gap-1 break-all",children:[e.jsx(Ya,{className:"w-4 h-4 flex-shrink-0"}),e.jsx("span",{className:"truncate",children:m.email})]}),m.phone&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(cs,{className:"w-4 h-4 flex-shrink-0"}),e.jsx("span",{children:m.phone})]}),e.jsxs(Z,{variant:"outline",className:"border-green-200 text-green-700 w-fit",children:[e.jsx(ks,{className:"w-3 h-3 mr-1"}),"Comprador verificado"]})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-3 sm:gap-4",children:[e.jsxs("div",{className:"text-center p-3 bg-orange-50 rounded-lg border border-orange-100",children:[e.jsx("div",{className:"text-xl sm:text-2xl font-bold text-orange-600",children:z.total_orders}),e.jsx("div",{className:"text-xs text-gray-600",children:"Pedidos totales"}),z.completed_orders>0&&e.jsxs("div",{className:"text-xs text-green-600 mt-1",children:[z.completed_orders," completados"]})]}),e.jsxs("div",{className:"text-center p-3 bg-green-50 rounded-lg border border-green-100",children:[e.jsxs("div",{className:"text-xl sm:text-2xl font-bold text-green-600",children:["Q",z.total_spent.toFixed(0)]}),e.jsx("div",{className:"text-xs text-gray-600",children:"Total gastado"}),z.total_orders>0&&e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["Promedio: Q",(z.total_spent/z.completed_orders||0).toFixed(0)]})]}),e.jsxs("div",{className:"text-center p-3 bg-yellow-50 rounded-lg border border-yellow-100",children:[e.jsxs("div",{className:"text-xl sm:text-2xl font-bold text-yellow-600 flex items-center justify-center gap-1",children:[z.average_rating>0?z.average_rating.toFixed(1):"0.0",e.jsx(le,{className:"w-4 h-4 fill-current"})]}),e.jsx("div",{className:"text-xs text-gray-600",children:"Tu calificaci√≥n"}),z.average_rating===0&&z.total_orders>0&&e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:"Sin calificar a√∫n"})]})]})]})]})})}),e.jsxs("div",{className:"grid grid-cols-1 xl:grid-cols-2 gap-6",children:[e.jsxs(Q,{className:"border-blue-200",children:[e.jsx(ee,{children:e.jsxs(se,{className:"flex items-center gap-2",children:[e.jsx(Ae,{className:"w-5 h-5 text-blue-500"}),"Informaci√≥n Personal"]})}),e.jsxs(H,{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 gap-4",children:[e.jsxs("div",{children:[e.jsx(pe,{htmlFor:"name",children:"Nombre completo"}),e.jsx(be,{id:"name",value:m.name,onChange:i=>c({...m,name:i.target.value}),disabled:!p,className:"mt-1"})]}),e.jsxs("div",{children:[e.jsx(pe,{htmlFor:"email",children:"Correo electr√≥nico"}),e.jsx(be,{id:"email",type:"email",value:m.email,disabled:!0,className:"mt-1 bg-gray-50"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"El correo no se puede cambiar"})]}),e.jsxs("div",{children:[e.jsx(pe,{htmlFor:"phone",children:"Tel√©fono"}),e.jsx(be,{id:"phone",value:m.phone||"",onChange:i=>c({...m,phone:i.target.value}),disabled:!p,placeholder:"Tu n√∫mero de tel√©fono",className:"mt-1"})]}),e.jsxs("div",{children:[e.jsx(pe,{htmlFor:"date_of_birth",children:"Fecha de nacimiento"}),e.jsx(be,{id:"date_of_birth",type:"date",value:m.date_of_birth||"",onChange:i=>c({...m,date_of_birth:i.target.value}),disabled:!p,className:"mt-1"})]})]}),p&&e.jsxs(L,{onClick:t,disabled:g,className:"w-full bg-gradient-to-r from-orange-500 to-green-500 hover:from-orange-600 hover:to-green-600",children:[e.jsx(Ss,{className:"w-4 h-4 mr-2"}),g?"Guardando...":"Guardar cambios"]}),T&&e.jsx("div",{className:"p-3 bg-red-50 border border-red-200 rounded-lg",children:e.jsx("p",{className:"text-red-700 text-sm",children:T})}),q&&e.jsx("div",{className:"p-3 bg-green-50 border border-green-200 rounded-lg",children:e.jsx("p",{className:"text-green-700 text-sm",children:q})})]})]}),e.jsxs(Q,{className:"border-green-200",children:[e.jsx(ee,{children:e.jsxs(se,{className:"flex items-center gap-2",children:[e.jsx(Oe,{className:"w-5 h-5 text-green-500"}),"Gesti√≥n de Direcciones"]})}),e.jsx(H,{children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(pe,{htmlFor:"preferred_delivery_address",children:"Direcci√≥n principal de entrega"}),e.jsx(Ke,{id:"preferred_delivery_address",className:"mt-1",rows:3,placeholder:"Ingresa tu direcci√≥n completa (calle, n√∫mero, colonia, referencias)",value:m.preferred_delivery_address||"",onChange:i=>c({...m,preferred_delivery_address:i.target.value}),disabled:!p}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Incluye referencias importantes (edificio, color de casa, puntos de referencia)"})]}),e.jsx(L,{variant:"outline",className:"w-full h-auto py-3",onClick:()=>{if(!navigator.geolocation){w("GPS no disponible en este dispositivo");return}if(_(!0),w(""),!r){w("Usuario no disponible"),_(!1);return}navigator.geolocation.getCurrentPosition(async i=>{try{const{latitude:a,longitude:u}=i.coords,{error:v}=await R.from("users").update({latitude:a,longitude:u,updated_at:new Date().toISOString()}).eq("id",r.id);if(v)throw v;f(`‚úÖ Ubicaci√≥n GPS actualizada: ${a.toFixed(6)}, ${u.toFixed(6)}`),setTimeout(()=>f(""),5e3)}catch{w("Error al guardar ubicaci√≥n GPS")}finally{_(!1)}},i=>{switch(_(!1),i.code){case i.PERMISSION_DENIED:w("Permiso de ubicaci√≥n denegado. Activa el GPS en configuraci√≥n.");break;case i.POSITION_UNAVAILABLE:w("Informaci√≥n de ubicaci√≥n no disponible.");break;case i.TIMEOUT:w("Tiempo de espera agotado para obtener ubicaci√≥n.");break;default:w("Error desconocido al obtener ubicaci√≥n.");break}},{enableHighAccuracy:!0,timeout:1e4,maximumAge:6e4})},disabled:g,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx(Oe,{className:"w-4 h-4 flex-shrink-0"}),e.jsx("span",{className:"text-center leading-tight",children:g?"Obteniendo ubicaci√≥n...":"Actualizar ubicaci√≥n GPS"})]})}),e.jsx("div",{className:"text-center",children:e.jsx("p",{className:"text-xs text-gray-500 break-words",children:"La ubicaci√≥n GPS nos ayuda a mostrar vendedores cercanos y calcular costos de entrega"})})]})})]})]}),e.jsxs(Q,{className:"border-purple-200",children:[e.jsx(ee,{children:e.jsxs(se,{className:"flex items-center gap-2",children:[e.jsx(Qe,{className:"w-5 h-5 text-purple-500"}),"Preferencias de Notificaciones"]})}),e.jsxs(H,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-start justify-between gap-4",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx(pe,{htmlFor:"order_updates",className:"text-base",children:"Actualizaciones de pedidos"}),e.jsx("p",{className:"text-sm text-gray-500 break-words",children:"Recibe notificaciones sobre el estado de tus pedidos"})]}),e.jsx("div",{className:"flex-shrink-0",children:e.jsx(ns,{id:"order_updates",checked:m.notification_preferences.order_updates,onCheckedChange:i=>k("order_updates",i),disabled:!p})})]}),e.jsx(je,{}),e.jsxs("div",{className:"flex items-start justify-between gap-4",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx(pe,{htmlFor:"promotions",className:"text-base",children:"Promociones y ofertas"}),e.jsx("p",{className:"text-sm text-gray-500 break-words",children:"Recibe ofertas especiales y promociones"})]}),e.jsx("div",{className:"flex-shrink-0",children:e.jsx(ns,{id:"promotions",checked:m.notification_preferences.promotions,onCheckedChange:i=>k("promotions",i),disabled:!p})})]}),e.jsx(je,{}),e.jsxs("div",{className:"flex items-start justify-between gap-4",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx(pe,{htmlFor:"new_products",className:"text-base",children:"Nuevos productos"}),e.jsx("p",{className:"text-sm text-gray-500 break-words",children:"Notificaciones cuando hay nuevos productos disponibles"})]}),e.jsx("div",{className:"flex-shrink-0",children:e.jsx(ns,{id:"new_products",checked:m.notification_preferences.new_products,onCheckedChange:i=>k("new_products",i),disabled:!p})})]})]}),p&&e.jsxs(L,{onClick:t,disabled:g,className:"w-full bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600",children:[e.jsx(Ss,{className:"w-4 h-4 mr-2"}),"Guardar preferencias"]})]})]}),e.jsxs(Q,{className:"border-gray-200",children:[e.jsx(ee,{children:e.jsxs(se,{className:"flex items-center gap-2",children:[e.jsx(va,{className:"w-5 h-5 text-gray-500"}),"Acciones R√°pidas"]})}),e.jsx(H,{children:e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-4",children:[e.jsxs(L,{variant:"outline",className:"h-16 flex flex-col gap-2 text-center",children:[e.jsx(Ye,{className:"w-5 h-5 text-red-500"}),e.jsx("span",{className:"text-sm leading-tight",children:"Productos favoritos"})]}),e.jsxs(L,{variant:"outline",className:"h-16 flex flex-col gap-2 text-center",children:[e.jsx(Ja,{className:"w-5 h-5 text-blue-500"}),e.jsx("span",{className:"text-sm leading-tight",children:"Historial de compras"})]}),e.jsxs(L,{variant:"outline",className:"h-16 flex flex-col gap-2 text-center",children:[e.jsx(Le,{className:"w-5 h-5 text-green-500"}),e.jsx("span",{className:"text-sm leading-tight",children:"M√©todos de pago"})]})]})})]}),e.jsxs(Q,{className:"border-yellow-200",children:[e.jsx(ee,{children:e.jsxs(se,{className:"flex items-center gap-2",children:[e.jsx(er,{className:"w-5 h-5 text-yellow-500"}),"Seguridad de la Cuenta"]})}),e.jsxs(H,{className:"space-y-4",children:[e.jsx("div",{className:"p-4 bg-yellow-50 rounded-lg border border-yellow-200",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(ks,{className:"w-8 h-8 text-yellow-600 flex-shrink-0"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h4",{className:"font-medium text-yellow-800",children:"Cuenta protegida"}),e.jsx("p",{className:"text-sm text-yellow-700 break-words",children:"Tu cuenta est√° protegida por autenticaci√≥n segura de Supabase"})]})]})}),e.jsx("div",{className:"text-center text-sm text-gray-500",children:e.jsx("p",{className:"break-words",children:"Para cambios de seguridad como contrase√±a, contacta al soporte t√©cnico"})})]})]}),e.jsx(hs,{onCartClick:s||(()=>{alert(`Tienes ${h()} productos en tu carrito. Funcionalidad de carrito implementada.`)})})]}):e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-orange-500"})})}function Jr({onContinueShopping:s,onProceedToCheckout:r}){const{user:n}=ke(),{items:h,updateCartItem:m,removeFromCart:c,clearCart:p,getCartTotal:d,getCartItemCount:g}=Te(),{openImageModal:_}=ms(),[D,l]=x.useState(null),[T,w]=x.useState(null),[q,f]=x.useState(""),E=d(),z=E,G=h.reduce((i,a)=>{var N,o,C;const u=((N=a.product)==null?void 0:N.seller_id)||"unknown",v=((C=(o=a.product)==null?void 0:o.seller)==null?void 0:C.business_name)||"Vendedor";return i[u]||(i[u]={sellerId:u,sellerName:v,items:[]}),i[u].items.push(a),i},{}),M=async(i,a)=>{if(!(a<0)){l(i);try{a===0?(await c(i),V.success("Eliminado")):await m(i,a)}catch(u){console.error("Error updating cart:",u),V.error("Error al actualizar el carrito")}finally{l(null)}}},y=(i,a)=>{w(i),f(a.toString())},j=i=>{const a=parseInt(q);!isNaN(a)&&a>=0&&M(i,a),w(null),f("")},I=(i,a)=>{i.key==="Enter"?j(a):i.key==="Escape"&&(w(null),f(""))},t=async i=>{try{await c(i),V.success("Eliminado")}catch(a){console.error("Error removing item:",a),V.error("Error al eliminar producto")}},k=async()=>{try{await p(),V.success("Carrito vac√≠o")}catch(i){console.error("Error clearing cart:",i),V.error("Error al vaciar carrito")}};return h.length===0?e.jsx("div",{className:"max-w-2xl mx-auto p-6",children:e.jsxs("div",{className:"text-center py-12",children:[e.jsx(we,{className:"w-24 h-24 text-gray-300 mx-auto mb-6"}),e.jsx("h3",{className:"text-2xl font-semibold text-gray-900 mb-2",children:"Tu carrito est√° vac√≠o"}),e.jsx("p",{className:"text-gray-600 mb-8",children:"Agrega algunos productos para comenzar tu pedido"}),e.jsxs(L,{onClick:s,className:"bg-orange-500 hover:bg-orange-600 text-white px-8 py-3",children:[e.jsx(Be,{className:"w-4 h-4 mr-2"}),"Explorar Productos"]})]})}):e.jsxs("div",{className:"max-w-6xl mx-auto p-4 lg:p-6",children:[e.jsxs("div",{className:"flex flex-col lg:flex-row lg:items-center lg:justify-between mb-6",children:[e.jsxs("div",{className:"mb-4 lg:mb-0",children:[e.jsxs("h1",{className:"text-2xl lg:text-3xl font-bold text-gray-900 flex items-center gap-3",children:[e.jsx(we,{className:"w-7 h-7 text-orange-500"}),"Mi Carrito"]}),e.jsxs("p",{className:"text-gray-600 mt-1",children:[g()," ",g()===1?"producto":"productos"," en tu carrito"]})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-3",children:[e.jsxs(L,{variant:"outline",onClick:s,className:"border-orange-200 text-orange-600 hover:bg-orange-50",children:[e.jsx(Be,{className:"w-4 h-4 mr-2"}),"Continuar Comprando"]}),h.length>0&&e.jsxs(L,{variant:"outline",onClick:k,className:"border-red-200 text-red-600 hover:bg-red-50",children:[e.jsx(Xe,{className:"w-4 h-4 mr-2"}),"Vaciar Carrito"]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsx("div",{className:"lg:col-span-2 space-y-6",children:Object.values(G).map(i=>e.jsxs(Q,{className:"shadow-sm border border-gray-200",children:[e.jsx(ee,{className:"pb-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(de,{className:"w-5 h-5 text-orange-500"}),e.jsxs("div",{children:[e.jsx(se,{className:"text-lg font-semibold",children:i.sellerName}),e.jsxs("p",{className:"text-sm text-gray-600",children:[i.items.length," productos"]})]})]})}),e.jsx(H,{children:e.jsx("div",{className:"space-y-4",children:i.items.map(a=>{var u,v,N,o,C,F;return e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center gap-4 p-4 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-4 flex-1",children:[e.jsx(ye,{src:((u=a.product)==null?void 0:u.image_url)||"https://images.unsplash.com/photo-1546069901-ba9599a7e63c?w=300&h=200&fit=crop",alt:((v=a.product)==null?void 0:v.name)||"Producto",className:"w-16 h-16 object-cover rounded-lg flex-shrink-0 cursor-pointer",onClick:()=>{var O,P;const b=((O=a.product)==null?void 0:O.image_url)||"https://images.unsplash.com/photo-1546069901-ba9599a7e63c?w=800&h=600&fit=crop";_(b,((P=a.product)==null?void 0:P.name)||"Producto")}}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h4",{className:"font-medium text-gray-900 truncate",children:(N=a.product)==null?void 0:N.name}),e.jsxs("p",{className:"text-green-600 font-semibold text-lg",children:["Q",(o=a.product)==null?void 0:o.price]}),((C=a.product)==null?void 0:C.description)&&e.jsx("p",{className:"text-sm text-gray-600 truncate",children:a.product.description})]})]}),e.jsxs("div",{className:"flex items-center justify-between sm:justify-end gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(L,{size:"sm",variant:"outline",onClick:()=>M(a.id,a.quantity-1),disabled:D===a.id,className:"h-8 w-8 p-0",children:e.jsx(We,{className:"w-3 h-3"})}),T===a.id?e.jsx(be,{value:q,onChange:b=>f(b.target.value),onBlur:()=>j(a.id),onKeyDown:b=>I(b,a.id),className:"w-16 h-8 text-center text-sm font-medium p-1",autoFocus:!0}):e.jsx("span",{className:"px-3 py-1 bg-white border rounded font-medium cursor-pointer hover:bg-gray-50 min-w-[3rem] text-center",onClick:()=>y(a.id,a.quantity),title:"Haz clic para editar cantidad",children:D===a.id?"...":a.quantity}),e.jsx(L,{size:"sm",variant:"outline",onClick:()=>M(a.id,a.quantity+1),disabled:D===a.id,className:"h-8 w-8 p-0",children:e.jsx(Se,{className:"w-3 h-3"})})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"text-right",children:e.jsxs("p",{className:"font-semibold text-lg",children:["Q",(((F=a.product)==null?void 0:F.price)*a.quantity).toFixed(2)]})}),e.jsx(L,{size:"sm",variant:"outline",onClick:()=>t(a.id),className:"h-8 w-8 p-0 text-red-600 border-red-200 hover:bg-red-50",children:e.jsx(Xe,{className:"w-3 h-3"})})]})]})]},a.id)})})})]},i.sellerId))}),e.jsx("div",{className:"space-y-6",children:e.jsxs(Q,{className:"shadow-sm border border-gray-200",children:[e.jsx(ee,{children:e.jsx(se,{className:"text-lg",children:"Resumen del Pedido"})}),e.jsxs(H,{className:"space-y-4",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Subtotal"}),e.jsxs("span",{className:"font-medium",children:["Q",E.toFixed(2)]})]}),e.jsx(je,{}),e.jsxs("div",{className:"flex justify-between text-lg font-semibold",children:[e.jsx("span",{children:"Total"}),e.jsxs("span",{className:"text-orange-600",children:["Q",z.toFixed(2)]})]}),e.jsxs(L,{onClick:r,className:"w-full bg-orange-500 hover:bg-orange-600 text-white py-3 text-lg font-medium",size:"lg",children:[e.jsx(Le,{className:"w-5 h-5 mr-2"}),"Proceder al Pago",e.jsx(Vs,{className:"w-5 h-5 ml-2"})]})]})]})})]})]})}var fs="Radio",[et,ta]=us(fs),[st,at]=et(fs),ia=x.forwardRef((s,r)=>{const{__scopeRadio:n,name:h,checked:m=!1,required:c,disabled:p,value:d="on",onCheck:g,form:_,...D}=s,[l,T]=x.useState(null),w=Ls(r,E=>T(E)),q=x.useRef(!1),f=l?_||!!l.closest("form"):!0;return e.jsxs(st,{scope:n,checked:m,disabled:p,children:[e.jsx($e.button,{type:"button",role:"radio","aria-checked":m,"data-state":oa(m),"data-disabled":p?"":void 0,disabled:p,value:d,...D,ref:w,onClick:os(s.onClick,E=>{m||g==null||g(),f&&(q.current=E.isPropagationStopped(),q.current||E.stopPropagation())})}),f&&e.jsx(rt,{control:l,bubbles:!q.current,name:h,value:d,checked:m,required:c,disabled:p,form:_,style:{transform:"translateX(-100%)"}})]})});ia.displayName=fs;var na="RadioIndicator",la=x.forwardRef((s,r)=>{const{__scopeRadio:n,forceMount:h,...m}=s,c=at(na,n);return e.jsx(Ta,{present:h||c.checked,children:e.jsx($e.span,{"data-state":oa(c.checked),"data-disabled":c.disabled?"":void 0,...m,ref:r})})});la.displayName=na;var rt=s=>{const{control:r,checked:n,bubbles:h=!0,...m}=s,c=x.useRef(null),p=Na(n),d=_a(r);return x.useEffect(()=>{const g=c.current,_=window.HTMLInputElement.prototype,l=Object.getOwnPropertyDescriptor(_,"checked").set;if(p!==n&&l){const T=new Event("click",{bubbles:h});l.call(g,n),g.dispatchEvent(T)}},[p,n,h]),e.jsx("input",{type:"radio","aria-hidden":!0,defaultChecked:n,...m,tabIndex:-1,ref:c,style:{...s.style,...d,position:"absolute",pointerEvents:"none",opacity:0,margin:0}})};function oa(s){return s?"checked":"unchecked"}var tt=["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"],js="RadioGroup",[it,Yt]=us(js,[Bs,ta]),ca=Bs(),da=ta(),[nt,lt]=it(js),ma=x.forwardRef((s,r)=>{const{__scopeRadioGroup:n,name:h,defaultValue:m,value:c,required:p=!1,disabled:d=!1,orientation:g,dir:_,loop:D=!0,onValueChange:l,...T}=s,w=ca(n),q=ya(_),[f,E]=ba({prop:c,defaultProp:m,onChange:l});return e.jsx(nt,{scope:n,name:h,required:p,disabled:d,value:f,onValueChange:E,children:e.jsx(Ca,{asChild:!0,...w,orientation:g,dir:q,loop:D,children:e.jsx($e.div,{role:"radiogroup","aria-required":p,"aria-orientation":g,"data-disabled":d?"":void 0,dir:q,...T,ref:r})})})});ma.displayName=js;var ua="RadioGroupItem",xa=x.forwardRef((s,r)=>{const{__scopeRadioGroup:n,disabled:h,...m}=s,c=lt(ua,n),p=c.disabled||h,d=ca(n),g=da(n),_=x.useRef(null),D=Ls(r,_),l=c.value===m.value,T=x.useRef(!1);return x.useEffect(()=>{const w=f=>{tt.includes(f.key)&&(T.current=!0)},q=()=>T.current=!1;return document.addEventListener("keydown",w),document.addEventListener("keyup",q),()=>{document.removeEventListener("keydown",w),document.removeEventListener("keyup",q)}},[]),e.jsx(Ea,{asChild:!0,...d,focusable:!p,active:l,children:e.jsx(ia,{disabled:p,required:c.required,checked:l,...g,...m,name:c.name,ref:D,onCheck:()=>c.onValueChange(m.value),onKeyDown:os(w=>{w.key==="Enter"&&w.preventDefault()}),onFocus:os(m.onFocus,()=>{var w;T.current&&((w=_.current)==null||w.click())})})})});xa.displayName=ua;var ot="RadioGroupIndicator",ga=x.forwardRef((s,r)=>{const{__scopeRadioGroup:n,...h}=s,m=da(n);return e.jsx(la,{...m,...h,ref:r})});ga.displayName=ot;var ct=ma,dt=xa,mt=ga;function $s({className:s,...r}){return e.jsx(ct,{"data-slot":"radio-group",className:Ue("grid gap-3",s),...r})}function Fs({className:s,...r}){return e.jsx(dt,{"data-slot":"radio-group-item",className:Ue("border-input text-primary focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive dark:bg-input/30 aspect-square size-4 shrink-0 rounded-full border shadow-xs transition-[color,box-shadow] outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50",s),...r,children:e.jsx(mt,{"data-slot":"radio-group-indicator",className:"relative flex items-center justify-center",children:e.jsx(dr,{className:"fill-primary absolute top-1/2 left-1/2 size-2 -translate-x-1/2 -translate-y-1/2"})})})}function ut({onBack:s,onComplete:r}){const{user:n}=ke(),{items:h,clearCart:m,getCartTotal:c}=Te(),{notify:p}=sr(),[d,g]=x.useState("complete-info"),[_,D]=x.useState("pickup"),[l,T]=x.useState(!1),[w,q]=x.useState(!1),[f,E]=x.useState({customer_name:"",phone_number:"",delivery_address:"",customer_notes:"",payment_method:"cash"});x.useEffect(()=>{n&&z()},[n]);const z=async()=>{try{const{data:b,error:O}=await R.from("users").select("name, phone, address, preferred_delivery_address").eq("id",n==null?void 0:n.id).single();if(O)throw O;E(b?P=>({...P,customer_name:b.name||(n==null?void 0:n.name)||"",phone_number:b.phone||(n==null?void 0:n.phone)||"",delivery_address:b.preferred_delivery_address||b.address||"",customer_notes:""}):P=>({...P,customer_name:(n==null?void 0:n.name)||"",phone_number:(n==null?void 0:n.phone)||"",delivery_address:"",customer_notes:""}))}catch(b){console.error("Error loading user profile:",b),E(O=>({...O,customer_name:(n==null?void 0:n.name)||"",phone_number:(n==null?void 0:n.phone)||"",delivery_address:"",customer_notes:""}))}},G=h.reduce((b,O)=>{var P;return b+(((P=O.product)==null?void 0:P.price)||0)*O.quantity},0),M=_==="delivery"?15:0,y=G+M,j=[{type:"pickup",title:"Recoger en tienda",description:"Recoge tu pedido directamente en la tienda",icon:de,fee:0},{type:"dine-in",title:"Comer en el lugar",description:"Disfruta tu comida en el restaurante",icon:yr,fee:0},{type:"delivery",title:"Servicio a domicilio",description:"Te llevamos tu pedido a tu direcci√≥n",icon:ue,fee:15}],I=[{type:"cash",title:"Efectivo",description:"Paga al recibir tu pedido",icon:or},{type:"card",title:"Tarjeta",description:"Tarjeta de d√©bito o cr√©dito",icon:Le},{type:"transfer",title:"Transferencia",description:"Transferencia bancaria",icon:_r}],t=b=>{switch(b){case"complete-info":return _==="delivery"&&!f.delivery_address.trim()?"Ingresa tu direcci√≥n de entrega":f.customer_name.trim()?f.phone_number.trim()?null:"Ingresa tu tel√©fono":"Ingresa tu nombre";case"payment":return f.payment_method?null:"Selecciona un m√©todo de pago";default:return null}},k=()=>{const b=t(d);if(b){V.error(b);return}const O=["complete-info","payment","review"],P=O.indexOf(d);P<O.length-1&&g(O[P+1])},i=()=>{const b=["complete-info","payment","review"],O=b.indexOf(d);O>0&&g(b[O-1])},a=async()=>{var O;if(!n){V.error("Debes iniciar sesi√≥n para crear un pedido");return}if(!f.customer_name.trim()||!f.phone_number.trim()){V.error("Por favor completa toda la informaci√≥n requerida"),g("complete-info");return}if(_==="delivery"&&!f.delivery_address.trim()){V.error("La direcci√≥n de entrega es requerida para servicio a domicilio"),g("complete-info");return}if(!h||h.length===0){V.error("Tu carrito est√° vac√≠o");return}if(h.filter(P=>!P.product_id||!P.quantity||P.quantity<=0).length>0){V.error("Hay productos inv√°lidos en tu carrito. Por favor actualiza tu carrito.");return}g("processing"),T(!0);try{console.log("Cart items:",h);let P=null;for(const A of h){if(A.seller_id){P=A.seller_id;break}if((O=A.product)!=null&&O.seller_id){P=A.product.seller_id;break}}if(console.log("Seller ID encontrado:",P),!P&&h.length>0){console.log("Intentando obtener seller_id del producto...");try{const{data:A,error:ae}=await R.from("products").select("seller_id").eq("id",h[0].product_id).single();!ae&&(A!=null&&A.seller_id)&&(P=A.seller_id,console.log("Seller ID obtenido del producto:",P))}catch(A){console.error("Error obteniendo seller_id del producto:",A)}}if(!P)throw new Error(`No se pudo identificar el vendedor. Por favor:
1. Vac√≠a tu carrito
2. Agrega los productos nuevamente
3. Si el problema persiste, contacta soporte`);const J={buyer_id:n.id,seller_id:P,subtotal:Number(G.toFixed(2)),delivery_fee:Number(M.toFixed(2)),total_amount:Number(y.toFixed(2)),total:Number(y.toFixed(2)),delivery_type:_,delivery_address:_==="delivery"?f.delivery_address.trim():_==="pickup"?"Recoger en tienda":"Comer en el lugar",customer_notes:f.customer_notes.trim()||null,phone_number:f.phone_number.trim(),customer_name:f.customer_name.trim(),payment_method:f.payment_method,status:"pending"};console.log("üîç Validando stock disponible...");const U=(await Promise.all(h.map(async A=>{var Ce;let ae=null,re="",fe=0;if(A.product_type==="daily"){const{data:ce}=await R.from("daily_products").select("stock_quantity, name, expires_at").eq("id",A.product_id).single();ce&&(ae=ce,re=ce.name,fe=new Date(ce.expires_at)<=new Date?0:ce.stock_quantity)}else{const{data:ce}=await R.from("products").select("stock_quantity, name").eq("id",A.product_id).single();ce&&(ae=ce,re=ce.name,fe=ce.stock_quantity)}return{productId:A.product_id,productName:re||((Ce=A.product)==null?void 0:Ce.name)||"Producto",requestedQuantity:A.quantity,availableStock:fe||0,isValid:(fe||0)>=A.quantity}}))).filter(A=>!A.isValid);if(U.length>0){const A=U.map(ae=>ae.availableStock===0?`‚ùå ${ae.productName}: AGOTADO`:`‚ö†Ô∏è ${ae.productName}: Solo ${ae.availableStock} disponibles (solicitaste ${ae.requestedQuantity})`).join(`
`);throw new Error(`‚ùå STOCK INSUFICIENTE:

${A}

üí° Actualiza las cantidades en tu carrito y vuelve a intentar.`)}console.log("‚úÖ Stock validado correctamente");const{data:X,error:te}=await R.from("orders").insert(J).select().single();if(te)throw console.error("Error creating order:",te),new Error(`Error al crear la orden: ${te.message}`);if(!X)throw new Error("No se pudo crear la orden");const ge=h.map(A=>{var ae,re,fe,Ce,ce;return{order_id:X.id,product_id:A.product_id,product_name:((ae=A.product)==null?void 0:ae.name)||A.product_name||"Producto",product_image:((re=A.product)==null?void 0:re.image_url)||A.product_image||null,price:Number((((fe=A.product)==null?void 0:fe.price)||A.product_price||0).toFixed(2)),price_per_unit:Number((((Ce=A.product)==null?void 0:Ce.price)||A.product_price||0).toFixed(2)),quantity:Number(A.quantity),total_price:Number(((((ce=A.product)==null?void 0:ce.price)||A.product_price||0)*A.quantity).toFixed(2)),product_type:A.product_type||"regular",notes:null}}),{error:B}=await R.from("order_items").insert(ge);if(B)throw console.error("Error creating order items:",B),await R.from("orders").delete().eq("id",X.id),new Error(`Error al agregar productos a la orden: ${B.message}`);try{await R.from("notifications").insert({recipient_id:P,type:"new_order",title:"üõí Nueva orden recibida",message:`${f.customer_name} ha realizado un pedido por Q${y.toFixed(2)} - ${_==="pickup"?"Recoger en tienda":_==="dine-in"?"Comer en el lugar":"Servicio a domicilio"}`,data:{order_id:X.id,delivery_type:_,payment_method:f.payment_method,customer_name:f.customer_name,customer_phone:f.phone_number,total:y}})}catch(A){console.error("Error creating notification:",A)}try{await p("üõí Nueva Orden Recibida",{body:`${f.customer_name} realiz√≥ un pedido por Q${y.toFixed(2)}`,sound:"NEW_ORDER",push:!0,data:{orderId:X.id,customerId:n==null?void 0:n.id,total:y}})}catch(A){console.error("Error sending sound notification:",A)}await m(),q(!0),V.success("¬°Pedido creado exitosamente!"),setTimeout(()=>{r()},2e3)}catch(P){console.error("Error creating order:",P);const J=P instanceof Error?P.message:"Error desconocido al crear el pedido";V.error(J),g("review")}finally{T(!1)}},u=()=>{const b=[{key:"complete-info",label:"Informaci√≥n",icon:Ae},{key:"payment",label:"Pago",icon:Le},{key:"review",label:"Revisar",icon:oe}],O=b.findIndex(P=>P.key===d);return e.jsx("div",{className:"flex items-center justify-between mb-8",children:b.map((P,J)=>{const ie=P.icon,U=P.key===d,X=J<O;return e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:`flex items-center justify-center w-8 h-8 rounded-full ${U?"bg-orange-500 text-white":X?"bg-green-500 text-white":"bg-gray-200 text-gray-400"}`,children:e.jsx(ie,{className:"w-4 h-4"})}),e.jsx("span",{className:`ml-2 text-sm ${U?"text-orange-600 font-medium":X?"text-green-600":"text-gray-400"}`,children:P.label}),J<b.length-1&&e.jsx("div",{className:`w-8 h-0.5 mx-4 ${X?"bg-green-500":"bg-gray-200"}`})]},P.key)})})},v=()=>e.jsxs("div",{className:"space-y-6",children:[e.jsxs(Q,{children:[e.jsx(ee,{children:e.jsxs(se,{className:"flex items-center gap-2",children:[e.jsx(ue,{className:"w-5 h-5"}),"Opciones de entrega"]})}),e.jsxs(H,{className:"space-y-4",children:[e.jsx($s,{value:_,onValueChange:b=>D(b),children:j.map(b=>{const O=b.icon;return e.jsxs("div",{className:"flex items-center space-x-2 p-4 border rounded-lg hover:bg-gray-50",children:[e.jsx(Fs,{value:b.type,id:b.type}),e.jsxs("div",{className:"flex-1 flex items-center gap-3",children:[e.jsx(O,{className:"w-5 h-5 text-orange-500"}),e.jsxs("div",{className:"flex-1",children:[e.jsx(pe,{htmlFor:b.type,className:"font-medium cursor-pointer",children:b.title}),e.jsx("p",{className:"text-sm text-gray-600",children:b.description})]}),e.jsx("div",{className:"text-right",children:b.fee>0?e.jsxs("span",{className:"font-medium",children:["Q",b.fee.toFixed(2)]}):e.jsx("span",{className:"text-green-600 font-medium",children:"Gratis"})})]})]},b.type)})}),_==="delivery"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(pe,{htmlFor:"address",children:"Direcci√≥n de entrega *"}),e.jsx(Ke,{id:"address",placeholder:"Ingresa tu direcci√≥n completa con referencias...",value:f.delivery_address,onChange:b=>E(O=>({...O,delivery_address:b.target.value})),rows:3,className:!f.delivery_address&&_==="delivery"?"border-red-300":""}),f.delivery_address&&e.jsxs("p",{className:"text-sm text-green-600 flex items-center gap-1",children:[e.jsx(oe,{className:"w-4 h-4"}),"Direcci√≥n cargada desde tu perfil"]})]})]})]}),e.jsxs(Q,{children:[e.jsx(ee,{children:e.jsxs(se,{className:"flex items-center gap-2",children:[e.jsx(Ae,{className:"w-5 h-5"}),"Confirmar informaci√≥n de contacto",f.customer_name&&f.phone_number&&e.jsx(oe,{className:"w-5 h-5 text-green-500 ml-auto"})]})}),e.jsxs(H,{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(pe,{htmlFor:"name",children:"Nombre completo *"}),e.jsx(be,{id:"name",placeholder:"Tu nombre completo",value:f.customer_name,onChange:b=>E(O=>({...O,customer_name:b.target.value})),className:f.customer_name?"border-green-300 bg-green-50":""}),f.customer_name&&e.jsx("p",{className:"text-xs text-green-600",children:"‚úì Cargado desde tu perfil"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(pe,{htmlFor:"phone",children:"N√∫mero de tel√©fono *"}),e.jsx(be,{id:"phone",placeholder:"+502 1234-5678",value:f.phone_number,onChange:b=>E(O=>({...O,phone_number:b.target.value})),className:f.phone_number?"border-green-300 bg-green-50":""}),f.phone_number&&e.jsx("p",{className:"text-xs text-green-600",children:"‚úì Cargado desde tu perfil"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(pe,{htmlFor:"notes",children:"Instrucciones especiales (opcional)"}),e.jsx(Ke,{id:"notes",placeholder:"Alguna instrucci√≥n especial para tu pedido...",value:f.customer_notes,onChange:b=>E(O=>({...O,customer_notes:b.target.value})),rows:2})]})]})]}),e.jsxs(Q,{children:[e.jsx(ee,{children:e.jsxs(se,{className:"flex items-center gap-2",children:[e.jsx(we,{className:"w-5 h-5"}),"Resumen del pedido"]})}),e.jsxs(H,{className:"space-y-4",children:[e.jsx("div",{className:"space-y-2 max-h-32 overflow-y-auto",children:h.map((b,O)=>{var P,J;return e.jsxs("div",{className:"flex justify-between items-center py-1 text-sm",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("span",{className:"font-medium",children:((P=b.product)==null?void 0:P.name)||b.name}),e.jsxs("span",{className:"text-gray-600 ml-2",children:["x",b.quantity]})]}),e.jsxs("span",{className:"font-medium",children:["Q",((((J=b.product)==null?void 0:J.price)||0)*b.quantity).toFixed(2)]})]},O)})}),e.jsx(je,{}),e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Subtotal:"}),e.jsxs("span",{children:["Q",G.toFixed(2)]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Entrega:"}),e.jsx("span",{children:M>0?`Q${M.toFixed(2)}`:"Gratis"})]}),e.jsx(je,{}),e.jsxs("div",{className:"flex justify-between text-lg font-bold",children:[e.jsx("span",{children:"Total:"}),e.jsxs("span",{className:"text-orange-600",children:["Q",y.toFixed(2)]})]})]})]})]})]}),N=()=>e.jsxs(Q,{children:[e.jsx(ee,{children:e.jsxs(se,{className:"flex items-center gap-2",children:[e.jsx(Le,{className:"w-5 h-5"}),"M√©todo de pago"]})}),e.jsxs(H,{className:"space-y-4",children:[e.jsx($s,{value:f.payment_method,onValueChange:b=>E(O=>({...O,payment_method:b})),children:I.map(b=>{const O=b.icon;return e.jsxs("div",{className:"flex items-center space-x-2 p-4 border rounded-lg hover:bg-gray-50",children:[e.jsx(Fs,{value:b.type,id:b.type}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(O,{className:"w-5 h-5 text-green-500"}),e.jsxs("div",{children:[e.jsx(pe,{htmlFor:b.type,className:"font-medium cursor-pointer",children:b.title}),e.jsx("p",{className:"text-sm text-gray-600",children:b.description})]})]})]},b.type)})}),e.jsxs("div",{className:"bg-blue-50 p-4 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2 text-blue-700",children:[e.jsx(oe,{className:"w-4 h-4"}),e.jsx("span",{className:"font-medium",children:"Pago seguro"})]}),e.jsx("p",{className:"text-sm text-blue-600 mt-1",children:"Todos los pagos son procesados de forma segura. Tu informaci√≥n est√° protegida."})]})]})]}),o=()=>{const b=j.find(P=>P.type===_),O=I.find(P=>P.type===f.payment_method);return e.jsxs("div",{className:"space-y-6",children:[e.jsxs(Q,{children:[e.jsx(ee,{children:e.jsxs(se,{className:"flex items-center gap-2",children:[e.jsx(we,{className:"w-5 h-5"}),"Resumen del pedido"]})}),e.jsxs(H,{className:"space-y-4",children:[h.map((P,J)=>{var ie,U,X,te,ge;return e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-gray-50 rounded-lg",children:[((ie=P.product)==null?void 0:ie.image_url)&&e.jsx("img",{src:P.product.image_url,alt:P.product.name,className:"w-12 h-12 object-cover rounded"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-medium",children:(U=P.product)==null?void 0:U.name}),e.jsxs("p",{className:"text-sm text-gray-600",children:["Q",(te=(X=P.product)==null?void 0:X.price)==null?void 0:te.toFixed(2)," x ",P.quantity]})]}),e.jsxs("span",{className:"font-medium",children:["Q",((((ge=P.product)==null?void 0:ge.price)||0)*P.quantity).toFixed(2)]})]},J)}),e.jsx(je,{}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Subtotal:"}),e.jsxs("span",{children:["Q",G.toFixed(2)]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Entrega:"}),e.jsx("span",{children:M>0?`Q${M.toFixed(2)}`:"Gratis"})]}),e.jsx(je,{}),e.jsxs("div",{className:"flex justify-between text-lg font-bold",children:[e.jsx("span",{children:"Total:"}),e.jsxs("span",{className:"text-orange-600",children:["Q",y.toFixed(2)]})]})]})]})]}),e.jsxs("div",{className:"grid md:grid-cols-2 gap-4",children:[e.jsxs(Q,{children:[e.jsx(ee,{children:e.jsx(se,{className:"text-base",children:"Entrega"})}),e.jsx(H,{children:e.jsxs("div",{className:"flex items-center gap-3",children:[b&&e.jsx(b.icon,{className:"w-5 h-5 text-orange-500"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:b==null?void 0:b.title}),_==="delivery"&&f.delivery_address&&e.jsx("p",{className:"text-sm text-gray-600",children:f.delivery_address})]})]})})]}),e.jsxs(Q,{children:[e.jsx(ee,{children:e.jsx(se,{className:"text-base",children:"Pago"})}),e.jsx(H,{children:e.jsxs("div",{className:"flex items-center gap-3",children:[O&&e.jsx(O.icon,{className:"w-5 h-5 text-green-500"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:O==null?void 0:O.title}),e.jsx("p",{className:"text-sm text-gray-600",children:O==null?void 0:O.description})]})]})})]})]}),e.jsxs(Q,{children:[e.jsx(ee,{children:e.jsx(se,{className:"text-base",children:"Contacto"})}),e.jsx(H,{children:e.jsxs("div",{className:"space-y-2",children:[e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Nombre:"})," ",f.customer_name]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Tel√©fono:"})," ",f.phone_number]}),f.customer_notes&&e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Notas:"})," ",f.customer_notes]})]})})]})]})},C=()=>e.jsx("div",{className:"text-center py-12",children:w?e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto",children:e.jsx(oe,{className:"w-8 h-8 text-green-600"})}),e.jsx("h3",{className:"text-xl font-bold text-green-600",children:"¬°Pedido creado exitosamente!"}),e.jsx("p",{className:"text-gray-600",children:"Tu pedido ha sido enviado al vendedor. Te notificaremos cuando sea confirmado."})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center mx-auto",children:e.jsx(me,{className:"w-8 h-8 text-orange-600 animate-spin"})}),e.jsx("h3",{className:"text-xl font-bold",children:"Procesando tu pedido..."}),e.jsx("p",{className:"text-gray-600",children:"Por favor espera mientras creamos tu pedido."})]})}),F=()=>{switch(d){case"complete-info":return v();case"payment":return N();case"review":return o();case"processing":return C();default:return null}};return e.jsxs("div",{className:"max-w-2xl mx-auto p-6",children:[e.jsxs("div",{className:"flex items-center gap-4 mb-6",children:[e.jsxs(L,{variant:"outline",size:"sm",onClick:s,disabled:l,children:[e.jsx(Be,{className:"w-4 h-4 mr-2"}),"Volver al carrito"]}),e.jsx("h1",{className:"text-2xl font-bold",children:"Checkout"})]}),d!=="processing"&&u(),F(),d!=="processing"&&e.jsxs("div",{className:"flex justify-between mt-8",children:[e.jsxs(L,{variant:"outline",onClick:i,disabled:d==="complete-info"||l,children:[e.jsx(Be,{className:"w-4 h-4 mr-2"}),"Anterior"]}),d==="review"?e.jsx(L,{onClick:a,disabled:l,className:"bg-gradient-to-r from-orange-500 to-green-500 hover:from-orange-600 hover:to-green-600",children:l?e.jsxs(e.Fragment,{children:[e.jsx(me,{className:"w-4 h-4 mr-2 animate-spin"}),"Procesando..."]}):e.jsxs(e.Fragment,{children:["Confirmar pedido Q",y.toFixed(2),e.jsx(oe,{className:"w-4 h-4 ml-2"})]})}):e.jsxs(L,{onClick:k,className:"bg-gradient-to-r from-orange-500 to-green-500 hover:from-orange-600 hover:to-green-600",children:["Siguiente",e.jsx(Vs,{className:"w-4 h-4 ml-2"})]})]})]})}function xt({notification:s,onDismiss:r,index:n}){const[h,m]=x.useState(!1),[c,p]=x.useState(!1),[d,g]=x.useState(null),[_,D]=x.useState(null),[l,T]=x.useState(0),[w,q]=x.useState(!1),f=x.useRef(null),E=x.useRef(null);x.useEffect(()=>{const v=setTimeout(()=>m(!0),100+n*150);return()=>clearTimeout(v)},[n]),x.useEffect(()=>(E.current=setTimeout(()=>{z()},5*60*1e3),()=>{E.current&&clearTimeout(E.current)}),[]);const z=()=>{E.current&&clearTimeout(E.current),p(!0),setTimeout(()=>{r(s.id)},300)},G=v=>({new_order:we,order_accepted:oe,order_ready:xe,order_assigned:Ae,order_picked_up:ue,order_in_transit:ue,order_delivered:oe,order_completed:le,order_cancelled:Ee,order_rejected:Ee,promotion:de,new_product:xe,message:Qe,system:Ee,rating:le,general:Qe})[v]||Qe,M=v=>({new_order:"bg-blue-500",order_accepted:"bg-green-500",order_ready:"bg-orange-500",order_assigned:"bg-purple-500",order_picked_up:"bg-indigo-500",order_in_transit:"bg-indigo-500",order_delivered:"bg-green-500",order_completed:"bg-gray-500",order_cancelled:"bg-red-500",order_rejected:"bg-red-500",promotion:"bg-yellow-500",new_product:"bg-pink-500",message:"bg-blue-500",system:"bg-gray-500",rating:"bg-yellow-500",general:"bg-gray-500"})[v]||"bg-gray-500",y=v=>{g(v.targetTouches[0].clientX),q(!0)},j=v=>{if(!d||!w)return;const N=v.targetTouches[0].clientX,o=N-d;T(o),D(N)},I=()=>{if(!d||!_){q(!1),T(0);return}const v=d-_;Math.abs(v)>50?z():T(0),q(!1),g(null),D(null)},t=v=>{g(v.clientX),q(!0)},k=v=>{if(!d||!w)return;const N=v.clientX-d;T(N),D(v.clientX)},i=()=>{if(!d||!_){q(!1),T(0);return}const v=d-_;Math.abs(v)>50?z():T(0),q(!1),g(null),D(null)},a=G(s.type),u=M(s.type);return e.jsx("div",{ref:f,className:`
        fixed top-4 left-4 right-4 z-50 transform transition-all duration-300 ease-out
        ${h&&!c?"translate-y-0 opacity-100":"-translate-y-full opacity-0"}
        ${w?"transition-none":""}
      `,style:{transform:`translateY(${h&&!c?n*80:-100}px) translateX(${l}px)`,opacity:w?Math.max(.5,1-Math.abs(l)/200):h&&!c?1:0},onTouchStart:y,onTouchMove:j,onTouchEnd:I,onMouseDown:t,onMouseMove:w?k:void 0,onMouseUp:i,onMouseLeave:i,children:e.jsx(Q,{className:"bg-white shadow-lg border-l-4 border-orange-500 cursor-grab active:cursor-grabbing select-none",children:e.jsxs(H,{className:"p-4",children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:`p-2 rounded-full ${u} text-white flex-shrink-0`,children:e.jsx(a,{className:"w-4 h-4"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h4",{className:"font-semibold text-gray-900 text-sm mb-1",children:s.title}),e.jsx("p",{className:"text-gray-700 text-sm",children:s.message})]}),e.jsx("button",{onClick:v=>{v.stopPropagation(),z()},className:"p-1 text-gray-400 hover:text-gray-600 flex-shrink-0",children:e.jsx(Ge,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-between text-xs text-gray-500",children:[e.jsx("span",{children:"Desliza para eliminar"}),e.jsx("span",{children:"Auto-eliminar en 5min"})]})]})})})}function gt(){const{user:s}=ke(),[r,n]=x.useState([]),[h,m]=x.useState(!1),c=async()=>{try{const{error:g}=await R.from("notifications").select("recipient_id, type, title, message, is_read, created_at").limit(1);return g?(console.warn("notifications table is not available:",g.code),!1):!0}catch(g){return console.warn("notifications table availability check failed:",g),!1}},p=async()=>{if(!(!s||!h))try{const g=new Date;g.setDate(g.getDate()-1);const{data:_,error:D}=await R.from("notifications").select("*").eq("recipient_id",s.id).eq("is_read",!1).gte("created_at",g.toISOString()).order("created_at",{ascending:!1}).limit(5);if(D){console.error("Error fetching notifications:",D);return}n(_||[])}catch(g){console.error("Unexpected error fetching notifications:",g)}},d=async g=>{if(n(_=>_.filter(D=>D.id!==g)),h)try{await R.from("notifications").update({is_read:!0}).eq("id",g)}catch(_){console.error("Error marking notification as read:",_)}};return x.useEffect(()=>{(async()=>{const _=await c();m(_),_&&await p()})()},[s==null?void 0:s.id]),x.useEffect(()=>{if(!h||!s)return;const g=R.channel("floating-notifications").on("postgres_changes",{event:"INSERT",schema:"public",table:"notifications",filter:`recipient_id=eq.${s.id}`},()=>{p()}).subscribe();return()=>{R.removeChannel(g)}},[s==null?void 0:s.id,h]),x.useEffect(()=>{const g=setInterval(()=>{h&&p()},6e4);return()=>clearInterval(g)},[h]),!h||r.length===0?null:e.jsx(e.Fragment,{children:r.map((g,_)=>e.jsx(xt,{notification:g,onDismiss:d,index:_},g.id))})}function ht({businessId:s,onBack:r,onShowCart:n}){var re,fe,Ce,ce,as,vs,ys;const{user:h}=ke(),{addToCart:m,items:c}=Te(),{getBusinessProducts:p,getBusinessDailyProducts:d,getBusinessById:g,refreshProductStock:_}=Ws(),{openImageModal:D}=ms(),[l,T]=x.useState(null),[w,q]=x.useState([]),[f,E]=x.useState([]),[z,G]=x.useState(!0),[M,y]=x.useState("productos"),[j,I]=x.useState(null),[t,k]=x.useState(!1),[i,a]=x.useState(new Date),[u,v]=x.useState(null),[N,o]=x.useState("");x.useEffect(()=>{C()},[s]);const C=async()=>{var S,W,Y;try{G(!0),console.log("üîç Cargando datos del negocio:",s);const[$,K,he]=await Promise.all([g(s),p(s),d(s)]);console.log("üìä Datos cargados:",{business:$,products:K,dailyProducts:he,productsWithImages:(K==null?void 0:K.filter(ne=>ne.image_url).length)||0,productsTotal:(K==null?void 0:K.length)||0,dailyWithImages:(he==null?void 0:he.filter(ne=>ne.image_url).length)||0,dailyTotal:(he==null?void 0:he.length)||0}),console.log("üî• DEBUG CONTACTO:",{business_phone:$==null?void 0:$.business_phone,phone:$==null?void 0:$.phone,email:$==null?void 0:$.email,address:$==null?void 0:$.address,business_address:$==null?void 0:$.business_address,user:$==null?void 0:$.user,user_phone:(S=$==null?void 0:$.user)==null?void 0:S.phone,user_email:(W=$==null?void 0:$.user)==null?void 0:W.email,user_address:(Y=$==null?void 0:$.user)==null?void 0:Y.address}),T($),q(K||[]),E(he||[]),a(new Date)}catch($){console.error("‚ùå Error loading business data:",$),V.error("Error al cargar informaci√≥n del comercio")}finally{G(!1)}},F=async()=>{k(!0);try{await _();const[S,W]=await Promise.all([p(s),d(s)]);q(S||[]),E(W||[]),a(new Date),V.success("Productos actualizados correctamente")}catch{V.error("Error al actualizar productos")}finally{k(!1)}},b=async(S,W)=>{if(!h){V.error("Debes iniciar sesi√≥n para agregar productos");return}if(j!==S){I(S);try{const Y=await m(S,1,"regular");Y.success?V.success("Agregado al carrito"):V.error(Y.message,{icon:e.jsx(Ee,{className:"w-4 h-4"}),duration:3e3})}catch(Y){console.error("Error adding to cart:",Y),V.error("Error al agregar al carrito",{icon:e.jsx(De,{className:"w-4 h-4"}),duration:3e3})}finally{I(null)}}},O=async(S,W)=>{if(!h){V.error("Debes iniciar sesi√≥n para agregar productos");return}if(j!==S){I(S);try{console.log("üç∫ Adding daily product to cart:",{productId:S,productName:W,productType:"daily"});const Y=await m(S,1,"daily");console.log("üç∫ Daily cart result:",Y),Y.success?V.success("Agregado al carrito"):(console.error("üç∫ Daily cart failed:",Y),V.error(Y.message,{icon:e.jsx(Ee,{className:"w-4 h-4"}),duration:3e3}))}catch(Y){console.error("Error adding daily to cart:",Y),V.error("Error al agregar al carrito",{icon:e.jsx(De,{className:"w-4 h-4"}),duration:3e3})}finally{I(null)}}},P=(S,W)=>{v(S),o(W.toString())},J=S=>{const W=parseInt(S);(S===""||!isNaN(W)&&W>=0&&W<=999)&&o(S)},ie=async S=>{const W=parseInt(N);!isNaN(W)&&W>=0&&await X(S,W),v(null),o("")},U=async(S,W)=>{S.key==="Enter"?await ie(W):S.key==="Escape"&&(v(null),o(""))},X=async(S,W)=>{const Y=c.find($=>$.product_id===S);if(Y){I(S);try{if(W<=0){const $=await m(S,-Y.quantity,"daily");$.success?V.success("Producto removido del carrito"):V.error($.message)}else{const $=W-Y.quantity,K=await m(S,$,"daily");K.success?V.success(`Cantidad actualizada: ${W}`):V.error(K.message)}}catch($){console.error("Error updating daily cart quantity:",$),V.error("Error al actualizar cantidad")}finally{I(null)}}},te=S=>{const W=c==null?void 0:c.find($=>$.product_id===S),Y=(W==null?void 0:W.quantity)||0;return console.log("üõí Cart check:",{productId:S,cartItems:(c==null?void 0:c.length)||0,foundItem:!!W,quantity:Y}),Y},ge=(l==null?void 0:l.logo_url)||((re=l==null?void 0:l.user)==null?void 0:re.avatar_url),B=l==null?void 0:l.cover_image_url,A=({product:S})=>{var Pe;const W=Ps(S),Y=te(S.id),$=j===S.id,K={isAvailable:S.is_available&&S.stock_quantity>0,hasStock:S.stock_quantity>0,isLowStock:S.stock_quantity<=5&&S.stock_quantity>0,isLastUnits:S.stock_quantity<=3&&S.stock_quantity>0,stockCount:S.stock_quantity||0,isDisabledByVendor:S.is_available===!1,isOutOfStock:S.stock_quantity===0};console.log("üõçÔ∏è ProductCard Availability:",{productName:S.name,productId:S.id,is_available:S.is_available,stock_quantity:S.stock_quantity,availabilityInfo:K,cartQuantity:Y,isAdding:$});const ne=K.isOutOfStock?{text:"Agotado",className:"bg-red-100 text-red-700"}:K.isDisabledByVendor?{text:"No disponible",className:"bg-gray-100 text-gray-600"}:K.isLastUnits?{text:`¬°√öltimas ${K.stockCount}!`,className:"bg-red-100 text-red-700 animate-pulse"}:K.isLowStock?{text:`${K.stockCount} disponibles`,className:"bg-orange-100 text-orange-700"}:K.hasStock?{text:`${K.stockCount} disponibles`,className:"bg-green-100 text-green-700"}:{text:"Sin stock",className:"bg-gray-100 text-gray-600"};return e.jsx(Q,{className:"bg-white shadow-sm border border-gray-100 rounded-xl overflow-hidden hover:shadow-md transition-all min-h-[100px]",children:e.jsx(H,{className:"p-0 h-full",style:{pointerEvents:"auto"},children:e.jsxs("div",{className:"flex h-full relative",onClick:Fe=>console.log("Card clicked",Fe.target),style:{pointerEvents:"auto"},children:[e.jsxs("div",{className:"relative w-20 h-20 bg-gray-100 flex-shrink-0 cursor-pointer",onClick:Fe=>{console.log("üñºÔ∏è Image area clicked"),Fe.stopPropagation(),W&&D(W,S.name)},style:{pointerEvents:"auto"},children:[W?e.jsx(ye,{src:W,alt:S.name,className:"w-full h-full object-cover hover:scale-105 transition-transform duration-200"}):e.jsx("div",{className:"w-full h-full bg-gradient-to-br from-orange-50 to-orange-100 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx(xe,{className:"w-5 h-5 text-orange-300 mx-auto mb-1"}),e.jsx("span",{className:"text-xs text-orange-400 font-medium",children:"Sin imagen"})]})}),e.jsxs("div",{className:"absolute top-1 left-1 space-y-1",children:[K.isOutOfStock&&e.jsx(Z,{className:"bg-red-500 text-white text-xs px-2 py-1 shadow-lg",children:"Agotado"}),K.isDisabledByVendor&&e.jsx(Z,{className:"bg-gray-500 text-white text-xs px-2 py-1 shadow-lg",children:"No disponible"}),K.isLastUnits&&e.jsxs(Z,{className:"bg-red-500 text-white text-xs px-2 py-1 shadow-lg animate-pulse",children:["üî• ¬°√öltimas ",K.stockCount,"!"]})]}),W&&e.jsx("div",{className:"absolute inset-0 bg-black/0 hover:bg-black/20 transition-colors duration-200 flex items-center justify-center",children:e.jsx("div",{className:"opacity-0 hover:opacity-100 transition-opacity bg-black/70 rounded-lg px-2 py-1",children:e.jsxs("div",{className:"flex items-center gap-1 text-white text-xs font-medium",children:[e.jsx(xs,{className:"w-3 h-3"}),e.jsx("span",{children:"Ver"})]})})})]}),e.jsxs("div",{className:"flex-1 p-3 pl-4 min-w-0",children:[e.jsxs("div",{className:"flex justify-between items-start mb-2",children:[e.jsxs("div",{className:"flex-1 pr-4 min-w-0",children:[e.jsx("h3",{className:"font-semibold text-sm text-gray-900 mb-1 line-clamp-2 break-words",children:S.name}),S.description&&e.jsx("p",{className:"text-xs text-gray-500 line-clamp-3 mb-2 break-words",children:S.description})]}),e.jsxs("div",{className:"text-right flex-shrink-0 ml-2",children:[e.jsxs("span",{className:"text-base font-bold text-gray-900 whitespace-nowrap",children:["Q",(Pe=S.price)==null?void 0:Pe.toFixed(2)]}),S.compare_at_price&&S.compare_at_price>S.price&&e.jsxs("div",{className:"text-xs text-gray-400 line-through whitespace-nowrap",children:["Q",S.compare_at_price.toFixed(2)]})]})]}),e.jsxs("div",{className:"flex justify-between items-center gap-2",children:[e.jsxs("div",{className:"flex-1 flex flex-col gap-1",children:[Y>0&&e.jsxs(Z,{className:"bg-orange-100 text-orange-700 text-xs font-semibold w-fit",children:[Y," en carrito"]}),e.jsx(Z,{className:`text-xs font-medium w-fit ${ne.className}`,children:ne.text})]}),e.jsx("div",{className:"flex-shrink-0",children:e.jsx("button",{onClick:()=>{K.isAvailable&&b(S.id,S.name)},disabled:!K.isAvailable||$,className:`
                      h-8 px-3 text-xs font-medium rounded transition-all duration-200
                      ${K.isAvailable&&!$?"bg-orange-500 hover:bg-orange-600 active:bg-orange-700 text-white cursor-pointer shadow-md hover:shadow-lg":"bg-gray-300 text-gray-500 cursor-not-allowed"}
                    `,type:"button",children:$?e.jsx("div",{className:"w-3 h-3 border border-white border-t-transparent rounded-full animate-spin"}):Y>0&&K.isAvailable?e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(Se,{className:"w-3 h-3"}),"+1"]}):K.isAvailable?e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(Se,{className:"w-3 h-3"}),"Agregar"]}):K.isOutOfStock?"Agotado":K.isDisabledByVendor?"No disponible":"Sin stock"})})]})]})]})})})},ae=({product:S})=>{var bs;const[W,Y]=x.useState(!1),[$,K]=x.useState({hours:0,minutes:0,isExpired:!0,formattedTime:"Expirado"}),he=Ps(S),ne=te(S.id),Pe=j===S.id;x.useEffect(()=>{if(!S.expires_at)return;const Re=()=>{const fa=new Date,rs=new Date(S.expires_at).getTime()-fa.getTime();if(rs<=0){K({hours:0,minutes:0,isExpired:!0,formattedTime:"Expirado"});return}const ts=Math.floor(rs/(1e3*60*60)),is=Math.floor(rs%(1e3*60*60)/(1e3*60));K({hours:ts,minutes:is,isExpired:!1,formattedTime:ts>0?`${ts}h ${is}m restantes`:`${is}m restantes`})};Re();const pa=setInterval(Re,1e3);return()=>clearInterval(pa)},[S.expires_at]);const Fe=()=>S.stock_quantity===0?"bg-red-500 text-white":S.stock_quantity<=3?"bg-yellow-500 text-white":"bg-green-500 text-white",ha=()=>{he&&D(he,S.name)};return e.jsx(Q,{className:"hover:shadow-xl transition-all duration-300 border-orange-200 overflow-hidden",children:e.jsx(H,{className:"p-0",children:e.jsxs("div",{className:"flex",children:[e.jsxs("div",{className:"relative w-20 h-20 sm:w-24 sm:h-24 bg-gray-100 flex-shrink-0",children:[e.jsx("div",{className:"cursor-pointer w-full h-full",onClick:ha,children:he?e.jsx(ye,{src:he,alt:S.name,className:"w-full h-full object-cover hover:scale-105 transition-transform duration-200",onError:()=>Y(!0)}):e.jsx("div",{className:"w-full h-full bg-gradient-to-br from-orange-100 to-orange-200 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx(Me,{className:"w-4 h-4 sm:w-5 sm:h-5 text-orange-400 mx-auto mb-1"}),e.jsx("span",{className:"text-xs text-orange-600 font-medium",children:"Sin imagen"})]})})}),e.jsxs(Z,{className:"absolute -top-1 -left-1 bg-orange-500 text-white animate-pulse text-xs px-1 py-0.5",children:[e.jsx(Ie,{className:"w-2.5 h-2.5 mr-0.5"}),e.jsx("span",{className:"hidden sm:inline",children:"Del D√≠a"}),e.jsx("span",{className:"sm:hidden",children:"Hoy"})]}),e.jsx("div",{className:"absolute -bottom-1 -right-1 bg-red-500 text-white rounded-full px-1.5 py-0.5 text-xs font-bold",children:$.hours>0?`${$.hours}h`:`${$.minutes}m`})]}),e.jsxs("div",{className:"flex-1 p-3 min-w-0",children:[e.jsxs("div",{className:"flex justify-between items-start mb-2",children:[e.jsxs("div",{className:"flex-1 min-w-0 mr-2",children:[e.jsx("h3",{className:"font-semibold text-sm sm:text-base text-gray-900 line-clamp-1 mb-1",children:S.name}),S.description&&e.jsx("p",{className:"text-xs text-gray-500 line-clamp-1 mb-1",children:S.description}),e.jsxs("div",{className:"flex items-center gap-1 text-xs text-gray-400 mb-1",children:[e.jsx(de,{className:"w-2.5 h-2.5"}),e.jsxs("span",{className:"truncate",children:["por ",(l==null?void 0:l.business_name)||"Este negocio"]})]})]}),e.jsxs("div",{className:"text-right flex-shrink-0",children:[e.jsxs("div",{className:"text-lg sm:text-xl font-bold text-orange-600",children:["Q",(bs=S.price)==null?void 0:bs.toFixed(2)]}),e.jsxs("div",{className:"flex items-center gap-0.5 text-xs text-gray-500 justify-end",children:[e.jsx(le,{className:"w-3 h-3 fill-yellow-400 text-yellow-400"}),e.jsx("span",{children:"4.5"})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2 mb-2 text-xs",children:[!$.isExpired&&e.jsxs("div",{className:"flex items-center gap-1 text-orange-600 bg-orange-50 px-1.5 py-0.5 rounded",children:[e.jsx(me,{className:"w-2.5 h-2.5"}),e.jsx("span",{className:"font-medium",children:$.hours>0?`${$.hours}h ${$.minutes}m`:`${$.minutes}m`})]}),e.jsx(Z,{className:`text-xs ${Fe()} px-1.5 py-0.5`,children:e.jsx("span",{children:S.stock_quantity===0?"Agotado":S.stock_quantity<=3?`¬°${S.stock_quantity}!`:`${S.stock_quantity} disponibles`})}),ne>0&&e.jsx(Z,{className:"bg-orange-100 text-orange-700 text-xs font-semibold px-1.5 py-0.5",children:ne}),!$.isExpired&&$.hours<2&&e.jsx(Z,{className:"bg-yellow-100 text-yellow-700 text-xs animate-pulse px-1.5 py-0.5",children:"¬°Urgente!"})]}),$.isExpired&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded p-1.5 mb-2",children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Ze,{className:"w-3 h-3 text-red-600 flex-shrink-0"}),e.jsx("span",{className:"text-xs text-red-700 font-medium",children:"Oferta expirada"})]})}),ne>0?e.jsxs("div",{className:"flex items-center gap-1 mb-2",children:[e.jsx(L,{size:"sm",variant:"outline",onClick:()=>X(S.id,ne-1),disabled:Pe,className:"h-7 w-7 p-0",children:e.jsx(We,{className:"w-3 h-3"})}),u===S.id?e.jsx(be,{type:"number",value:N,onChange:Re=>J(Re.target.value),onBlur:()=>ie(S.id),onKeyDown:Re=>U(Re,S.id),className:"w-12 h-7 text-center text-xs p-1",autoFocus:!0}):e.jsx("button",{onClick:()=>P(S.id,ne),className:"w-12 h-7 text-xs font-medium bg-gray-100 rounded border hover:bg-gray-200 flex items-center justify-center",title:"Haz clic para editar cantidad",children:ne}),e.jsx(L,{size:"sm",variant:"outline",onClick:()=>X(S.id,ne+1),disabled:Pe||S.stock_quantity<=ne,className:"h-7 w-7 p-0",children:e.jsx(Se,{className:"w-3 h-3"})})]}):null,e.jsx(L,{onClick:()=>{ne>0?X(S.id,ne+1):(console.log("üç∫ DailyProductCard button clicked - should call handleAddDailyToCart"),O(S.id,S.name))},disabled:!S.is_available||Pe||S.stock_quantity<=0||$.isExpired,className:"w-full h-8 sm:h-9 bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-600 hover:to-red-600 text-white text-sm font-medium",children:Pe?e.jsxs(e.Fragment,{children:[e.jsx(wa,{className:"w-3 h-3 mr-1 animate-spin"}),e.jsx("span",{className:"sm:hidden",children:"..."}),e.jsx("span",{className:"hidden sm:inline",children:"Agregando..."})]}):S.stock_quantity<=0?"Agotado":$.isExpired?"Expirado":ne>0?e.jsxs(e.Fragment,{children:[e.jsx(Se,{className:"w-3 h-3 mr-1"}),e.jsx("span",{className:"sm:hidden",children:"+1"}),e.jsx("span",{className:"hidden sm:inline",children:"+1 m√°s"})]}):e.jsxs(e.Fragment,{children:[e.jsx(we,{className:"w-3 h-3 mr-1"}),e.jsx("span",{className:"sm:hidden",children:"Agregar"}),e.jsx("span",{className:"hidden sm:inline",children:"Agregar al carrito"})]})})]})]})})})};return z?e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-orange-500 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"Cargando perfil del comercio..."})]})}):l?e.jsxs("div",{className:"min-h-screen bg-gray-50",children:[e.jsx("div",{className:"bg-white border-b border-gray-200 px-4 py-3",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs(L,{onClick:r,size:"sm",variant:"ghost",className:"text-gray-600 hover:text-gray-900",children:[e.jsx(Be,{className:"w-4 h-4 mr-2"}),"Volver"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(L,{onClick:F,disabled:t,size:"sm",variant:"ghost",className:"text-green-600 hover:text-green-900 hover:bg-green-50",children:e.jsx(qe,{className:`w-4 h-4 ${t?"animate-spin":""}`})}),e.jsx(L,{size:"sm",variant:"ghost",className:"text-gray-600 hover:text-gray-900",children:e.jsx(Ye,{className:"w-4 h-4"})}),e.jsx(L,{size:"sm",variant:"ghost",className:"text-gray-600 hover:text-gray-900",children:e.jsx(pr,{className:"w-4 h-4"})})]})]})}),e.jsxs("div",{className:"px-4 py-4 bg-white",children:[e.jsxs("div",{className:"flex items-start gap-4",children:[ge&&e.jsx("div",{className:"w-16 h-16 rounded-2xl bg-gray-100 shadow-md p-1 flex-shrink-0",children:e.jsx(ye,{src:ge,alt:`Logo de ${l.business_name}`,className:"w-full h-full object-cover rounded-xl"})}),e.jsx("div",{className:"flex-1 min-w-0",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("h1",{className:"text-xl font-bold text-gray-900 truncate",children:l.business_name}),e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["Actualizado: ",i.toLocaleTimeString()]}),e.jsxs("div",{className:"flex items-center gap-3 mt-2",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(le,{className:"w-4 h-4 text-yellow-400 fill-current mr-1"}),e.jsx("span",{className:"text-sm font-medium",children:l.rating.toFixed(1)}),e.jsxs("span",{className:"text-xs text-gray-500 ml-1",children:["(",l.products_count," productos)"]})]}),e.jsx(Z,{className:`text-xs px-2 py-1 ${l.is_open_now?"bg-green-100 text-green-700 border-green-200":"bg-red-100 text-red-700 border-red-200"}`,variant:"outline",children:l.is_open_now?"üü¢ Abierto":"üî¥ Cerrado"})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-4 mt-3 text-sm text-gray-600",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(Oe,{className:"w-4 h-4 mr-1 text-gray-400"}),e.jsx("span",{className:"truncate",children:l.address||l.business_address||"Direcci√≥n no disponible"})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx(me,{className:"w-4 h-4 mr-1 text-gray-400"}),e.jsx("span",{children:"25-35 min"})]})]})]}),l.is_verified&&e.jsx("div",{className:"ml-3",children:e.jsxs(Z,{className:"bg-blue-50 text-blue-700 border-blue-200",variant:"outline",children:[e.jsx(Us,{className:"w-3 h-3 mr-1"}),"Verificado"]})})]})})]}),e.jsx("div",{className:"mt-4 pt-4 border-t border-gray-100",children:e.jsxs("div",{className:"grid grid-cols-3 gap-3 sm:gap-4",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"w-10 h-10 bg-orange-100 rounded-xl flex items-center justify-center mx-auto mb-2",children:e.jsx(we,{className:"w-5 h-5 text-orange-600"})}),e.jsx("p",{className:"text-xs text-gray-500 mb-1",children:"Pedido m√≠nimo"}),e.jsx("p",{className:"text-sm font-semibold text-gray-900",children:"Q50"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"w-10 h-10 bg-green-100 rounded-xl flex items-center justify-center mx-auto mb-2",children:e.jsx(me,{className:"w-5 h-5 text-green-600"})}),e.jsx("p",{className:"text-xs text-gray-500 mb-1",children:"Costo env√≠o"}),e.jsx("p",{className:"text-sm font-semibold text-gray-900",children:"Q15"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"w-10 h-10 bg-blue-100 rounded-xl flex items-center justify-center mx-auto mb-2",children:e.jsx(Me,{className:"w-5 h-5 text-blue-600"})}),e.jsx("p",{className:"text-xs text-gray-500 mb-1",children:"Tiempo entrega"}),e.jsx("p",{className:"text-sm font-semibold text-gray-900",children:"25-35 min"})]})]})})]}),B&&e.jsx("div",{className:"relative w-full h-40 mx-4 mb-4 rounded-xl overflow-hidden",children:e.jsx(ye,{src:B,alt:`Portada de ${l.business_name}`,className:"w-full h-full object-cover"})}),e.jsx("div",{className:"bg-gray-50",children:e.jsx("div",{className:"px-4 mb-4",children:e.jsx(Q,{className:"bg-white shadow-lg border-0 rounded-2xl overflow-hidden",children:e.jsx(H,{className:"p-0",children:e.jsxs(es,{value:M,onValueChange:y,className:"w-full",children:[e.jsxs(ss,{className:"grid w-full grid-cols-3 bg-gray-50 p-1 m-2 rounded-xl",children:[e.jsxs(_e,{value:"productos",className:"rounded-lg text-sm font-medium data-[state=active]:bg-white data-[state=active]:shadow-sm transition-all",children:[e.jsx(xe,{className:"w-4 h-4 mr-2"}),"Productos (",w.length,")"]}),e.jsxs(_e,{value:"dia",className:"rounded-lg text-sm font-medium data-[state=active]:bg-white data-[state=active]:shadow-sm transition-all",children:[e.jsx(Me,{className:"w-4 h-4 mr-2"}),"Del D√≠a (",f.length,")"]}),e.jsxs(_e,{value:"info",className:"rounded-lg text-sm font-medium data-[state=active]:bg-white data-[state=active]:shadow-sm transition-all",children:[e.jsx(Cs,{className:"w-4 h-4 mr-2"}),"Info"]})]}),e.jsxs("div",{className:"px-3 py-4",children:[e.jsx(ve,{value:"productos",className:"mt-0",children:z?e.jsx("div",{className:"space-y-3",children:[...Array(6)].map((S,W)=>e.jsx("div",{className:"bg-gray-100 rounded-xl h-24 animate-pulse"},W))}):w&&w.length>0?e.jsx("div",{className:"space-y-3",children:w.map(S=>e.jsx(A,{product:S},S.id))}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(xe,{className:"w-12 h-12 text-gray-300 mx-auto mb-3"}),e.jsx("p",{className:"text-gray-500 mb-2",children:"No hay productos disponibles"}),e.jsx("p",{className:"text-xs text-gray-400",children:w&&w.length>0?`Se encontraron ${w.length} productos pero no est√°n disponibles`:"No se pudieron cargar los productos"}),w&&w.length>0&&e.jsx("button",{onClick:()=>console.log("üîç Productos encontrados:",w),className:"mt-2 text-xs text-blue-500 hover:text-blue-700",children:"Ver detalles en consola"})]})}),e.jsx(ve,{value:"dia",className:"mt-0",children:z?e.jsx("div",{className:"space-y-3",children:[...Array(3)].map((S,W)=>e.jsx("div",{className:"bg-gray-100 rounded-xl h-24 animate-pulse"},W))}):f&&f.length>0?e.jsx("div",{className:"space-y-3",children:f.map(S=>e.jsx(ae,{product:S},S.id))}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Me,{className:"w-12 h-12 text-gray-300 mx-auto mb-3"}),e.jsx("p",{className:"text-gray-500 mb-2",children:"No hay productos del d√≠a"}),e.jsx("p",{className:"text-xs text-gray-400",children:f&&f.length>0?`Se encontraron ${f.length} productos del d√≠a pero no est√°n disponibles`:"No se pudieron cargar los productos del d√≠a"}),f&&f.length>0&&e.jsx("button",{onClick:()=>console.log("üîç Productos del d√≠a encontrados:",f),className:"mt-2 text-xs text-blue-500 hover:text-blue-700",children:"Ver detalles en consola"})]})}),e.jsx(ve,{value:"info",className:"mt-0",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-gray-50 rounded-xl p-4",children:[e.jsxs("h3",{className:"font-semibold text-gray-900 mb-3 flex items-center",children:[e.jsx(me,{className:"w-5 h-5 mr-2 text-blue-600"}),"Horarios de Atenci√≥n"]}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Lunes - Viernes:"}),e.jsx("span",{className:"font-medium",children:"8:00 AM - 9:00 PM"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"S√°bados:"}),e.jsx("span",{className:"font-medium",children:"8:00 AM - 10:00 PM"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Domingos:"}),e.jsx("span",{className:"font-medium",children:"9:00 AM - 8:00 PM"})]})]})]}),e.jsxs("div",{className:"bg-gray-50 rounded-xl p-4",children:[e.jsxs("h3",{className:"font-semibold text-gray-900 mb-3 flex items-center",children:[e.jsx(cs,{className:"w-5 h-5 mr-2 text-green-600"}),"Contacto"]}),e.jsxs("div",{className:"space-y-2 text-sm",children:[console.log("üî• RENDER CONTACTO:",{phone_options:[l.phone,l.business_phone,(fe=l.user)==null?void 0:fe.phone],address_options:[l.address,l.business_address,(Ce=l.user)==null?void 0:Ce.address],final_phone:l.phone||l.business_phone||((ce=l.user)==null?void 0:ce.phone)||"No disponible",final_address:l.address||l.business_address||((as=l.user)==null?void 0:as.address)||"Direcci√≥n no disponible"}),e.jsxs("div",{className:"flex items-center",children:[e.jsx(cs,{className:"w-4 h-4 mr-2 text-gray-400"}),e.jsx("span",{children:l.phone||l.business_phone||((vs=l.user)==null?void 0:vs.phone)||"No disponible"})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx(Oe,{className:"w-4 h-4 mr-2 text-gray-400"}),e.jsx("span",{children:l.address||l.business_address||((ys=l.user)==null?void 0:ys.address)||"Direcci√≥n no disponible"})]})]})]}),(l.description||l.business_description)&&e.jsxs("div",{className:"bg-gray-50 rounded-xl p-4",children:[e.jsxs("h3",{className:"font-semibold text-gray-900 mb-3 flex items-center",children:[e.jsx(Cs,{className:"w-5 h-5 mr-2 text-purple-600"}),"Acerca de"]}),e.jsx("p",{className:"text-sm text-gray-600 leading-relaxed",children:l.description||l.business_description})]})]})})]})]})})})})}),e.jsx(hs,{onCartClick:()=>{console.log("üõí Carrito flotante clicked desde BusinessProfile!"),n?n():alert("üõí Carrito flotante funcional! Navegaci√≥n no configurada.")}})]}):e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx(Ee,{className:"w-16 h-16 text-gray-300 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"No se pudo cargar el comercio"}),e.jsx(L,{onClick:r,children:"Volver"})]})})}function pt({onAlert:s}){const{user:r}=ke(),[n,h]=x.useState([]),[m,c]=x.useState(!1),p=x.useCallback(async()=>{if(r)try{let l=R.from("orders").select("*");switch(r.role){case"vendedor":l=l.eq("seller_id",r.id);break;case"comprador":l=l.eq("buyer_id",r.id);break;case"repartidor":l=l.eq("driver_id",r.id);break;default:return}l=l.in("status",["pending","accepted","ready","assigned","picked-up","in-transit"]);const{data:T}=await l;if(!T)return;const w=new Date,q=[];T.forEach(f=>{const E=new Date(f.created_at),z=f.accepted_at?new Date(f.accepted_at):null,G=f.ready_at?new Date(f.ready_at):null,M=f.status==="assigned"?new Date(f.updated_at):null,y=f.picked_up_at?new Date(f.picked_up_at):null;let j=E,I=0,t="low";switch(f.status){case"pending":if(j=E,I=10,r.role==="vendedor"){const a=(w.getTime()-j.getTime())/6e4;a>15?t="critical":a>12?t="high":a>8&&(t="medium")}break;case"accepted":if(j=z||E,I=f.delivery_type==="dine-in"?25:30,r.role==="vendedor"){const a=(w.getTime()-j.getTime())/6e4;a>I+15?t="critical":a>I+10?t="high":a>I&&(t="medium")}break;case"ready":if(j=G||E,f.delivery_type==="pickup"){if(I=20,r.role==="comprador"){const a=(w.getTime()-j.getTime())/6e4;a>30?t="critical":a>25?t="high":a>15&&(t="medium")}}else if(f.delivery_type==="delivery"){I=15;const a=(w.getTime()-j.getTime())/(1e3*60);a>25?t="critical":a>20?t="high":a>15&&(t="medium")}break;case"assigned":if(j=M||G||E,I=15,r.role==="repartidor"){const a=(w.getTime()-j.getTime())/6e4;a>25?t="critical":a>20?t="high":a>15&&(t="medium")}break;case"picked-up":case"in-transit":j=y||M||G||E,I=45;const i=(w.getTime()-j.getTime())/(1e3*60);i>60?t="critical":i>50?t="high":i>40&&(t="medium");break}const k=(w.getTime()-j.getTime())/(1e3*60);k>I&&t!=="low"&&q.push({orderId:f.id,status:f.status,timeSinceStatus:Math.floor(k),customerName:f.customer_name||"Cliente",total:f.total,urgencyLevel:t})}),h(q),q.filter(f=>f.urgencyLevel==="critical").forEach(f=>{s==null||s(f),console.error(`üö® ALERTA CR√çTICA: Orden ${f.orderId.slice(-6)} en estado ${f.status} por ${f.timeSinceStatus} minutos`)})}catch(l){console.error("Error checking timeout alerts:",l)}},[r,s]),d=x.useCallback(async l=>{if(!(!r||l.length===0))try{for(const T of l){const{data:w}=await R.from("orders").select("buyer_id, seller_id, driver_id").eq("id",T.orderId).single();if(!w)continue;const q=[];switch(T.status){case"pending":q.push({recipient_id:w.seller_id,type:"order_timeout_critical",title:"üö® ORDEN CR√çTICA",message:`Orden pendiente por ${T.timeSinceStatus} minutos - ACEPTAR URGENTE`,data:{order_id:T.orderId,timeout_minutes:T.timeSinceStatus}}),q.push({recipient_id:w.buyer_id,type:"order_delay",title:"Demora en tu pedido",message:"Tu pedido est√° tardando m√°s de lo esperado. Te mantendremos informado.",data:{order_id:T.orderId}});break;case"accepted":q.push({recipient_id:w.seller_id,type:"preparation_timeout",title:"‚è∞ PREPARACI√ìN LENTA",message:`Orden en preparaci√≥n por ${T.timeSinceStatus} minutos`,data:{order_id:T.orderId,timeout_minutes:T.timeSinceStatus}});break;case"ready":T.timeSinceStatus>20&&q.push({recipient_id:w.buyer_id,type:"pickup_reminder",title:"üì¶ Tu pedido est√° listo",message:`Tu pedido lleva ${T.timeSinceStatus} minutos esperando ser recogido`,data:{order_id:T.orderId,waiting_minutes:T.timeSinceStatus}});break}q.length>0&&await R.from("notifications").insert(q)}}catch(T){console.error("Error sending critical timeout notifications:",T)}},[r]);x.useEffect(()=>{if(!r)return;c(!0),p();const l=setInterval(p,2*60*1e3);return()=>{clearInterval(l),c(!1)}},[r,p]),x.useEffect(()=>{const l=n.filter(T=>T.urgencyLevel==="critical");l.length>0&&d(l)},[n,d]);const g=l=>{switch(l){case"critical":return"bg-red-100 border-red-300 text-red-800";case"high":return"bg-orange-100 border-orange-300 text-orange-800";case"medium":return"bg-yellow-100 border-yellow-300 text-yellow-800";default:return"bg-gray-100 border-gray-300 text-gray-800"}},_=l=>{switch(l){case"critical":return e.jsx(ka,{className:"w-4 h-4"});case"high":return e.jsx(Ze,{className:"w-4 h-4"});case"medium":return e.jsx(me,{className:"w-4 h-4"});default:return e.jsx(qa,{className:"w-4 h-4"})}},D=l=>{switch(l.status){case"pending":return`Esperando aceptaci√≥n por ${l.timeSinceStatus} min`;case"accepted":return`En preparaci√≥n por ${l.timeSinceStatus} min`;case"ready":return`Listo por ${l.timeSinceStatus} min`;case"assigned":return`Repartidor asignado hace ${l.timeSinceStatus} min`;case"picked-up":case"in-transit":return`En camino por ${l.timeSinceStatus} min`;default:return`En estado ${l.status} por ${l.timeSinceStatus} min`}};return!m||n.length===0?null:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(me,{className:"w-5 h-5 text-orange-600"}),e.jsxs("h3",{className:"text-lg font-semibold text-gray-900",children:["Alertas de tiempo (",n.length,")"]})]}),e.jsx("div",{className:"space-y-2",children:n.map(l=>e.jsx("div",{className:`border rounded-lg p-3 ${g(l.urgencyLevel)}`,children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[_(l.urgencyLevel),e.jsxs("div",{children:[e.jsxs("p",{className:"font-medium",children:[l.customerName," - Q",l.total.toFixed(2)]}),e.jsx("p",{className:"text-sm",children:D(l)}),e.jsxs("p",{className:"text-xs opacity-75",children:["Orden #",l.orderId.slice(-6)]})]})]}),l.urgencyLevel==="critical"&&e.jsxs("div",{className:"flex items-center space-x-1 text-red-600",children:[e.jsx("span",{className:"text-xs font-bold",children:"URGENTE"}),e.jsx("div",{className:"w-2 h-2 bg-red-500 rounded-full animate-pulse"})]})]})},l.orderId))})]})}function Jt(){var G;const{user:s,signOut:r}=ke(),{getCartItemCount:n}=Te(),[h,m]=x.useState("home"),[c,p]=x.useState("dashboard"),[d,g]=x.useState(""),[_,D]=x.useState(""),l=M=>{g(M),p("business-profile")},T=()=>{p("dashboard"),g("")},w=()=>{p("dashboard"),m("home")},q=M=>{D(M),p("order-tracking")},f=()=>{p("dashboard"),D("")},E=(M,y)=>{console.log(`üö® Alerta cr√≠tica para comprador: ${M} - ${y}`)},z=M=>{console.log(`‚è∞ Alerta de timeout: Orden ${M.orderId} - ${M.timeSinceStatus} min`)};return c==="business-profile"?e.jsx(ht,{businessId:d,onBack:T,onShowCart:()=>p("cart")}):c==="cart"?e.jsx(Jr,{onContinueShopping:()=>p("dashboard"),onProceedToCheckout:()=>p("checkout")}):c==="checkout"?e.jsx(ut,{onBack:w,onComplete:()=>{p("dashboard"),m("orders")}}):c==="order-tracking"?e.jsx(Es,{children:e.jsx(Zs,{orderId:_,onBack:f})}):e.jsx(Es,{children:e.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-orange-50 to-green-50",children:[e.jsx(ar,{showBanner:!0,enableAutoActivation:!1}),e.jsx("div",{className:"container mx-auto px-4",children:typeof window<"u"&&"Notification"in window&&Notification.permission!=="granted"&&e.jsx("div",{className:"flex justify-end mb-2"})}),e.jsx(rr,{onNotification:E}),e.jsx(pt,{onAlert:z}),_&&e.jsx("div",{className:"container mx-auto px-4 mb-4",children:e.jsx(tr,{orderId:_})}),e.jsx("div",{className:"bg-white border-b border-gray-200 shadow-sm sticky top-0 z-30 mb-2",children:e.jsx("div",{className:"container mx-auto px-4 py-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"bg-gradient-to-r from-orange-500 to-orange-600 p-2 rounded-lg",children:e.jsx(de,{className:"w-5 h-5 md:w-6 md:h-6 text-white"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-lg md:text-xl font-bold bg-gradient-to-r from-orange-600 to-red-600 bg-clip-text text-transparent",children:"TRATO"}),e.jsxs("p",{className:"text-xs md:text-sm text-gray-600 hidden sm:block",children:["¬°Hola, ",((G=s==null?void 0:s.email)==null?void 0:G.split("@")[0])||"guichointeriano","!"]})]})]}),e.jsxs(L,{variant:"outline",onClick:r,className:"flex items-center gap-1 text-xs md:text-sm px-2 md:px-4 py-2 min-h-[44px]",children:[e.jsx(ir,{className:"w-4 h-4"}),e.jsx("span",{children:"Cerrar Sesi√≥n"})]})]})})}),e.jsx(gt,{}),e.jsxs("div",{className:"main-content container mx-auto px-4 py-4 md:py-6",style:{paddingBottom:window.innerWidth<=768?"80px":"24px"},children:[e.jsx("div",{className:"block md:hidden",children:e.jsx("div",{className:"mobile-bottom-nav",style:{position:"fixed",bottom:0,left:0,right:0,background:"white",borderTop:"2px solid #e5e7eb",padding:"12px",zIndex:50,boxShadow:"0 -4px 6px -1px rgba(0, 0, 0, 0.1)"},children:e.jsx("div",{className:"grid grid-cols-3 gap-1",children:[{id:"home",label:"Inicio",icon:_s},{id:"orders",label:"Pedidos",icon:xe},{id:"profile",label:"Perfil",icon:Ae}].map(M=>{const y=M.icon,j=h===M.id;return e.jsxs("button",{onClick:()=>m(M.id),style:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",gap:"4px",padding:"8px",borderRadius:"8px",minHeight:"60px",fontSize:"10px",fontWeight:"500",backgroundColor:j?"#fef3c7":"transparent",color:j?"#f97316":"#6b7280",border:"none",cursor:"pointer",transition:"all 0.2s"},children:[e.jsx(y,{className:"w-5 h-5"}),e.jsx("span",{style:{fontSize:"10px",fontWeight:"500",lineHeight:"1.2"},children:M.label})]},M.id)})})})}),e.jsx("div",{className:"hidden md:block",children:e.jsxs(es,{value:h,onValueChange:m,className:"space-y-6",children:[e.jsx(ss,{className:"grid w-full grid-cols-3 lg:w-2/3 mx-auto bg-white border border-gray-200",children:[{id:"home",label:"Inicio",icon:_s},{id:"orders",label:"Pedidos",icon:xe},{id:"profile",label:"Perfil",icon:Ae}].map(M=>{const y=M.icon;return e.jsxs(_e,{value:M.id,className:"flex flex-col items-center gap-1 p-4 data-[state=active]:bg-green-100 data-[state=active]:text-green-700 relative",children:[e.jsx(y,{className:"w-5 h-5"}),e.jsx("span",{className:"text-xs font-medium",children:M.label})]},M.id)})}),e.jsx(ve,{value:"home",className:"space-y-6",children:e.jsx(Is,{onBusinessClick:l,onShowCart:()=>p("cart")})}),e.jsx(ve,{value:"orders",className:"space-y-6",children:e.jsx(Ds,{onViewOrder:q})}),e.jsx(ve,{value:"profile",className:"space-y-6",children:e.jsx(As,{onShowCart:()=>p("cart")})})]})}),e.jsxs("div",{className:"block md:hidden",children:[h==="home"&&e.jsx(Is,{onBusinessClick:l,onShowCart:()=>p("cart")}),h==="orders"&&e.jsx(Ds,{onViewOrder:q}),h==="profile"&&e.jsx(As,{onShowCart:()=>p("cart")})]})]}),c==="order-tracking"&&e.jsx("div",{className:"fixed top-4 left-4 right-4 md:left-auto md:right-4 md:w-auto z-50",children:e.jsx(Q,{className:"mobile-card border-green-200 bg-green-50",children:e.jsx(H,{className:"mobile-card-content",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(oe,{className:"w-5 h-5 text-green-600 flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"mobile-text font-medium text-green-800 mb-1",children:"¬°Orden creada exitosamente!"}),e.jsx("p",{className:"mobile-text-small text-green-600",children:"Puedes seguir el estado de tu pedido aqu√≠"})]})]})})})}),e.jsx(Da,{})]})})}export{Jt as BuyerDashboard};
