import{g as D,u as A,F as S,r as d,s as j,t as v,j as n,C as I,c as V,B as E,v as $,X as U,f as R,p as O,e as z}from"./index-4-AwG29v.js";import{T as L}from"./triangle-alert-Bssc8toj.js";import{M as G}from"./MobileToastNotifications-3ugepJgb.js";/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const W=[["path",{d:"M11 4.702a.705.705 0 0 0-1.203-.498L6.413 7.587A1.4 1.4 0 0 1 5.416 8H3a1 1 0 0 0-1 1v6a1 1 0 0 0 1 1h2.416a1.4 1.4 0 0 1 .997.413l3.383 3.384A.705.705 0 0 0 11 19.298z",key:"uqj9uw"}],["path",{d:"M16 9a5 5 0 0 1 0 6",key:"1q6k2b"}],["path",{d:"M19.364 18.364a9 9 0 0 0 0-12.728",key:"ijwkga"}]],H=D("volume-2",W);/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Q=[["path",{d:"M12 20h.01",key:"zekei9"}],["path",{d:"M8.5 16.429a5 5 0 0 1 7 0",key:"1bycff"}],["path",{d:"M5 12.859a10 10 0 0 1 5.17-2.69",key:"1dl1wf"}],["path",{d:"M19 12.859a10 10 0 0 0-2.007-1.523",key:"4k23kn"}],["path",{d:"M2 8.82a15 15 0 0 1 4.177-2.643",key:"1grhjp"}],["path",{d:"M22 8.82a15 15 0 0 0-11.288-3.764",key:"z3jwby"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]],F=D("wifi-off",Q);/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const X=[["path",{d:"M12 20h.01",key:"zekei9"}],["path",{d:"M2 8.82a15 15 0 0 1 20 0",key:"dnpr2z"}],["path",{d:"M5 12.859a10 10 0 0 1 14 0",key:"1x1e6c"}],["path",{d:"M8.5 16.429a5 5 0 0 1 7 0",key:"1bycff"}]],Y=D("wifi",X);var k=(t=>(t.NEW_ORDER="new-order",t.ORDER_ASSIGNED="order-assigned",t.ORDER_READY="order-ready",t.ORDER_DELIVERED="order-delivered",t.NEW_PRODUCT="new-product",t.GENERAL="general",t))(k||{});const J={enabled:!0,volume:.7,sounds:{"new-order":{frequency:800,duration:300,pattern:"triple"},"order-assigned":{frequency:600,duration:200,pattern:"double"},"order-ready":{frequency:1e3,duration:250,pattern:"double"},"order-delivered":{frequency:500,duration:400,pattern:"single"},"new-product":{frequency:700,duration:200,pattern:"single"},general:{frequency:650,duration:200,pattern:"single"}}};function P(){const{user:t}=A(),{showOrderNotification:l,showDeliveryNotification:o,requestPermission:g}=S(),i=d.useRef(null),f=d.useRef(J);d.useEffect(()=>{if(!i.current)try{i.current=new(window.AudioContext||window.webkitAudioContext)}catch(r){console.warn("Web Audio API not supported:",r)}return g().then(r=>{r?console.log("✅ Permisos de notificación concedidos"):console.warn("⚠️ Permisos de notificación denegados")}),()=>{if(i.current&&i.current.state!=="closed")try{i.current.close().catch(r=>{console.warn("Error closing AudioContext:",r)})}catch(r){console.warn("Error closing AudioContext:",r)}}},[g]);const s=d.useCallback(r=>{if(!f.current.enabled||!i.current)return;const e=f.current.sounds[r],a=i.current;if(a.state==="closed"){console.warn("AudioContext is closed, cannot play sound");return}a.state==="suspended"&&a.resume().catch(h=>{console.warn("Error resuming AudioContext:",h)});const c=(h=0)=>{setTimeout(()=>{try{if(a.state==="closed")return;const p=a.createOscillator(),_=a.createGain();p.connect(_),_.connect(a.destination),p.frequency.value=e.frequency,p.type="sine",_.gain.setValueAtTime(0,a.currentTime),_.gain.linearRampToValueAtTime(f.current.volume,a.currentTime+.01),_.gain.exponentialRampToValueAtTime(.01,a.currentTime+e.duration/1e3),p.start(a.currentTime),p.stop(a.currentTime+e.duration/1e3)}catch(p){console.warn("Error playing sound tone:",p)}},h)};switch(e.pattern){case"single":c();break;case"double":c(),c(e.duration+100);break;case"triple":c(),c(e.duration+100),c((e.duration+100)*2);break}},[]),x=d.useCallback(()=>{if(!t||t.role!=="vendedor")return;const r=j.channel("vendor-sound-notifications").on("postgres_changes",{event:"INSERT",schema:"public",table:"orders",filter:`seller_id=eq.${t.id}`},e=>{console.log("🔊 Vendor: New order notification with sound"),s("new-order"),window.notifyNewOrder&&window.notifyNewOrder({id:e.new.id,customer_name:e.new.customer_name||"Cliente",total:e.new.total_amount||e.new.total||0,delivery_type:e.new.delivery_type||"pickup"}),l({customer_name:e.new.customer_name||"Cliente",total:e.new.total_amount||e.new.total||0,delivery_type:e.new.delivery_type||"pickup",order_id:e.new.id}),v.success("¡Nueva orden recibida!",{description:`Pedido por Q${e.new.total_amount||e.new.total||0}`,duration:5e3})}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"orders",filter:`seller_id=eq.${t.id}`},e=>{var h,p;const a=(h=e.old)==null?void 0:h.status,c=(p=e.new)==null?void 0:p.status;a==="ready"&&c==="assigned"&&(console.log("🔊 Vendor: Driver assigned notification with sound"),s("order-assigned"),window.notifyDriverAssigned&&window.notifyDriverAssigned({id:e.new.id,customer_name:e.new.customer_name}),o("Un repartidor aceptó la entrega"),v.info("Repartidor asignado",{description:"Un repartidor aceptó la entrega",duration:4e3})),c==="delivered"&&(console.log("🔊 Vendor: Order delivered notification with sound"),s("order-delivered"),o("El pedido fue entregado exitosamente"),v.success("Pedido entregado",{description:"El pedido fue entregado exitosamente",duration:4e3}))}).subscribe();return()=>r.unsubscribe()},[t,s]),b=d.useCallback(()=>{if(!t||t.role!=="repartidor")return;const r=j.channel("driver-sound-notifications").on("postgres_changes",{event:"UPDATE",schema:"public",table:"orders",filter:"status=eq.ready"},e=>{console.log("🔊 Driver: New delivery available with sound"),s("order-ready"),window.notifyDeliveryAvailable&&window.notifyDeliveryAvailable({id:e.new.id,customer_name:e.new.customer_name||"Cliente",delivery_address:e.new.delivery_address||"Dirección no especificada",total:e.new.total_amount||e.new.total||0}),o("Nueva entrega disponible",`Pedido de Q${e.new.total_amount||e.new.total||0} listo para recoger`),v.info("¡Nueva entrega disponible!",{description:`Pedido de Q${e.new.total_amount||e.new.total||0} listo para recoger`,duration:6e3})}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"orders",filter:`driver_id=eq.${t.id}`},e=>{var c;((c=e.new)==null?void 0:c.status)==="assigned"&&(console.log("🔊 Driver: Order assigned to you with sound"),s("order-assigned"),o("Entrega asignada","Tienes una nueva entrega asignada"),v.success("Entrega asignada",{description:"Tienes una nueva entrega asignada",duration:4e3}))}).subscribe();return()=>r.unsubscribe()},[t,s,o]),u=d.useCallback(()=>{if(!t||t.role!=="comprador")return;const r=j.channel("buyer-sound-notifications").on("postgres_changes",{event:"UPDATE",schema:"public",table:"orders",filter:`buyer_id=eq.${t.id}`},e=>{var h,p;const a=(h=e.old)==null?void 0:h.status,c=(p=e.new)==null?void 0:p.status;a==="pending"&&c==="accepted"&&(console.log("🔊 Buyer: Order accepted with sound"),s("general"),l({customer_name:"Tu pedido",total:e.new.total_amount||e.new.total||0,delivery_type:e.new.delivery_type||"pickup",order_id:e.new.id}),v.success("Pedido aceptado",{description:"El vendedor aceptó tu pedido",duration:4e3})),c==="ready"&&(console.log("🔊 Buyer: Order ready with sound"),s("order-ready"),l({customer_name:"Tu pedido",total:e.new.total_amount||e.new.total||0,delivery_type:e.new.delivery_type||"pickup",order_id:e.new.id}),v.info("Pedido listo",{description:"Tu pedido está listo para recoger o será entregado pronto",duration:5e3})),c==="assigned"&&(console.log("🔊 Buyer: Driver assigned with sound"),s("order-assigned"),o("Repartidor asignado","Un repartidor está en camino a recoger tu pedido"),v.info("Repartidor asignado",{description:"Un repartidor está en camino a recoger tu pedido",duration:4e3})),c==="delivered"&&(console.log("🔊 Buyer: Order delivered with sound"),s("order-delivered"),window.notifyOrderDelivered&&window.notifyOrderDelivered({id:e.new.id}),l({customer_name:"Tu pedido",total:e.new.total_amount||e.new.total||0,delivery_type:e.new.delivery_type||"pickup",order_id:e.new.id}),v.success("¡Pedido entregado!",{description:"Tu pedido ha sido entregado exitosamente",duration:5e3}))}).on("postgres_changes",{event:"INSERT",schema:"public",table:"daily_products"},e=>{console.log("🔊 Buyer: New product available with sound"),s("new-product"),l({customer_name:"Nuevo producto",total:0,delivery_type:"pickup",order_id:"new-product"}),v.info("¡Nuevo producto disponible!",{description:"Se agregó un nuevo producto al catálogo",duration:4e3})}).subscribe();return()=>r.unsubscribe()},[t,s,l,o]);d.useEffect(()=>{if(!t)return;let r;switch(t.role){case"vendedor":r=x();break;case"repartidor":r=b();break;case"comprador":r=u();break}return r},[t,x,b,u]);const w=d.useCallback(r=>{f.current={...f.current,...r}},[]),m=d.useCallback(r=>{f.current.enabled=r},[]),y=d.useCallback(r=>{f.current.volume=Math.max(0,Math.min(1,r))},[]),N=d.useCallback(r=>{s(r)},[s]);return{playSound:s,updateConfig:w,toggleSounds:m,setVolume:y,testSound:N,config:f.current,isEnabled:f.current.enabled}}function K({onDismiss:t}){const{user:l}=A(),{permission:o,requestPermission:g}=S(),{isEnabled:i,toggleSounds:f,testSound:s}=P(),[x,b]=d.useState(!1),[u,w]=d.useState("checking"),[m,y]=d.useState(!1),[N,r]=d.useState(!1),e=!x&&(o!=="granted"||!i||u==="disconnected");d.useEffect(()=>{l&&(async()=>{w("checking");try{const q=j.channel("banner-test").on("broadcast",{event:"test"},()=>{w("connected")}).subscribe(T=>{T==="SUBSCRIBED"?w("connected"):(T==="CHANNEL_ERROR"||T==="TIMED_OUT")&&w("disconnected")});setTimeout(()=>{j.removeChannel(q)},3e3)}catch{w("disconnected")}})()},[l]);const a=async()=>{r(!0);try{if(o!=="granted"&&!await g()){alert("⚠️ Las notificaciones son necesarias para recibir pedidos. Por favor, permite las notificaciones en la configuración del navegador."),r(!1);return}i||f(!0),setTimeout(()=>{s("general")},500),setTimeout(()=>{b(!0),t==null||t()},1e3)}catch(C){console.error("Error activating notifications:",C),alert("Error al activar notificaciones. Inténtalo de nuevo.")}finally{r(!1)}},c=()=>{b(!0),t==null||t()};if(!e||!l)return null;const h=()=>o==="granted"&&i&&u==="connected"?"bg-green-50 border-green-200":o==="denied"?"bg-red-50 border-red-200":"bg-orange-50 border-orange-200",p=()=>o==="granted"&&i&&u==="connected"?n.jsx(z,{className:"w-5 h-5 text-green-600"}):o==="denied"?n.jsx(L,{className:"w-5 h-5 text-red-600"}):n.jsx(O,{className:"w-5 h-5 text-orange-600"}),_=()=>{switch(l.role){case"vendedor":return{title:"🔔 Activa las notificaciones para no perder ventas",description:"Recibirás alertas sonoras cada vez que llegue un nuevo pedido"};case"repartidor":return{title:"🚚 Activa las notificaciones para nuevas entregas",description:"Te avisaremos cuando haya pedidos listos para entregar"};case"comprador":return{title:"📱 Activa las notificaciones para seguir tus pedidos",description:"Te mantendremos informado del estado de tus órdenes"};default:return{title:"🔔 Activa las notificaciones",description:"Mantente informado de actualizaciones importantes"}}},{title:M,description:B}=_();return n.jsx(I,{className:`mx-4 my-2 shadow-lg ${h()}`,children:n.jsx(V,{className:"p-4",children:n.jsxs("div",{className:"flex items-start gap-3",children:[n.jsx("div",{className:"flex-shrink-0 mt-0.5",children:p()}),n.jsxs("div",{className:"flex-1 min-w-0",children:[n.jsxs("div",{className:"flex items-center justify-between mb-2",children:[n.jsx("h3",{className:"font-semibold text-gray-900 text-sm md:text-base",children:M}),n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx(E,{variant:"ghost",size:"sm",onClick:()=>y(!m),className:"h-6 w-6 p-0",children:n.jsx($,{className:"w-4 h-4"})}),n.jsx(E,{variant:"ghost",size:"sm",onClick:c,className:"h-6 w-6 p-0",children:n.jsx(U,{className:"w-4 h-4"})})]})]}),n.jsx("p",{className:"text-sm text-gray-700 mb-3",children:B}),n.jsxs("div",{className:"flex flex-wrap gap-2 mb-4",children:[n.jsxs(R,{variant:o==="granted"?"default":"destructive",className:"text-xs",children:[n.jsx(O,{className:"w-3 h-3 mr-1"}),o==="granted"?"Permisos ✓":"Sin permisos"]}),n.jsxs(R,{variant:i?"default":"secondary",className:"text-xs",children:[n.jsx(H,{className:"w-3 h-3 mr-1"}),i?"Sonido ✓":"Sin sonido"]}),n.jsxs(R,{variant:u==="connected"?"default":"destructive",className:"text-xs",children:[u==="connected"?n.jsx(Y,{className:"w-3 h-3 mr-1"}):n.jsx(F,{className:"w-3 h-3 mr-1"}),u==="connected"?"Tiempo real ✓":u==="checking"?"Verificando...":"Sin conexión"]})]}),m&&n.jsxs("div",{className:"bg-white bg-opacity-50 rounded-lg p-3 mb-3 text-xs space-y-2",children:[n.jsxs("div",{className:"flex justify-between",children:[n.jsx("span",{children:"Notificaciones del navegador:"}),n.jsx("span",{className:o==="granted"?"text-green-600":"text-red-600",children:o==="granted"?"✅ Activadas":o==="denied"?"❌ Bloqueadas":"⏳ Pendientes"})]}),n.jsxs("div",{className:"flex justify-between",children:[n.jsx("span",{children:"Sonidos:"}),n.jsx("span",{className:i?"text-green-600":"text-gray-600",children:i?"✅ Activados":"⏹️ Desactivados"})]}),n.jsxs("div",{className:"flex justify-between",children:[n.jsx("span",{children:"Conexión en tiempo real:"}),n.jsx("span",{className:u==="connected"?"text-green-600":"text-red-600",children:u==="connected"?"✅ Conectado":u==="checking"?"🔄 Verificando":"❌ Desconectado"})]})]}),n.jsxs("div",{className:"flex gap-2",children:[o!=="granted"||!i?n.jsx(E,{onClick:a,disabled:N,className:"bg-orange-600 hover:bg-orange-700 text-white text-sm px-4 py-2",children:N?n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"Activando..."]}):"Activar Notificaciones"}):n.jsx(E,{onClick:c,variant:"outline",className:"text-sm px-4 py-2",children:"Todo configurado ✓"}),u==="disconnected"&&n.jsx(E,{variant:"outline",size:"sm",onClick:()=>window.location.reload(),className:"text-xs",children:"Reconectar"})]}),typeof window<"u"&&!window.location.protocol.startsWith("https")&&n.jsx("div",{className:"mt-3 p-2 bg-red-100 border border-red-200 rounded text-xs text-red-700",children:"⚠️ Las notificaciones requieren HTTPS. En desarrollo usa: https://localhost:5173"})]})]})})})}function ne({showBanner:t=!0,enableAutoActivation:l=!0,className:o=""}){const{user:g}=A(),{permission:i,requestPermission:f}=S(),{isEnabled:s,toggleSounds:x}=P(),[b,u]=d.useState(!1),[w,m]=d.useState(!1);if(d.useEffect(()=>{if(!g||w||!l)return;if((g.role==="vendedor"||g.role==="repartidor")&&(i!=="granted"||!s)){const e=setTimeout(async()=>{try{i==="default"&&await f(),s||x(!0)}catch(a){console.log("Auto-activation failed:",a)}finally{m(!0)}},2e3);return()=>clearTimeout(e)}else m(!0)},[g,i,s,l,w]),!g)return null;const y=t&&!b&&(i!=="granted"||!s||!w);return n.jsxs("div",{className:`notification-system ${o}`,children:[y&&n.jsx(K,{onDismiss:()=>u(!0)}),n.jsx(G,{})]})}function re(){const{user:t}=A(),{permission:l,requestPermission:o,showNotification:g}=S(),{isEnabled:i,toggleSounds:f,testSound:s}=P(),x=l==="granted"&&i;return{isReady:x,needsSetup:!x&&t,permission:l,soundEnabled:i,setupNotifications:async()=>{try{if(!await o())throw new Error("Push notifications denied");return i||f(!0),(t==null?void 0:t.role)==="vendedor"?await s(k.NEW_ORDER):(t==null?void 0:t.role)==="repartidor"&&await s(k.ORDER_ASSIGNED),!0}catch(m){return console.error("Notification setup failed:",m),!1}},notify:async(m,y)=>{const{body:N,sound:r=k.GENERAL,push:e=!0,data:a}=y||{};try{i&&r&&await s(r),e&&l==="granted"&&await g(m,{body:N,icon:"/icon-192x192.png",data:a,tag:`notification-${Date.now()}`,requireInteraction:(t==null?void 0:t.role)==="vendedor"})}catch(c){console.error("Notification failed:",c)}},testSound:m=>s(m)}}export{ne as N,re as u};
