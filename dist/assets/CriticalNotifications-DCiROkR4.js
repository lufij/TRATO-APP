import{g as h,u as $,r as o,s as i}from"./index-Dv1WvEuL.js";/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const T=[["path",{d:"M8 2v4",key:"1cmpym"}],["path",{d:"M16 2v4",key:"4m81vk"}],["rect",{width:"18",height:"18",x:"3",y:"4",rx:"2",key:"1hopcy"}],["path",{d:"M3 10h18",key:"8toen8"}]],M=h("calendar",T);/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const C=[["path",{d:"M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z",key:"1tc9qg"}],["circle",{cx:"12",cy:"13",r:"3",key:"1vg3eu"}]],S=h("camera",C);/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const q=[["path",{d:"M7.9 20A9 9 0 1 0 4 16.1L2 22Z",key:"vv11sd"}]],f=h("message-circle",q);/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const E=[["polygon",{points:"3 11 22 2 13 21 11 13 3 11",key:"1ltx0t"}]],D=h("navigation",E);/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const P=[["path",{d:"M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z",key:"foiqr5"}]],O=h("phone",P);function I({onNotification:r}){const{user:s}=$(),y=o.useCallback(async()=>{if(!(!s||s.role!=="vendedor"))try{const t=i.channel("stock-alerts").on("postgres_changes",{event:"UPDATE",schema:"public",table:"products",filter:`seller_id=eq.${s.id}`},c=>{const{old:e,new:a}=c;a.stock<=5&&e.stock>5&&(console.warn(`âš ï¸ Stock bajo: ${a.name} (${a.stock} restantes)`),r==null||r("stock_low",`Stock bajo: ${a.name}`)),a.stock===0&&e.stock>0&&(console.error(`ðŸš« AGOTADO: ${a.name}`),r==null||r("stock_out",`Producto agotado: ${a.name}`))}).subscribe();return()=>t.unsubscribe()}catch(t){console.error("Error setting up stock alerts:",t)}},[s,r]),g=o.useCallback(async()=>{if(!s)return;const t=async()=>{try{let e=i.from("orders").select("*");switch(s.role){case"vendedor":e=e.eq("seller_id",s.id);break;case"comprador":e=e.eq("buyer_id",s.id);break;case"repartidor":e=e.eq("driver_id",s.id);break}const{data:a}=await e;if(!a)return;const u=new Date;a.forEach(n=>{const l=new Date(n.created_at),d=(u.getTime()-l.getTime())/(1e3*60);n.status==="pending"&&d>10&&s.role==="vendedor"&&(console.warn(`â° Orden pendiente desde hace ${Math.floor(d)} min`),r==null||r("order_timeout",`Orden #${n.id.slice(-6)} pendiente`)),n.status==="accepted"&&d>30&&(console.error(`ðŸ•’ Orden en preparaciÃ³n desde hace ${Math.floor(d)} min`),r==null||r("preparation_timeout",`PreparaciÃ³n excedida: #${n.id.slice(-6)}`)),n.status==="ready"&&n.delivery_type==="pickup"&&d>45&&s.role==="comprador"&&console.warn(`ðŸ“¦ Tu pedido estÃ¡ listo desde hace ${Math.floor(d)} min`)})}catch(e){console.error("Error checking timeouts:",e)}},c=setInterval(t,5*60*1e3);return t(),()=>clearInterval(c)},[s,r]),v=o.useCallback(async()=>{if(!s||s.role!=="repartidor")return;const t=i.channel("location-alerts").on("postgres_changes",{event:"UPDATE",schema:"public",table:"orders",filter:`driver_id=eq.${s.id}`},c=>{const e=c.new;e.status==="assigned"&&c.old.status!=="assigned"&&(console.log(`ðŸšš Nueva entrega asignada: ${e.delivery_address}`),r==null||r("delivery_assigned",`Nueva entrega: ${e.customer_name}`))}).subscribe();return()=>t.unsubscribe()},[s,r]),k=o.useCallback(async()=>{if(!s)return;const t=async()=>{try{const{data:e}=await i.from("drivers").select("id").eq("is_online",!0).eq("is_active",!0).eq("is_verified",!0);(!e||e.length===0)&&(console.error("ðŸš¨ CRÃTICO: No hay repartidores disponibles"),r==null||r("no_drivers","Sin repartidores disponibles"));const{data:a}=await i.from("orders").select("id").eq("status","ready");a&&a.length>10&&(console.warn(`ðŸ“Š ALERTA: ${a.length} Ã³rdenes esperando entrega`),r==null||r("high_volume",`${a.length} Ã³rdenes pendientes`))}catch(e){console.error("Error checking system health:",e)}},c=setInterval(t,3*60*1e3);return t(),()=>clearInterval(c)},[s,r]),b=o.useCallback(async()=>{if(!(!s||s.role!=="vendedor"))try{const t=new Date().toISOString().split("T")[0],{data:c}=await i.from("daily_products").select("*").eq("seller_id",s.id).eq("date",t).lt("stock",10);c&&c.length>0&&c.forEach(e=>{e.stock<=3&&console.warn(`â° Producto del dÃ­a agotÃ¡ndose: ${e.name} (${e.stock} left)`)})}catch(t){console.error("Error checking daily products:",t)}},[s,r]);return o.useEffect(()=>{const t=c=>{const{type:e,message:a,data:u}=c.detail;if(console.log(`ðŸ”¥ NotificaciÃ³n crÃ­tica recibida: ${e} - ${a}`,u),r==null||r(e,a),e==="new_order"){const n=()=>{try{const l=new(window.AudioContext||window.webkitAudioContext),d=(_,w,A=0)=>{setTimeout(()=>{const p=l.createOscillator(),m=l.createGain();p.connect(m),m.connect(l.destination),p.frequency.setValueAtTime(_,l.currentTime),p.type="sine",m.gain.setValueAtTime(.3,l.currentTime),m.gain.exponentialRampToValueAtTime(.01,l.currentTime+w),p.start(l.currentTime),p.stop(l.currentTime+w)},A)};d(800,.2,0),d(1e3,.2,300),d(1200,.3,600)}catch(l){console.warn("No se pudo reproducir sonido con Web Audio API:",l),navigator.vibrate&&navigator.vibrate([300,100,300,100,300])}};n(),setTimeout(n,2e3)}};return window.addEventListener("criticalNotification",t),()=>{window.removeEventListener("criticalNotification",t)}},[r]),o.useEffect(()=>{if(!s)return;const t=[];return(async()=>{const e=await y(),a=await g(),u=await v(),n=await k();b(),e&&t.push(e),a&&t.push(a),u&&t.push(u),n&&t.push(n)})(),()=>{t.forEach(e=>e())}},[s,y,g,v,k,b]),null}export{M as C,f as M,D as N,O as P,S as a,I as b};
