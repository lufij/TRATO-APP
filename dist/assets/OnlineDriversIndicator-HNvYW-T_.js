import{g as y,s as m,r as h,j as s,f as D}from"./index-4-AwG29v.js";import{E as v}from"./eye-BWSEqSXu.js";import{T as q}from"./truck-B1XgDIDQ.js";import{U as E}from"./users-lsPUPacr.js";/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const S=[["path",{d:"M3.85 8.62a4 4 0 0 1 4.78-4.77 4 4 0 0 1 6.74 0 4 4 0 0 1 4.78 4.78 4 4 0 0 1 0 6.74 4 4 0 0 1-4.77 4.78 4 4 0 0 1-6.75 0 4 4 0 0 1-4.78-4.77 4 4 0 0 1 0-6.76Z",key:"3c2336"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]],W=y("badge-check",S);/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const P=[["path",{d:"M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z",key:"96xj49"}]],F=y("flame",P);/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const O=[["path",{d:"M15 21v-8a1 1 0 0 0-1-1h-4a1 1 0 0 0-1 1v8",key:"5wwlr5"}],["path",{d:"M3 10a2 2 0 0 1 .709-1.528l7-5.999a2 2 0 0 1 2.582 0l7 5.999A2 2 0 0 1 21 10v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z",key:"1d0kgt"}]],J=y("house",O);/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const C=[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"M12 5v14",key:"s699le"}]],V=y("plus",C);/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const T=[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}]],X=y("rotate-ccw",T);/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const z=[["path",{d:"M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7",key:"1m0v6g"}],["path",{d:"M18.375 2.625a1 1 0 0 1 3 3l-9.013 9.014a2 2 0 0 1-.853.505l-2.873.84a.5.5 0 0 1-.62-.62l.84-2.873a2 2 0 0 1 .506-.852z",key:"ohrbg2"}]],Q=y("square-pen",z);/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const R=[["line",{x1:"10",x2:"14",y1:"2",y2:"2",key:"14vaq8"}],["line",{x1:"12",x2:"15",y1:"14",y2:"11",key:"17fdiu"}],["circle",{cx:"12",cy:"14",r:"8",key:"1e1u0o"}]],Y=y("timer",R);async function K(a,r){if(console.log("üîÑ Iniciando actualizaci√≥n de stock para orden:",r),console.log("üì¶ Items a procesar:",a.length),a.forEach((t,e)=>{console.log(`   ${e+1}. ${t.product_name}`),console.log(`      - Cantidad: ${t.quantity}`),console.log(`      - Tipo: ${t.product_type||"regular"}`),console.log(`      - Product ID: ${t.product_id}`),console.log(`      - Daily Product ID: ${t.daily_product_id||"N/A"}`)}),!a||a.length===0)return console.log("‚ö†Ô∏è No hay items para procesar"),{success:!1,message:"No hay items para actualizar stock"};try{const t=[];for(const e of a){console.log(`üîç Procesando producto, cantidad: ${e.quantity}, tipo: ${e.product_type||"regular"}`),console.log(`    Product ID: ${e.product_id}, Daily Product ID: ${e.daily_product_id}`);const i=e.product_type==="daily"||!!e.daily_product_id,u=i?"daily_products":"products";let o=null,n=null;if(i&&e.product_id){console.log(`üîç OPCI√ìN 1: Buscando producto del d√≠a por product_id: ${e.product_id}`);const{data:d,error:c}=await m.from("daily_products").select("id, name, stock_quantity, is_available").eq("id",e.product_id).single();!c&&d?(o=d,console.log(`‚úÖ ENCONTRADO por product_id en daily_products: ${o.name}`)):console.log("‚ùå No encontrado por product_id en daily_products:",c==null?void 0:c.message)}if(!o&&i&&e.daily_product_id){console.log(`üîç OPCI√ìN 2: Buscando por daily_product_id (legacy): ${e.daily_product_id}`);const{data:d,error:c}=await m.from("daily_products").select("id, name, stock_quantity, is_available").eq("id",e.daily_product_id).single();!c&&d?(o=d,console.log(`‚úÖ ENCONTRADO por daily_product_id: ${o.name}`)):console.log("‚ùå No encontrado por daily_product_id:",c==null?void 0:c.message)}if(!o&&!i&&e.product_id){console.log(`üîç OPCI√ìN 3: Buscando producto regular por product_id: ${e.product_id}`);const{data:d,error:c}=await m.from("products").select("id, name, stock_quantity, is_available").eq("id",e.product_id).single();!c&&d?(o=d,console.log(`‚úÖ ENCONTRADO por product_id en products: ${o.name}`)):console.log("‚ùå No encontrado por product_id en products:",c==null?void 0:c.message)}if(!o&&i&&e.product_name){console.log(`üîç OPCI√ìN 4: Buscando por nombre en daily_products: ${e.product_name}`);const{data:d,error:c}=await m.from("daily_products").select("id, name, stock_quantity, is_available, expires_at").eq("name",e.product_name).gte("expires_at",new Date().toISOString()).order("created_at",{ascending:!1}).limit(1);!c&&d&&d.length>0?(o=d[0],console.log(`‚úÖ ENCONTRADO por nombre: ${o.name}`)):console.log("‚ùå No encontrado por nombre:",c==null?void 0:c.message)}if(!o&&!i&&e.product_name){console.log(`üîç OPCI√ìN 5: Buscando por nombre en products: ${e.product_name}`);const{data:d,error:c}=await m.from("products").select("id, name, stock_quantity, is_available").eq("name",e.product_name).limit(1);!c&&d&&d.length>0?(o=d[0],console.log(`‚úÖ ENCONTRADO por nombre: ${o.name}`)):console.log("‚ùå No encontrado por nombre:",c==null?void 0:c.message)}if(!o)return console.log("‚ùå PRODUCTO NO ENCONTRADO EN NINGUNA B√öSQUEDA"),console.log("üîç Detalles del item:",{product_id:e.product_id,daily_product_id:e.daily_product_id,product_name:e.product_name,product_type:e.product_type,isDaily:i,tableName:u}),{success:!1,message:`Error al obtener informaci√≥n del producto ${e.product_name}. Producto no encontrado en ninguna tabla.`};const l=o.stock_quantity,p=l-e.quantity;if(console.log(`üìä ${i?"Producto del d√≠a":"Producto regular"} "${o.name}": ${l} ‚Üí ${p} (vendido: ${e.quantity})`),l<e.quantity)return console.error(`‚ùå Stock insuficiente para ${o.name}: tiene ${l}, necesita ${e.quantity}`),{success:!1,message:`Stock insuficiente para ${o.name}. Solo quedan ${l} unidades.`};const f=i?"daily_products":"products";console.log(`üîÑ Actualizando en tabla: ${f}, ID: ${o.id}`);const g={stock_quantity:p,updated_at:new Date().toISOString()};i||(g.is_available=p>0&&o.is_available);const{error:_}=await m.from(f).update(g).eq("id",o.id);if(_)return console.error(`‚ùå Error actualizando stock para ${o.id}:`,_),await M(t,r),{success:!1,message:`Error al actualizar el stock del producto ${o.name}`};t.push({product_id:o.id,old_stock:l,new_stock:p,quantity_sold:e.quantity,product_type:e.product_type||"regular"}),console.log(`‚úÖ Stock actualizado exitosamente para "${o.name}" (${i?"producto del d√≠a":"producto regular"})`)}return await x(r,"stock_decrease",t),console.log("üéâ Actualizaci√≥n de stock completada exitosamente"),{success:!0,message:"Stock actualizado correctamente",updatedProducts:t}}catch(t){return console.error("‚ùå Error inesperado actualizando stock:",t),{success:!1,message:"Error inesperado al actualizar el inventario"}}}async function M(a,r){console.log("üîÑ Iniciando rollback de stock para orden:",r);for(const t of a)try{const e=t.product_type==="daily",i=e?"daily_products":"products";await m.from(i).update({stock_quantity:t.old_stock,updated_at:new Date().toISOString()}).eq("id",t.product_id),console.log(`‚úÖ Rollback exitoso para ${e?"producto del d√≠a":"producto regular"} ${t.product_id}: ${t.new_stock} ‚Üí ${t.old_stock}`)}catch(e){console.error(`‚ùå Error en rollback para producto ${t.product_id}:`,e)}}async function ee(a,r){console.log("üîÑ Iniciando restauraci√≥n de stock para orden cancelada:",r);try{const t=[];for(const e of a){const i=e.product_type==="daily",u=i?"daily_products":"products",{data:o,error:n}=await m.from(u).select("id, name, stock_quantity, is_available").eq("id",e.product_id).single();if(n||!o){console.error(`‚ùå Error obteniendo ${i?"producto del d√≠a":"producto regular"} para restaurar ${e.product_id}:`,n);continue}const l=o.stock_quantity,p=l+e.quantity,f={stock_quantity:p,updated_at:new Date().toISOString()};i||(f.is_available=!0);const{error:g}=await m.from(u).update(f).eq("id",e.product_id);if(g){console.error(`‚ùå Error restaurando stock para ${e.product_id}:`,g);continue}t.push({product_id:e.product_id,old_stock:l,new_stock:p,quantity_sold:-e.quantity,product_type:e.product_type||"regular"}),console.log(`‚úÖ Stock restaurado para "${o.name}" (${i?"producto del d√≠a":"producto regular"}): ${l} ‚Üí ${p}`)}return await x(r,"stock_restore",t),{success:!0,message:"Stock restaurado correctamente",updatedProducts:t}}catch(t){return console.error("‚ùå Error inesperado restaurando stock:",t),{success:!1,message:"Error inesperado al restaurar el inventario"}}}async function x(a,r,t){try{console.log("üìù Log de transacci√≥n de stock:",{orderId:a,type:r,timestamp:new Date().toISOString(),products:t})}catch(e){console.warn("‚ö†Ô∏è Error registrando log de stock (no cr√≠tico):",e)}}async function oe(a){console.log("üîç Validando stock antes de crear orden");try{const r=[];for(const t of a){const{data:e,error:i}=await m.from("products").select("id, name, stock_quantity, is_available").eq("id",t.product_id).single();if(i||!e){r.push({product_id:t.product_id,product_name:t.product_name||"Producto desconocido",requested:t.quantity,available:0});continue}(!e.is_available||e.stock_quantity<t.quantity)&&r.push({product_id:t.product_id,product_name:e.name,requested:t.quantity,available:e.stock_quantity})}return r.length>0?{isValid:!1,message:`Stock insuficiente: ${r.map(e=>`${e.product_name}: solicitas ${e.requested}, disponibles ${e.available}`).join("; ")}`,invalidItems:r}:{isValid:!0,message:"Stock suficiente para todos los productos"}}catch(r){return console.error("‚ùå Error validando stock:",r),{isValid:!1,message:"Error al validar disponibilidad de productos"}}}const $="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODgiIGhlaWdodD0iODgiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgc3Ryb2tlPSIjMDAwIiBzdHJva2UtbGluZWpvaW49InJvdW5kIiBvcGFjaXR5PSIuMyIgZmlsbD0ibm9uZSIgc3Ryb2tlLXdpZHRoPSIzLjciPjxyZWN0IHg9IjE2IiB5PSIxNiIgd2lkdGg9IjU2IiBoZWlnaHQ9IjU2IiByeD0iNiIvPjxwYXRoIGQ9Im0xNiA1OCAxNi0xOCAzMiAzMiIvPjxjaXJjbGUgY3g9IjUzIiBjeT0iMzUiIHI9IjciLz48L3N2Zz4KCg==";function te({expandable:a=!1,onExpand:r,...t}){const[e,i]=h.useState(!1),[u,o]=h.useState(!1),[n,l]=h.useState(!0),p=()=>{console.log("Image failed to load:",t.src),i(!0),l(!1)},f=()=>{l(!1)},g=w=>{if(a&&r&&t.src){w.preventDefault(),w.stopPropagation();const I=e?$:t.src,j=t.alt||"Imagen";r(I,j)}},{src:_,alt:d,style:c,className:k,onClick:b,onError:A,onLoad:L,...N}=t;return console.log("ImageWithFallback rendering with src:",_),!_||_.trim()===""?(console.log("No src provided, showing fallback"),s.jsxs("div",{className:`relative inline-block bg-gray-100 text-center align-middle ${k??""} ${a?"cursor-pointer group":""}`,style:c,onClick:a?g:b,onMouseEnter:a?()=>o(!0):void 0,onMouseLeave:a?()=>o(!1):void 0,children:[s.jsx("div",{className:"flex items-center justify-center w-full h-full",children:s.jsx("img",{src:$,alt:"No image available",...N})}),a&&s.jsx("div",{className:`absolute inset-0 bg-black/0 group-hover:bg-black/20 transition-all duration-200 flex items-center justify-center ${u?"opacity-100":"opacity-0"}`,children:s.jsx("div",{className:"bg-white/90 backdrop-blur-sm rounded-full p-2 shadow-lg transform scale-0 group-hover:scale-100 transition-transform duration-200",children:s.jsx(v,{className:"w-4 h-4 text-gray-800"})})})]})):e?s.jsxs("div",{className:`relative inline-block bg-gray-100 text-center align-middle ${k??""} ${a?"cursor-pointer group":""}`,style:c,onClick:a?g:b,onMouseEnter:a?()=>o(!0):void 0,onMouseLeave:a?()=>o(!1):void 0,children:[s.jsx("div",{className:"flex items-center justify-center w-full h-full",children:s.jsx("img",{src:$,alt:"Error loading image",...N,"data-original-url":_})}),a&&s.jsx("div",{className:`absolute inset-0 bg-black/0 group-hover:bg-black/20 transition-all duration-200 flex items-center justify-center ${u?"opacity-100":"opacity-0"}`,children:s.jsx("div",{className:"bg-white/90 backdrop-blur-sm rounded-full p-2 shadow-lg transform scale-0 group-hover:scale-100 transition-transform duration-200",children:s.jsx(v,{className:"w-4 h-4 text-gray-800"})})})]}):s.jsxs("div",{className:`relative ${a?"cursor-pointer group":""}`,onClick:a?g:b,onMouseEnter:a?()=>o(!0):void 0,onMouseLeave:a?()=>o(!1):void 0,children:[n&&s.jsx("div",{className:"absolute inset-0 bg-gray-200 animate-pulse rounded"}),s.jsx("img",{src:_,alt:d,className:`${k??""} ${n?"opacity-0":"opacity-100"} transition-all duration-200 ${a?"group-hover:scale-105":""}`,style:c,...N,onError:p,onLoad:f}),a&&!n&&s.jsx("div",{className:`absolute inset-0 bg-black/0 group-hover:bg-black/20 transition-all duration-200 flex items-center justify-center ${u?"opacity-100":"opacity-0"}`,children:s.jsx("div",{className:"bg-white/90 backdrop-blur-sm rounded-full p-2 shadow-lg transform scale-0 group-hover:scale-100 transition-transform duration-200",children:s.jsx(v,{className:"w-4 h-4 text-gray-800"})})}),a&&!n&&s.jsx("div",{className:"absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity duration-200",children:s.jsx("div",{className:"bg-black/50 backdrop-blur-sm rounded-full p-1",children:s.jsx(v,{className:"w-3 h-3 text-white"})})})]})}function B(a){const r=new Date(a),t=-6;return new Date(r.getTime()+t*60*60*1e3)}function ae(a){return B(a).toLocaleTimeString("es-ES",{hour:"2-digit",minute:"2-digit",hour12:!0})}function re(a){const r=new Date,e=new Date(a).getTime()-r.getTime();if(e<=0)return{isExpired:!0,formattedTime:"Expirado",hours:0,minutes:0};const i=Math.floor(e/(1e3*60*60)),u=Math.floor(e%(1e3*60*60)/(1e3*60));return{isExpired:!1,formattedTime:`${i}h ${u}m`,hours:i,minutes:u}}function se({className:a=""}){const[r,t]=h.useState(0),[e,i]=h.useState(!0);h.useEffect(()=>{u();const o=m.channel("online-drivers-changes").on("postgres_changes",{event:"*",schema:"public",table:"drivers"},l=>{console.log("üîÑ Driver status change detected:",l),u()}).subscribe(),n=setInterval(()=>{console.log("‚è∞ Actualizando conteo de repartidores (intervalo)"),u()},15e3);return()=>{o.unsubscribe(),clearInterval(n)}},[]);const u=async()=>{try{console.log("üîç Cargando cantidad de repartidores en l√≠nea...");try{const{data:o,error:n}=await m.rpc("get_online_drivers_count");if(!n&&typeof o=="number"){console.log("‚úÖ Drivers online (funci√≥n RPC):",o),t(o);return}else console.warn("‚ö†Ô∏è Funci√≥n RPC fall√≥:",n==null?void 0:n.message)}catch(o){console.warn("‚ö†Ô∏è Error en RPC:",o)}try{const{count:o,error:n}=await m.from("drivers").select("*",{count:"exact",head:!0}).eq("is_online",!0).eq("is_active",!0).eq("is_verified",!0);if(n)console.warn("‚ö†Ô∏è Consulta directa fall√≥:",n.message);else{console.log("‚úÖ Drivers disponibles (consulta directa):",o),t(o||0);return}}catch(o){console.warn("‚ö†Ô∏è Error en consulta directa:",o)}try{const{data:o,error:n}=await m.from("drivers").select("is_online, is_active, is_verified").limit(50);if(!n&&o){const l=o.filter(p=>p.is_online&&p.is_active&&p.is_verified).length;console.log("‚úÖ Drivers disponibles (fallback):",l),t(l);return}else console.error("‚ùå Fallback tambi√©n fall√≥:",n==null?void 0:n.message)}catch(o){console.error("‚ùå Error en fallback:",o)}console.error("‚ùå Todos los m√©todos fallaron, mostrando 0"),t(0)}catch(o){console.error("‚ùå Error general:",o),t(0)}finally{i(!1)}};return e?null:s.jsx("div",{className:"fixed top-28 left-4 z-40 md:top-32 md:left-6",children:s.jsxs("div",{className:"flex flex-col gap-1",children:[s.jsxs(D,{variant:"default",className:"bg-green-600 hover:bg-green-700 text-white px-2 py-1 shadow-md flex items-center gap-1.5 text-xs font-medium cursor-pointer transition-all duration-200 hover:scale-105",onClick:u,children:[s.jsxs("div",{className:"flex items-center gap-0.5",children:[s.jsx(q,{className:"w-3 h-3"}),s.jsx(E,{className:"w-3 h-3"})]}),s.jsxs("span",{className:"text-xs leading-tight",children:[r," disponible",r!==1?"s":""]}),r>0&&s.jsx("div",{className:"w-1.5 h-1.5 bg-green-300 rounded-full animate-pulse ml-0.5"})]}),!1]})})}export{W as B,F,J as H,te as I,se as O,V as P,X as R,Q as S,Y as T,ae as f,re as g,ee as r,K as u,oe as v};
