import{u as P,r as d,s as g,j as t}from"./index-DROr5LJE.js";import{M}from"./map-pin-BGfHVsd0.js";import{N as $,M as S,P as q}from"./phone-B67LUAwg.js";import{C as D}from"./clock-COpOlDBy.js";function F({onNotification:e}){const{user:a}=P(),r=d.useCallback(async()=>{if(!(!a||a.role!=="vendedor"))try{const c=g.channel("stock-alerts").on("postgres_changes",{event:"UPDATE",schema:"public",table:"products",filter:`seller_id=eq.${a.id}`},o=>{const{old:s,new:i}=o;i.stock<=5&&s.stock>5&&(console.warn(`‚ö†Ô∏è Stock bajo: ${i.name} (${i.stock} restantes)`),e==null||e("stock_low",`Stock bajo: ${i.name}`)),i.stock===0&&s.stock>0&&(console.error(`üö´ AGOTADO: ${i.name}`),e==null||e("stock_out",`Producto agotado: ${i.name}`))}).subscribe();return()=>c.unsubscribe()}catch(c){console.error("Error setting up stock alerts:",c)}},[a,e]),y=d.useCallback(async()=>{if(!a)return;const c=async()=>{try{let s=g.from("orders").select("*");switch(a.role){case"vendedor":s=s.eq("seller_id",a.id);break;case"comprador":s=s.eq("buyer_id",a.id);break;case"repartidor":s=s.eq("driver_id",a.id);break}const{data:i}=await s;if(!i)return;const v=new Date;i.forEach(u=>{const p=new Date(u.created_at),x=(v.getTime()-p.getTime())/(1e3*60);u.status==="pending"&&x>10&&a.role==="vendedor"&&(console.warn(`‚è∞ Orden pendiente desde hace ${Math.floor(x)} min`),e==null||e("order_timeout",`Orden #${u.id.slice(-6)} pendiente`)),u.status==="accepted"&&x>30&&(console.error(`üïí Orden en preparaci√≥n desde hace ${Math.floor(x)} min`),e==null||e("preparation_timeout",`Preparaci√≥n excedida: #${u.id.slice(-6)}`)),u.status==="ready"&&u.delivery_type==="pickup"&&x>45&&a.role==="comprador"&&console.warn(`üì¶ Tu pedido est√° listo desde hace ${Math.floor(x)} min`)})}catch(s){console.error("Error checking timeouts:",s)}},o=setInterval(c,5*60*1e3);return c(),()=>clearInterval(o)},[a,e]),w=d.useCallback(async()=>{if(!a||a.role!=="repartidor")return;const c=g.channel("location-alerts").on("postgres_changes",{event:"UPDATE",schema:"public",table:"orders",filter:`driver_id=eq.${a.id}`},o=>{const s=o.new;s.status==="assigned"&&o.old.status!=="assigned"&&(console.log(`üöö Nueva entrega asignada: ${s.delivery_address}`),e==null||e("delivery_assigned",`Nueva entrega: ${s.customer_name}`))}).subscribe();return()=>c.unsubscribe()},[a,e]),k=d.useCallback(async()=>{if(!a)return;const c=async()=>{try{const{data:s}=await g.from("drivers").select("id").eq("is_online",!0).eq("is_active",!0).eq("is_verified",!0);(!s||s.length===0)&&(console.error("üö® CR√çTICO: No hay repartidores disponibles"),e==null||e("no_drivers","Sin repartidores disponibles"));const{data:i}=await g.from("orders").select("id").eq("status","ready");i&&i.length>10&&(console.warn(`üìä ALERTA: ${i.length} √≥rdenes esperando entrega`),e==null||e("high_volume",`${i.length} √≥rdenes pendientes`))}catch(s){console.error("Error checking system health:",s)}},o=setInterval(c,3*60*1e3);return c(),()=>clearInterval(o)},[a,e]),_=d.useCallback(async()=>{if(!(!a||a.role!=="vendedor"))try{const c=new Date().toISOString().split("T")[0],{data:o}=await g.from("daily_products").select("*").eq("seller_id",a.id).eq("date",c).lt("stock",10);o&&o.length>0&&o.forEach(s=>{s.stock<=3&&console.warn(`‚è∞ Producto del d√≠a agot√°ndose: ${s.name} (${s.stock} left)`)})}catch(c){console.error("Error checking daily products:",c)}},[a,e]);return d.useEffect(()=>{const c=o=>{const{type:s,message:i,data:v}=o.detail;if(console.log(`üî• Notificaci√≥n cr√≠tica recibida: ${s} - ${i}`,v),e==null||e(s,i),s==="new_order"){const u=()=>{try{const p=new(window.AudioContext||window.webkitAudioContext),x=(A,j,E=0)=>{setTimeout(()=>{const n=p.createOscillator(),l=p.createGain();n.connect(l),l.connect(p.destination),n.frequency.setValueAtTime(A,p.currentTime),n.type="sine",l.gain.setValueAtTime(.3,p.currentTime),l.gain.exponentialRampToValueAtTime(.01,p.currentTime+j),n.start(p.currentTime),n.stop(p.currentTime+j)},E)};x(800,.2,0),x(1e3,.2,300),x(1200,.3,600)}catch(p){console.warn("No se pudo reproducir sonido con Web Audio API:",p),navigator.vibrate&&navigator.vibrate([300,100,300,100,300])}};u(),setTimeout(u,2e3)}};return window.addEventListener("criticalNotification",c),()=>{window.removeEventListener("criticalNotification",c)}},[e]),d.useEffect(()=>{if(!a)return;const c=[];return(async()=>{const s=await r(),i=await y(),v=await w(),u=await k();_(),s&&c.push(s),i&&c.push(i),v&&c.push(v),u&&c.push(u)})(),()=>{c.forEach(s=>s())}},[a,r,y,w,k,_]),null}function G({orderId:e,onLocationUpdate:a}){const{user:r}=P(),[y,w]=d.useState(null),[k,_]=d.useState(!1),[c,o]=d.useState(null),[s,i]=d.useState(null),[v,u]=d.useState(null),p=d.useCallback(()=>{if(!r||r.role!=="repartidor"||!navigator.geolocation){console.warn("Geolocation not supported or user not a driver");return}const n={enableHighAccuracy:!0,timeout:1e4,maximumAge:3e4},l=async f=>{const h={latitude:f.coords.latitude,longitude:f.coords.longitude,timestamp:new Date().toISOString(),accuracy:f.coords.accuracy,driver_id:r.id,order_id:e};w(h),a==null||a(h.latitude,h.longitude);try{await g.from("driver_locations").upsert({driver_id:r.id,order_id:e,latitude:h.latitude,longitude:h.longitude,timestamp:h.timestamp,accuracy:h.accuracy}),await x(h)}catch(T){console.error("Error saving location:",T)}},m=f=>{console.error("Location error:",f),_(!1)},b=navigator.geolocation.watchPosition(l,m,n);o(b),_(!0)},[r,e,a]),x=async n=>{try{const{data:l}=await g.from("orders").select("delivery_latitude, delivery_longitude, buyer_id, customer_name").eq("id",e).single();if(!l||!l.delivery_latitude||!l.delivery_longitude)return;const m=A(n.latitude,n.longitude,l.delivery_latitude,l.delivery_longitude);if(i(m),m<=.5&&m>.3)try{await g.from("notifications").insert({recipient_id:l.buyer_id,type:"driver_nearby",title:"Repartidor cerca",message:"Tu repartidor est√° a menos de 500 metros de tu ubicaci√≥n",data:{order_id:e,distance:Math.round(m*1e3),driver_id:r==null?void 0:r.id}}),console.log("üîî Notificaci√≥n enviada: Repartidor cerca")}catch(b){console.error("Error sending proximity notification:",b)}if(m<=.1)try{await g.from("notifications").insert({recipient_id:l.buyer_id,type:"driver_arrived",title:"Repartidor lleg√≥",message:"Tu repartidor ha llegado a tu ubicaci√≥n",data:{order_id:e,driver_id:r==null?void 0:r.id}}),console.log("üîî Notificaci√≥n enviada: Repartidor lleg√≥")}catch(b){console.error("Error sending arrival notification:",b)}if(m>.1){const f=m/25,h=Math.ceil(f*60);u(`${h} min`)}else u("Llegando...")}catch(l){console.error("Error checking proximity:",l)}},A=(n,l,m,b)=>{const h=(m-n)*Math.PI/180,T=(b-l)*Math.PI/180,C=Math.sin(h/2)*Math.sin(h/2)+Math.cos(n*Math.PI/180)*Math.cos(m*Math.PI/180)*Math.sin(T/2)*Math.sin(T/2);return 6371*(2*Math.atan2(Math.sqrt(C),Math.sqrt(1-C)))},j=d.useCallback(()=>{c!==null&&(navigator.geolocation.clearWatch(c),o(null),_(!1))},[c]),E=d.useCallback(async()=>{if(r)try{const{data:n}=await g.from("orders").select("buyer_id, seller_id, customer_name").eq("id",e).single();n&&(await g.from("notifications").insert({recipient_id:n.buyer_id,type:"delivery_issue",title:"Problema con la entrega",message:"El repartidor report√≥ dificultades para encontrar tu ubicaci√≥n",data:{order_id:e,driver_id:r.id,issue_type:"location_not_found"}}),await g.from("notifications").insert({recipient_id:n.seller_id,type:"delivery_issue",title:"Problema de entrega",message:`Problema reportado en entrega para ${n.customer_name}`,data:{order_id:e,driver_id:r.id,issue_type:"location_not_found"}}),console.log("üîî Problema de ubicaci√≥n reportado"))}catch(n){console.error("Error reporting location issue:",n)}},[r,e]);return d.useEffect(()=>((r==null?void 0:r.role)==="repartidor"&&p(),()=>{j()}),[r==null?void 0:r.role,r==null?void 0:r.id]),d.useEffect(()=>{if(!r||r.role==="repartidor")return;const n=g.channel("location-updates").on("postgres_changes",{event:"INSERT",schema:"public",table:"driver_locations",filter:`order_id=eq.${e}`},l=>{const m=l.new;w(m),a==null||a(m.latitude,m.longitude)}).subscribe();return()=>{n.unsubscribe()}},[r==null?void 0:r.role,e]),(r==null?void 0:r.role)!=="repartidor"&&!y?t.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:t.jsxs("div",{className:"flex items-center space-x-3",children:[t.jsx(M,{className:"w-5 h-5 text-blue-600"}),t.jsxs("div",{children:[t.jsx("p",{className:"text-sm font-medium text-blue-900",children:"Esperando ubicaci√≥n del repartidor..."}),t.jsx("p",{className:"text-xs text-blue-600",children:"Te notificaremos cuando tu pedido est√© en camino"})]})]})}):t.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-4 space-y-4",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Tracking en vivo"}),(r==null?void 0:r.role)==="repartidor"&&t.jsx("div",{className:"flex items-center space-x-2",children:k?t.jsxs("div",{className:"flex items-center space-x-1 text-green-600",children:[t.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full animate-pulse"}),t.jsx("span",{className:"text-xs font-medium",children:"Activo"})]}):t.jsx("span",{className:"text-xs text-gray-500",children:"Inactivo"})})]}),y&&t.jsxs("div",{className:"space-y-3",children:[t.jsxs("div",{className:"flex items-center space-x-3",children:[t.jsx($,{className:"w-4 h-4 text-blue-600"}),t.jsxs("div",{children:[t.jsx("p",{className:"text-sm font-medium text-gray-900",children:"Ubicaci√≥n actual"}),t.jsxs("p",{className:"text-xs text-gray-600",children:[y.latitude.toFixed(6),", ",y.longitude.toFixed(6)]}),y.accuracy&&t.jsxs("p",{className:"text-xs text-gray-500",children:["Precisi√≥n: ¬±",Math.round(y.accuracy),"m"]})]})]}),s!==null&&t.jsxs("div",{className:"flex items-center space-x-3",children:[t.jsx(M,{className:"w-4 h-4 text-orange-600"}),t.jsxs("div",{children:[t.jsxs("p",{className:"text-sm font-medium text-gray-900",children:["Distancia: ",s.toFixed(2)," km"]}),v&&t.jsxs("p",{className:"text-xs text-gray-600",children:["Tiempo estimado: ",v]})]})]}),t.jsxs("div",{className:"flex items-center space-x-3",children:[t.jsx(D,{className:"w-4 h-4 text-gray-600"}),t.jsx("div",{children:t.jsxs("p",{className:"text-xs text-gray-600",children:["√öltima actualizaci√≥n: ",new Date(y.timestamp).toLocaleTimeString()]})})]})]}),(r==null?void 0:r.role)==="repartidor"&&t.jsx("div",{className:"border-t pt-3 space-y-2",children:t.jsxs("div",{className:"flex space-x-2",children:[t.jsxs("button",{onClick:E,className:"flex-1 flex items-center justify-center space-x-1 px-3 py-2 bg-orange-100 text-orange-700 rounded-lg hover:bg-orange-200 transition-colors",children:[t.jsx(S,{className:"w-4 h-4"}),t.jsx("span",{className:"text-sm",children:"Reportar problema"})]}),t.jsxs("button",{onClick:()=>{},className:"flex-1 flex items-center justify-center space-x-1 px-3 py-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition-colors",children:[t.jsx(q,{className:"w-4 h-4"}),t.jsx("span",{className:"text-sm",children:"Llamar cliente"})]})]})})]})}export{F as C,G as D};
