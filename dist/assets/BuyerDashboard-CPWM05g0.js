import{g as Ne,u as ke,h as Te,r as m,s as I,j as e,B as M,f as Z,R as Ae,X as Ve,C as Q,c as H,a as ee,b as se,i as cs,t as V,e as oe,P as $s,d as Ee,S as fe,k as ds,l as $e,m as pa,n as Fs,o as Ue,p as Ge,q as is,v as fa,w as ja,x as va,y as zs,z as ns,A as ya,E as ba,L as Na,Z as _a}from"./index-urxcoLs_.js";import{P as xe,T as Je,a as es,b as _e,c as Qe,d as je,D as wa,e as Ms,R as ka,I as Sa,f as Ca}from"./MobileToastNotifications-C-QnXEI8.js";import{r as ys,v as Ea,g as Ta,I as ye,F as Ie,P as Se,B as Ls,R as Pa,S as Ia,T as Ra,H as bs,O as qa}from"./OnlineDriversIndicator-B9EAGIRI.js";import{S as we}from"./shopping-cart-BcLNYpLf.js";import{S as ze,M as He}from"./search-B9VVAKGN.js";import{I as be}from"./input-qHtuaJE-.js";import{S as Aa,a as Da,b as Oa,c as $a,d as Ns}from"./select-CwG0Q3Ss.js";import{S as de}from"./store-CjME3cjw.js";import{S as le}from"./star-dRXZJAUd.js";import{M as Re}from"./map-pin-giNlXS6N.js";import{C as me}from"./clock-CmqsdHSK.js";import{C as De}from"./circle-x-B81EBSrE.js";import{E as ms}from"./eye-BN7c8EG1.js";import{T as ue}from"./truck-SBhFVdHN.js";import{T as We}from"./textarea-CZEV-FU5.js";import{A as Fa,a as za}from"./alert-xsM8RmRy.js";import{A as Ma,a as La,b as Ba,c as Ua,d as Va,e as Ga,f as Qa,g as Ha,h as Wa}from"./alert-dialog-BK9HpypI.js";import{T as Ke}from"./trash-2-BLc-u0RI.js";import{T as Xe}from"./triangle-alert-D0GK7goV.js";import{C as Me,a as Ka,P as ls}from"./phone-BLgC7u0q.js";import{L as he}from"./label-74OaXu9Z.js";import{M as Xa}from"./mail-C4f_jUQJ.js";import{S as _s}from"./shield-CbVC7fRQ.js";import{U as Oe}from"./user-B0UErowU.js";import{S as ws}from"./save-FUAxyLqp.js";import{S as Za}from"./shopping-bag-Cuev8Twq.js";import{L as Ya}from"./lock-BgtCbmQN.js";import{A as Be}from"./arrow-left-B-DnNMCV.js";import{u as Ja,N as er}from"./NotificationSystem-DHj5g0kd.js";import{I as ks}from"./info-Dc2uxSMi.js";import{C as sr,D as ar}from"./DeliveryTracking-D3tYxWoF.js";import{L as rr}from"./log-out-BmhDXmiG.js";import"./users-BAiOA3Ek.js";/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const tr=[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"m12 5 7 7-7 7",key:"xquz4c"}]],Bs=Ne("arrow-right",tr);/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ir=[["rect",{width:"20",height:"12",x:"2",y:"6",rx:"2",key:"9lu3g6"}],["circle",{cx:"12",cy:"12",r:"2",key:"1c9p78"}],["path",{d:"M6 12h.01M18 12h.01",key:"113zkx"}]],nr=Ne("banknote",ir);/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const lr=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]],or=Ne("circle",lr);/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const cr=[["rect",{width:"20",height:"14",x:"2",y:"5",rx:"2",key:"ynyp8z"}],["line",{x1:"2",x2:"22",y1:"10",y2:"10",key:"1b3vmo"}]],Le=Ne("credit-card",cr);/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const dr=[["path",{d:"M10 20a1 1 0 0 0 .553.895l2 1A1 1 0 0 0 14 21v-7a2 2 0 0 1 .517-1.341L21.74 4.67A1 1 0 0 0 21 3H3a1 1 0 0 0-.742 1.67l7.225 7.989A2 2 0 0 1 10 14z",key:"sc7q7i"}]],mr=Ne("funnel",dr);/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ur=[["path",{d:"M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z",key:"c3ymky"}]],Ze=Ne("heart",ur);/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const xr=[["circle",{cx:"18",cy:"5",r:"3",key:"gq8acd"}],["circle",{cx:"6",cy:"12",r:"3",key:"w7nqdw"}],["circle",{cx:"18",cy:"19",r:"3",key:"1xt0gg"}],["line",{x1:"8.59",x2:"15.42",y1:"13.51",y2:"17.49",key:"47mynk"}],["line",{x1:"15.41",x2:"8.59",y1:"6.51",y2:"10.49",key:"1n3mei"}]],gr=Ne("share-2",xr);/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const hr=[["path",{d:"M7 10v12",key:"1qc93n"}],["path",{d:"M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2a3.13 3.13 0 0 1 3 3.88Z",key:"emmmcr"}]],pr=Ne("thumbs-up",hr);/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const fr=[["path",{d:"m16 2-2.3 2.3a3 3 0 0 0 0 4.2l1.8 1.8a3 3 0 0 0 4.2 0L22 8",key:"n7qcjb"}],["path",{d:"M15 15 3.3 3.3a4.2 4.2 0 0 0 0 6l7.3 7.3c.7.7 2 .7 2.8 0L15 15Zm0 0 7 7",key:"d0u48b"}],["path",{d:"m2.1 21.8 6.4-6.3",key:"yn04lh"}],["path",{d:"m19 5-7 7",key:"194lzd"}]],jr=Ne("utensils-crossed",fr);/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const vr=[["path",{d:"M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2",key:"cjf0a3"}],["path",{d:"M7 2v20",key:"1473qp"}],["path",{d:"M21 15V2a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7",key:"j28e5"}]],Us=Ne("utensils",vr);/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const yr=[["path",{d:"M19 7V4a1 1 0 0 0-1-1H5a2 2 0 0 0 0 4h15a1 1 0 0 1 1 1v4h-3a2 2 0 0 0 0 4h3a1 1 0 0 0 1-1v-2a1 1 0 0 0-1-1",key:"18etb6"}],["path",{d:"M3 5v14a2 2 0 0 0 2 2h15a1 1 0 0 0 1-1v-4",key:"xoc0q4"}]],br=Ne("wallet",yr),Vs=m.createContext(void 0);function Ss({children:s}){const{user:r}=ke(),{clearCart:l}=Te(),[g,u]=m.useState([]),[c,j]=m.useState(!1),[x,h]=m.useState(null),[N,A]=m.useState(null),n=async()=>{if(!r){u([]);return}try{j(!0),h(null);const{error:i}=await I.from("orders").select("count",{count:"exact",head:!0});if((i==null?void 0:i.code)==="PGRST205"){console.log("Orders table does not exist yet"),u([]);return}let y=I.from("orders").select(`
          *,
          order_items (*)
        `);switch(r.role){case"comprador":y=y.eq("buyer_id",r.id);break;case"vendedor":y=y.eq("seller_id",r.id);break;case"repartidor":y=y.or(`driver_id.eq.${r.id},status.eq.ready,status.eq.assigned`);break}const{data:t,error:a}=await y.order("created_at",{ascending:!1});if(a){console.error("Error fetching orders:",a),h("Error al cargar las √≥rdenes");return}const o=await Promise.all((t||[]).map(async k=>{let d="",S="";if(k.seller_id){const{data:O}=await I.from("users").select("name").eq("id",k.seller_id).single();d=(O==null?void 0:O.name)||""}if(k.driver_id){const{data:O}=await I.from("users").select("name").eq("id",k.driver_id).single();S=(O==null?void 0:O.name)||""}return{...k,items:k.order_items||[],seller_name:d,driver_name:S}}));u(o)}catch(i){console.error("Unexpected error fetching orders:",i),h("Error inesperado al cargar las √≥rdenes")}finally{j(!1)}},E=async i=>{if(!r)return{success:!1,message:"Debes iniciar sesi√≥n para crear una orden"};try{j(!0),h(null);const{data:y,error:t}=await I.from("cart_items").select(`
          *,
          products!inner (
            id,
            name,
            price,
            seller_id,
            is_public
          )
        `).eq("user_id",r.id);if(t)return console.error("Error fetching cart items:",t),{success:!1,message:"Error al obtener los productos del carrito"};if(!y||y.length===0)return{success:!1,message:"El carrito est√° vac√≠o"};const a=y.filter(U=>U.products?U.products.is_public?!0:(console.warn(`Product ${U.product_id} is not public`),!1):(console.warn(`Cart item ${U.id} has no associated product`),!1));if(a.length===0)return{success:!1,message:"No hay productos v√°lidos en el carrito"};if(a.length!==y.length)return{success:!1,message:"Algunos productos en tu carrito ya no est√°n disponibles. Por favor actualiza tu carrito."};const o=[...new Set(a.map(U=>U.products.seller_id))];if(o.length>1)return{success:!1,message:"Todos los productos deben ser del mismo vendedor"};const k=o[0];if(!k)return{success:!1,message:"Error: productos sin vendedor asignado"};const d=a.reduce((U,X)=>{const te=X.products.price||X.product_price||0;return U+te*X.quantity},0);let S=0;i.delivery_type==="delivery"&&(S=15);const O=d+S;console.log("üõ°Ô∏è Validando disponibilidad de stock antes de crear orden...");const L=await Ea(a.map(U=>({product_id:U.product_id,quantity:U.quantity,product_name:U.products.name})));if(!L.isValid)return console.warn("‚ö†Ô∏è Stock insuficiente:",L.message),{success:!1,message:L.message};console.log("‚úÖ Stock validado correctamente, procediendo con la orden");const b={buyer_id:r.id,seller_id:k,subtotal:d,delivery_fee:S,total:O,delivery_type:i.delivery_type,delivery_address:i.delivery_address,customer_notes:i.customer_notes,phone_number:i.phone_number,customer_name:i.customer_name,status:"pending",estimated_time:30};i.delivery_location?(b.delivery_latitude=i.delivery_location.latitude,b.delivery_longitude=i.delivery_location.longitude,(i.delivery_location.address_id||i.delivery_location.delivery_instructions||i.delivery_location.landmark)&&(b.delivery_location=i.delivery_location)):(b.delivery_latitude=i.delivery_latitude,b.delivery_longitude=i.delivery_longitude);const{data:R,error:T}=await I.from("orders").insert(b).select().single();if(T||!R)return console.error("Error creating order:",T),{success:!1,message:"Error al crear la orden"};const J=a.map(U=>{const X=U.products.price||U.product_price||0,te=U.product_type==="daily";return{order_id:R.id,product_id:te?null:U.product_id,daily_product_id:te?U.product_id:null,product_name:U.products.name||U.product_name||"",product_image:U.product_image,price:X,quantity:U.quantity,product_type:U.product_type||"regular",notes:""}}),{error:ie}=await I.from("order_items").insert(J);if(ie)return console.error("Error creating order items:",ie),await I.from("orders").delete().eq("id",R.id),ie.code==="23503"?{success:!1,message:"Error: algunos productos ya no est√°n disponibles"}:{success:!1,message:"Error al crear los items de la orden"};console.log("üì¶ Orden creada exitosamente. Stock se actualizar√° cuando se marque como entregado.");try{await I.from("notifications").insert({recipient_id:k,type:"new_order",title:"Nueva Orden",message:`Nueva orden por Q${O.toFixed(2)} - ${i.delivery_type}`,data:{order_id:R.id}})}catch(U){console.warn("Failed to create notification:",U)}try{await l()}catch(U){console.warn("Failed to clear cart:",U)}return A(R),await n(),{success:!0,message:"Orden creada exitosamente",orderId:R.id}}catch(y){return console.error("Unexpected error creating order:",y),{success:!1,message:"Error inesperado al crear la orden"}}finally{j(!1)}},_=async(i,y,t)=>{if(!r)return{success:!1,message:"Debes iniciar sesi√≥n"};try{j(!0);const a={status:y,updated_at:new Date().toISOString()};switch(y){case"accepted":a.accepted_at=new Date().toISOString();break;case"ready":a.ready_at=new Date().toISOString();break;case"picked_up":a.picked_up_at=new Date().toISOString();break;case"delivered":a.delivered_at=new Date().toISOString();break;case"completed":a.completed_at=new Date().toISOString();break;case"rejected":a.rejection_reason=t||"Sin raz√≥n especificada";break}const{error:o}=await I.from("orders").update(a).eq("id",i);if(o)return console.error("Error updating order status:",o),{success:!1,message:"Error al actualizar el estado de la orden"};if(y==="cancelled"||y==="rejected")try{const{data:d,error:S}=await I.from("order_items").select("product_id, quantity, product_name").eq("order_id",i);if(!S&&d&&d.length>0){console.log(`üì¶ Restaurando stock para orden ${y}...`);for(const O of d){const L=await ys(O.product_id,O.quantity);L.success?console.log(`‚úÖ Stock restaurado: ${O.product_name} - Cantidad devuelta: ${O.quantity}`):console.warn(`‚ö†Ô∏è No se pudo restaurar stock para ${O.product_name}:`,L.message)}console.log("üéâ Stock restaurado exitosamente")}}catch(d){console.error("‚ùå Error restaurando stock:",d)}const{data:k}=await I.from("orders").select("*, order_items(*)").eq("id",i).single();if(k){const d=[];switch(y){case"accepted":d.push({recipient_id:k.buyer_id,type:"order_accepted",title:"Orden Aceptada",message:`Tu orden ha sido aceptada y ser√° preparada en ${k.estimated_time} minutos`,data:{order_id:i}});break;case"ready":if(d.push({recipient_id:k.buyer_id,type:"order_ready",title:"Orden Lista",message:k.delivery_type==="pickup"?"Tu orden est√° lista para recoger":"Tu orden est√° lista para entrega",data:{order_id:i}}),k.delivery_type==="delivery"){const{data:S}=await I.from("users").select("id").eq("role","repartidor").eq("is_available",!0);S&&S.forEach(O=>{d.push({recipient_id:O.id,type:"delivery_available",title:"Entrega Disponible",message:`Nueva entrega disponible - Q${k.delivery_fee.toFixed(2)}`,data:{order_id:i}})})}break;case"delivered":d.push({recipient_id:k.buyer_id,type:"order_delivered",title:"Orden Entregada",message:"Tu orden ha sido entregada exitosamente",data:{order_id:i}});break}if(d.length>0)try{await I.from("notifications").insert(d)}catch(S){console.warn("Failed to create notifications:",S)}}return await n(),{success:!0,message:"Estado actualizado exitosamente"}}catch(a){return console.error("Unexpected error updating order status:",a),{success:!1,message:"Error inesperado al actualizar el estado"}}finally{j(!1)}},q=async(i,y)=>{if(!r)return{success:!1,message:"Debes iniciar sesi√≥n"};try{const{error:t}=await I.from("orders").update({driver_id:y,status:"assigned",updated_at:new Date().toISOString()}).eq("id",i);if(t)return console.error("Error assigning driver:",t),{success:!1,message:"Error al asignar repartidor"};const{data:a}=await I.from("orders").select("buyer_id, seller_id").eq("id",i).single();if(a){const o=[{recipient_id:a.buyer_id,type:"driver_assigned",title:"Repartidor Asignado",message:"Un repartidor ha sido asignado a tu orden",data:{order_id:i}},{recipient_id:y,type:"delivery_assigned",title:"Entrega Asignada",message:"Se te ha asignado una nueva entrega",data:{order_id:i}}];try{await I.from("notifications").insert(o)}catch(k){console.warn("Failed to create assignment notifications:",k)}}return await n(),{success:!0,message:"Repartidor asignado exitosamente"}}catch(t){return console.error("Unexpected error assigning driver:",t),{success:!1,message:"Error inesperado al asignar repartidor"}}},p=async(i,y,t,a)=>{if(!r)return{success:!1,message:"Debes iniciar sesi√≥n"};try{console.log("üåü Enviando calificaci√≥n:",{orderId:i,rating:y,type:t,comment:a});const{data:o}=await I.from("orders").select("buyer_id, seller_id, driver_id, status").eq("id",i).single();if(!o)return{success:!1,message:"Orden no encontrada"};const k=t==="seller"?o.seller_id:o.driver_id;if(!k)return{success:!1,message:`No hay ${t==="seller"?"vendedor":"repartidor"} asignado`};let d;if(r.id===o.buyer_id)d=t==="seller"?"buyer_to_seller":"buyer_to_driver";else if(r.id===o.seller_id)d=t==="seller"?"seller_to_buyer":"seller_to_driver";else return{success:!1,message:"No tienes permisos para calificar esta orden"};if(console.log("üéØ Tipo de calificaci√≥n:",d),o.status!=="delivered")return{success:!1,message:"Solo se pueden calificar √≥rdenes entregadas"};const{data:S}=await I.from("ratings").select("id").eq("order_id",i).eq("rater_id",r.id).eq("rated_id",k).eq("rating_type",d).eq("status","completed").single();if(S)return{success:!1,message:"Ya has calificado esta orden"};let O;const{data:L}=await I.from("ratings").select("id").eq("order_id",i).eq("rater_id",r.id).eq("rated_id",k).eq("rating_type",d).eq("status","pending").single();if(L)O=L.id;else{const{data:T,error:J}=await I.from("ratings").insert({order_id:i,rater_id:r.id,rated_id:k,rating_type:d,status:"pending"}).select("id").single();if(J)return console.error("Error creating rating:",J),{success:!1,message:"Error al crear la calificaci√≥n: "+J.message};if(!T)return{success:!1,message:"No se pudo crear la calificaci√≥n"};O=T.id}const{data:b,error:R}=await I.rpc("complete_rating",{p_rating_id:O,p_user_id:r.id,p_rating:y,p_comment:a||null});return R?(console.error("Error completing rating:",R),{success:!1,message:"Error al enviar la calificaci√≥n: "+R.message}):b?(console.log("‚úÖ Calificaci√≥n enviada exitosamente"),{success:!0,message:"¬°Calificaci√≥n enviada exitosamente!"}):{success:!1,message:"No se pudo completar la calificaci√≥n"}}catch(o){return console.error("Unexpected error rating order:",o),{success:!1,message:"Error inesperado al enviar la calificaci√≥n"}}},C=async i=>{try{const{data:y,error:t}=await I.from("orders").select(`
          *,
          order_items (*)
        `).eq("id",i).single();return t||!y?(console.error("Error fetching order:",t),null):{...y,items:y.order_items||[]}}catch(y){return console.error("Unexpected error fetching order:",y),null}},F=async(i,y)=>r?await _(i,"cancelled",y):{success:!1,message:"Debes iniciar sesi√≥n"},G=async i=>{if(!r||r.role!=="comprador")return{success:!1,message:"Solo los compradores pueden eliminar pedidos no confirmados"};try{j(!0);const{data:y,error:t}=await I.from("orders").select("status, buyer_id, seller_id, total").eq("id",i).single();if(t||!y)return{success:!1,message:"Orden no encontrada"};if(y.buyer_id!==r.id)return{success:!1,message:"No tienes permisos para eliminar esta orden"};if(y.status!=="pending")return{success:!1,message:"Solo se pueden eliminar pedidos pendientes"};const{data:a,error:o}=await I.from("order_items").select("product_id, quantity, product_name").eq("order_id",i);o&&console.error("Error fetching order items for stock restoration:",o);const{error:k}=await I.from("order_items").delete().eq("order_id",i);if(k)return console.error("Error deleting order items:",k),{success:!1,message:"Error al eliminar los items del pedido"};const{error:d}=await I.from("orders").delete().eq("id",i);if(d)return console.error("Error deleting order:",d),{success:!1,message:"Error al eliminar el pedido"};if(a&&a.length>0){console.log("üì¶ Restaurando stock despu√©s de eliminar orden...");try{for(const S of a){const O=await ys(S.product_id,S.quantity);O.success?console.log(`‚úÖ Stock restaurado: ${S.product_name} - Cantidad devuelta: ${S.quantity}`):console.warn(`‚ö†Ô∏è No se pudo restaurar stock para ${S.product_name}:`,O.message)}console.log("üéâ Stock restaurado exitosamente")}catch(S){console.error("‚ùå Error restaurando stock:",S)}}if(y.seller_id)try{await I.from("notifications").insert({recipient_id:y.seller_id,type:"order_cancelled",title:"Pedido Eliminado",message:`Un pedido por Q${y.total.toFixed(2)} fue eliminado por el cliente`,data:{order_id:i,deleted:!0}})}catch(S){console.warn("Failed to create cancellation notification:",S)}return u(S=>S.filter(O=>O.id!==i)),{success:!0,message:"Pedido eliminado exitosamente"}}catch(y){return console.error("Unexpected error deleting order:",y),{success:!1,message:"Error inesperado al eliminar el pedido"}}finally{j(!1)}},z=async()=>{await n()},v=i=>g.filter(y=>y.status===i),f=()=>g.filter(i=>!["completed","cancelled","rejected"].includes(i.status));m.useEffect(()=>{n()},[r]),m.useEffect(()=>{if(!r)return;const i=I.channel("orders").on("postgres_changes",{event:"*",schema:"public",table:"orders",filter:r.role==="comprador"?`buyer_id=eq.${r.id}`:r.role==="vendedor"?`seller_id=eq.${r.id}`:`driver_id=eq.${r.id}`},()=>{n()}).subscribe();return()=>{i.unsubscribe()}},[r]);const P={orders:g,loading:c,error:x,currentOrder:N,createOrder:E,updateOrderStatus:_,assignDriver:q,rateOrder:p,getOrderById:C,refreshOrders:z,getOrdersByStatus:v,getActiveOrders:f,cancelOrder:F,deleteUnconfirmedOrder:G};return e.jsx(Vs.Provider,{value:P,children:s})}function us(){const s=m.useContext(Vs);if(s===void 0)throw new Error("useOrder must be used within an OrderProvider");return s}function Ye(s){if(s){if(s.startsWith("http://")||s.startsWith("https://"))return s;if(s.startsWith("business-logos/")||s.startsWith("avatars/")||s.startsWith("products/")){const r=s.startsWith("business-logos/")?"business-logos":s.startsWith("avatars/")?"avatars":"products",{data:l}=I.storage.from(r).getPublicUrl(s);return l.publicUrl}if(!s.includes("/")){const{data:r}=I.storage.from("business-logos").getPublicUrl(s);return r.publicUrl}return s}}function Cs(s){var r;if(s.logo_url)return Ye(s.logo_url);if((r=s.user)!=null&&r.avatar_url)return Ye(s.user.avatar_url)}function Es(s){if(s.image_url)return Ye(s.image_url)}function Gs(s){return Ye(s)}const Nr=()=>{const[s,r]=m.useState(()=>typeof document<"u"?!document.hidden:!0);return m.useEffect(()=>{if(typeof document>"u")return;const l=()=>{r(!document.hidden)};return document.addEventListener("visibilitychange",l),()=>document.removeEventListener("visibilitychange",l)},[]),s};function Qs(){const[s,r]=m.useState([]),[l,g]=m.useState([]),[u,c]=m.useState([]),[j,x]=m.useState({products:!1,dailyProducts:!1,businesses:!1}),h=Nr(),N=async v=>{var f,P;try{x(a=>({...a,products:!0}));let i=I.from("products").select(`
          *,
          seller:sellers(
            id,
            business_name,
            business_description,
            logo_url,
            is_verified,
            user:users(name, avatar_url)
          )
        `).eq("is_public",!0).eq("is_available",!0).gt("stock_quantity",0);v!=null&&v.search&&(i=i.or(`name.ilike.%${v.search}%,description.ilike.%${v.search}%`)),v!=null&&v.category&&v.category!=="all"&&(i=i.eq("category",v.category)),v!=null&&v.limit&&(i=i.limit(v.limit));let{data:y,error:t}=await i.order("created_at",{ascending:!1});if(t){const a=(t==null?void 0:t.code)||"",o=((P=(f=t==null?void 0:t.message)==null?void 0:f.toLowerCase)==null?void 0:P.call(f))||"";if(a==="PGRST201"||a==="PGRST200"||a==="42P01"||a==="42703"||o.includes("relationship")||o.includes("column")||o.includes("relation")){let d=I.from("products").select("*").eq("is_public",!0).eq("is_available",!0).gt("stock_quantity",0);v!=null&&v.search&&(d=d.or(`name.ilike.%${v.search}%,description.ilike.%${v.search}%`)),v!=null&&v.category&&v.category!=="all"&&(d=d.eq("category",v.category)),v!=null&&v.limit&&(d=d.limit(v.limit));const S=await d.order("created_at",{ascending:!1});y=S.data,t=S.error}}t?(console.error("Error fetching products:",t),r([])):r(y||[])}catch(i){console.error("Error fetching products:",i)}finally{x(i=>({...i,products:!1}))}},A=async()=>{var v,f;try{x(a=>({...a,dailyProducts:!0}));const P=new Date,i=new Date(P);i.setHours(23,59,59,999);let{data:y,error:t}=await I.from("daily_products").select(`
          *,
          seller:sellers(
            id,
            business_name,
            logo_url,
            is_verified,
            user:users(name, avatar_url)
          )
        `).gt("stock_quantity",0).gte("expires_at",new Date().toISOString()).lte("expires_at",i.toISOString()).order("created_at",{ascending:!1});if(t){const a=(t==null?void 0:t.code)||"",o=((f=(v=t==null?void 0:t.message)==null?void 0:v.toLowerCase)==null?void 0:f.call(v))||"";if(a==="PGRST205"){console.log("daily_products table does not exist yet"),g([]);return}if(a==="PGRST201"||a==="PGRST200"||a==="42P01"||a==="42703"||o.includes("relationship")||o.includes("relation")||o.includes("column")){const d=await I.from("daily_products").select(`
              *,
              seller:sellers(
                id,
                business_name,
                logo_url,
                is_verified
              )
            `).gt("stock_quantity",0).gte("expires_at",new Date().toISOString()).lte("expires_at",i.toISOString()).order("created_at",{ascending:!1});if(d.error){const S=await I.from("daily_products").select("*").gt("stock_quantity",0).gte("expires_at",new Date().toISOString()).lte("expires_at",i.toISOString()).order("created_at",{ascending:!1});y=S.data,t=S.error}else y=d.data,t=d.error}}if(t)console.error("Error fetching daily products:",t),g([]);else{const a=y?y.filter((o,k,d)=>k===d.findIndex(S=>S.name===o.name)):[];console.log(`üì¶ Productos del d√≠a cargados: ${(y==null?void 0:y.length)||0} total, ${a.length} √∫nicos`),g(a)}}catch(P){console.error("Error fetching daily products:",P)}finally{x(P=>({...P,dailyProducts:!1}))}},n=async()=>{var v,f;try{x(d=>({...d,businesses:!0}));let{data:P,error:i}=await I.from("sellers").select(`
          id,
          business_name,
          business_description,
          business_address,
          business_phone,
          phone,
          address,
          business_logo,
          cover_image_url,
          logo_url,
          is_verified,
          user:users(name, phone, email, address, avatar_url)
        `).not("business_name","is",null).order("is_verified",{ascending:!1});if(i){const d=(i==null?void 0:i.code)||"",S=((f=(v=i==null?void 0:i.message)==null?void 0:v.toLowerCase)==null?void 0:f.call(v))||"";if(d==="PGRST201"||d==="PGRST200"||d==="42P01"||d==="42703"||S.includes("relationship")||S.includes("column")||S.includes("relation")){const L=await I.from("sellers").select("id,business_name,business_description,business_address,business_phone,phone,address,business_logo,cover_image_url,logo_url,is_verified").not("business_name","is",null).order("is_verified",{ascending:!1});P=L.data,i=L.error}}if(i){console.error("Error fetching businesses:",i),c([]);return}const y=P||[],t=y.map(d=>d.id);let a=new Map,o=new Map;if(t.length>0){try{const{data:d,error:S}=await I.from("products").select("seller_id").in("seller_id",t).eq("is_public",!0);S?console.error("Error fetching products for counts:",S):a=(d==null?void 0:d.reduce((O,L)=>(O.set(L.seller_id,(O.get(L.seller_id)||0)+1),O),new Map))??new Map}catch(d){console.error("Error aggregating product counts:",d)}try{const{data:d,error:S}=await I.from("seller_ratings_view").select("seller_id, average_rating").in("seller_id",t);S?console.error("Error fetching ratings:",S):o=(d==null?void 0:d.reduce((O,L)=>(O.set(L.seller_id,L.average_rating||0),O),new Map))??new Map}catch(d){console.error("Error aggregating ratings:",d)}}const k=y.map(d=>{var T,J,ie,U,X,te;const S=d.cover_image_url||d.business_logo||d.logo_url,O=d.business_logo||d.logo_url,L=Cs({logo_url:O??void 0,user:d.user?{avatar_url:d.user.avatar_url}:void 0});console.log("üî• BUSINESS DATA:",{id:d.id,name:d.business_name,cover_image_url:d.cover_image_url,business_logo:d.business_logo,logo_url:d.logo_url,final_cover:S,final_logo:O});const b=a.get(d.id)||0,R=o.get(d.id)||0;return{id:d.id,business_name:d.business_name,business_description:d.business_description??void 0,business_address:d.business_address??void 0,business_phone:d.business_phone??void 0,logo_url:O??void 0,cover_image_url:S??void 0,is_verified:d.is_verified,products_count:b,rating:R,phone:d.phone,address:d.address,user:{name:((T=d.user)==null?void 0:T.name)??"Usuario",phone:((J=d.user)==null?void 0:J.phone)??void 0,email:((ie=d.user)==null?void 0:ie.email)??void 0,address:((U=d.user)==null?void 0:U.address)??void 0,avatar_url:((X=d.user)==null?void 0:X.avatar_url)??void 0},cover_image:S??void 0,category:"General",phone_number:d.phone||d.business_phone||((te=d.user)==null?void 0:te.phone)||void 0,is_open_now:!0}});c(k)}catch(P){console.error("Error fetching businesses:",P)}finally{x(P=>({...P,businesses:!1}))}},E=async v=>{var f,P;try{let i=I.from("products").select(`
          *,
          seller:sellers(
            id,
            business_name,
            logo_url,
            is_verified
          )
        `).eq("seller_id",v).eq("is_public",!0).eq("is_available",!0).gt("stock_quantity",0).order("created_at",{ascending:!1}),{data:y,error:t}=await i;if(t){const o=(t==null?void 0:t.code)||"",k=((P=(f=t==null?void 0:t.message)==null?void 0:f.toLowerCase)==null?void 0:P.call(f))||"";if(o==="PGRST201"||o==="PGRST200"||o==="42P01"||o==="42703"||k.includes("relationship")||k.includes("column")||k.includes("relation")){const S=await I.from("products").select("*").eq("seller_id",v).eq("is_public",!0).eq("is_available",!0).gt("stock_quantity",0).order("created_at",{ascending:!1});y=S.data,t=S.error}}if(t)return console.error("Error fetching business products:",t),[];const a=(y==null?void 0:y.map(o=>({...o,is_actually_available:o.is_available&&o.stock_quantity>0,stock_info:{has_stock:o.stock_quantity>0,is_low_stock:o.stock_quantity<=5&&o.stock_quantity>0,is_last_units:o.stock_quantity<=3&&o.stock_quantity>0,count:o.stock_quantity}})))||[];return console.log("üì¶ Productos procesados (USANDO COLUMNA REAL):",{total:a.length,available:a.filter(o=>o.is_actually_available).length,with_stock:a.filter(o=>o.stock_info.has_stock).length,low_stock:a.filter(o=>o.stock_info.is_low_stock).length,products_sample:a.slice(0,3).map(o=>({name:o.name,is_available:o.is_available,stock_quantity:o.stock_quantity,is_actually_available:o.is_actually_available}))}),a}catch(i){return console.error("Error fetching business products:",i),[]}},_=async v=>{var f,P;try{const i=new Date,y=new Date(i);y.setHours(23,59,59,999);let{data:t,error:a}=await I.from("daily_products").select(`
          *,
          seller:sellers(
            id,
            business_name,
            logo_url,
            is_verified,
            user:users(name, avatar_url)
          )
        `).eq("seller_id",v).gt("stock_quantity",0).gte("expires_at",new Date().toISOString()).lte("expires_at",y.toISOString()).order("created_at",{ascending:!1});if(a){const o=a==null?void 0:a.code;if(o==="PGRST205")return console.log("daily_products table does not exist yet"),[];const k=((P=(f=a==null?void 0:a.message)==null?void 0:f.toLowerCase)==null?void 0:P.call(f))||"";if(o==="PGRST200"||o==="42P01"||o==="42703"||k.includes("relationship")||k.includes("column")||k.includes("relation")){const S=await I.from("daily_products").select("*").eq("seller_id",v).gt("stock_quantity",0).gte("expires_at",new Date().toISOString()).lte("expires_at",y.toISOString()).order("created_at",{ascending:!1});t=S.data,a=S.error}}return a?(console.error("Error fetching business daily products:",a),[]):t||[]}catch(i){return console.error("Error fetching business daily products:",i),[]}},q=async v=>{try{const{data:f,error:P}=await I.from("sellers").select(`
          id,
          business_name,
          business_description,
          business_address,
          business_phone,
          phone,
          address,
          business_logo,
          cover_image_url,
          logo_url,
          is_verified,
          rating_avg
        `).eq("id",v).single();if(P)return console.error("Error fetching business:",P),null;const{data:i,error:y}=await I.from("users").select("name, phone, email, address, avatar_url").eq("id",v).single();y&&console.error("Error fetching user data:",y);const{count:t}=await I.from("products").select("*",{count:"exact",head:!0}).eq("seller_id",v).eq("is_public",!0);let a=0;try{const{data:L,error:b}=await I.from("seller_ratings_view").select("average_rating").eq("seller_id",v).single();!b&&L&&(a=L.average_rating||0)}catch(L){console.error("Error fetching business rating:",L)}const o={...f,user:i||null,products_count:t||0,rating:a};console.log("üî• COMBINED DATA DEBUG:",{seller_data:{phone:f.phone,address:f.address,business_phone:f.business_phone,business_address:f.business_address},user_data:i,combined_user:o.user});const k=(f==null?void 0:f.cover_image_url)||(f==null?void 0:f.business_logo)||(f==null?void 0:f.logo_url),d=(f==null?void 0:f.business_logo)||(f==null?void 0:f.logo_url),S=Cs({logo_url:d??void 0,user:f!=null&&f.user?{avatar_url:f.user.avatar_url}:void 0});console.log("üî• getBusinessById DATA:",{id:f==null?void 0:f.id,name:f==null?void 0:f.business_name,cover_image_url:f==null?void 0:f.cover_image_url,business_logo:f==null?void 0:f.business_logo,logo_url:f==null?void 0:f.logo_url,final_cover:k,final_logo:d});const O=f;return{id:o.id,business_name:o.business_name,business_description:o.business_description??void 0,business_address:o.business_address??void 0,business_phone:o.business_phone??void 0,logo_url:d??void 0,cover_image_url:k??void 0,is_verified:o.is_verified,products_count:o.products_count,rating:o.rating,phone:o.phone,address:o.address,user:o.user?{name:o.user.name,phone:o.user.phone,email:o.user.email,address:o.user.address,avatar_url:o.user.avatar_url}:void 0,cover_image:k??void 0,category:"General",is_open_now:!0}}catch(f){return console.error("Error fetching business by ID:",f),null}},p=async v=>{await Promise.all([N({search:v})])},C=async(v=8)=>{try{const{data:f,error:P}=await I.from("products").select(`
          *,
          seller:sellers(
            id,
            business_name,
            logo_url,
            is_verified,
            user:users(name, avatar_url)
          )
        `).eq("is_public",!0).gt("stock_quantity",0).order("created_at",{ascending:!1}).limit(v);return P?(console.error("Error fetching featured products:",P),[]):f||[]}catch(f){return console.error("Error fetching featured products:",f),[]}},F=v=>{const f=new Date,i=new Date(v).getTime()-f.getTime();if(i<=0)return"Expirado";const y=Math.floor(i/(1e3*60*60)),t=Math.floor(i%(1e3*60*60)/(1e3*60));return y>0?`${y}h ${t}m restantes`:`${t}m restantes`};m.useEffect(()=>{N(),A(),n();const v=setInterval(()=>{h?(console.log("üî• Actualizando productos del d√≠a autom√°ticamente..."),A()):console.log("‚è∏Ô∏è App en background - pausando actualizaci√≥n de productos del d√≠a")},5*60*1e3),f=setInterval(()=>{h?(console.log("üîÑ Actualizando productos autom√°ticamente (stock en tiempo real)..."),N()):console.log("‚è∏Ô∏è App en background - pausando actualizaci√≥n de productos")},30*1e3),P=setInterval(()=>{h?(console.log("üè™ Actualizando negocios autom√°ticamente..."),n()):console.log("‚è∏Ô∏è App en background - pausando actualizaci√≥n de negocios")},10*60*1e3);return()=>{clearInterval(v),clearInterval(f),clearInterval(P)}},[h]),m.useEffect(()=>{h&&(console.log("üì± App volvi√≥ a primer plano - refrescando datos..."),N(),A())},[h]),m.useEffect(()=>{const v=f=>{console.log("üö® Stock actualizado - refrescando datos:",f.detail),z(),A()};return window.addEventListener("stockUpdated",v),()=>{window.removeEventListener("stockUpdated",v)}},[]);const G=async()=>{console.log("üîÑ Refrescando todos los datos manualmente..."),await Promise.all([N(),A(),n()])},z=async()=>{console.log("üé≤ Mezclando productos para mostrar nuevos...");try{x(a=>({...a,products:!0,dailyProducts:!0}));const{data:v,error:f}=await I.from("products").select("*").eq("is_public",!0).gt("stock_quantity",0).order("created_at",{ascending:!1});if(f)console.error("‚ùå Error al obtener productos:",f);else{const a=v?[...v].sort(()=>Math.random()-.5):[];console.log("‚úÖ Productos mezclados:",(a==null?void 0:a.length)||0),r(a||[])}const P=new Date,i=new Date(P);i.setHours(23,59,59,999);const{data:y,error:t}=await I.from("daily_products").select("*").gt("stock_quantity",0).gte("expires_at",new Date().toISOString()).lte("expires_at",i.toISOString()).order("created_at",{ascending:!1});if(t&&t.code!=="PGRST205")console.error("‚ùå Error al obtener productos del d√≠a:",t);else{const o=(y?[...y].sort(()=>Math.random()-.5):[]).filter((k,d,S)=>d===S.findIndex(O=>O.name===k.name));console.log("‚úÖ Productos del d√≠a mezclados:",(o==null?void 0:o.length)||0),g(o)}}catch(v){console.error("‚ùå Error cr√≠tico al mezclar productos:",v)}finally{x(v=>({...v,products:!1,dailyProducts:!1}))}console.log("‚úÖ Productos nuevos listos para descubrir")};return{products:s,dailyProducts:l,businesses:u,loading:j,isPageVisible:h,fetchProducts:N,fetchDailyProducts:A,fetchBusinesses:n,refreshAllData:G,refreshProductStock:z,getBusinessProducts:E,getBusinessDailyProducts:_,getBusinessById:q,searchAll:p,getFeaturedProducts:C,getTimeRemaining:F}}function xs({onCartClick:s}){const{items:r,getCartItemCount:l,getCartTotal:g}=Te(),u=l(),c=g();return u===0?null:e.jsx("div",{className:"fixed bottom-4 right-4 z-50",children:e.jsxs(M,{onClick:()=>{console.log("FloatingCart clicked!"),s?s():alert(`Carrito: ${u} productos - Q${c.toFixed(2)}`)},className:"relative h-16 w-16 rounded-full bg-orange-500 hover:bg-orange-600 shadow-xl",children:[e.jsx(we,{className:"w-6 h-6 text-white"}),e.jsx(Z,{className:"absolute -top-2 -right-2 h-6 w-6 rounded-full bg-red-500 text-white text-xs font-bold flex items-center justify-center",children:u})]})})}function _r({viewMode:s,setViewMode:r,onRefreshStock:l,onRefreshAll:g,isLoading:u,isRefreshing:c,lastUpdated:j,searchQuery:x,selectedCategory:h}){return e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-800",children:"Explorar Productos"}),e.jsxs("div",{className:"flex items-center gap-4 text-sm text-gray-500 mt-1",children:[e.jsxs("span",{children:["Actualizado: ",j.toLocaleTimeString()]}),(x||h!=="all")&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ze,{className:"w-3 h-3"}),e.jsxs("span",{className:"text-orange-600 font-medium",children:[x&&`"${x}"`,x&&h!=="all"&&" ‚Ä¢ ",h!=="all"&&h]})]})]})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs(M,{onClick:l,disabled:c,size:"sm",variant:"outline",className:"gap-2 border-green-300 text-green-600 hover:bg-green-50 bg-green-50",children:[e.jsx(Ae,{className:`w-4 h-4 ${c?"animate-spin":""}`}),"Descubrir"]})})]})})}function wr({searchQuery:s,setSearchQuery:r,selectedCategory:l,setSelectedCategory:g,categories:u,onSearch:c,isLoading:j}){const[x,h]=m.useState(!1),N=m.useRef(null);m.useEffect(()=>{x&&N.current&&N.current.focus()},[x]),m.useEffect(()=>{const E=_=>{_.key==="Escape"&&x&&h(!1)};return document.addEventListener("keydown",E),()=>document.removeEventListener("keydown",E)},[x]);const A=()=>{c(),h(!1)},n=()=>{r(""),g("all"),h(!1)};return e.jsxs(e.Fragment,{children:[x&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-20 backdrop-blur-sm z-40",onClick:()=>h(!1)}),!x&&e.jsx(M,{onClick:()=>h(!0),className:"fixed bottom-24 right-4 z-50 w-14 h-14 rounded-full bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 shadow-lg hover:shadow-xl transition-all duration-300 border-2 border-white",size:"sm",children:e.jsx(ze,{className:"w-6 h-6 text-white"})}),x&&e.jsx("div",{className:"fixed bottom-24 left-4 right-4 z-50 max-w-md mx-auto",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl border border-gray-200 p-4 space-y-4 animate-in slide-in-from-bottom-2 duration-300",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ze,{className:"w-5 h-5 text-orange-500"}),e.jsx("span",{className:"font-semibold text-gray-800",children:"Buscar productos"})]}),e.jsx(M,{variant:"ghost",size:"sm",onClick:()=>h(!1),className:"h-8 w-8 p-0 hover:bg-gray-100",children:e.jsx(Ve,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"relative",children:[e.jsx(ze,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"}),e.jsx(be,{ref:N,placeholder:"¬øQu√© est√°s buscando?",value:s,onChange:E=>r(E.target.value),className:"pl-10 h-12 border-gray-200 focus:border-orange-300 focus:ring-orange-200",onKeyPress:E=>{E.key==="Enter"&&A()}})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(mr,{className:"w-4 h-4 text-gray-500"}),e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Categor√≠a"})]}),e.jsxs(Aa,{value:l,onValueChange:g,children:[e.jsx(Da,{className:"h-10 border-gray-200",children:e.jsx(Oa,{placeholder:"Todas las categor√≠as"})}),e.jsxs($a,{children:[e.jsx(Ns,{value:"all",children:"Todas las categor√≠as"}),u.map(E=>e.jsx(Ns,{value:E,children:E},E))]})]})]}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx(M,{variant:"outline",onClick:n,className:"flex-1 h-10",disabled:j,children:"Limpiar"}),e.jsx(M,{onClick:A,disabled:j,className:"flex-1 h-10 bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700",children:j?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"}),"Buscando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ze,{className:"w-4 h-4 mr-2"}),"Buscar"]})})]}),(s||l!=="all")&&e.jsx("div",{className:"pt-2 border-t border-gray-100",children:e.jsxs("div",{className:"flex flex-wrap gap-2",children:[s&&e.jsxs("div",{className:"inline-flex items-center gap-1 px-2 py-1 bg-orange-100 text-orange-700 rounded-full text-xs",children:[e.jsxs("span",{children:['"',s,'"']}),e.jsx("button",{onClick:()=>r(""),className:"hover:text-orange-900",children:e.jsx(Ve,{className:"w-3 h-3"})})]}),l!=="all"&&e.jsxs("div",{className:"inline-flex items-center gap-1 px-2 py-1 bg-blue-100 text-blue-700 rounded-full text-xs",children:[e.jsx("span",{children:l}),e.jsx("button",{onClick:()=>g("all"),className:"hover:text-blue-900",children:e.jsx(Ve,{className:"w-3 h-3"})})]})]})})]})})]})}function kr(s,r="regular"){const[l,g]=m.useState({stock_quantity:0,sold_quantity:0,available_stock:0,loading:!0,error:null});return m.useEffect(()=>{if(!s)return;const u=async()=>{try{if(g(j=>({...j,loading:!0,error:null})),r==="daily"){const{data:j,error:x}=await I.from("daily_products").select("stock_quantity").eq("id",s).single();if(x)throw x;const{data:h,error:N}=await I.from("order_items").select(`
              quantity,
              orders!inner (
                status
              )
            `).eq("product_id",s).eq("product_type","daily").in("orders.status",["confirmed","preparing","ready","out_for_delivery","delivered"]);N&&console.warn("Error fetching sold quantity:",N);const A=(h==null?void 0:h.reduce((_,q)=>_+(q.quantity||0),0))||0,n=j.stock_quantity||0,E=Math.max(0,n-A);g({stock_quantity:n,sold_quantity:A,available_stock:E,loading:!1,error:null})}else{const{data:j,error:x}=await I.from("products").select("stock_quantity").eq("id",s).single();if(x)throw x;const h=j.stock_quantity||0;g({stock_quantity:h,sold_quantity:0,available_stock:h,loading:!1,error:null})}}catch(j){console.error("Error fetching real-time stock:",j),g(x=>({...x,loading:!1,error:j.message||"Error loading stock"}))}};u();const c=setInterval(u,3e4);return()=>clearInterval(c)},[s,r]),l}function Sr(s){const[r,l]=m.useState({average_rating:0,total_reviews:0,loading:!0});return m.useEffect(()=>{if(!s)return;(async()=>{try{const{data:u,error:c}=await I.from("seller_ratings_view").select("average_rating, total_reviews").eq("seller_id",s).single();if(c){console.warn("No rating found for seller:",s),l({average_rating:0,total_reviews:0,loading:!1});return}l({average_rating:u.average_rating||0,total_reviews:u.total_reviews||0,loading:!1})}catch(u){console.error("Error fetching seller rating:",u),l({average_rating:0,total_reviews:0,loading:!1})}})()},[s]),r}function Cr(s){const[r,l]=m.useState({hours:0,minutes:0,isExpired:!0,formattedTime:"Expirado"});return m.useEffect(()=>{if(!s)return;const g=()=>{const c=Ta(s);l({hours:c.hours,minutes:c.minutes,isExpired:c.isExpired,formattedTime:c.isExpired?"Expirado":c.hours>0?`${c.hours}h ${c.minutes}m restantes`:`${c.minutes}m restantes`})};g();const u=setInterval(g,6e4);return()=>clearInterval(u)},[s]),r}function os({product:s,viewMode:r,cartQuantity:l,onAddToCart:g,onUpdateQuantity:u,onImageClick:c,onBusinessClick:j,addingToCart:x,editingQuantity:h,tempQuantity:N,onQuantityClick:A,onQuantityChange:n,onQuantitySubmit:E,onQuantityKeyDown:_}){var d,S,O;const[q,p]=m.useState(!1),C="expires_at"in s,F=s.image_url||"",G=((d=s.seller)==null?void 0:d.name)||"Tienda",{available_stock:z,stock_quantity:v,sold_quantity:f,loading:P}=kr(s.id,C?"daily":"regular"),{average_rating:i,total_reviews:y,loading:t}=Sr(s.seller_id||""),a=Cr(C&&"expires_at"in s?s.expires_at:void 0),o=P?s.stock_quantity||0:z,k=()=>{p(!q)};return r==="list"?e.jsx(Q,{className:"mb-4 overflow-hidden hover:shadow-lg transition-all duration-200 border-gray-200",children:e.jsx(H,{className:"p-0",children:e.jsxs("div",{className:"flex",children:[e.jsxs("div",{className:"w-32 h-32 flex-shrink-0 relative",children:[e.jsx(ye,{src:F,alt:s.name,className:"w-full h-full object-cover cursor-pointer",onClick:()=>F&&c(F)}),C&&e.jsx(Z,{className:"absolute top-2 left-2 bg-red-500 text-white text-xs",children:"Del d√≠a"}),e.jsx(M,{size:"sm",variant:"ghost",className:"absolute top-2 right-2 h-8 w-8 p-0 bg-white/80 hover:bg-white",onClick:k,children:e.jsx(Ze,{className:`w-4 h-4 ${q?"fill-red-500 text-red-500":"text-gray-600"}`})})]}),e.jsxs("div",{className:"flex-1 p-4 flex flex-col justify-between",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-start justify-between mb-2",children:[e.jsx("h3",{className:"font-semibold text-lg text-gray-800 line-clamp-1",children:s.name}),e.jsx("div",{className:"text-right",children:e.jsxs("div",{className:"text-xl font-bold text-green-600",children:["Q",(S=s.price)==null?void 0:S.toFixed(2)]})})]}),e.jsx("p",{className:"text-sm text-gray-600 mb-3 line-clamp-2",children:s.description}),e.jsxs("div",{className:"flex items-center gap-4 text-xs text-gray-500 mb-3",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(de,{className:"w-3 h-3"}),e.jsx("button",{onClick:()=>j(s.seller_id),className:"hover:text-orange-600 hover:underline",children:G})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(le,{className:"w-3 h-3 fill-yellow-400 text-yellow-400"}),t?e.jsx("span",{className:"animate-pulse bg-gray-200 w-6 h-3 rounded"}):e.jsxs("span",{className:"font-medium",children:[i>0?i.toFixed(1):"0.0",y>0&&e.jsxs("span",{className:"text-gray-400 ml-1",children:["(",y,")"]})]})]}),C&&!a.isExpired&&e.jsxs("div",{className:"flex items-center gap-1 text-orange-600 font-medium",children:[e.jsx(Ie,{className:"w-3 h-3"}),e.jsx("span",{children:"Termina hoy"})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Re,{className:"w-3 h-3"}),e.jsx("span",{children:"2.1 km"})]})]}),C&&!a.isExpired&&e.jsxs("div",{className:"flex items-center gap-2 text-xs text-orange-600 bg-orange-50 px-2 py-1 rounded-md mb-3",children:[e.jsx(me,{className:"w-3 h-3"}),e.jsx("span",{className:"font-medium",children:a.formattedTime})]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"flex items-center gap-1",children:o>0?e.jsxs(Z,{variant:"outline",className:"text-green-600 border-green-300",children:[e.jsx(xe,{className:"w-3 h-3 mr-1"}),P?e.jsx("span",{className:"animate-pulse",children:"Cargando..."}):e.jsxs(e.Fragment,{children:["Stock: ",o,C&&f>0&&e.jsxs("span",{className:"text-gray-500 ml-1",children:["(",v-f,"/",v,")"]})]})]}):e.jsxs(Z,{variant:"outline",className:"text-red-600 border-red-300",children:[e.jsx(De,{className:"w-3 h-3 mr-1"}),"Agotado"]})}),e.jsx("div",{className:"flex items-center gap-2",children:l>0?e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(M,{size:"sm",variant:"outline",onClick:()=>u(s.id,l-1),className:"h-8 w-8 p-0",children:e.jsx(He,{className:"w-3 h-3"})}),h?e.jsx(be,{type:"number",value:N,onChange:L=>n(L.target.value),onBlur:()=>E(s.id),onKeyDown:L=>_(L,s.id),className:"w-16 h-8 text-center text-sm",autoFocus:!0}):e.jsx("button",{onClick:()=>A(s.id,l),className:"w-16 h-8 text-sm font-medium bg-gray-100 rounded border hover:bg-gray-200",children:l}),e.jsx(M,{size:"sm",variant:"outline",onClick:()=>u(s.id,l+1),className:"h-8 w-8 p-0",disabled:l>=o,children:e.jsx(Se,{className:"w-3 h-3"})})]}):e.jsxs(M,{size:"sm",onClick:()=>g(s.id,C,s.name),disabled:x||o<=0,className:"bg-gradient-to-r from-orange-500 to-green-500 hover:from-orange-600 hover:to-green-600 text-white",children:[e.jsx(Se,{className:"w-3 h-3 mr-1"}),"Agregar"]})})]})]})]})})}):e.jsx(Q,{className:"overflow-hidden hover:shadow-lg transition-all duration-200 border-gray-200 h-full",children:e.jsxs(H,{className:"p-0",children:[e.jsxs("div",{className:"relative aspect-square",children:[e.jsx(ye,{src:F,alt:s.name,className:"w-full h-full object-cover cursor-pointer",onClick:()=>F&&c(F)}),e.jsxs("div",{className:"absolute top-2 left-2 flex flex-col gap-1",children:[C&&e.jsx(Z,{className:"bg-red-500 text-white text-xs",children:"Del d√≠a"}),o<=5&&o>0&&e.jsxs(Z,{variant:"outline",className:"bg-yellow-500 text-white text-xs border-yellow-500",children:["√öltimos ",o]})]}),e.jsx(M,{size:"sm",variant:"ghost",className:"absolute top-2 right-2 h-8 w-8 p-0 bg-white/80 hover:bg-white",onClick:k,children:e.jsx(Ze,{className:`w-4 h-4 ${q?"fill-red-500 text-red-500":"text-gray-600"}`})}),e.jsx("div",{className:"absolute bottom-2 left-2",children:o>0?e.jsxs(Z,{variant:"outline",className:"bg-white text-green-600 border-green-300 text-xs",children:[e.jsx(xe,{className:"w-3 h-3 mr-1"}),P?"...":o,C&&f>0&&e.jsxs("span",{className:"text-gray-500 ml-1",children:["/",v]})]}):e.jsxs(Z,{variant:"outline",className:"bg-white text-red-600 border-red-300 text-xs",children:[e.jsx(De,{className:"w-3 h-3 mr-1"}),"Agotado"]})}),C&&!a.isExpired&&e.jsx("div",{className:"absolute top-2 left-2",children:e.jsxs(Z,{className:"bg-orange-500 text-white text-xs font-semibold",children:[e.jsx(Ie,{className:"w-3 h-3 mr-1"}),"Del D√≠a"]})})]}),e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"mb-3",children:[e.jsx("h3",{className:"font-semibold text-base text-gray-800 line-clamp-2 mb-1",children:s.name}),e.jsx("p",{className:"text-sm text-gray-600 line-clamp-2 mb-2",children:s.description}),e.jsxs("div",{className:"flex items-center justify-between text-xs text-gray-500 mb-2",children:[e.jsxs("button",{onClick:()=>j(s.seller_id),className:"flex items-center gap-1 hover:text-orange-600 hover:underline",children:[e.jsx(de,{className:"w-3 h-3"}),G]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(le,{className:"w-3 h-3 fill-yellow-400 text-yellow-400"}),t?e.jsx("span",{className:"animate-pulse bg-gray-200 w-6 h-3 rounded"}):e.jsxs("span",{children:[i>0?i.toFixed(1):"0.0",y>0&&e.jsxs("span",{className:"text-gray-400 ml-1",children:["(",y,")"]})]})]})]}),C&&!a.isExpired&&e.jsxs("div",{className:"flex items-center gap-1 text-xs text-orange-600 bg-orange-50 px-2 py-1 rounded-md mb-2",children:[e.jsx(me,{className:"w-3 h-3"}),e.jsx("span",{className:"font-medium",children:a.formattedTime})]}),e.jsxs("div",{className:"text-xl font-bold text-green-600 mb-3",children:["Q",(O=s.price)==null?void 0:O.toFixed(2)]})]}),e.jsx("div",{className:"space-y-2",children:l>0?e.jsxs("div",{className:"flex items-center justify-center gap-1",children:[e.jsx(M,{size:"sm",variant:"outline",onClick:()=>u(s.id,l-1),className:"h-8 w-8 p-0",children:e.jsx(He,{className:"w-3 h-3"})}),h?e.jsx(be,{type:"number",value:N,onChange:L=>n(L.target.value),onBlur:()=>E(s.id),onKeyDown:L=>_(L,s.id),className:"w-16 h-8 text-center text-sm",autoFocus:!0}):e.jsx("button",{onClick:()=>A(s.id,l),className:"w-16 h-8 text-sm font-medium bg-gray-100 rounded border hover:bg-gray-200",children:l}),e.jsx(M,{size:"sm",variant:"outline",onClick:()=>u(s.id,l+1),className:"h-8 w-8 p-0",disabled:l>=o,children:e.jsx(Se,{className:"w-3 h-3"})})]}):e.jsxs(M,{onClick:()=>g(s.id,C,s.name),disabled:x||o<=0,className:"w-full bg-gradient-to-r from-orange-500 to-green-500 hover:from-orange-600 hover:to-green-600 text-white",children:[e.jsx(Se,{className:"w-4 h-4 mr-2"}),"Agregar al carrito"]})})]})]})})}function Er({products:s,viewMode:r,cartItems:l,onAddToCart:g,onUpdateQuantity:u,onImageClick:c,onBusinessClick:j,addingToCart:x,editingQuantity:h,tempQuantity:N,onQuantityClick:A,onQuantityChange:n,onQuantitySubmit:E,onQuantityKeyDown:_,loading:q=!1}){const p=C=>{const F=l.find(G=>G.product_id===C);return(F==null?void 0:F.quantity)||0};return q?e.jsx("div",{className:"space-y-6",children:e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6",children:[...Array(8)].map((C,F)=>e.jsxs("div",{className:"animate-pulse",children:[e.jsx("div",{className:"bg-gray-200 aspect-square rounded-lg mb-4"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"h-4 bg-gray-200 rounded w-3/4"}),e.jsx("div",{className:"h-3 bg-gray-200 rounded w-1/2"}),e.jsx("div",{className:"h-6 bg-gray-200 rounded w-1/4"})]})]},F))})}):!s||s.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"text-gray-400 mb-4",children:e.jsx("svg",{className:"mx-auto h-12 w-12",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2 2v-5m16 0h-2M4 13h2m13-8l-8 8-4-4"})})}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"No se encontraron productos"}),e.jsx("p",{className:"text-gray-500",children:"Intenta cambiar los filtros de b√∫squeda o revisa m√°s tarde."})]}):e.jsxs("div",{className:"space-y-6",children:[r==="grid"?e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6",children:s.map(C=>e.jsx(os,{product:C,viewMode:r,cartQuantity:p(C.id),onAddToCart:g,onUpdateQuantity:u,onImageClick:c,onBusinessClick:j,addingToCart:x===C.id,editingQuantity:h===C.id,tempQuantity:N,onQuantityClick:A,onQuantityChange:n,onQuantitySubmit:E,onQuantityKeyDown:_},C.id))}):e.jsx("div",{className:"space-y-4",children:s.map(C=>e.jsx(os,{product:C,viewMode:r,cartQuantity:p(C.id),onAddToCart:g,onUpdateQuantity:u,onImageClick:c,onBusinessClick:j,addingToCart:x===C.id,editingQuantity:h===C.id,tempQuantity:N,onQuantityClick:A,onQuantityChange:n,onQuantitySubmit:E,onQuantityKeyDown:_},C.id))}),s.length>0&&s.length%20===0&&e.jsx("div",{className:"text-center pt-8",children:e.jsx("button",{className:"px-6 py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 font-medium",children:"Cargar m√°s productos"})})]})}function Tr({dailyProducts:s,cartItems:r,onAddToCart:l,onUpdateQuantity:g,onImageClick:u,onBusinessClick:c,addingToCart:j,editingQuantity:x,tempQuantity:h,onQuantityClick:N,onQuantityChange:A,onQuantitySubmit:n,onQuantityKeyDown:E,loading:_=!1}){const q=p=>{const C=r.find(F=>F.product_id===p);return(C==null?void 0:C.quantity)||0};return _?e.jsxs(Q,{className:"border-red-200 shadow-lg",children:[e.jsx(ee,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(se,{className:"flex items-center gap-2 text-red-600",children:[e.jsx(Ie,{className:"w-6 h-6"}),"Productos del D√≠a"]}),e.jsx("div",{className:"animate-pulse",children:e.jsx("div",{className:"h-4 bg-gray-200 rounded w-20"})})]})}),e.jsx(H,{children:e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4",children:[...Array(3)].map((p,C)=>e.jsxs("div",{className:"animate-pulse",children:[e.jsx("div",{className:"bg-gray-200 aspect-square rounded-lg mb-3"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"h-4 bg-gray-200 rounded w-3/4"}),e.jsx("div",{className:"h-3 bg-gray-200 rounded w-1/2"})]})]},C))})})]}):!s||s.length===0?e.jsxs(Q,{className:"border-red-200 shadow-lg",children:[e.jsx(ee,{children:e.jsxs(se,{className:"flex items-center gap-2 text-red-600",children:[e.jsx(Ie,{className:"w-6 h-6"}),"Productos del D√≠a"]})}),e.jsx(H,{children:e.jsxs("div",{className:"text-center py-8",children:[e.jsx(me,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-500",children:"No hay productos del d√≠a disponibles en este momento."}),e.jsx("p",{className:"text-sm text-gray-400 mt-2",children:"¬°Vuelve ma√±ana para ver las nuevas ofertas!"})]})})]}):e.jsxs(Q,{className:"border-red-200 shadow-lg",children:[e.jsxs(ee,{children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(se,{className:"flex items-center gap-2 text-red-600",children:[e.jsx(Ie,{className:"w-6 h-6"}),"Productos del D√≠a"]}),e.jsxs(Z,{variant:"destructive",className:"animate-pulse",children:[e.jsx(me,{className:"w-3 h-3 mr-1"}),"Oferta especial"]})]}),e.jsx("p",{className:"text-sm text-gray-600",children:"Ofertas especiales disponibles solo por hoy. ¬°No te las pierdas!"})]}),e.jsxs(H,{children:[e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4",children:s.map(p=>e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute top-2 left-2 z-10",children:e.jsxs(Z,{className:"bg-red-500 text-white text-xs font-semibold",children:[e.jsx(Ie,{className:"w-3 h-3 mr-1"}),"Oferta del d√≠a"]})}),e.jsx(os,{product:p,viewMode:"grid",cartQuantity:q(p.id),onAddToCart:l,onUpdateQuantity:g,onImageClick:u,onBusinessClick:c,addingToCart:j===p.id,editingQuantity:x===p.id,tempQuantity:h,onQuantityClick:N,onQuantityChange:A,onQuantitySubmit:n,onQuantityKeyDown:E})]},p.id))}),s.length>3&&e.jsx("div",{className:"text-center mt-6",children:e.jsx("button",{className:"text-red-600 hover:text-red-700 font-medium text-sm hover:underline",children:"Ver todos los productos del d√≠a ‚Üí"})})]})]})}function Ts({onBusinessClick:s,onShowCart:r}){const{user:l}=ke(),{items:g,addToCart:u,updateCartItem:c,removeFromCart:j}=Te(),{products:x,dailyProducts:h,businesses:N,loading:A,refreshProductStock:n,refreshAllData:E}=Qs(),{openImageModal:_}=cs(),[q,p]=m.useState(""),[C,F]=m.useState("all"),[G,z]=m.useState("grid"),[v,f]=m.useState(null),[P,i]=m.useState(!1),[y,t]=m.useState(new Date),[a,o]=m.useState(null),[k,d]=m.useState(""),[S,O]=m.useState([]),L=["Comida","Bebidas","Dulces","Panader√≠a","L√°cteos","Carnes","Verduras","Frutas","Limpieza","Cuidado Personal"],b=async()=>{const B=x.filter(D=>{var pe;const ae=!q||D.name.toLowerCase().includes(q.toLowerCase())||((pe=D.description)==null?void 0:pe.toLowerCase().includes(q.toLowerCase())),re=C==="all"||D.category===C;return ae&&re});O(B)};m.useEffect(()=>{b()},[x,q,C]),m.useEffect(()=>{O(x)},[x]);const R=async(B,D=!1,ae="Producto")=>{if(!l){V.error("Debes iniciar sesi√≥n para agregar productos");return}try{f(B);const re=await u(B,1,D?"daily":"regular");re!=null&&re.success?V.success("Agregado al carrito"):V.error(`‚ùå Error: ${(re==null?void 0:re.message)||"No se pudo agregar el producto"}`)}catch(re){console.error("Error adding to cart:",re),V.error("‚ùå Error al agregar producto al carrito")}finally{f(null)}},T=async(B,D)=>{const ae=g.find(re=>re.product_id===B);ae&&(D<=0?await j(ae.id):await c(ae.id,D))},J=(B,D)=>{o(B),d(D.toString())},ie=B=>{const D=parseInt(B);!isNaN(D)&&D>=0&&d(B)},U=async B=>{const D=parseInt(k);isNaN(D)||await T(B,D),o(null),d("")},X=async(B,D)=>{B.key==="Enter"?await U(D):B.key==="Escape"&&(o(null),d(""))},te=async()=>{if(!P)try{i(!0),await n(),t(new Date),V.success("‚úÖ Productos actualizados - Nuevos productos disponibles")}catch(B){console.error("‚ùå Error en refresco manual:",B),V.error("‚ùå Error al actualizar productos - Intenta de nuevo")}finally{i(!1)}};m.useEffect(()=>{x.length>0&&t(new Date)},[x]);const ve=B=>{s(B)};return e.jsxs("div",{className:"space-y-6",children:[e.jsx(_r,{searchQuery:q,setSearchQuery:p,selectedCategory:C,setSelectedCategory:F,viewMode:G,setViewMode:z,categories:L,onSearch:b,onRefreshStock:te,onRefreshAll:E,isLoading:Object.values(A).some(Boolean),isRefreshing:P,lastUpdated:y}),e.jsxs(Je,{defaultValue:"products",className:"w-full",children:[e.jsxs(es,{className:"grid w-full grid-cols-3",children:[e.jsxs(_e,{value:"products",className:"flex items-center gap-2",children:[e.jsx(Qe,{className:"w-4 h-4"}),"Productos"]}),e.jsxs(_e,{value:"daily",className:"flex items-center gap-2",children:[e.jsx(le,{className:"w-4 h-4"}),"Del D√≠a"]}),e.jsxs(_e,{value:"businesses",className:"flex items-center gap-2",children:[e.jsx(de,{className:"w-4 h-4"}),"Negocios"]})]}),e.jsx(je,{value:"products",className:"space-y-6",children:e.jsxs(Q,{className:"border-orange-200 shadow-lg",children:[e.jsx(ee,{children:e.jsxs(se,{className:"flex items-center gap-2",children:[e.jsx(de,{className:"w-5 h-5 text-orange-500"}),"Todos los Productos"]})}),e.jsx(H,{children:e.jsx(Er,{products:S,viewMode:G,cartItems:g,onAddToCart:R,onUpdateQuantity:T,onImageClick:_,onBusinessClick:ve,addingToCart:v,editingQuantity:a,tempQuantity:k,onQuantityClick:J,onQuantityChange:ie,onQuantitySubmit:U,onQuantityKeyDown:X,loading:A.products})})]})}),e.jsx(je,{value:"daily",className:"space-y-6",children:e.jsx(Tr,{dailyProducts:h,cartItems:g,onAddToCart:R,onUpdateQuantity:T,onImageClick:_,onBusinessClick:ve,addingToCart:v,editingQuantity:a,tempQuantity:k,onQuantityClick:J,onQuantityChange:ie,onQuantitySubmit:U,onQuantityKeyDown:X,loading:A.dailyProducts})}),e.jsx(je,{value:"businesses",className:"space-y-6",children:e.jsxs(Q,{className:"border-green-200 shadow-lg",children:[e.jsx(ee,{children:e.jsxs(se,{className:"flex items-center gap-2",children:[e.jsx(de,{className:"w-5 h-5 text-green-500"}),"Negocios Locales"]})}),e.jsx(H,{children:A.businesses?e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:[...Array(6)].map((B,D)=>e.jsxs("div",{className:"animate-pulse",children:[e.jsx("div",{className:"bg-gray-200 h-32 rounded-t-lg mb-4"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"h-4 bg-gray-200 rounded w-3/4"}),e.jsx("div",{className:"h-3 bg-gray-200 rounded w-1/2"})]})]},D))}):N&&N.length>0?e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:N.map(B=>{var re;const D=B.cover_image_url||B.cover_image,ae=B.logo_url;return e.jsxs(Q,{className:"cursor-pointer hover:shadow-xl transition-all duration-300 border-green-200",onClick:()=>ve(B.id),children:[e.jsxs("div",{className:"relative",children:[D?e.jsx(ye,{src:D,alt:`Portada de ${B.business_name}`,className:"w-full h-32 object-cover rounded-t-lg",expandable:!0,onExpand:_}):e.jsx("div",{className:"w-full h-32 bg-gradient-to-r from-orange-400 to-green-400 flex items-center justify-center rounded-t-lg",children:e.jsxs("div",{className:"text-center text-white",children:[e.jsx(de,{className:"w-8 h-8 mx-auto mb-1"}),e.jsx("p",{className:"text-sm font-semibold",children:B.business_name})]})}),B.is_verified&&e.jsxs(Z,{className:"absolute top-2 right-2 bg-blue-500 text-white",children:[e.jsx(Ls,{className:"w-3 h-3 mr-1"}),"Verificado"]}),ae&&e.jsx("div",{className:"absolute bottom-2 left-2",children:e.jsx("div",{className:"w-12 h-12 rounded-full bg-white shadow-lg p-1",children:e.jsx(ye,{src:ae,alt:`Logo de ${B.business_name}`,className:"w-full h-full object-cover rounded-full",expandable:!0,onExpand:_})})})]}),e.jsxs(H,{className:"p-4",children:[e.jsx("h3",{className:"font-semibold text-lg mb-1",children:B.business_name}),e.jsx("p",{className:"text-gray-600 text-sm mb-2 line-clamp-2",children:B.business_description||"Comercio local en Gual√°n"}),e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(le,{className:"w-4 h-4 text-yellow-400 fill-current"}),e.jsx("span",{className:"text-sm text-gray-600 ml-1",children:B.rating&&B.rating>0?B.rating.toFixed(1):"Nuevo"})]}),e.jsx(Z,{variant:"outline",children:B.category||"General"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("span",{className:"text-sm text-gray-500 flex items-center",children:[e.jsx(Re,{className:"w-3 h-3 mr-1"}),B.address||B.business_address||((re=B.user)==null?void 0:re.address)||"Gual√°n, Zacapa"]}),e.jsxs(M,{size:"sm",variant:"outline",children:[e.jsx(ms,{className:"w-3 h-3 mr-1"}),"Ver productos"]})]}),e.jsx("div",{className:"mt-3 pt-3 border-t border-gray-100",children:e.jsxs("span",{className:"text-xs text-gray-500",children:[B.products_count||0," productos disponibles"]})})]})]},B.id)})}):e.jsxs("div",{className:"text-center py-12",children:[e.jsx(de,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"No hay negocios disponibles"}),e.jsx("p",{className:"text-gray-500",children:"Los negocios aparecer√°n aqu√≠ cuando est√©n disponibles."})]})})]})})]}),e.jsx(xs,{onCartClick:()=>{r&&r()}}),e.jsx(wr,{searchQuery:q,setSearchQuery:p,selectedCategory:C,setSelectedCategory:F,categories:L,onSearch:b,isLoading:A.products||A.dailyProducts||A.businesses})]})}const Ps={pending:{label:"Pendiente",color:"bg-yellow-100 text-yellow-800",description:"Esperando confirmaci√≥n del vendedor"},accepted:{label:"Aceptado",color:"bg-blue-100 text-blue-800",description:"El vendedor est√° preparando tu pedido"},ready:{label:"Listo",color:"bg-green-100 text-green-800",description:"Tu pedido est√° listo"},assigned:{label:"Repartidor asignado",color:"bg-purple-100 text-purple-800",description:"Un repartidor fue asignado"},"picked-up":{label:"En camino",color:"bg-orange-100 text-orange-800",description:"El repartidor est√° en camino"},"in-transit":{label:"En tr√°nsito",color:"bg-indigo-100 text-indigo-800",description:"Tu pedido est√° siendo entregado"},delivered:{label:"Entregado",color:"bg-green-100 text-green-800",description:"Tu pedido fue entregado"},completed:{label:"Completado",color:"bg-gray-100 text-gray-800",description:"Pedido completado exitosamente"},cancelled:{label:"Cancelado",color:"bg-red-100 text-red-800",description:"El pedido fue cancelado"},rejected:{label:"Rechazado",color:"bg-red-100 text-red-800",description:"El vendedor rechaz√≥ tu pedido"}},Is={pickup:{label:"Recoger en tienda",icon:e.jsx(de,{className:"w-4 h-4"}),color:"text-blue-600",description:"Recoge tu pedido en el establecimiento"},"dine-in":{label:"Comer en el lugar",icon:e.jsx(Us,{className:"w-4 h-4"}),color:"text-purple-600",description:"Tu pedido ser√° servido en tu mesa"},delivery:{label:"Servicio a domicilio",icon:e.jsx(ue,{className:"w-4 h-4"}),color:"text-green-600",description:"Tu pedido ser√° entregado a tu direcci√≥n"}};function Pr(s){return Ps[s]||Ps.pending}function Ir(s){return Is[s]||Is.pickup}function Hs(s){return new Date(s).toLocaleTimeString("es-GT",{hour:"2-digit",minute:"2-digit"})}function Rr(s){return new Date(s).toLocaleDateString("es-GT")}function qr(s){return s.status==="delivered"||s.status==="completed"}function Ar(s){switch(s){case"pickup":return"15-25 min";case"dine-in":return"20-30 min";case"delivery":return"30-45 min";default:return"20-30 min"}}function Ws(s){const r=[{key:"pending",label:"Pedido realizado",icon:e.jsx(xe,{className:"w-4 h-4"}),completed:!0,current:s.status==="pending",timestamp:s.created_at},{key:"accepted",label:"Pedido aceptado",icon:e.jsx(oe,{className:"w-4 h-4"}),completed:["accepted","ready","assigned","picked_up","in_transit","delivered","completed"].includes(s.status),current:s.status==="accepted",timestamp:s.accepted_at},{key:"ready",label:s.delivery_type==="pickup"?"Listo para recoger":"Pedido listo",icon:s.delivery_type==="pickup"?e.jsx(de,{className:"w-4 h-4"}):e.jsx(oe,{className:"w-4 h-4"}),completed:["ready","assigned","picked_up","in_transit","delivered","completed"].includes(s.status),current:s.status==="ready",timestamp:s.ready_at}];return s.delivery_type==="delivery"&&r.push({key:"assigned",label:"Repartidor asignado",icon:e.jsx(ue,{className:"w-4 h-4"}),completed:["assigned","picked_up","in_transit","delivered","completed"].includes(s.status),current:s.status==="assigned",timestamp:s.status==="assigned"?s.updated_at:void 0},{key:"picked_up",label:"Pedido recogido",icon:e.jsx(xe,{className:"w-4 h-4"}),completed:["picked_up","in_transit","delivered","completed"].includes(s.status),current:s.status==="picked_up",timestamp:s.picked_up_at},{key:"in_transit",label:"En camino",icon:e.jsx(ue,{className:"w-4 h-4"}),completed:["in_transit","delivered","completed"].includes(s.status),current:s.status==="in_transit",timestamp:s.status==="in_transit"?s.updated_at:void 0}),r.push({key:"delivered",label:s.delivery_type==="pickup"?"Recogido":"Entregado",icon:e.jsx(oe,{className:"w-4 h-4"}),completed:["delivered","completed"].includes(s.status),current:s.status==="delivered",timestamp:s.delivered_at}),r}function Dr(s){const r=s.filter(l=>l.completed).length;return Math.round(r/s.length*100)}function Or({order:s}){const r=Pr(s.status),l=Ir(s.delivery_type),g=Ws(s),u=Dr(g);return e.jsxs(Q,{children:[e.jsx(ee,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(se,{className:"flex items-center gap-2",children:[l.icon,"Estado del Pedido"]}),e.jsx(Z,{variant:r.color,children:r.label})]})}),e.jsxs(H,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm font-medium",children:"Progreso"}),e.jsxs("span",{className:"text-sm text-gray-600",children:[u,"%"]})]}),e.jsx($s,{value:u,className:"h-3"})]}),e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[l.icon,e.jsx("span",{className:"font-medium",children:l.label})]}),e.jsx("p",{className:"text-sm text-gray-600",children:l.description}),s.estimated_time&&e.jsxs("div",{className:"flex items-center gap-2 mt-2 text-sm text-gray-600",children:[e.jsx(me,{className:"w-4 h-4"}),e.jsxs("span",{children:["Tiempo estimado: ",Ar(s.delivery_type)]})]})]}),(s.status==="rejected"||s.status==="cancelled")&&s.rejection_reason&&e.jsxs("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(Ee,{className:"w-4 h-4 text-red-600"}),e.jsx("span",{className:"font-medium text-red-800",children:s.status==="rejected"?"Raz√≥n del rechazo":"Raz√≥n de cancelaci√≥n"})]}),e.jsx("p",{className:"text-sm text-red-700",children:s.rejection_reason})]})]})]})}function $r({order:s}){const r=Ws(s);return e.jsxs(Q,{children:[e.jsx(ee,{children:e.jsx(se,{children:"Seguimiento del Pedido"})}),e.jsx(H,{children:e.jsx("div",{className:"space-y-4",children:r.map((l,g)=>e.jsxs("div",{className:"relative flex gap-4",children:[e.jsx("div",{className:`flex-shrink-0 w-8 h-8 rounded-full border-2 flex items-center justify-center ${l.completed?"bg-green-500 border-green-500 text-white":l.current?"bg-orange-500 border-orange-500 text-white animate-pulse":"border-gray-300 text-gray-400"}`,children:l.icon}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:`font-medium ${l.completed?"text-green-700":l.current?"text-orange-700":"text-gray-500"}`,children:l.label}),l.timestamp&&e.jsx("div",{className:"text-sm text-gray-600",children:Hs(l.timestamp)})]}),g<r.length-1&&e.jsx("div",{className:`absolute left-4 mt-8 w-0.5 h-4 ${l.completed?"bg-green-500":"bg-gray-300"}`,style:{marginLeft:"15px"}})]},l.key))})})]})}function Fr({orderId:s,type:r,onClose:l,onRatingSubmitted:g}){const{rateOrder:u}=us(),[c,j]=m.useState(0),[x,h]=m.useState(0),[N,A]=m.useState(""),[n,E]=m.useState(!1),[_,q]=m.useState(null),[p,C]=m.useState(!1),F=async()=>{if(c===0){q("Por favor selecciona una calificaci√≥n");return}E(!0),q(null);try{const P=await u(s,c,r,N.trim()||void 0);P.success?(C(!0),setTimeout(()=>{g()},1500)):q(P.message)}catch(P){console.error("Error submitting rating:",P),q("Error inesperado al enviar la calificaci√≥n")}finally{E(!1)}},G=P=>{switch(P){case 1:return"Muy malo";case 2:return"Malo";case 3:return"Regular";case 4:return"Bueno";case 5:return"Excelente";default:return"Selecciona una calificaci√≥n"}},z=()=>r==="seller"?e.jsx(de,{className:"w-6 h-6"}):e.jsx(ue,{className:"w-6 h-6"}),v=()=>r==="seller"?"Calificar Vendedor":"Calificar Repartidor",f=()=>r==="seller"?"¬øC√≥mo fue tu experiencia con el vendedor y la calidad de los productos?":"¬øC√≥mo fue la experiencia con el servicio de entrega?";return p?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:e.jsx(Q,{className:"w-full max-w-md bg-white",children:e.jsxs(H,{className:"p-8 text-center bg-white",children:[e.jsx("div",{className:"bg-green-100 p-4 rounded-full w-16 h-16 mx-auto mb-4",children:e.jsx(oe,{className:"w-8 h-8 text-green-600"})}),e.jsx("h3",{className:"text-lg font-semibold mb-2 text-gray-900",children:"¬°Gracias por tu calificaci√≥n!"}),e.jsx("p",{className:"text-gray-600",children:"Tu opini√≥n nos ayuda a mejorar el servicio"})]})})}):e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:e.jsxs(Q,{className:"w-full max-w-md bg-white border border-gray-200 shadow-xl",children:[e.jsxs(ee,{className:"text-center bg-white",children:[e.jsx("div",{className:"bg-gradient-to-r from-orange-100 to-green-100 p-3 rounded-full w-16 h-16 mx-auto mb-4",children:e.jsx("div",{className:"text-orange-600",children:z()})}),e.jsx(se,{className:"text-gray-900",children:v()}),e.jsx("p",{className:"text-sm text-gray-600 font-normal",children:f()})]}),e.jsxs(H,{className:"space-y-6 bg-white",children:[_&&e.jsx(Fa,{variant:"destructive",children:e.jsx(za,{children:_})}),e.jsxs("div",{className:"text-center space-y-2",children:[e.jsx("div",{className:"flex justify-center gap-2",children:[1,2,3,4,5].map(P=>e.jsx("button",{className:"transition-all duration-200 hover:scale-110",onMouseEnter:()=>h(P),onMouseLeave:()=>h(0),onClick:()=>j(P),disabled:n,children:e.jsx(le,{className:`w-8 h-8 ${P<=(x||c)?"text-yellow-400 fill-current":"text-gray-300"}`})},P))}),e.jsx("p",{className:"text-sm text-gray-600",children:G(x||c)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Comentarios (opcional)"}),e.jsx(We,{placeholder:r==="seller"?"Cu√©ntanos sobre la calidad de los productos, el servicio al cliente, etc.":"Cu√©ntanos sobre la puntualidad, el trato, el estado de los productos, etc.",value:N,onChange:P=>A(P.target.value),rows:3,maxLength:500,disabled:n,className:"bg-white border border-gray-300"}),e.jsxs("div",{className:"text-xs text-gray-500 text-right",children:[N.length,"/500"]})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(M,{variant:"outline",onClick:l,disabled:n,className:"flex-1 bg-white border-gray-300 text-gray-700 hover:bg-gray-50",children:"Cancelar"}),e.jsx(M,{onClick:F,disabled:n||c===0,className:"flex-1 bg-gradient-to-r from-orange-500 to-green-500 hover:from-orange-600 hover:to-green-600 text-white",children:n?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent mr-2"}),"Enviando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(le,{className:"w-4 h-4 mr-2"}),"Enviar Calificaci√≥n"]})})]}),e.jsx("p",{className:"text-xs text-gray-500 text-center bg-white",children:"Tu calificaci√≥n ser√° visible para otros usuarios y ayudar√° a mejorar la calidad del servicio"})]})]})})}function zr({order:s,onOrderUpdate:r}){var j;const[l,g]=m.useState(!1),[u,c]=m.useState("seller");return e.jsxs(e.Fragment,{children:[e.jsxs(Q,{className:"sticky top-4",children:[e.jsx(ee,{children:e.jsx(se,{children:"Resumen del Pedido"})}),e.jsxs(H,{className:"space-y-4",children:[e.jsx("div",{className:"space-y-3",children:(j=s.items)==null?void 0:j.map(x=>e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-12 h-12 rounded-lg overflow-hidden bg-gray-100 flex-shrink-0",children:e.jsx(ye,{src:Gs(x.product_image),alt:x.product_name,className:"w-full h-full object-cover"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"font-medium text-sm truncate",children:x.product_name}),e.jsxs("div",{className:"text-xs text-gray-600",children:[x.quantity," x Q",x.price.toFixed(2)]})]}),e.jsxs("div",{className:"text-sm font-medium",children:["Q",(x.price*x.quantity).toFixed(2)]})]},x.id))}),e.jsx(fe,{}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Cliente:"}),e.jsx("span",{children:s.customer_name})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Tel√©fono:"}),e.jsx("span",{children:s.phone_number})]})]}),s.delivery_type==="delivery"&&s.delivery_address&&e.jsxs(e.Fragment,{children:[e.jsx(fe,{}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"text-sm font-medium text-gray-700 flex items-center gap-2",children:[e.jsx(Re,{className:"w-4 h-4"}),"Direcci√≥n de Entrega"]}),e.jsx("p",{className:"text-sm text-gray-600",children:s.delivery_address})]})]}),s.customer_notes&&e.jsxs(e.Fragment,{children:[e.jsx(fe,{}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium text-gray-700",children:"Notas especiales:"}),e.jsx("p",{className:"text-sm text-gray-600 bg-gray-50 p-2 rounded",children:s.customer_notes})]})]}),e.jsx(fe,{}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Subtotal"}),e.jsxs("span",{children:["Q",s.subtotal.toFixed(2)]})]}),s.delivery_fee>0&&e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Env√≠o"}),e.jsxs("span",{children:["Q",s.delivery_fee.toFixed(2)]})]}),e.jsx(fe,{}),e.jsxs("div",{className:"flex justify-between font-semibold",children:[e.jsx("span",{children:"Total"}),e.jsxs("span",{children:["Q",s.total.toFixed(2)]})]})]}),qr(s)&&e.jsxs(e.Fragment,{children:[e.jsx(fe,{}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h4",{className:"font-medium text-sm",children:"Calificar experiencia"}),e.jsxs("div",{className:"space-y-2",children:[!s.seller_rating&&e.jsxs(M,{variant:"outline",size:"sm",className:"w-full justify-start",onClick:()=>{c("seller"),g(!0)},children:[e.jsx(le,{className:"w-4 h-4 mr-2"}),"Calificar Vendedor"]}),s.delivery_type==="delivery"&&s.driver_id&&!s.driver_rating&&e.jsxs(M,{variant:"outline",size:"sm",className:"w-full justify-start",onClick:()=>{c("driver"),g(!0)},children:[e.jsx(le,{className:"w-4 h-4 mr-2"}),"Calificar Repartidor"]})]}),(s.seller_rating||s.driver_rating)&&e.jsxs("div",{className:"space-y-1 text-xs text-gray-600",children:[s.seller_rating&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{children:"Vendedor:"}),e.jsx("div",{className:"flex",children:[...Array(5)].map((x,h)=>e.jsx(le,{className:`w-3 h-3 ${h<s.seller_rating?"text-yellow-400 fill-current":"text-gray-300"}`},h))})]}),s.driver_rating&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{children:"Repartidor:"}),e.jsx("div",{className:"flex",children:[...Array(5)].map((x,h)=>e.jsx(le,{className:`w-3 h-3 ${h<s.driver_rating?"text-yellow-400 fill-current":"text-gray-300"}`},h))})]})]})]})]})]})]}),l&&e.jsx(Fr,{orderId:s.id,type:u,onClose:()=>g(!1),onRatingSubmitted:()=>{g(!1),r==null||r()}})]})}function Ks({orderId:s,onBack:r}){const{getOrderById:l,refreshOrders:g,loading:u}=us(),[c,j]=m.useState(null),[x,h]=m.useState(!1);m.useEffect(()=>{N()},[s]);const N=async()=>{const n=await l(s);j(n)},A=async()=>{h(!0),await g(),await N(),h(!1)};return u&&!c?e.jsx("div",{className:"max-w-4xl mx-auto p-4",children:e.jsxs("div",{className:"animate-pulse space-y-6",children:[e.jsx("div",{className:"h-8 bg-gray-200 rounded w-1/4"}),e.jsx("div",{className:"h-64 bg-gray-200 rounded"}),e.jsx("div",{className:"h-32 bg-gray-200 rounded"})]})}):c?e.jsxs("div",{className:"max-w-4xl mx-auto p-4 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(M,{variant:"outline",onClick:r,children:"‚Üê Volver"}),e.jsxs("div",{children:[e.jsxs("h1",{className:"text-2xl font-semibold",children:["Orden #",c.id.slice(-8).toUpperCase()]}),e.jsxs("p",{className:"text-gray-600",children:["Realizada el ",Rr(c.created_at)," a las ",Hs(c.created_at)]})]})]}),e.jsxs(M,{variant:"outline",onClick:A,disabled:x,size:"sm",children:[e.jsx(Ae,{className:`w-4 h-4 mr-2 ${x?"animate-spin":""}`}),x?"Actualizando...":"Actualizar"]})]}),e.jsxs("div",{className:"grid lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[e.jsx(Or,{order:c}),e.jsx($r,{order:c})]}),e.jsx("div",{className:"lg:col-span-1",children:e.jsx(zr,{order:c,onOrderUpdate:N})})]})]}):e.jsxs("div",{className:"max-w-4xl mx-auto p-4 text-center",children:[e.jsx(Ee,{className:"w-16 h-16 mx-auto mb-4 text-gray-400"}),e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Orden no encontrada"}),e.jsx("p",{className:"text-gray-600 mb-4",children:"No se pudo cargar la informaci√≥n de la orden"}),e.jsx(M,{onClick:r,children:"Volver a mis √≥rdenes"})]})}function Mr({order:s,isHistory:r=!1,onViewOrder:l,onDeleteOrder:g,onConfirmReceived:u,onReorderFn:c,deletingOrderId:j,confirmingOrderId:x}){var t;const h=a=>{const o={pending:{label:"Pendiente",color:"bg-yellow-100 text-yellow-800",icon:me,description:"Esperando confirmaci√≥n del vendedor"},accepted:{label:"Aceptado",color:"bg-blue-100 text-blue-800",icon:oe,description:"El vendedor est√° preparando tu pedido"},ready:{label:"Listo",color:"bg-green-100 text-green-800",icon:xe,description:"Tu pedido est√° listo"},assigned:{label:"Repartidor asignado",color:"bg-purple-100 text-purple-800",icon:ue,description:"Un repartidor fue asignado"},picked_up:{label:"En camino",color:"bg-orange-100 text-orange-800",icon:ue,description:"El repartidor est√° en camino"},"in-transit":{label:"En tr√°nsito",color:"bg-indigo-100 text-indigo-800",icon:ue,description:"Tu pedido est√° siendo entregado"},delivered:{label:"Entregado",color:"bg-green-100 text-green-800",icon:oe,description:"Tu pedido fue entregado"},completed:{label:"Completado",color:"bg-gray-100 text-gray-800",icon:pr,description:"Pedido completado exitosamente"},cancelled:{label:"Cancelado",color:"bg-red-100 text-red-800",icon:De,description:"El pedido fue cancelado"},rejected:{label:"Rechazado",color:"bg-red-100 text-red-800",icon:De,description:"El vendedor rechaz√≥ tu pedido"}};return o[a]||o.pending},N=a=>{const o={pickup:{label:"Recoger en tienda",icon:de,color:"text-blue-600"},"dine-in":{label:"Comer dentro",icon:Us,color:"text-purple-600"},delivery:{label:"Servicio a domicilio",icon:ue,color:"text-green-600"}};return o[a]||o.pickup},A=a=>({pending:10,accepted:25,ready:50,assigned:60,picked_up:75,in_transit:85,delivered:95,completed:100,cancelled:0,rejected:0})[a]||0,n=a=>a==="pending",E=a=>a==="delivered",_=h(s.status),q=N(s.delivery_type),p=A(s.status),C=_.icon,F=q.icon,G=n(s.status),z=E(s.status),v=j===s.id,f=x===s.id,P=r?"border-gray-200 hover:shadow-md transition-shadow":"border-orange-200 shadow-lg hover:shadow-xl transition-shadow",i=r?"bg-gray-100":"bg-orange-100",y=r?"text-gray-600":"text-orange-600";return e.jsx(Q,{className:P,children:e.jsxs(H,{className:"p-6",children:[e.jsxs("div",{className:"flex items-start justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:`${i} p-2 rounded-lg`,children:e.jsx(C,{className:`w-5 h-5 ${y}`})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-lg",children:s.seller_name||"Vendedor"}),e.jsxs("p",{className:"text-sm text-gray-600",children:["Pedido #",s.id.slice(-8).toUpperCase()]})]})]}),e.jsxs("div",{className:"text-right flex flex-col items-end gap-2",children:[e.jsx(Z,{className:_.color,children:_.label}),e.jsx("p",{className:"text-sm text-gray-500",children:new Date(s.created_at).toLocaleDateString("es-GT")}),G&&g&&e.jsxs(Ma,{children:[e.jsx(La,{asChild:!0,children:e.jsx(M,{variant:"outline",size:"sm",className:"border-red-200 text-red-600 hover:bg-red-50 hover:border-red-300 h-8 px-2",disabled:v,title:"Eliminar pedido no confirmado",children:v?e.jsx(Ae,{className:"w-3 h-3 animate-spin"}):e.jsx(Ke,{className:"w-3 h-3"})})}),e.jsxs(Ba,{className:"bg-white",children:[e.jsxs(Ua,{children:[e.jsxs(Va,{className:"flex items-center gap-2",children:[e.jsx(Xe,{className:"w-5 h-5 text-red-600"}),"¬øEliminar pedido no confirmado?"]}),e.jsxs(Ga,{children:["Est√°s a punto de eliminar tu pedido de ",e.jsx("strong",{children:s.seller_name})," por un total de ",e.jsxs("strong",{children:["Q",s.total.toFixed(2)]}),".",e.jsx("br",{}),e.jsx("br",{}),"Esta acci√≥n no se puede deshacer. El pedido ser√° eliminado permanentemente y no podr√°s recuperarlo.",e.jsx("br",{}),e.jsx("br",{}),e.jsx("span",{className:"text-yellow-600 font-medium",children:"üí° Tip:"})," Tambi√©n puedes esperar a que el vendedor responda a tu pedido."]})]}),e.jsxs(Qa,{children:[e.jsx(Ha,{children:"Mantener pedido"}),e.jsx(Wa,{onClick:()=>g(s.id,s.seller_name||"Vendedor"),className:"bg-red-600 hover:bg-red-700",disabled:v,children:v?e.jsxs(e.Fragment,{children:[e.jsx(Ae,{className:"w-4 h-4 mr-2 animate-spin"}),"Eliminando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Ke,{className:"w-4 h-4 mr-2"}),"S√≠, eliminar pedido"]})})]})]})]})]})]}),e.jsxs("div",{className:"space-y-4",children:[!r&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600",children:_.description}),e.jsxs("span",{className:"font-medium",children:[p,"%"]})]}),e.jsx($s,{value:p,className:"h-2"})]}),G&&e.jsxs("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-3 flex items-start gap-2",children:[e.jsx(Xe,{className:"w-4 h-4 text-yellow-600 mt-0.5 flex-shrink-0"}),e.jsxs("div",{className:"flex-1 text-sm",children:[e.jsx("p",{className:"text-yellow-700 font-medium",children:"Pedido pendiente de confirmaci√≥n"}),e.jsx("p",{className:"text-yellow-600 text-xs mt-1",children:"Si el vendedor no acepta tu pedido o demora mucho en responder, puedes eliminarlo usando el bot√≥n üóëÔ∏è arriba."})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 p-4 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(F,{className:`w-4 h-4 ${q.color}`}),e.jsx("span",{className:"text-sm font-medium",children:q.label})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(xe,{className:"w-4 h-4 text-gray-500"}),e.jsxs("span",{className:"text-sm",children:[((t=s.items)==null?void 0:t.length)||0," productos"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(me,{className:"w-4 h-4 text-gray-500"}),e.jsxs("span",{className:"text-sm",children:[s.estimated_time||30," min estimado"]})]})]}),s.items&&s.items.length>0&&e.jsxs("div",{className:"flex gap-2 overflow-x-auto",children:[s.items.slice(0,r?4:3).map(a=>{var o;return e.jsxs("div",{className:"flex-shrink-0 flex items-center gap-2 bg-white border rounded-lg p-2",children:[e.jsx("div",{className:"w-10 h-10 rounded overflow-hidden bg-gray-100",children:e.jsx(ye,{src:Gs(a.product_image)||"",alt:a.product_name,className:"w-full h-full object-cover"})}),e.jsxs("div",{className:"text-sm",children:[e.jsx("div",{className:"font-medium truncate w-24",children:a.product_name}),e.jsxs("div",{className:"text-gray-500",children:[a.quantity,"x Q",((o=a.price)==null?void 0:o.toFixed(2))||"0.00"]})]})]},a.id)}),s.items.length>(r?4:3)&&e.jsx("div",{className:"flex-shrink-0 flex items-center justify-center bg-gray-100 rounded-lg w-16 h-16",children:e.jsxs("span",{className:"text-sm text-gray-600",children:["+",s.items.length-(r?4:3)]})})]}),e.jsxs("div",{className:"flex items-center justify-between pt-2 border-t border-gray-100",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("span",{className:"text-lg font-semibold text-green-600",children:["Q",s.total.toFixed(2)]}),r&&(s.seller_rating||s.driver_rating)&&e.jsxs("div",{className:"flex items-center gap-2",children:[s.seller_rating&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(le,{className:"w-4 h-4 text-yellow-400 fill-current"}),e.jsx("span",{className:"text-sm",children:s.seller_rating})]}),s.driver_rating&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ue,{className:"w-4 h-4 text-blue-500"}),e.jsx(le,{className:"w-3 h-3 text-yellow-400 fill-current"}),e.jsx("span",{className:"text-sm",children:s.driver_rating})]})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(M,{variant:"outline",size:"sm",onClick:()=>l(s.id),children:[e.jsx(ms,{className:"w-4 h-4 mr-2"}),"Ver detalles"]}),z&&u&&e.jsx(M,{variant:"default",size:"sm",onClick:()=>u(s.id,s.seller_name||"Vendedor"),disabled:f,className:"bg-green-600 hover:bg-green-700",children:f?e.jsxs(e.Fragment,{children:[e.jsx(Ae,{className:"w-4 h-4 mr-2 animate-spin"}),"Confirmando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(oe,{className:"w-4 h-4 mr-2"}),"Confirmar recibido"]})}),r&&c&&e.jsxs(M,{variant:"outline",size:"sm",onClick:()=>c(s.id),children:[e.jsx(Pa,{className:"w-4 h-4 mr-2"}),"Volver a pedir"]})]})]})]})]})})}function Rs({orders:s,isHistory:r=!1,loading:l=!1,onViewOrder:g,onDeleteOrder:u,onConfirmReceived:c,onReorderFn:j,deletingOrderId:x,confirmingOrderId:h,emptyTitle:N,emptyDescription:A}){if(l)return e.jsx("div",{className:"space-y-4",children:[...Array(3)].map((n,E)=>e.jsx("div",{className:"animate-pulse",children:e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-6 shadow-sm",children:[e.jsxs("div",{className:"flex items-start justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"bg-gray-200 w-10 h-10 rounded-lg"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"bg-gray-200 h-5 w-32 rounded"}),e.jsx("div",{className:"bg-gray-200 h-4 w-24 rounded"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"bg-gray-200 h-6 w-20 rounded-full"}),e.jsx("div",{className:"bg-gray-200 h-4 w-16 rounded"})]})]}),!r&&e.jsxs("div",{className:"space-y-2 mb-4",children:[e.jsx("div",{className:"bg-gray-200 h-4 w-full rounded"}),e.jsx("div",{className:"bg-gray-200 h-2 w-full rounded"})]}),e.jsx("div",{className:"bg-gray-100 p-4 rounded-lg mb-4",children:e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsx("div",{className:"bg-gray-200 h-4 w-24 rounded"}),e.jsx("div",{className:"bg-gray-200 h-4 w-20 rounded"}),e.jsx("div",{className:"bg-gray-200 h-4 w-28 rounded"})]})}),e.jsx("div",{className:"flex gap-2 mb-4",children:[...Array(3)].map((_,q)=>e.jsxs("div",{className:"flex items-center gap-2 bg-gray-50 p-2 rounded-lg",children:[e.jsx("div",{className:"bg-gray-200 w-10 h-10 rounded"}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"bg-gray-200 h-3 w-20 rounded"}),e.jsx("div",{className:"bg-gray-200 h-3 w-12 rounded"})]})]},q))}),e.jsxs("div",{className:"flex items-center justify-between pt-2 border-t border-gray-100",children:[e.jsx("div",{className:"bg-gray-200 h-6 w-20 rounded"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("div",{className:"bg-gray-200 h-8 w-24 rounded"}),e.jsx("div",{className:"bg-gray-200 h-8 w-28 rounded"})]})]})]})},E))});if(s.length===0){const n=r?"No hay pedidos en el historial":"No tienes pedidos activos",E=r?"Tus pedidos completados, cancelados o rechazados aparecer√°n aqu√≠":"Tus pedidos en proceso aparecer√°n aqu√≠";return e.jsxs("div",{className:"flex flex-col items-center justify-center py-16 px-4",children:[e.jsx("div",{className:"bg-gray-100 rounded-full p-6 mb-6",children:e.jsx(we,{className:"w-16 h-16 text-gray-400"})}),e.jsx("h3",{className:"text-xl font-semibold text-gray-900 mb-2 text-center",children:N||n}),e.jsx("p",{className:"text-gray-500 text-center max-w-md",children:A||E}),!r&&e.jsx("div",{className:"mt-6 p-4 bg-orange-50 rounded-lg border border-orange-200",children:e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-orange-700 font-medium text-sm mb-2",children:"üí° ¬øQuieres hacer tu primer pedido?"}),e.jsx("p",{className:"text-orange-600 text-sm",children:"Explora los productos disponibles y agrega algunos al carrito"})]})})]})}return e.jsx("div",{className:"space-y-4",children:s.map(n=>e.jsx(Mr,{order:n,isHistory:r,onViewOrder:g,onDeleteOrder:u,onConfirmReceived:c,onReorderFn:j,deletingOrderId:x,confirmingOrderId:h},n.id))})}function Lr({stats:s,loading:r=!1}){if(r)return e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:[...Array(4)].map((c,j)=>e.jsx(Q,{className:"animate-pulse",children:e.jsx(H,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"bg-gray-200 h-4 w-20 rounded"}),e.jsx("div",{className:"bg-gray-200 h-6 w-16 rounded"})]}),e.jsx("div",{className:"bg-gray-200 w-8 h-8 rounded"})]})})},j))});const l=[{title:"Total de Pedidos",value:s.totalOrders,icon:we,color:"text-blue-600",bgColor:"bg-blue-100",description:"Pedidos realizados"},{title:"Pedidos Activos",value:s.activeOrders,icon:me,color:"text-orange-600",bgColor:"bg-orange-100",description:"En proceso"},{title:"Completados",value:s.completedOrders,icon:oe,color:"text-green-600",bgColor:"bg-green-100",description:"Exitosos"},{title:"Total Gastado",value:`Q${s.totalSpent.toFixed(2)}`,icon:wa,color:"text-purple-600",bgColor:"bg-purple-100",description:"Inversi√≥n total"}],g=[{label:"Promedio por pedido",value:`Q${s.averageOrderValue.toFixed(2)}`,icon:Qe,color:"text-green-600"},{label:"Calificaci√≥n promedio",value:s.averageRating>0?`${s.averageRating.toFixed(1)} ‚òÖ`:"Sin calificar",icon:le,color:"text-yellow-600"},{label:"Este mes",value:`${s.thisMonthOrders} pedidos`,icon:Me,color:"text-indigo-600"}],u=[{label:"A domicilio",value:s.deliveryOrders,icon:ue,color:"text-green-600",percentage:s.totalOrders>0?(s.deliveryOrders/s.totalOrders*100).toFixed(0):0},{label:"Recoger en tienda",value:s.pickupOrders,icon:xe,color:"text-blue-600",percentage:s.totalOrders>0?(s.pickupOrders/s.totalOrders*100).toFixed(0):0},{label:"Comer en lugar",value:s.dineInOrders,icon:xe,color:"text-purple-600",percentage:s.totalOrders>0?(s.dineInOrders/s.totalOrders*100).toFixed(0):0}];return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:l.map((c,j)=>{const x=c.icon;return e.jsx(Q,{className:"border-orange-200 shadow-lg hover:shadow-xl transition-shadow",children:e.jsx(H,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-sm font-medium text-gray-600",children:c.title}),e.jsx("p",{className:"text-2xl font-bold text-gray-900",children:c.value}),e.jsx("p",{className:"text-xs text-gray-500",children:c.description})]}),e.jsx("div",{className:`${c.bgColor} p-3 rounded-lg`,children:e.jsx(x,{className:`w-6 h-6 ${c.color}`})})]})})},j)})}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs(Q,{className:"border-orange-200 shadow-lg",children:[e.jsx(ee,{children:e.jsxs(se,{className:"flex items-center gap-2 text-lg",children:[e.jsx(Qe,{className:"w-5 h-5 text-orange-500"}),"M√©tricas Adicionales"]})}),e.jsx(H,{className:"space-y-4",children:g.map((c,j)=>{const x=c.icon;return e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(x,{className:`w-4 h-4 ${c.color}`}),e.jsx("span",{className:"text-sm font-medium text-gray-700",children:c.label})]}),e.jsx(Z,{variant:"outline",className:"font-medium",children:c.value})]},j)})})]}),e.jsxs(Q,{className:"border-orange-200 shadow-lg",children:[e.jsx(ee,{children:e.jsxs(se,{className:"flex items-center gap-2 text-lg",children:[e.jsx(ue,{className:"w-5 h-5 text-orange-500"}),"Tipos de Entrega"]})}),e.jsx(H,{className:"space-y-4",children:u.map((c,j)=>{const x=c.icon;return e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(x,{className:`w-4 h-4 ${c.color}`}),e.jsx("span",{className:"text-sm font-medium text-gray-700",children:c.label})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-sm font-bold text-gray-900",children:c.value}),e.jsxs(Z,{variant:"secondary",className:"text-xs",children:[c.percentage,"%"]})]})]}),e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-2",children:e.jsx("div",{className:`${c.color.replace("text-","bg-")} h-2 rounded-full transition-all duration-300`,style:{width:`${c.percentage}%`}})})]},j)})})]})]}),s.totalOrders>0&&e.jsx(Q,{className:"border-green-200 bg-green-50",children:e.jsx(H,{className:"p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"bg-green-100 p-2 rounded-lg",children:e.jsx(Qe,{className:"w-5 h-5 text-green-600"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-medium text-green-900 mb-1",children:"Resumen de tu actividad"}),e.jsxs("div",{className:"text-sm text-green-700 space-y-1",children:[e.jsxs("p",{children:["‚Ä¢ Has realizado ",e.jsx("strong",{children:s.totalOrders})," pedidos con un gasto total de ",e.jsxs("strong",{children:["Q",s.totalSpent.toFixed(2)]})]}),e.jsxs("p",{children:["‚Ä¢ Tu pedido promedio es de ",e.jsxs("strong",{children:["Q",s.averageOrderValue.toFixed(2)]})]}),s.cancelledOrders>0&&e.jsxs("p",{children:["‚Ä¢ Tasa de √©xito: ",e.jsxs("strong",{children:[(s.completedOrders/s.totalOrders*100).toFixed(0),"%"]}),"(",s.cancelledOrders," cancelados)"]}),s.averageRating>0&&e.jsxs("p",{children:["‚Ä¢ Calificaci√≥n promedio que das: ",e.jsxs("strong",{children:[s.averageRating.toFixed(1)," estrellas"]})]})]})]})]})})})]})}function qs({onViewOrder:s}){const{orders:r,loading:l,refreshOrders:g,deleteUnconfirmedOrder:u}=us(),{user:c}=ke(),[j,x]=m.useState("orders"),[h,N]=m.useState(null),[A,n]=m.useState(!1),[E,_]=m.useState(null),[q,p]=m.useState(null),C=i=>{N(i),s&&s(i)},F=async(i,y)=>{_(i);try{const t=await u(i);t.success?(V.success("Pedido eliminado",{description:`El pedido de ${y} ha sido eliminado exitosamente.`,duration:4e3}),await g()):V.error("Error",{description:t.message||"No se pudo eliminar el pedido.",duration:5e3})}catch(t){console.error("Error deleting order:",t),V.error("Error",{description:"Error inesperado al eliminar el pedido.",duration:5e3})}finally{_(null)}},G=async(i,y)=>{var t;if(c!=null&&c.id){p(i);try{const{error:a}=await I.from("orders").update({status:"completed",completed_at:new Date().toISOString(),updated_at:new Date().toISOString()}).eq("id",i);if(a)throw a;const{error:o}=await I.from("notifications").insert([{recipient_id:(t=(await I.from("orders").select("seller_id").eq("id",i).single()).data)==null?void 0:t.seller_id,type:"order_completed_by_buyer",title:"‚úÖ Comprador confirm√≥ recepci√≥n",message:`El comprador confirm√≥ que recibi√≥ su pedido #${i.slice(0,8)}. ¬°Pedido completado exitosamente!`,data:{order_id:i,buyer_id:c.id},created_at:new Date().toISOString()}]);o&&console.error("Error enviando notificaci√≥n:",o),V.success("¬°Orden confirmada!",{description:`Has confirmado que recibiste tu pedido de ${y}.`,duration:4e3}),await g()}catch(a){console.error("Error confirming order received:",a),V.error("Error",{description:"No se pudo confirmar la recepci√≥n de la orden.",duration:5e3})}finally{p(null)}}},z=async i=>{V.info("Funci√≥n en desarrollo",{description:"La funcionalidad de volver a pedir estar√° disponible pronto.",duration:3e3})},v=r.filter(i=>!["delivered","completed","cancelled","rejected"].includes(i.status)),f=r.filter(i=>["delivered","completed","cancelled","rejected"].includes(i.status)),P=m.useMemo(()=>{const i=r.length,y=r.filter(T=>!["delivered","completed","cancelled","rejected"].includes(T.status)).length,t=r.filter(T=>["delivered","completed"].includes(T.status)).length,a=r.filter(T=>["cancelled","rejected"].includes(T.status)).length,o=r.filter(T=>["delivered","completed"].includes(T.status)).reduce((T,J)=>T+J.total,0),k=t>0?o/t:0,d=0,S=new Date;S.setDate(1);const O=r.filter(T=>new Date(T.created_at)>=S).length,L=r.filter(T=>T.delivery_type==="delivery").length,b=r.filter(T=>T.delivery_type==="pickup").length,R=r.filter(T=>T.delivery_type==="dine-in").length;return{totalOrders:i,activeOrders:y,completedOrders:t,cancelledOrders:a,totalSpent:o,averageOrderValue:k,averageRating:d,thisMonthOrders:O,deliveryOrders:L,pickupOrders:b,dineInOrders:R}},[r]);return h?e.jsx(Ks,{orderId:h,onBack:()=>N(null)}):e.jsx("div",{className:"space-y-6",children:e.jsxs(Je,{value:j,onValueChange:x,className:"space-y-6",children:[e.jsxs(es,{className:"grid w-full grid-cols-3 lg:w-[400px] mx-auto bg-white border border-orange-200",children:[e.jsxs(_e,{value:"orders",className:"data-[state=active]:bg-orange-100 data-[state=active]:text-orange-700",children:["Pedidos (",v.length,")"]}),e.jsxs(_e,{value:"history",className:"data-[state=active]:bg-gray-100 data-[state=active]:text-gray-700",children:["Historial (",f.length,")"]}),e.jsx(_e,{value:"stats",className:"data-[state=active]:bg-blue-100 data-[state=active]:text-blue-700",children:"Estad√≠sticas"})]}),e.jsx(je,{value:"orders",className:"space-y-4",children:e.jsx(Rs,{orders:v,isHistory:!1,loading:l,onViewOrder:C,onDeleteOrder:F,onConfirmReceived:G,deletingOrderId:E,confirmingOrderId:q,emptyTitle:"No tienes pedidos activos",emptyDescription:"Tus pedidos en proceso aparecer√°n aqu√≠"})}),e.jsx(je,{value:"history",className:"space-y-4",children:e.jsx(Rs,{orders:f,isHistory:!0,loading:l,onViewOrder:C,onReorderFn:z,emptyTitle:"No hay pedidos en el historial",emptyDescription:"Tus pedidos completados, cancelados o rechazados aparecer√°n aqu√≠"})}),e.jsx(je,{value:"stats",className:"space-y-6",children:e.jsx(Lr,{stats:P,loading:l})})]})})}var gs="Avatar",[Br,Kt]=ds(gs),[Ur,Xs]=Br(gs),Zs=m.forwardRef((s,r)=>{const{__scopeAvatar:l,...g}=s,[u,c]=m.useState("idle");return e.jsx(Ur,{scope:l,imageLoadingStatus:u,onImageLoadingStatusChange:c,children:e.jsx($e.span,{...g,ref:r})})});Zs.displayName=gs;var Ys="AvatarImage",Js=m.forwardRef((s,r)=>{const{__scopeAvatar:l,src:g,onLoadingStatusChange:u=()=>{},...c}=s,j=Xs(Ys,l),x=Vr(g,c.referrerPolicy),h=pa(N=>{u(N),j.onImageLoadingStatusChange(N)});return Fs(()=>{x!=="idle"&&h(x)},[x,h]),x==="loaded"?e.jsx($e.img,{...c,ref:r,src:g}):null});Js.displayName=Ys;var ea="AvatarFallback",sa=m.forwardRef((s,r)=>{const{__scopeAvatar:l,delayMs:g,...u}=s,c=Xs(ea,l),[j,x]=m.useState(g===void 0);return m.useEffect(()=>{if(g!==void 0){const h=window.setTimeout(()=>x(!0),g);return()=>window.clearTimeout(h)}},[g]),j&&c.imageLoadingStatus!=="loaded"?e.jsx($e.span,{...u,ref:r}):null});sa.displayName=ea;function Vr(s,r){const[l,g]=m.useState("idle");return Fs(()=>{if(!s){g("error");return}let u=!0;const c=new window.Image,j=x=>()=>{u&&g(x)};return g("loading"),c.onload=j("loaded"),c.onerror=j("error"),c.src=s,r&&(c.referrerPolicy=r),()=>{u=!1}},[s,r]),l}var Gr=Zs,Qr=Js,Hr=sa;function Wr({className:s,...r}){return e.jsx(Gr,{"data-slot":"avatar",className:Ue("relative flex size-10 shrink-0 overflow-hidden rounded-full",s),...r})}function Kr({className:s,...r}){return e.jsx(Qr,{"data-slot":"avatar-image",className:Ue("aspect-square size-full",s),...r})}function Xr({className:s,...r}){return e.jsx(Hr,{"data-slot":"avatar-fallback",className:Ue("bg-muted flex size-full items-center justify-center rounded-full",s),...r})}function As({onShowCart:s}){const{user:r,updateProfile:l}=ke(),{getCartItemCount:g}=Te(),[u,c]=m.useState(null),[j,x]=m.useState(!1),[h,N]=m.useState(!1),[A,n]=m.useState(!1),[E,_]=m.useState(""),[q,p]=m.useState(""),C=m.useRef(null),[F,G]=m.useState({total_orders:0,completed_orders:0,total_spent:0,average_rating:0});m.useEffect(()=>{r&&(z(),P())},[r]);const z=async()=>{if(r)try{const{data:t,error:a}=await I.from("users").select("*").eq("id",r.id).single();if(a)throw a;c({...t,notification_preferences:t.notification_preferences||{order_updates:!0,promotions:!0,new_products:!1}})}catch(t){console.error("Error loading profile:",t)}},v=(t,a,o,k=.9)=>new Promise(d=>{const S=document.createElement("canvas"),O=S.getContext("2d"),L=new Image;L.onload=()=>{let{width:b,height:R}=L;b>R?b>a&&(R=R*a/b,b=a):R>o&&(b=b*o/R,R=o),S.width=b,S.height=R,O.drawImage(L,0,0,b,R),S.toBlob(d,"image/jpeg",k)},L.src=URL.createObjectURL(t)}),f=async t=>{var o;const a=(o=t.target.files)==null?void 0:o[0];if(!(!a||!r))try{n(!0),_(""),p("");const k=["image/jpeg","image/jpg","image/png","image/webp"],d=5*1024*1024;if(!k.includes(a.type.toLowerCase())){_("Solo se permiten im√°genes JPG, PNG o WebP");return}if(a.size>d){_("La imagen debe ser menor a 5MB");return}const S=await v(a,400,400,.85);if(!S){_("Error al procesar la imagen");return}const O=`${r.id}/avatar-${Date.now()}.jpg`,{error:L}=await I.storage.from("user-avatars").upload(O,S,{upsert:!0,contentType:"image/jpeg"});if(L){console.error("Upload error:",L),_(`Error subiendo imagen: ${L.message}`);return}const{data:b}=I.storage.from("user-avatars").getPublicUrl(O),{error:R}=await I.from("users").update({avatar_url:b.publicUrl,updated_at:new Date().toISOString()}).eq("id",r.id);if(R){_(`Error guardando en base de datos: ${R.message}`);return}c(T=>T?{...T,avatar_url:b.publicUrl}:null),await l({avatar_url:b.publicUrl}),p("‚úÖ Foto de perfil actualizada correctamente"),setTimeout(()=>p(""),3e3)}catch(k){console.error("Avatar upload error:",k),_(`Error: ${k.message||"Error desconocido"}`)}finally{n(!1),C.current&&(C.current.value="")}},P=async()=>{if(r)try{const{data:t,error:a}=await I.from("orders").select("total, status, seller_rating, created_at, delivery_type").eq("buyer_id",r.id);if(a){console.error("Error loading orders:",a);return}if(!t||t.length===0){G({total_orders:0,completed_orders:0,total_spent:0,average_rating:0});return}const o=t.reduce((d,S)=>{d.total_orders++;const O=Number(S.total)||0;return S.status==="completed"&&(d.completed_orders++,d.total_spent+=O),S.seller_rating&&S.seller_rating>0&&d.ratings.push(Number(S.seller_rating)),d},{total_orders:0,completed_orders:0,total_spent:0,ratings:[]}),k=o.ratings.length>0?o.ratings.reduce((d,S)=>d+S,0)/o.ratings.length:0;G({total_orders:o.total_orders,completed_orders:o.completed_orders,total_spent:o.total_spent,average_rating:Math.round(k*10)/10})}catch(t){console.error("Error loading order stats:",t),G({total_orders:0,completed_orders:0,total_spent:0,average_rating:0})}},i=async()=>{if(u){N(!0),_("");try{const{error:t}=await I.from("users").update({name:u.name,phone:u.phone,address:u.address,preferred_delivery_address:u.preferred_delivery_address}).eq("id",u.id);if(t)throw t;await l({name:u.name,phone:u.phone}),p("‚úÖ Perfil actualizado correctamente"),x(!1),setTimeout(()=>p(""),3e3)}catch(t){console.error("Error updating profile:",t),_("Error al actualizar perfil: "+t.message)}finally{N(!1)}}},y=(t,a)=>{u&&c({...u,notification_preferences:{...u.notification_preferences,[t]:a}})};return u?e.jsxs("div",{className:"space-y-4 sm:space-y-6 p-4 sm:p-0",children:[E&&e.jsx("div",{className:"bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg",children:e.jsx("p",{className:"break-words",children:E})}),q&&e.jsx("div",{className:"bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg",children:e.jsx("p",{className:"break-words",children:q})}),e.jsx(Q,{className:"border-orange-200 shadow-lg",children:e.jsx(H,{className:"p-4 sm:p-6",children:e.jsxs("div",{className:"flex flex-col sm:flex-row items-center gap-4 sm:gap-6",children:[e.jsxs("div",{className:"relative flex-shrink-0",children:[e.jsxs(Wr,{className:"w-20 h-20 sm:w-24 sm:h-24 border-4 border-white shadow-lg",children:[e.jsx(Kr,{src:u.avatar_url,className:"object-cover"}),e.jsx(Xr,{className:"text-xl sm:text-2xl bg-gradient-to-r from-orange-500 to-green-500 text-white",children:u.name.charAt(0).toUpperCase()})]}),e.jsx("input",{ref:C,type:"file",accept:"image/*",className:"hidden",onChange:f}),e.jsx(M,{size:"sm",variant:"outline",className:"absolute -bottom-2 -right-2 h-8 w-8 p-0 rounded-full bg-white shadow-lg hover:bg-orange-50 transition-colors",onClick:()=>{var t;return(t=C.current)==null?void 0:t.click()},disabled:A,children:A?e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-orange-500"}):e.jsx(Ka,{className:"w-4 h-4 text-orange-600"})})]}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h2",{className:"text-2xl font-bold",children:u.name}),e.jsxs(M,{variant:"outline",size:"sm",onClick:()=>x(!j),children:[e.jsx(Ia,{className:"w-4 h-4 mr-2"}),j?"Cancelar":"Editar perfil"]})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:gap-4 text-sm text-gray-600 mb-3 space-y-2 sm:space-y-0",children:[e.jsxs("div",{className:"flex items-center gap-1 break-all",children:[e.jsx(Xa,{className:"w-4 h-4 flex-shrink-0"}),e.jsx("span",{className:"truncate",children:u.email})]}),u.phone&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ls,{className:"w-4 h-4 flex-shrink-0"}),e.jsx("span",{children:u.phone})]}),e.jsxs(Z,{variant:"outline",className:"border-green-200 text-green-700 w-fit",children:[e.jsx(_s,{className:"w-3 h-3 mr-1"}),"Comprador verificado"]})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-3 sm:gap-4",children:[e.jsxs("div",{className:"text-center p-3 bg-orange-50 rounded-lg border border-orange-100",children:[e.jsx("div",{className:"text-xl sm:text-2xl font-bold text-orange-600",children:F.total_orders}),e.jsx("div",{className:"text-xs text-gray-600",children:"Pedidos totales"}),F.completed_orders>0&&e.jsxs("div",{className:"text-xs text-green-600 mt-1",children:[F.completed_orders," completados"]})]}),e.jsxs("div",{className:"text-center p-3 bg-green-50 rounded-lg border border-green-100",children:[e.jsxs("div",{className:"text-xl sm:text-2xl font-bold text-green-600",children:["Q",F.total_spent.toFixed(0)]}),e.jsx("div",{className:"text-xs text-gray-600",children:"Total gastado"}),F.total_orders>0&&e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["Promedio: Q",(F.total_spent/F.completed_orders||0).toFixed(0)]})]}),e.jsxs("div",{className:"text-center p-3 bg-yellow-50 rounded-lg border border-yellow-100",children:[e.jsxs("div",{className:"text-xl sm:text-2xl font-bold text-yellow-600 flex items-center justify-center gap-1",children:[F.average_rating>0?F.average_rating.toFixed(1):"0.0",e.jsx(le,{className:"w-4 h-4 fill-current"})]}),e.jsx("div",{className:"text-xs text-gray-600",children:"Tu calificaci√≥n"}),F.average_rating===0&&F.total_orders>0&&e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:"Sin calificar a√∫n"})]})]})]})]})})}),e.jsxs("div",{className:"grid grid-cols-1 xl:grid-cols-2 gap-6",children:[e.jsxs(Q,{className:"border-blue-200",children:[e.jsx(ee,{children:e.jsxs(se,{className:"flex items-center gap-2",children:[e.jsx(Oe,{className:"w-5 h-5 text-blue-500"}),"Informaci√≥n Personal"]})}),e.jsxs(H,{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 gap-4",children:[e.jsxs("div",{children:[e.jsx(he,{htmlFor:"name",children:"Nombre completo"}),e.jsx(be,{id:"name",value:u.name,onChange:t=>c({...u,name:t.target.value}),disabled:!j,className:"mt-1"})]}),e.jsxs("div",{children:[e.jsx(he,{htmlFor:"email",children:"Correo electr√≥nico"}),e.jsx(be,{id:"email",type:"email",value:u.email,disabled:!0,className:"mt-1 bg-gray-50"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"El correo no se puede cambiar"})]}),e.jsxs("div",{children:[e.jsx(he,{htmlFor:"phone",children:"Tel√©fono"}),e.jsx(be,{id:"phone",value:u.phone||"",onChange:t=>c({...u,phone:t.target.value}),disabled:!j,placeholder:"Tu n√∫mero de tel√©fono",className:"mt-1"})]}),e.jsxs("div",{children:[e.jsx(he,{htmlFor:"date_of_birth",children:"Fecha de nacimiento"}),e.jsx(be,{id:"date_of_birth",type:"date",value:u.date_of_birth||"",onChange:t=>c({...u,date_of_birth:t.target.value}),disabled:!j,className:"mt-1"})]})]}),j&&e.jsxs(M,{onClick:i,disabled:h,className:"w-full bg-gradient-to-r from-orange-500 to-green-500 hover:from-orange-600 hover:to-green-600",children:[e.jsx(ws,{className:"w-4 h-4 mr-2"}),h?"Guardando...":"Guardar cambios"]}),E&&e.jsx("div",{className:"p-3 bg-red-50 border border-red-200 rounded-lg",children:e.jsx("p",{className:"text-red-700 text-sm",children:E})}),q&&e.jsx("div",{className:"p-3 bg-green-50 border border-green-200 rounded-lg",children:e.jsx("p",{className:"text-green-700 text-sm",children:q})})]})]}),e.jsxs(Q,{className:"border-green-200",children:[e.jsx(ee,{children:e.jsxs(se,{className:"flex items-center gap-2",children:[e.jsx(Re,{className:"w-5 h-5 text-green-500"}),"Gesti√≥n de Direcciones"]})}),e.jsx(H,{children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(he,{htmlFor:"preferred_delivery_address",children:"Direcci√≥n principal de entrega"}),e.jsx(We,{id:"preferred_delivery_address",className:"mt-1",rows:3,placeholder:"Ingresa tu direcci√≥n completa (calle, n√∫mero, colonia, referencias)",value:u.preferred_delivery_address||"",onChange:t=>c({...u,preferred_delivery_address:t.target.value}),disabled:!j}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Incluye referencias importantes (edificio, color de casa, puntos de referencia)"})]}),e.jsx(M,{variant:"outline",className:"w-full h-auto py-3",onClick:()=>{if(!navigator.geolocation){_("GPS no disponible en este dispositivo");return}if(N(!0),_(""),!r){_("Usuario no disponible"),N(!1);return}navigator.geolocation.getCurrentPosition(async t=>{try{const{latitude:a,longitude:o}=t.coords,{error:k}=await I.from("users").update({latitude:a,longitude:o,updated_at:new Date().toISOString()}).eq("id",r.id);if(k)throw k;p(`‚úÖ Ubicaci√≥n GPS actualizada: ${a.toFixed(6)}, ${o.toFixed(6)}`),setTimeout(()=>p(""),5e3)}catch{_("Error al guardar ubicaci√≥n GPS")}finally{N(!1)}},t=>{switch(N(!1),t.code){case t.PERMISSION_DENIED:_("Permiso de ubicaci√≥n denegado. Activa el GPS en configuraci√≥n.");break;case t.POSITION_UNAVAILABLE:_("Informaci√≥n de ubicaci√≥n no disponible.");break;case t.TIMEOUT:_("Tiempo de espera agotado para obtener ubicaci√≥n.");break;default:_("Error desconocido al obtener ubicaci√≥n.");break}},{enableHighAccuracy:!0,timeout:1e4,maximumAge:6e4})},disabled:h,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx(Re,{className:"w-4 h-4 flex-shrink-0"}),e.jsx("span",{className:"text-center leading-tight",children:h?"Obteniendo ubicaci√≥n...":"Actualizar ubicaci√≥n GPS"})]})}),e.jsx("div",{className:"text-center",children:e.jsx("p",{className:"text-xs text-gray-500 break-words",children:"La ubicaci√≥n GPS nos ayuda a mostrar vendedores cercanos y calcular costos de entrega"})})]})})]})]}),e.jsxs(Q,{className:"border-purple-200",children:[e.jsx(ee,{children:e.jsxs(se,{className:"flex items-center gap-2",children:[e.jsx(Ge,{className:"w-5 h-5 text-purple-500"}),"Preferencias de Notificaciones"]})}),e.jsxs(H,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-start justify-between gap-4",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx(he,{htmlFor:"order_updates",className:"text-base",children:"Actualizaciones de pedidos"}),e.jsx("p",{className:"text-sm text-gray-500 break-words",children:"Recibe notificaciones sobre el estado de tus pedidos"})]}),e.jsx("div",{className:"flex-shrink-0",children:e.jsx(is,{id:"order_updates",checked:u.notification_preferences.order_updates,onCheckedChange:t=>y("order_updates",t),disabled:!j})})]}),e.jsx(fe,{}),e.jsxs("div",{className:"flex items-start justify-between gap-4",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx(he,{htmlFor:"promotions",className:"text-base",children:"Promociones y ofertas"}),e.jsx("p",{className:"text-sm text-gray-500 break-words",children:"Recibe ofertas especiales y promociones"})]}),e.jsx("div",{className:"flex-shrink-0",children:e.jsx(is,{id:"promotions",checked:u.notification_preferences.promotions,onCheckedChange:t=>y("promotions",t),disabled:!j})})]}),e.jsx(fe,{}),e.jsxs("div",{className:"flex items-start justify-between gap-4",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx(he,{htmlFor:"new_products",className:"text-base",children:"Nuevos productos"}),e.jsx("p",{className:"text-sm text-gray-500 break-words",children:"Notificaciones cuando hay nuevos productos disponibles"})]}),e.jsx("div",{className:"flex-shrink-0",children:e.jsx(is,{id:"new_products",checked:u.notification_preferences.new_products,onCheckedChange:t=>y("new_products",t),disabled:!j})})]})]}),j&&e.jsxs(M,{onClick:i,disabled:h,className:"w-full bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600",children:[e.jsx(ws,{className:"w-4 h-4 mr-2"}),"Guardar preferencias"]})]})]}),e.jsxs(Q,{className:"border-gray-200",children:[e.jsx(ee,{children:e.jsxs(se,{className:"flex items-center gap-2",children:[e.jsx(fa,{className:"w-5 h-5 text-gray-500"}),"Acciones R√°pidas"]})}),e.jsx(H,{children:e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-4",children:[e.jsxs(M,{variant:"outline",className:"h-16 flex flex-col gap-2 text-center",children:[e.jsx(Ze,{className:"w-5 h-5 text-red-500"}),e.jsx("span",{className:"text-sm leading-tight",children:"Productos favoritos"})]}),e.jsxs(M,{variant:"outline",className:"h-16 flex flex-col gap-2 text-center",children:[e.jsx(Za,{className:"w-5 h-5 text-blue-500"}),e.jsx("span",{className:"text-sm leading-tight",children:"Historial de compras"})]}),e.jsxs(M,{variant:"outline",className:"h-16 flex flex-col gap-2 text-center",children:[e.jsx(Le,{className:"w-5 h-5 text-green-500"}),e.jsx("span",{className:"text-sm leading-tight",children:"M√©todos de pago"})]})]})})]}),e.jsxs(Q,{className:"border-yellow-200",children:[e.jsx(ee,{children:e.jsxs(se,{className:"flex items-center gap-2",children:[e.jsx(Ya,{className:"w-5 h-5 text-yellow-500"}),"Seguridad de la Cuenta"]})}),e.jsxs(H,{className:"space-y-4",children:[e.jsx("div",{className:"p-4 bg-yellow-50 rounded-lg border border-yellow-200",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(_s,{className:"w-8 h-8 text-yellow-600 flex-shrink-0"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h4",{className:"font-medium text-yellow-800",children:"Cuenta protegida"}),e.jsx("p",{className:"text-sm text-yellow-700 break-words",children:"Tu cuenta est√° protegida por autenticaci√≥n segura de Supabase"})]})]})}),e.jsx("div",{className:"text-center text-sm text-gray-500",children:e.jsx("p",{className:"break-words",children:"Para cambios de seguridad como contrase√±a, contacta al soporte t√©cnico"})})]})]}),e.jsx(xs,{onCartClick:s||(()=>{alert(`Tienes ${g()} productos en tu carrito. Funcionalidad de carrito implementada.`)})})]}):e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-orange-500"})})}function Zr({onContinueShopping:s,onProceedToCheckout:r}){const{user:l}=ke(),{items:g,updateCartItem:u,removeFromCart:c,clearCart:j,getCartTotal:x,getCartItemCount:h}=Te(),{openImageModal:N}=cs(),[A,n]=m.useState(null),[E,_]=m.useState(null),[q,p]=m.useState(""),C=x(),F=C,G=g.reduce((t,a)=>{var d,S,O;const o=((d=a.product)==null?void 0:d.seller_id)||"unknown",k=((O=(S=a.product)==null?void 0:S.seller)==null?void 0:O.business_name)||"Vendedor";return t[o]||(t[o]={sellerId:o,sellerName:k,items:[]}),t[o].items.push(a),t},{}),z=async(t,a)=>{if(!(a<0)){n(t);try{a===0?(await c(t),V.success("Eliminado")):await u(t,a)}catch(o){console.error("Error updating cart:",o),V.error("Error al actualizar el carrito")}finally{n(null)}}},v=(t,a)=>{_(t),p(a.toString())},f=t=>{const a=parseInt(q);!isNaN(a)&&a>=0&&z(t,a),_(null),p("")},P=(t,a)=>{t.key==="Enter"?f(a):t.key==="Escape"&&(_(null),p(""))},i=async t=>{try{await c(t),V.success("Eliminado")}catch(a){console.error("Error removing item:",a),V.error("Error al eliminar producto")}},y=async()=>{try{await j(),V.success("Carrito vac√≠o")}catch(t){console.error("Error clearing cart:",t),V.error("Error al vaciar carrito")}};return g.length===0?e.jsx("div",{className:"max-w-2xl mx-auto p-6",children:e.jsxs("div",{className:"text-center py-12",children:[e.jsx(we,{className:"w-24 h-24 text-gray-300 mx-auto mb-6"}),e.jsx("h3",{className:"text-2xl font-semibold text-gray-900 mb-2",children:"Tu carrito est√° vac√≠o"}),e.jsx("p",{className:"text-gray-600 mb-8",children:"Agrega algunos productos para comenzar tu pedido"}),e.jsxs(M,{onClick:s,className:"bg-orange-500 hover:bg-orange-600 text-white px-8 py-3",children:[e.jsx(Be,{className:"w-4 h-4 mr-2"}),"Explorar Productos"]})]})}):e.jsxs("div",{className:"max-w-6xl mx-auto p-4 lg:p-6",children:[e.jsxs("div",{className:"flex flex-col lg:flex-row lg:items-center lg:justify-between mb-6",children:[e.jsxs("div",{className:"mb-4 lg:mb-0",children:[e.jsxs("h1",{className:"text-2xl lg:text-3xl font-bold text-gray-900 flex items-center gap-3",children:[e.jsx(we,{className:"w-7 h-7 text-orange-500"}),"Mi Carrito"]}),e.jsxs("p",{className:"text-gray-600 mt-1",children:[h()," ",h()===1?"producto":"productos"," en tu carrito"]})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-3",children:[e.jsxs(M,{variant:"outline",onClick:s,className:"border-orange-200 text-orange-600 hover:bg-orange-50",children:[e.jsx(Be,{className:"w-4 h-4 mr-2"}),"Continuar Comprando"]}),g.length>0&&e.jsxs(M,{variant:"outline",onClick:y,className:"border-red-200 text-red-600 hover:bg-red-50",children:[e.jsx(Ke,{className:"w-4 h-4 mr-2"}),"Vaciar Carrito"]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsx("div",{className:"lg:col-span-2 space-y-6",children:Object.values(G).map(t=>e.jsxs(Q,{className:"shadow-sm border border-gray-200",children:[e.jsx(ee,{className:"pb-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(de,{className:"w-5 h-5 text-orange-500"}),e.jsxs("div",{children:[e.jsx(se,{className:"text-lg font-semibold",children:t.sellerName}),e.jsxs("p",{className:"text-sm text-gray-600",children:[t.items.length," productos"]})]})]})}),e.jsx(H,{children:e.jsx("div",{className:"space-y-4",children:t.items.map(a=>{var o,k,d,S,O,L;return e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center gap-4 p-4 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-4 flex-1",children:[e.jsx(ye,{src:((o=a.product)==null?void 0:o.image_url)||"https://images.unsplash.com/photo-1546069901-ba9599a7e63c?w=300&h=200&fit=crop",alt:((k=a.product)==null?void 0:k.name)||"Producto",className:"w-16 h-16 object-cover rounded-lg flex-shrink-0 cursor-pointer",onClick:()=>{var R,T;const b=((R=a.product)==null?void 0:R.image_url)||"https://images.unsplash.com/photo-1546069901-ba9599a7e63c?w=800&h=600&fit=crop";N(b,((T=a.product)==null?void 0:T.name)||"Producto")}}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h4",{className:"font-medium text-gray-900 truncate",children:(d=a.product)==null?void 0:d.name}),e.jsxs("p",{className:"text-green-600 font-semibold text-lg",children:["Q",(S=a.product)==null?void 0:S.price]}),((O=a.product)==null?void 0:O.description)&&e.jsx("p",{className:"text-sm text-gray-600 truncate",children:a.product.description})]})]}),e.jsxs("div",{className:"flex items-center justify-between sm:justify-end gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(M,{size:"sm",variant:"outline",onClick:()=>z(a.id,a.quantity-1),disabled:A===a.id,className:"h-8 w-8 p-0",children:e.jsx(He,{className:"w-3 h-3"})}),E===a.id?e.jsx(be,{value:q,onChange:b=>p(b.target.value),onBlur:()=>f(a.id),onKeyDown:b=>P(b,a.id),className:"w-16 h-8 text-center text-sm font-medium p-1",autoFocus:!0}):e.jsx("span",{className:"px-3 py-1 bg-white border rounded font-medium cursor-pointer hover:bg-gray-50 min-w-[3rem] text-center",onClick:()=>v(a.id,a.quantity),title:"Haz clic para editar cantidad",children:A===a.id?"...":a.quantity}),e.jsx(M,{size:"sm",variant:"outline",onClick:()=>z(a.id,a.quantity+1),disabled:A===a.id,className:"h-8 w-8 p-0",children:e.jsx(Se,{className:"w-3 h-3"})})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"text-right",children:e.jsxs("p",{className:"font-semibold text-lg",children:["Q",(((L=a.product)==null?void 0:L.price)*a.quantity).toFixed(2)]})}),e.jsx(M,{size:"sm",variant:"outline",onClick:()=>i(a.id),className:"h-8 w-8 p-0 text-red-600 border-red-200 hover:bg-red-50",children:e.jsx(Ke,{className:"w-3 h-3"})})]})]})]},a.id)})})})]},t.sellerId))}),e.jsx("div",{className:"space-y-6",children:e.jsxs(Q,{className:"shadow-sm border border-gray-200",children:[e.jsx(ee,{children:e.jsx(se,{className:"text-lg",children:"Resumen del Pedido"})}),e.jsxs(H,{className:"space-y-4",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Subtotal"}),e.jsxs("span",{className:"font-medium",children:["Q",C.toFixed(2)]})]}),e.jsx(fe,{}),e.jsxs("div",{className:"flex justify-between text-lg font-semibold",children:[e.jsx("span",{children:"Total"}),e.jsxs("span",{className:"text-orange-600",children:["Q",F.toFixed(2)]})]}),e.jsxs(M,{onClick:r,className:"w-full bg-orange-500 hover:bg-orange-600 text-white py-3 text-lg font-medium",size:"lg",children:[e.jsx(Le,{className:"w-5 h-5 mr-2"}),"Proceder al Pago",e.jsx(Bs,{className:"w-5 h-5 ml-2"})]})]})]})})]})]})}var hs="Radio",[Yr,aa]=ds(hs),[Jr,et]=Yr(hs),ra=m.forwardRef((s,r)=>{const{__scopeRadio:l,name:g,checked:u=!1,required:c,disabled:j,value:x="on",onCheck:h,form:N,...A}=s,[n,E]=m.useState(null),_=zs(r,C=>E(C)),q=m.useRef(!1),p=n?N||!!n.closest("form"):!0;return e.jsxs(Jr,{scope:l,checked:u,disabled:j,children:[e.jsx($e.button,{type:"button",role:"radio","aria-checked":u,"data-state":na(u),"data-disabled":j?"":void 0,disabled:j,value:x,...A,ref:_,onClick:ns(s.onClick,C=>{u||h==null||h(),p&&(q.current=C.isPropagationStopped(),q.current||C.stopPropagation())})}),p&&e.jsx(st,{control:n,bubbles:!q.current,name:g,value:x,checked:u,required:c,disabled:j,form:N,style:{transform:"translateX(-100%)"}})]})});ra.displayName=hs;var ta="RadioIndicator",ia=m.forwardRef((s,r)=>{const{__scopeRadio:l,forceMount:g,...u}=s,c=et(ta,l);return e.jsx(Ca,{present:g||c.checked,children:e.jsx($e.span,{"data-state":na(c.checked),"data-disabled":c.disabled?"":void 0,...u,ref:r})})});ia.displayName=ta;var st=s=>{const{control:r,checked:l,bubbles:g=!0,...u}=s,c=m.useRef(null),j=ya(l),x=ba(r);return m.useEffect(()=>{const h=c.current,N=window.HTMLInputElement.prototype,n=Object.getOwnPropertyDescriptor(N,"checked").set;if(j!==l&&n){const E=new Event("click",{bubbles:g});n.call(h,l),h.dispatchEvent(E)}},[j,l,g]),e.jsx("input",{type:"radio","aria-hidden":!0,defaultChecked:l,...u,tabIndex:-1,ref:c,style:{...s.style,...x,position:"absolute",pointerEvents:"none",opacity:0,margin:0}})};function na(s){return s?"checked":"unchecked"}var at=["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"],ps="RadioGroup",[rt,Xt]=ds(ps,[Ms,aa]),la=Ms(),oa=aa(),[tt,it]=rt(ps),ca=m.forwardRef((s,r)=>{const{__scopeRadioGroup:l,name:g,defaultValue:u,value:c,required:j=!1,disabled:x=!1,orientation:h,dir:N,loop:A=!0,onValueChange:n,...E}=s,_=la(l),q=ja(N),[p,C]=va({prop:c,defaultProp:u,onChange:n});return e.jsx(tt,{scope:l,name:g,required:j,disabled:x,value:p,onValueChange:C,children:e.jsx(ka,{asChild:!0,..._,orientation:h,dir:q,loop:A,children:e.jsx($e.div,{role:"radiogroup","aria-required":j,"aria-orientation":h,"data-disabled":x?"":void 0,dir:q,...E,ref:r})})})});ca.displayName=ps;var da="RadioGroupItem",ma=m.forwardRef((s,r)=>{const{__scopeRadioGroup:l,disabled:g,...u}=s,c=it(da,l),j=c.disabled||g,x=la(l),h=oa(l),N=m.useRef(null),A=zs(r,N),n=c.value===u.value,E=m.useRef(!1);return m.useEffect(()=>{const _=p=>{at.includes(p.key)&&(E.current=!0)},q=()=>E.current=!1;return document.addEventListener("keydown",_),document.addEventListener("keyup",q),()=>{document.removeEventListener("keydown",_),document.removeEventListener("keyup",q)}},[]),e.jsx(Sa,{asChild:!0,...x,focusable:!j,active:n,children:e.jsx(ra,{disabled:j,required:c.required,checked:n,...h,...u,name:c.name,ref:A,onCheck:()=>c.onValueChange(u.value),onKeyDown:ns(_=>{_.key==="Enter"&&_.preventDefault()}),onFocus:ns(u.onFocus,()=>{var _;E.current&&((_=N.current)==null||_.click())})})})});ma.displayName=da;var nt="RadioGroupIndicator",ua=m.forwardRef((s,r)=>{const{__scopeRadioGroup:l,...g}=s,u=oa(l);return e.jsx(ia,{...u,...g,ref:r})});ua.displayName=nt;var lt=ca,ot=ma,ct=ua;function Ds({className:s,...r}){return e.jsx(lt,{"data-slot":"radio-group",className:Ue("grid gap-3",s),...r})}function Os({className:s,...r}){return e.jsx(ot,{"data-slot":"radio-group-item",className:Ue("border-input text-primary focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive dark:bg-input/30 aspect-square size-4 shrink-0 rounded-full border shadow-xs transition-[color,box-shadow] outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50",s),...r,children:e.jsx(ct,{"data-slot":"radio-group-indicator",className:"relative flex items-center justify-center",children:e.jsx(or,{className:"fill-primary absolute top-1/2 left-1/2 size-2 -translate-x-1/2 -translate-y-1/2"})})})}function dt({onBack:s,onComplete:r}){const{user:l}=ke(),{items:g,clearCart:u,getCartTotal:c}=Te(),{notify:j}=Ja(),[x,h]=m.useState("complete-info"),[N,A]=m.useState("pickup"),[n,E]=m.useState(!1),[_,q]=m.useState(!1),[p,C]=m.useState({customer_name:"",phone_number:"",delivery_address:"",customer_notes:"",payment_method:"cash"});m.useEffect(()=>{l&&F()},[l]);const F=async()=>{try{const{data:b,error:R}=await I.from("users").select("name, phone, address, preferred_delivery_address").eq("id",l==null?void 0:l.id).single();if(R)throw R;C(b?T=>({...T,customer_name:b.name||(l==null?void 0:l.name)||"",phone_number:b.phone||(l==null?void 0:l.phone)||"",delivery_address:b.preferred_delivery_address||b.address||"",customer_notes:""}):T=>({...T,customer_name:(l==null?void 0:l.name)||"",phone_number:(l==null?void 0:l.phone)||"",delivery_address:"",customer_notes:""}))}catch(b){console.error("Error loading user profile:",b),C(R=>({...R,customer_name:(l==null?void 0:l.name)||"",phone_number:(l==null?void 0:l.phone)||"",delivery_address:"",customer_notes:""}))}},G=g.reduce((b,R)=>{var T;return b+(((T=R.product)==null?void 0:T.price)||0)*R.quantity},0),z=N==="delivery"?15:0,v=G+z,f=[{type:"pickup",title:"Recoger en tienda",description:"Recoge tu pedido directamente en la tienda",icon:de,fee:0},{type:"dine-in",title:"Comer en el lugar",description:"Disfruta tu comida en el restaurante",icon:jr,fee:0},{type:"delivery",title:"Servicio a domicilio",description:"Te llevamos tu pedido a tu direcci√≥n",icon:ue,fee:15}],P=[{type:"cash",title:"Efectivo",description:"Paga al recibir tu pedido",icon:nr},{type:"card",title:"Tarjeta",description:"Tarjeta de d√©bito o cr√©dito",icon:Le},{type:"transfer",title:"Transferencia",description:"Transferencia bancaria",icon:br}],i=b=>{switch(b){case"complete-info":return N==="delivery"&&!p.delivery_address.trim()?"Ingresa tu direcci√≥n de entrega":p.customer_name.trim()?p.phone_number.trim()?null:"Ingresa tu tel√©fono":"Ingresa tu nombre";case"payment":return p.payment_method?null:"Selecciona un m√©todo de pago";default:return null}},y=()=>{const b=i(x);if(b){V.error(b);return}const R=["complete-info","payment","review"],T=R.indexOf(x);T<R.length-1&&h(R[T+1])},t=()=>{const b=["complete-info","payment","review"],R=b.indexOf(x);R>0&&h(b[R-1])},a=async()=>{var R;if(!l){V.error("Debes iniciar sesi√≥n para crear un pedido");return}if(!p.customer_name.trim()||!p.phone_number.trim()){V.error("Por favor completa toda la informaci√≥n requerida"),h("complete-info");return}if(N==="delivery"&&!p.delivery_address.trim()){V.error("La direcci√≥n de entrega es requerida para servicio a domicilio"),h("complete-info");return}if(!g||g.length===0){V.error("Tu carrito est√° vac√≠o");return}if(g.filter(T=>!T.product_id||!T.quantity||T.quantity<=0).length>0){V.error("Hay productos inv√°lidos en tu carrito. Por favor actualiza tu carrito.");return}h("processing"),E(!0);try{console.log("Cart items:",g);let T=null;for(const D of g){if(D.seller_id){T=D.seller_id;break}if((R=D.product)!=null&&R.seller_id){T=D.product.seller_id;break}}if(console.log("Seller ID encontrado:",T),!T&&g.length>0){console.log("Intentando obtener seller_id del producto...");try{const{data:D,error:ae}=await I.from("products").select("seller_id").eq("id",g[0].product_id).single();!ae&&(D!=null&&D.seller_id)&&(T=D.seller_id,console.log("Seller ID obtenido del producto:",T))}catch(D){console.error("Error obteniendo seller_id del producto:",D)}}if(!T)throw new Error(`No se pudo identificar el vendedor. Por favor:
1. Vac√≠a tu carrito
2. Agrega los productos nuevamente
3. Si el problema persiste, contacta soporte`);const J={buyer_id:l.id,seller_id:T,subtotal:Number(G.toFixed(2)),delivery_fee:Number(z.toFixed(2)),total_amount:Number(v.toFixed(2)),total:Number(v.toFixed(2)),delivery_type:N,delivery_address:N==="delivery"?p.delivery_address.trim():N==="pickup"?"Recoger en tienda":"Comer en el lugar",customer_notes:p.customer_notes.trim()||null,phone_number:p.phone_number.trim(),customer_name:p.customer_name.trim(),payment_method:p.payment_method,status:"pending"};console.log("üîç Validando stock disponible...");const U=(await Promise.all(g.map(async D=>{var Ce;let ae=null,re="",pe=0;if(D.product_type==="daily"){const{data:ce}=await I.from("daily_products").select("stock_quantity, name, expires_at").eq("id",D.product_id).single();ce&&(ae=ce,re=ce.name,pe=new Date(ce.expires_at)<=new Date?0:ce.stock_quantity)}else{const{data:ce}=await I.from("products").select("stock_quantity, name").eq("id",D.product_id).single();ce&&(ae=ce,re=ce.name,pe=ce.stock_quantity)}return{productId:D.product_id,productName:re||((Ce=D.product)==null?void 0:Ce.name)||"Producto",requestedQuantity:D.quantity,availableStock:pe||0,isValid:(pe||0)>=D.quantity}}))).filter(D=>!D.isValid);if(U.length>0){const D=U.map(ae=>ae.availableStock===0?`‚ùå ${ae.productName}: AGOTADO`:`‚ö†Ô∏è ${ae.productName}: Solo ${ae.availableStock} disponibles (solicitaste ${ae.requestedQuantity})`).join(`
`);throw new Error(`‚ùå STOCK INSUFICIENTE:

${D}

üí° Actualiza las cantidades en tu carrito y vuelve a intentar.`)}console.log("‚úÖ Stock validado correctamente");const{data:X,error:te}=await I.from("orders").insert(J).select().single();if(te)throw console.error("Error creating order:",te),new Error(`Error al crear la orden: ${te.message}`);if(!X)throw new Error("No se pudo crear la orden");const ve=g.map(D=>{var ae,re,pe,Ce,ce;return{order_id:X.id,product_id:D.product_id,product_name:((ae=D.product)==null?void 0:ae.name)||D.product_name||"Producto",product_image:((re=D.product)==null?void 0:re.image_url)||D.product_image||null,price:Number((((pe=D.product)==null?void 0:pe.price)||D.product_price||0).toFixed(2)),price_per_unit:Number((((Ce=D.product)==null?void 0:Ce.price)||D.product_price||0).toFixed(2)),quantity:Number(D.quantity),total_price:Number(((((ce=D.product)==null?void 0:ce.price)||D.product_price||0)*D.quantity).toFixed(2)),product_type:D.product_type||"regular",notes:null}}),{error:B}=await I.from("order_items").insert(ve);if(B)throw console.error("Error creating order items:",B),await I.from("orders").delete().eq("id",X.id),new Error(`Error al agregar productos a la orden: ${B.message}`);try{await I.from("notifications").insert({recipient_id:T,type:"new_order",title:"üõí Nueva orden recibida",message:`${p.customer_name} ha realizado un pedido por Q${v.toFixed(2)} - ${N==="pickup"?"Recoger en tienda":N==="dine-in"?"Comer en el lugar":"Servicio a domicilio"}`,data:{order_id:X.id,delivery_type:N,payment_method:p.payment_method,customer_name:p.customer_name,customer_phone:p.phone_number,total:v}})}catch(D){console.error("Error creating notification:",D)}try{await j("üõí Nueva Orden Recibida",{body:`${p.customer_name} realiz√≥ un pedido por Q${v.toFixed(2)}`,sound:"NEW_ORDER",push:!0,data:{orderId:X.id,customerId:l==null?void 0:l.id,total:v}})}catch(D){console.error("Error sending sound notification:",D)}await u(),q(!0),V.success("¬°Pedido creado exitosamente!"),setTimeout(()=>{r()},2e3)}catch(T){console.error("Error creating order:",T);const J=T instanceof Error?T.message:"Error desconocido al crear el pedido";V.error(J),h("review")}finally{E(!1)}},o=()=>{const b=[{key:"complete-info",label:"Informaci√≥n",icon:Oe},{key:"payment",label:"Pago",icon:Le},{key:"review",label:"Revisar",icon:oe}],R=b.findIndex(T=>T.key===x);return e.jsx("div",{className:"flex items-center justify-between mb-8",children:b.map((T,J)=>{const ie=T.icon,U=T.key===x,X=J<R;return e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:`flex items-center justify-center w-8 h-8 rounded-full ${U?"bg-orange-500 text-white":X?"bg-green-500 text-white":"bg-gray-200 text-gray-400"}`,children:e.jsx(ie,{className:"w-4 h-4"})}),e.jsx("span",{className:`ml-2 text-sm ${U?"text-orange-600 font-medium":X?"text-green-600":"text-gray-400"}`,children:T.label}),J<b.length-1&&e.jsx("div",{className:`w-8 h-0.5 mx-4 ${X?"bg-green-500":"bg-gray-200"}`})]},T.key)})})},k=()=>e.jsxs("div",{className:"space-y-6",children:[e.jsxs(Q,{children:[e.jsx(ee,{children:e.jsxs(se,{className:"flex items-center gap-2",children:[e.jsx(ue,{className:"w-5 h-5"}),"Opciones de entrega"]})}),e.jsxs(H,{className:"space-y-4",children:[e.jsx(Ds,{value:N,onValueChange:b=>A(b),children:f.map(b=>{const R=b.icon;return e.jsxs("div",{className:"flex items-center space-x-2 p-4 border rounded-lg hover:bg-gray-50",children:[e.jsx(Os,{value:b.type,id:b.type}),e.jsxs("div",{className:"flex-1 flex items-center gap-3",children:[e.jsx(R,{className:"w-5 h-5 text-orange-500"}),e.jsxs("div",{className:"flex-1",children:[e.jsx(he,{htmlFor:b.type,className:"font-medium cursor-pointer",children:b.title}),e.jsx("p",{className:"text-sm text-gray-600",children:b.description})]}),e.jsx("div",{className:"text-right",children:b.fee>0?e.jsxs("span",{className:"font-medium",children:["Q",b.fee.toFixed(2)]}):e.jsx("span",{className:"text-green-600 font-medium",children:"Gratis"})})]})]},b.type)})}),N==="delivery"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(he,{htmlFor:"address",children:"Direcci√≥n de entrega *"}),e.jsx(We,{id:"address",placeholder:"Ingresa tu direcci√≥n completa con referencias...",value:p.delivery_address,onChange:b=>C(R=>({...R,delivery_address:b.target.value})),rows:3,className:!p.delivery_address&&N==="delivery"?"border-red-300":""}),p.delivery_address&&e.jsxs("p",{className:"text-sm text-green-600 flex items-center gap-1",children:[e.jsx(oe,{className:"w-4 h-4"}),"Direcci√≥n cargada desde tu perfil"]})]})]})]}),e.jsxs(Q,{children:[e.jsx(ee,{children:e.jsxs(se,{className:"flex items-center gap-2",children:[e.jsx(Oe,{className:"w-5 h-5"}),"Confirmar informaci√≥n de contacto",p.customer_name&&p.phone_number&&e.jsx(oe,{className:"w-5 h-5 text-green-500 ml-auto"})]})}),e.jsxs(H,{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(he,{htmlFor:"name",children:"Nombre completo *"}),e.jsx(be,{id:"name",placeholder:"Tu nombre completo",value:p.customer_name,onChange:b=>C(R=>({...R,customer_name:b.target.value})),className:p.customer_name?"border-green-300 bg-green-50":""}),p.customer_name&&e.jsx("p",{className:"text-xs text-green-600",children:"‚úì Cargado desde tu perfil"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(he,{htmlFor:"phone",children:"N√∫mero de tel√©fono *"}),e.jsx(be,{id:"phone",placeholder:"+502 1234-5678",value:p.phone_number,onChange:b=>C(R=>({...R,phone_number:b.target.value})),className:p.phone_number?"border-green-300 bg-green-50":""}),p.phone_number&&e.jsx("p",{className:"text-xs text-green-600",children:"‚úì Cargado desde tu perfil"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(he,{htmlFor:"notes",children:"Instrucciones especiales (opcional)"}),e.jsx(We,{id:"notes",placeholder:"Alguna instrucci√≥n especial para tu pedido...",value:p.customer_notes,onChange:b=>C(R=>({...R,customer_notes:b.target.value})),rows:2})]})]})]}),e.jsxs(Q,{children:[e.jsx(ee,{children:e.jsxs(se,{className:"flex items-center gap-2",children:[e.jsx(we,{className:"w-5 h-5"}),"Resumen del pedido"]})}),e.jsxs(H,{className:"space-y-4",children:[e.jsx("div",{className:"space-y-2 max-h-32 overflow-y-auto",children:g.map((b,R)=>{var T,J;return e.jsxs("div",{className:"flex justify-between items-center py-1 text-sm",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("span",{className:"font-medium",children:((T=b.product)==null?void 0:T.name)||b.name}),e.jsxs("span",{className:"text-gray-600 ml-2",children:["x",b.quantity]})]}),e.jsxs("span",{className:"font-medium",children:["Q",((((J=b.product)==null?void 0:J.price)||0)*b.quantity).toFixed(2)]})]},R)})}),e.jsx(fe,{}),e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Subtotal:"}),e.jsxs("span",{children:["Q",G.toFixed(2)]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Entrega:"}),e.jsx("span",{children:z>0?`Q${z.toFixed(2)}`:"Gratis"})]}),e.jsx(fe,{}),e.jsxs("div",{className:"flex justify-between text-lg font-bold",children:[e.jsx("span",{children:"Total:"}),e.jsxs("span",{className:"text-orange-600",children:["Q",v.toFixed(2)]})]})]})]})]})]}),d=()=>e.jsxs(Q,{children:[e.jsx(ee,{children:e.jsxs(se,{className:"flex items-center gap-2",children:[e.jsx(Le,{className:"w-5 h-5"}),"M√©todo de pago"]})}),e.jsxs(H,{className:"space-y-4",children:[e.jsx(Ds,{value:p.payment_method,onValueChange:b=>C(R=>({...R,payment_method:b})),children:P.map(b=>{const R=b.icon;return e.jsxs("div",{className:"flex items-center space-x-2 p-4 border rounded-lg hover:bg-gray-50",children:[e.jsx(Os,{value:b.type,id:b.type}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(R,{className:"w-5 h-5 text-green-500"}),e.jsxs("div",{children:[e.jsx(he,{htmlFor:b.type,className:"font-medium cursor-pointer",children:b.title}),e.jsx("p",{className:"text-sm text-gray-600",children:b.description})]})]})]},b.type)})}),e.jsxs("div",{className:"bg-blue-50 p-4 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2 text-blue-700",children:[e.jsx(oe,{className:"w-4 h-4"}),e.jsx("span",{className:"font-medium",children:"Pago seguro"})]}),e.jsx("p",{className:"text-sm text-blue-600 mt-1",children:"Todos los pagos son procesados de forma segura. Tu informaci√≥n est√° protegida."})]})]})]}),S=()=>{const b=f.find(T=>T.type===N),R=P.find(T=>T.type===p.payment_method);return e.jsxs("div",{className:"space-y-6",children:[e.jsxs(Q,{children:[e.jsx(ee,{children:e.jsxs(se,{className:"flex items-center gap-2",children:[e.jsx(we,{className:"w-5 h-5"}),"Resumen del pedido"]})}),e.jsxs(H,{className:"space-y-4",children:[g.map((T,J)=>{var ie,U,X,te,ve;return e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-gray-50 rounded-lg",children:[((ie=T.product)==null?void 0:ie.image_url)&&e.jsx("img",{src:T.product.image_url,alt:T.product.name,className:"w-12 h-12 object-cover rounded"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-medium",children:(U=T.product)==null?void 0:U.name}),e.jsxs("p",{className:"text-sm text-gray-600",children:["Q",(te=(X=T.product)==null?void 0:X.price)==null?void 0:te.toFixed(2)," x ",T.quantity]})]}),e.jsxs("span",{className:"font-medium",children:["Q",((((ve=T.product)==null?void 0:ve.price)||0)*T.quantity).toFixed(2)]})]},J)}),e.jsx(fe,{}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Subtotal:"}),e.jsxs("span",{children:["Q",G.toFixed(2)]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Entrega:"}),e.jsx("span",{children:z>0?`Q${z.toFixed(2)}`:"Gratis"})]}),e.jsx(fe,{}),e.jsxs("div",{className:"flex justify-between text-lg font-bold",children:[e.jsx("span",{children:"Total:"}),e.jsxs("span",{className:"text-orange-600",children:["Q",v.toFixed(2)]})]})]})]})]}),e.jsxs("div",{className:"grid md:grid-cols-2 gap-4",children:[e.jsxs(Q,{children:[e.jsx(ee,{children:e.jsx(se,{className:"text-base",children:"Entrega"})}),e.jsx(H,{children:e.jsxs("div",{className:"flex items-center gap-3",children:[b&&e.jsx(b.icon,{className:"w-5 h-5 text-orange-500"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:b==null?void 0:b.title}),N==="delivery"&&p.delivery_address&&e.jsx("p",{className:"text-sm text-gray-600",children:p.delivery_address})]})]})})]}),e.jsxs(Q,{children:[e.jsx(ee,{children:e.jsx(se,{className:"text-base",children:"Pago"})}),e.jsx(H,{children:e.jsxs("div",{className:"flex items-center gap-3",children:[R&&e.jsx(R.icon,{className:"w-5 h-5 text-green-500"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:R==null?void 0:R.title}),e.jsx("p",{className:"text-sm text-gray-600",children:R==null?void 0:R.description})]})]})})]})]}),e.jsxs(Q,{children:[e.jsx(ee,{children:e.jsx(se,{className:"text-base",children:"Contacto"})}),e.jsx(H,{children:e.jsxs("div",{className:"space-y-2",children:[e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Nombre:"})," ",p.customer_name]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Tel√©fono:"})," ",p.phone_number]}),p.customer_notes&&e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Notas:"})," ",p.customer_notes]})]})})]})]})},O=()=>e.jsx("div",{className:"text-center py-12",children:_?e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto",children:e.jsx(oe,{className:"w-8 h-8 text-green-600"})}),e.jsx("h3",{className:"text-xl font-bold text-green-600",children:"¬°Pedido creado exitosamente!"}),e.jsx("p",{className:"text-gray-600",children:"Tu pedido ha sido enviado al vendedor. Te notificaremos cuando sea confirmado."})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center mx-auto",children:e.jsx(me,{className:"w-8 h-8 text-orange-600 animate-spin"})}),e.jsx("h3",{className:"text-xl font-bold",children:"Procesando tu pedido..."}),e.jsx("p",{className:"text-gray-600",children:"Por favor espera mientras creamos tu pedido."})]})}),L=()=>{switch(x){case"complete-info":return k();case"payment":return d();case"review":return S();case"processing":return O();default:return null}};return e.jsxs("div",{className:"max-w-2xl mx-auto p-6",children:[e.jsxs("div",{className:"flex items-center gap-4 mb-6",children:[e.jsxs(M,{variant:"outline",size:"sm",onClick:s,disabled:n,children:[e.jsx(Be,{className:"w-4 h-4 mr-2"}),"Volver al carrito"]}),e.jsx("h1",{className:"text-2xl font-bold",children:"Checkout"})]}),x!=="processing"&&o(),L(),x!=="processing"&&e.jsxs("div",{className:"flex justify-between mt-8",children:[e.jsxs(M,{variant:"outline",onClick:t,disabled:x==="complete-info"||n,children:[e.jsx(Be,{className:"w-4 h-4 mr-2"}),"Anterior"]}),x==="review"?e.jsx(M,{onClick:a,disabled:n,className:"bg-gradient-to-r from-orange-500 to-green-500 hover:from-orange-600 hover:to-green-600",children:n?e.jsxs(e.Fragment,{children:[e.jsx(me,{className:"w-4 h-4 mr-2 animate-spin"}),"Procesando..."]}):e.jsxs(e.Fragment,{children:["Confirmar pedido Q",v.toFixed(2),e.jsx(oe,{className:"w-4 h-4 ml-2"})]})}):e.jsxs(M,{onClick:y,className:"bg-gradient-to-r from-orange-500 to-green-500 hover:from-orange-600 hover:to-green-600",children:["Siguiente",e.jsx(Bs,{className:"w-4 h-4 ml-2"})]})]})]})}function mt({notification:s,onDismiss:r,index:l}){const[g,u]=m.useState(!1),[c,j]=m.useState(!1),[x,h]=m.useState(null),[N,A]=m.useState(null),[n,E]=m.useState(0),[_,q]=m.useState(!1),p=m.useRef(null),C=m.useRef(null);m.useEffect(()=>{const k=setTimeout(()=>u(!0),100+l*150);return()=>clearTimeout(k)},[l]),m.useEffect(()=>(C.current=setTimeout(()=>{F()},5*60*1e3),()=>{C.current&&clearTimeout(C.current)}),[]);const F=()=>{C.current&&clearTimeout(C.current),j(!0),setTimeout(()=>{r(s.id)},300)},G=k=>({new_order:we,order_accepted:oe,order_ready:xe,order_assigned:Oe,order_picked_up:ue,order_in_transit:ue,order_delivered:oe,order_completed:le,order_cancelled:Ee,order_rejected:Ee,promotion:de,new_product:xe,message:Ge,system:Ee,rating:le,general:Ge})[k]||Ge,z=k=>({new_order:"bg-blue-500",order_accepted:"bg-green-500",order_ready:"bg-orange-500",order_assigned:"bg-purple-500",order_picked_up:"bg-indigo-500",order_in_transit:"bg-indigo-500",order_delivered:"bg-green-500",order_completed:"bg-gray-500",order_cancelled:"bg-red-500",order_rejected:"bg-red-500",promotion:"bg-yellow-500",new_product:"bg-pink-500",message:"bg-blue-500",system:"bg-gray-500",rating:"bg-yellow-500",general:"bg-gray-500"})[k]||"bg-gray-500",v=k=>{h(k.targetTouches[0].clientX),q(!0)},f=k=>{if(!x||!_)return;const d=k.targetTouches[0].clientX,S=d-x;E(S),A(d)},P=()=>{if(!x||!N){q(!1),E(0);return}const k=x-N;Math.abs(k)>50?F():E(0),q(!1),h(null),A(null)},i=k=>{h(k.clientX),q(!0)},y=k=>{if(!x||!_)return;const d=k.clientX-x;E(d),A(k.clientX)},t=()=>{if(!x||!N){q(!1),E(0);return}const k=x-N;Math.abs(k)>50?F():E(0),q(!1),h(null),A(null)},a=G(s.type),o=z(s.type);return e.jsx("div",{ref:p,className:`
        fixed top-4 left-4 right-4 z-50 transform transition-all duration-300 ease-out
        ${g&&!c?"translate-y-0 opacity-100":"-translate-y-full opacity-0"}
        ${_?"transition-none":""}
      `,style:{transform:`translateY(${g&&!c?l*80:-100}px) translateX(${n}px)`,opacity:_?Math.max(.5,1-Math.abs(n)/200):g&&!c?1:0},onTouchStart:v,onTouchMove:f,onTouchEnd:P,onMouseDown:i,onMouseMove:_?y:void 0,onMouseUp:t,onMouseLeave:t,children:e.jsx(Q,{className:"bg-white shadow-lg border-l-4 border-orange-500 cursor-grab active:cursor-grabbing select-none",children:e.jsxs(H,{className:"p-4",children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:`p-2 rounded-full ${o} text-white flex-shrink-0`,children:e.jsx(a,{className:"w-4 h-4"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h4",{className:"font-semibold text-gray-900 text-sm mb-1",children:s.title}),e.jsx("p",{className:"text-gray-700 text-sm",children:s.message})]}),e.jsx("button",{onClick:k=>{k.stopPropagation(),F()},className:"p-1 text-gray-400 hover:text-gray-600 flex-shrink-0",children:e.jsx(Ve,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-between text-xs text-gray-500",children:[e.jsx("span",{children:"Desliza para eliminar"}),e.jsx("span",{children:"Auto-eliminar en 5min"})]})]})})})}function ut(){const{user:s}=ke(),[r,l]=m.useState([]),[g,u]=m.useState(!1),c=async()=>{try{const{error:h}=await I.from("notifications").select("recipient_id, type, title, message, is_read, created_at").limit(1);return h?(console.warn("notifications table is not available:",h.code),!1):!0}catch(h){return console.warn("notifications table availability check failed:",h),!1}},j=async()=>{if(!(!s||!g))try{const h=new Date;h.setDate(h.getDate()-1);const{data:N,error:A}=await I.from("notifications").select("*").eq("recipient_id",s.id).eq("is_read",!1).gte("created_at",h.toISOString()).order("created_at",{ascending:!1}).limit(5);if(A){console.error("Error fetching notifications:",A);return}l(N||[])}catch(h){console.error("Unexpected error fetching notifications:",h)}},x=async h=>{if(l(N=>N.filter(A=>A.id!==h)),g)try{await I.from("notifications").update({is_read:!0}).eq("id",h)}catch(N){console.error("Error marking notification as read:",N)}};return m.useEffect(()=>{(async()=>{const N=await c();u(N),N&&await j()})()},[s==null?void 0:s.id]),m.useEffect(()=>{if(!g||!s)return;const h=I.channel("floating-notifications").on("postgres_changes",{event:"INSERT",schema:"public",table:"notifications",filter:`recipient_id=eq.${s.id}`},()=>{j()}).subscribe();return()=>{I.removeChannel(h)}},[s==null?void 0:s.id,g]),m.useEffect(()=>{const h=setInterval(()=>{g&&j()},6e4);return()=>clearInterval(h)},[g]),!g||r.length===0?null:e.jsx(e.Fragment,{children:r.map((h,N)=>e.jsx(mt,{notification:h,onDismiss:x,index:N},h.id))})}function xt({businessId:s,onBack:r,onShowCart:l}){var re,pe,Ce,ce,ss,fs,js;const{user:g}=ke(),{addToCart:u,items:c}=Te(),{getBusinessProducts:j,getBusinessDailyProducts:x,getBusinessById:h,refreshProductStock:N}=Qs(),{openImageModal:A}=cs(),[n,E]=m.useState(null),[_,q]=m.useState([]),[p,C]=m.useState([]),[F,G]=m.useState(!0),[z,v]=m.useState("productos"),[f,P]=m.useState(null),[i,y]=m.useState(!1),[t,a]=m.useState(new Date),[o,k]=m.useState(null),[d,S]=m.useState("");m.useEffect(()=>{O()},[s]);const O=async()=>{var w,W,Y;try{G(!0),console.log("üîç Cargando datos del negocio:",s);const[$,K,ge]=await Promise.all([h(s),j(s),x(s)]);console.log("üìä Datos cargados:",{business:$,products:K,dailyProducts:ge,productsWithImages:(K==null?void 0:K.filter(ne=>ne.image_url).length)||0,productsTotal:(K==null?void 0:K.length)||0,dailyWithImages:(ge==null?void 0:ge.filter(ne=>ne.image_url).length)||0,dailyTotal:(ge==null?void 0:ge.length)||0}),console.log("üî• DEBUG CONTACTO:",{business_phone:$==null?void 0:$.business_phone,phone:$==null?void 0:$.phone,email:$==null?void 0:$.email,address:$==null?void 0:$.address,business_address:$==null?void 0:$.business_address,user:$==null?void 0:$.user,user_phone:(w=$==null?void 0:$.user)==null?void 0:w.phone,user_email:(W=$==null?void 0:$.user)==null?void 0:W.email,user_address:(Y=$==null?void 0:$.user)==null?void 0:Y.address}),E($),q(K||[]),C(ge||[]),a(new Date)}catch($){console.error("‚ùå Error loading business data:",$),V.error("Error al cargar informaci√≥n del comercio")}finally{G(!1)}},L=async()=>{y(!0);try{await N();const[w,W]=await Promise.all([j(s),x(s)]);q(w||[]),C(W||[]),a(new Date),V.success("Productos actualizados correctamente")}catch{V.error("Error al actualizar productos")}finally{y(!1)}},b=async(w,W)=>{if(!g){V.error("Debes iniciar sesi√≥n para agregar productos");return}if(f!==w){P(w);try{const Y=await u(w,1,"regular");Y.success?V.success("Agregado al carrito"):V.error(Y.message,{icon:e.jsx(Ee,{className:"w-4 h-4"}),duration:3e3})}catch(Y){console.error("Error adding to cart:",Y),V.error("Error al agregar al carrito",{icon:e.jsx(De,{className:"w-4 h-4"}),duration:3e3})}finally{P(null)}}},R=async(w,W)=>{if(!g){V.error("Debes iniciar sesi√≥n para agregar productos");return}if(f!==w){P(w);try{console.log("üç∫ Adding daily product to cart:",{productId:w,productName:W,productType:"daily"});const Y=await u(w,1,"daily");console.log("üç∫ Daily cart result:",Y),Y.success?V.success("Agregado al carrito"):(console.error("üç∫ Daily cart failed:",Y),V.error(Y.message,{icon:e.jsx(Ee,{className:"w-4 h-4"}),duration:3e3}))}catch(Y){console.error("Error adding daily to cart:",Y),V.error("Error al agregar al carrito",{icon:e.jsx(De,{className:"w-4 h-4"}),duration:3e3})}finally{P(null)}}},T=(w,W)=>{k(w),S(W.toString())},J=w=>{const W=parseInt(w);(w===""||!isNaN(W)&&W>=0&&W<=999)&&S(w)},ie=async w=>{const W=parseInt(d);!isNaN(W)&&W>=0&&await X(w,W),k(null),S("")},U=async(w,W)=>{w.key==="Enter"?await ie(W):w.key==="Escape"&&(k(null),S(""))},X=async(w,W)=>{const Y=c.find($=>$.product_id===w);if(Y){P(w);try{if(W<=0){const $=await u(w,-Y.quantity,"daily");$.success?V.success("Producto removido del carrito"):V.error($.message)}else{const $=W-Y.quantity,K=await u(w,$,"daily");K.success?V.success(`Cantidad actualizada: ${W}`):V.error(K.message)}}catch($){console.error("Error updating daily cart quantity:",$),V.error("Error al actualizar cantidad")}finally{P(null)}}},te=w=>{const W=c==null?void 0:c.find($=>$.product_id===w),Y=(W==null?void 0:W.quantity)||0;return console.log("üõí Cart check:",{productId:w,cartItems:(c==null?void 0:c.length)||0,foundItem:!!W,quantity:Y}),Y},ve=(n==null?void 0:n.logo_url)||((re=n==null?void 0:n.user)==null?void 0:re.avatar_url),B=n==null?void 0:n.cover_image_url,D=({product:w})=>{var Pe;const W=Es(w),Y=te(w.id),$=f===w.id,K={isAvailable:w.is_available&&w.stock_quantity>0,hasStock:w.stock_quantity>0,isLowStock:w.stock_quantity<=5&&w.stock_quantity>0,isLastUnits:w.stock_quantity<=3&&w.stock_quantity>0,stockCount:w.stock_quantity||0,isDisabledByVendor:w.is_available===!1,isOutOfStock:w.stock_quantity===0};console.log("üõçÔ∏è ProductCard Availability:",{productName:w.name,productId:w.id,is_available:w.is_available,stock_quantity:w.stock_quantity,availabilityInfo:K,cartQuantity:Y,isAdding:$});const ne=K.isOutOfStock?{text:"Agotado",className:"bg-red-100 text-red-700"}:K.isDisabledByVendor?{text:"No disponible",className:"bg-gray-100 text-gray-600"}:K.isLastUnits?{text:`¬°√öltimas ${K.stockCount}!`,className:"bg-red-100 text-red-700 animate-pulse"}:K.isLowStock?{text:`${K.stockCount} disponibles`,className:"bg-orange-100 text-orange-700"}:K.hasStock?{text:`${K.stockCount} disponibles`,className:"bg-green-100 text-green-700"}:{text:"Sin stock",className:"bg-gray-100 text-gray-600"};return e.jsx(Q,{className:"bg-white shadow-sm border border-gray-100 rounded-xl overflow-hidden hover:shadow-md transition-all min-h-[100px]",children:e.jsx(H,{className:"p-0 h-full",style:{pointerEvents:"auto"},children:e.jsxs("div",{className:"flex h-full relative",onClick:Fe=>console.log("Card clicked",Fe.target),style:{pointerEvents:"auto"},children:[e.jsxs("div",{className:"relative w-20 h-20 bg-gray-100 flex-shrink-0 cursor-pointer",onClick:Fe=>{console.log("üñºÔ∏è Image area clicked"),Fe.stopPropagation(),W&&A(W,w.name)},style:{pointerEvents:"auto"},children:[W?e.jsx(ye,{src:W,alt:w.name,className:"w-full h-full object-cover hover:scale-105 transition-transform duration-200"}):e.jsx("div",{className:"w-full h-full bg-gradient-to-br from-orange-50 to-orange-100 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx(xe,{className:"w-5 h-5 text-orange-300 mx-auto mb-1"}),e.jsx("span",{className:"text-xs text-orange-400 font-medium",children:"Sin imagen"})]})}),e.jsxs("div",{className:"absolute top-1 left-1 space-y-1",children:[K.isOutOfStock&&e.jsx(Z,{className:"bg-red-500 text-white text-xs px-2 py-1 shadow-lg",children:"Agotado"}),K.isDisabledByVendor&&e.jsx(Z,{className:"bg-gray-500 text-white text-xs px-2 py-1 shadow-lg",children:"No disponible"}),K.isLastUnits&&e.jsxs(Z,{className:"bg-red-500 text-white text-xs px-2 py-1 shadow-lg animate-pulse",children:["üî• ¬°√öltimas ",K.stockCount,"!"]})]}),W&&e.jsx("div",{className:"absolute inset-0 bg-black/0 hover:bg-black/20 transition-colors duration-200 flex items-center justify-center",children:e.jsx("div",{className:"opacity-0 hover:opacity-100 transition-opacity bg-black/70 rounded-lg px-2 py-1",children:e.jsxs("div",{className:"flex items-center gap-1 text-white text-xs font-medium",children:[e.jsx(ms,{className:"w-3 h-3"}),e.jsx("span",{children:"Ver"})]})})})]}),e.jsxs("div",{className:"flex-1 p-3 pl-4 min-w-0",children:[e.jsxs("div",{className:"flex justify-between items-start mb-2",children:[e.jsxs("div",{className:"flex-1 pr-4 min-w-0",children:[e.jsx("h3",{className:"font-semibold text-sm text-gray-900 mb-1 line-clamp-2 break-words",children:w.name}),w.description&&e.jsx("p",{className:"text-xs text-gray-500 line-clamp-3 mb-2 break-words",children:w.description})]}),e.jsxs("div",{className:"text-right flex-shrink-0 ml-2",children:[e.jsxs("span",{className:"text-base font-bold text-gray-900 whitespace-nowrap",children:["Q",(Pe=w.price)==null?void 0:Pe.toFixed(2)]}),w.compare_at_price&&w.compare_at_price>w.price&&e.jsxs("div",{className:"text-xs text-gray-400 line-through whitespace-nowrap",children:["Q",w.compare_at_price.toFixed(2)]})]})]}),e.jsxs("div",{className:"flex justify-between items-center gap-2",children:[e.jsxs("div",{className:"flex-1 flex flex-col gap-1",children:[Y>0&&e.jsxs(Z,{className:"bg-orange-100 text-orange-700 text-xs font-semibold w-fit",children:[Y," en carrito"]}),e.jsx(Z,{className:`text-xs font-medium w-fit ${ne.className}`,children:ne.text})]}),e.jsx("div",{className:"flex-shrink-0",children:e.jsx("button",{onClick:()=>{K.isAvailable&&b(w.id,w.name)},disabled:!K.isAvailable||$,className:`
                      h-8 px-3 text-xs font-medium rounded transition-all duration-200
                      ${K.isAvailable&&!$?"bg-orange-500 hover:bg-orange-600 active:bg-orange-700 text-white cursor-pointer shadow-md hover:shadow-lg":"bg-gray-300 text-gray-500 cursor-not-allowed"}
                    `,type:"button",children:$?e.jsx("div",{className:"w-3 h-3 border border-white border-t-transparent rounded-full animate-spin"}):Y>0&&K.isAvailable?e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(Se,{className:"w-3 h-3"}),"+1"]}):K.isAvailable?e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(Se,{className:"w-3 h-3"}),"Agregar"]}):K.isOutOfStock?"Agotado":K.isDisabledByVendor?"No disponible":"Sin stock"})})]})]})]})})})},ae=({product:w})=>{var vs;const[W,Y]=m.useState(!1),[$,K]=m.useState({hours:0,minutes:0,isExpired:!0,formattedTime:"Expirado"}),ge=Es(w),ne=te(w.id),Pe=f===w.id;m.useEffect(()=>{if(!w.expires_at)return;const qe=()=>{const ha=new Date,as=new Date(w.expires_at).getTime()-ha.getTime();if(as<=0){K({hours:0,minutes:0,isExpired:!0,formattedTime:"Expirado"});return}const rs=Math.floor(as/(1e3*60*60)),ts=Math.floor(as%(1e3*60*60)/(1e3*60));K({hours:rs,minutes:ts,isExpired:!1,formattedTime:rs>0?`${rs}h ${ts}m restantes`:`${ts}m restantes`})};qe();const ga=setInterval(qe,1e3);return()=>clearInterval(ga)},[w.expires_at]);const Fe=()=>w.stock_quantity===0?"bg-red-500 text-white":w.stock_quantity<=3?"bg-yellow-500 text-white":"bg-green-500 text-white",xa=()=>{ge&&A(ge,w.name)};return e.jsx(Q,{className:"hover:shadow-xl transition-all duration-300 border-orange-200 overflow-hidden",children:e.jsx(H,{className:"p-0",children:e.jsxs("div",{className:"flex",children:[e.jsxs("div",{className:"relative w-20 h-20 sm:w-24 sm:h-24 bg-gray-100 flex-shrink-0",children:[e.jsx("div",{className:"cursor-pointer w-full h-full",onClick:xa,children:ge?e.jsx(ye,{src:ge,alt:w.name,className:"w-full h-full object-cover hover:scale-105 transition-transform duration-200",onError:()=>Y(!0)}):e.jsx("div",{className:"w-full h-full bg-gradient-to-br from-orange-100 to-orange-200 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx(Me,{className:"w-4 h-4 sm:w-5 sm:h-5 text-orange-400 mx-auto mb-1"}),e.jsx("span",{className:"text-xs text-orange-600 font-medium",children:"Sin imagen"})]})})}),e.jsxs(Z,{className:"absolute -top-1 -left-1 bg-orange-500 text-white animate-pulse text-xs px-1 py-0.5",children:[e.jsx(Ie,{className:"w-2.5 h-2.5 mr-0.5"}),e.jsx("span",{className:"hidden sm:inline",children:"Del D√≠a"}),e.jsx("span",{className:"sm:hidden",children:"Hoy"})]}),e.jsx("div",{className:"absolute -bottom-1 -right-1 bg-red-500 text-white rounded-full px-1.5 py-0.5 text-xs font-bold",children:$.hours>0?`${$.hours}h`:`${$.minutes}m`})]}),e.jsxs("div",{className:"flex-1 p-3 min-w-0",children:[e.jsxs("div",{className:"flex justify-between items-start mb-2",children:[e.jsxs("div",{className:"flex-1 min-w-0 mr-2",children:[e.jsx("h3",{className:"font-semibold text-sm sm:text-base text-gray-900 line-clamp-1 mb-1",children:w.name}),w.description&&e.jsx("p",{className:"text-xs text-gray-500 line-clamp-1 mb-1",children:w.description}),e.jsxs("div",{className:"flex items-center gap-1 text-xs text-gray-400 mb-1",children:[e.jsx(de,{className:"w-2.5 h-2.5"}),e.jsxs("span",{className:"truncate",children:["por ",(n==null?void 0:n.business_name)||"Este negocio"]})]})]}),e.jsxs("div",{className:"text-right flex-shrink-0",children:[e.jsxs("div",{className:"text-lg sm:text-xl font-bold text-orange-600",children:["Q",(vs=w.price)==null?void 0:vs.toFixed(2)]}),e.jsxs("div",{className:"flex items-center gap-0.5 text-xs text-gray-500 justify-end",children:[e.jsx(le,{className:"w-3 h-3 fill-yellow-400 text-yellow-400"}),e.jsx("span",{children:"4.5"})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2 mb-2 text-xs",children:[!$.isExpired&&e.jsxs("div",{className:"flex items-center gap-1 text-orange-600 bg-orange-50 px-1.5 py-0.5 rounded",children:[e.jsx(me,{className:"w-2.5 h-2.5"}),e.jsx("span",{className:"font-medium",children:$.hours>0?`${$.hours}h ${$.minutes}m`:`${$.minutes}m`})]}),e.jsx(Z,{className:`text-xs ${Fe()} px-1.5 py-0.5`,children:e.jsx("span",{children:w.stock_quantity===0?"Agotado":w.stock_quantity<=3?`¬°${w.stock_quantity}!`:`${w.stock_quantity} disponibles`})}),ne>0&&e.jsx(Z,{className:"bg-orange-100 text-orange-700 text-xs font-semibold px-1.5 py-0.5",children:ne}),!$.isExpired&&$.hours<2&&e.jsx(Z,{className:"bg-yellow-100 text-yellow-700 text-xs animate-pulse px-1.5 py-0.5",children:"¬°Urgente!"})]}),$.isExpired&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded p-1.5 mb-2",children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Xe,{className:"w-3 h-3 text-red-600 flex-shrink-0"}),e.jsx("span",{className:"text-xs text-red-700 font-medium",children:"Oferta expirada"})]})}),ne>0?e.jsxs("div",{className:"flex items-center gap-1 mb-2",children:[e.jsx(M,{size:"sm",variant:"outline",onClick:()=>X(w.id,ne-1),disabled:Pe,className:"h-7 w-7 p-0",children:e.jsx(He,{className:"w-3 h-3"})}),o===w.id?e.jsx(be,{type:"number",value:d,onChange:qe=>J(qe.target.value),onBlur:()=>ie(w.id),onKeyDown:qe=>U(qe,w.id),className:"w-12 h-7 text-center text-xs p-1",autoFocus:!0}):e.jsx("button",{onClick:()=>T(w.id,ne),className:"w-12 h-7 text-xs font-medium bg-gray-100 rounded border hover:bg-gray-200 flex items-center justify-center",title:"Haz clic para editar cantidad",children:ne}),e.jsx(M,{size:"sm",variant:"outline",onClick:()=>X(w.id,ne+1),disabled:Pe||w.stock_quantity<=ne,className:"h-7 w-7 p-0",children:e.jsx(Se,{className:"w-3 h-3"})})]}):null,e.jsx(M,{onClick:()=>{ne>0?X(w.id,ne+1):(console.log("üç∫ DailyProductCard button clicked - should call handleAddDailyToCart"),R(w.id,w.name))},disabled:!w.is_available||Pe||w.stock_quantity<=0||$.isExpired,className:"w-full h-8 sm:h-9 bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-600 hover:to-red-600 text-white text-sm font-medium",children:Pe?e.jsxs(e.Fragment,{children:[e.jsx(Na,{className:"w-3 h-3 mr-1 animate-spin"}),e.jsx("span",{className:"sm:hidden",children:"..."}),e.jsx("span",{className:"hidden sm:inline",children:"Agregando..."})]}):w.stock_quantity<=0?"Agotado":$.isExpired?"Expirado":ne>0?e.jsxs(e.Fragment,{children:[e.jsx(Se,{className:"w-3 h-3 mr-1"}),e.jsx("span",{className:"sm:hidden",children:"+1"}),e.jsx("span",{className:"hidden sm:inline",children:"+1 m√°s"})]}):e.jsxs(e.Fragment,{children:[e.jsx(we,{className:"w-3 h-3 mr-1"}),e.jsx("span",{className:"sm:hidden",children:"Agregar"}),e.jsx("span",{className:"hidden sm:inline",children:"Agregar al carrito"})]})})]})]})})})};return F?e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-orange-500 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"Cargando perfil del comercio..."})]})}):n?e.jsxs("div",{className:"min-h-screen bg-gray-50",children:[e.jsx("div",{className:"bg-white border-b border-gray-200 px-4 py-3",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs(M,{onClick:r,size:"sm",variant:"ghost",className:"text-gray-600 hover:text-gray-900",children:[e.jsx(Be,{className:"w-4 h-4 mr-2"}),"Volver"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(M,{onClick:L,disabled:i,size:"sm",variant:"ghost",className:"text-green-600 hover:text-green-900 hover:bg-green-50",children:e.jsx(Ae,{className:`w-4 h-4 ${i?"animate-spin":""}`})}),e.jsx(M,{size:"sm",variant:"ghost",className:"text-gray-600 hover:text-gray-900",children:e.jsx(Ze,{className:"w-4 h-4"})}),e.jsx(M,{size:"sm",variant:"ghost",className:"text-gray-600 hover:text-gray-900",children:e.jsx(gr,{className:"w-4 h-4"})})]})]})}),e.jsxs("div",{className:"px-4 py-4 bg-white",children:[e.jsxs("div",{className:"flex items-start gap-4",children:[ve&&e.jsx("div",{className:"w-16 h-16 rounded-2xl bg-gray-100 shadow-md p-1 flex-shrink-0",children:e.jsx(ye,{src:ve,alt:`Logo de ${n.business_name}`,className:"w-full h-full object-cover rounded-xl"})}),e.jsx("div",{className:"flex-1 min-w-0",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("h1",{className:"text-xl font-bold text-gray-900 truncate",children:n.business_name}),e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["Actualizado: ",t.toLocaleTimeString()]}),e.jsxs("div",{className:"flex items-center gap-3 mt-2",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(le,{className:"w-4 h-4 text-yellow-400 fill-current mr-1"}),e.jsx("span",{className:"text-sm font-medium",children:n.rating.toFixed(1)}),e.jsxs("span",{className:"text-xs text-gray-500 ml-1",children:["(",n.products_count," productos)"]})]}),e.jsx(Z,{className:`text-xs px-2 py-1 ${n.is_open_now?"bg-green-100 text-green-700 border-green-200":"bg-red-100 text-red-700 border-red-200"}`,variant:"outline",children:n.is_open_now?"üü¢ Abierto":"üî¥ Cerrado"})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-4 mt-3 text-sm text-gray-600",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(Re,{className:"w-4 h-4 mr-1 text-gray-400"}),e.jsx("span",{className:"truncate",children:n.address||n.business_address||"Direcci√≥n no disponible"})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx(me,{className:"w-4 h-4 mr-1 text-gray-400"}),e.jsx("span",{children:"25-35 min"})]})]})]}),n.is_verified&&e.jsx("div",{className:"ml-3",children:e.jsxs(Z,{className:"bg-blue-50 text-blue-700 border-blue-200",variant:"outline",children:[e.jsx(Ls,{className:"w-3 h-3 mr-1"}),"Verificado"]})})]})})]}),e.jsx("div",{className:"mt-4 pt-4 border-t border-gray-100",children:e.jsxs("div",{className:"grid grid-cols-3 gap-3 sm:gap-4",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"w-10 h-10 bg-orange-100 rounded-xl flex items-center justify-center mx-auto mb-2",children:e.jsx(we,{className:"w-5 h-5 text-orange-600"})}),e.jsx("p",{className:"text-xs text-gray-500 mb-1",children:"Pedido m√≠nimo"}),e.jsx("p",{className:"text-sm font-semibold text-gray-900",children:"Q50"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"w-10 h-10 bg-green-100 rounded-xl flex items-center justify-center mx-auto mb-2",children:e.jsx(me,{className:"w-5 h-5 text-green-600"})}),e.jsx("p",{className:"text-xs text-gray-500 mb-1",children:"Costo env√≠o"}),e.jsx("p",{className:"text-sm font-semibold text-gray-900",children:"Q15"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"w-10 h-10 bg-blue-100 rounded-xl flex items-center justify-center mx-auto mb-2",children:e.jsx(Me,{className:"w-5 h-5 text-blue-600"})}),e.jsx("p",{className:"text-xs text-gray-500 mb-1",children:"Tiempo entrega"}),e.jsx("p",{className:"text-sm font-semibold text-gray-900",children:"25-35 min"})]})]})})]}),B&&e.jsx("div",{className:"relative w-full h-40 mx-4 mb-4 rounded-xl overflow-hidden",children:e.jsx(ye,{src:B,alt:`Portada de ${n.business_name}`,className:"w-full h-full object-cover"})}),e.jsx("div",{className:"bg-gray-50",children:e.jsx("div",{className:"px-4 mb-4",children:e.jsx(Q,{className:"bg-white shadow-lg border-0 rounded-2xl overflow-hidden",children:e.jsx(H,{className:"p-0",children:e.jsxs(Je,{value:z,onValueChange:v,className:"w-full",children:[e.jsxs(es,{className:"grid w-full grid-cols-3 bg-gray-50 p-1 m-2 rounded-xl",children:[e.jsxs(_e,{value:"productos",className:"rounded-lg text-sm font-medium data-[state=active]:bg-white data-[state=active]:shadow-sm transition-all",children:[e.jsx(xe,{className:"w-4 h-4 mr-2"}),"Productos (",_.length,")"]}),e.jsxs(_e,{value:"dia",className:"rounded-lg text-sm font-medium data-[state=active]:bg-white data-[state=active]:shadow-sm transition-all",children:[e.jsx(Me,{className:"w-4 h-4 mr-2"}),"Del D√≠a (",p.length,")"]}),e.jsxs(_e,{value:"info",className:"rounded-lg text-sm font-medium data-[state=active]:bg-white data-[state=active]:shadow-sm transition-all",children:[e.jsx(ks,{className:"w-4 h-4 mr-2"}),"Info"]})]}),e.jsxs("div",{className:"px-3 py-4",children:[e.jsx(je,{value:"productos",className:"mt-0",children:F?e.jsx("div",{className:"space-y-3",children:[...Array(6)].map((w,W)=>e.jsx("div",{className:"bg-gray-100 rounded-xl h-24 animate-pulse"},W))}):_&&_.length>0?e.jsx("div",{className:"space-y-3",children:_.map(w=>e.jsx(D,{product:w},w.id))}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(xe,{className:"w-12 h-12 text-gray-300 mx-auto mb-3"}),e.jsx("p",{className:"text-gray-500 mb-2",children:"No hay productos disponibles"}),e.jsx("p",{className:"text-xs text-gray-400",children:_&&_.length>0?`Se encontraron ${_.length} productos pero no est√°n disponibles`:"No se pudieron cargar los productos"}),_&&_.length>0&&e.jsx("button",{onClick:()=>console.log("üîç Productos encontrados:",_),className:"mt-2 text-xs text-blue-500 hover:text-blue-700",children:"Ver detalles en consola"})]})}),e.jsx(je,{value:"dia",className:"mt-0",children:F?e.jsx("div",{className:"space-y-3",children:[...Array(3)].map((w,W)=>e.jsx("div",{className:"bg-gray-100 rounded-xl h-24 animate-pulse"},W))}):p&&p.length>0?e.jsx("div",{className:"space-y-3",children:p.map(w=>e.jsx(ae,{product:w},w.id))}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Me,{className:"w-12 h-12 text-gray-300 mx-auto mb-3"}),e.jsx("p",{className:"text-gray-500 mb-2",children:"No hay productos del d√≠a"}),e.jsx("p",{className:"text-xs text-gray-400",children:p&&p.length>0?`Se encontraron ${p.length} productos del d√≠a pero no est√°n disponibles`:"No se pudieron cargar los productos del d√≠a"}),p&&p.length>0&&e.jsx("button",{onClick:()=>console.log("üîç Productos del d√≠a encontrados:",p),className:"mt-2 text-xs text-blue-500 hover:text-blue-700",children:"Ver detalles en consola"})]})}),e.jsx(je,{value:"info",className:"mt-0",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-gray-50 rounded-xl p-4",children:[e.jsxs("h3",{className:"font-semibold text-gray-900 mb-3 flex items-center",children:[e.jsx(me,{className:"w-5 h-5 mr-2 text-blue-600"}),"Horarios de Atenci√≥n"]}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Lunes - Viernes:"}),e.jsx("span",{className:"font-medium",children:"8:00 AM - 9:00 PM"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"S√°bados:"}),e.jsx("span",{className:"font-medium",children:"8:00 AM - 10:00 PM"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Domingos:"}),e.jsx("span",{className:"font-medium",children:"9:00 AM - 8:00 PM"})]})]})]}),e.jsxs("div",{className:"bg-gray-50 rounded-xl p-4",children:[e.jsxs("h3",{className:"font-semibold text-gray-900 mb-3 flex items-center",children:[e.jsx(ls,{className:"w-5 h-5 mr-2 text-green-600"}),"Contacto"]}),e.jsxs("div",{className:"space-y-2 text-sm",children:[console.log("üî• RENDER CONTACTO:",{phone_options:[n.phone,n.business_phone,(pe=n.user)==null?void 0:pe.phone],address_options:[n.address,n.business_address,(Ce=n.user)==null?void 0:Ce.address],final_phone:n.phone||n.business_phone||((ce=n.user)==null?void 0:ce.phone)||"No disponible",final_address:n.address||n.business_address||((ss=n.user)==null?void 0:ss.address)||"Direcci√≥n no disponible"}),e.jsxs("div",{className:"flex items-center",children:[e.jsx(ls,{className:"w-4 h-4 mr-2 text-gray-400"}),e.jsx("span",{children:n.phone||n.business_phone||((fs=n.user)==null?void 0:fs.phone)||"No disponible"})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx(Re,{className:"w-4 h-4 mr-2 text-gray-400"}),e.jsx("span",{children:n.address||n.business_address||((js=n.user)==null?void 0:js.address)||"Direcci√≥n no disponible"})]})]})]}),(n.description||n.business_description)&&e.jsxs("div",{className:"bg-gray-50 rounded-xl p-4",children:[e.jsxs("h3",{className:"font-semibold text-gray-900 mb-3 flex items-center",children:[e.jsx(ks,{className:"w-5 h-5 mr-2 text-purple-600"}),"Acerca de"]}),e.jsx("p",{className:"text-sm text-gray-600 leading-relaxed",children:n.description||n.business_description})]})]})})]})]})})})})}),e.jsx(xs,{onCartClick:()=>{console.log("üõí Carrito flotante clicked desde BusinessProfile!"),l?l():alert("üõí Carrito flotante funcional! Navegaci√≥n no configurada.")}})]}):e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx(Ee,{className:"w-16 h-16 text-gray-300 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"No se pudo cargar el comercio"}),e.jsx(M,{onClick:r,children:"Volver"})]})})}function gt({onAlert:s}){const{user:r}=ke(),[l,g]=m.useState([]),[u,c]=m.useState(!1),j=m.useCallback(async()=>{if(r)try{let n=I.from("orders").select("*");switch(r.role){case"vendedor":n=n.eq("seller_id",r.id);break;case"comprador":n=n.eq("buyer_id",r.id);break;case"repartidor":n=n.eq("driver_id",r.id);break;default:return}n=n.in("status",["pending","accepted","ready","assigned","picked-up","in-transit"]);const{data:E}=await n;if(!E)return;const _=new Date,q=[];E.forEach(p=>{const C=new Date(p.created_at),F=p.accepted_at?new Date(p.accepted_at):null,G=p.ready_at?new Date(p.ready_at):null,z=p.status==="assigned"?new Date(p.updated_at):null,v=p.picked_up_at?new Date(p.picked_up_at):null;let f=C,P=0,i="low";switch(p.status){case"pending":if(f=C,P=10,r.role==="vendedor"){const a=(_.getTime()-f.getTime())/6e4;a>15?i="critical":a>12?i="high":a>8&&(i="medium")}break;case"accepted":if(f=F||C,P=p.delivery_type==="dine-in"?25:30,r.role==="vendedor"){const a=(_.getTime()-f.getTime())/6e4;a>P+15?i="critical":a>P+10?i="high":a>P&&(i="medium")}break;case"ready":if(f=G||C,p.delivery_type==="pickup"){if(P=20,r.role==="comprador"){const a=(_.getTime()-f.getTime())/6e4;a>30?i="critical":a>25?i="high":a>15&&(i="medium")}}else if(p.delivery_type==="delivery"){P=15;const a=(_.getTime()-f.getTime())/(1e3*60);a>25?i="critical":a>20?i="high":a>15&&(i="medium")}break;case"assigned":if(f=z||G||C,P=15,r.role==="repartidor"){const a=(_.getTime()-f.getTime())/6e4;a>25?i="critical":a>20?i="high":a>15&&(i="medium")}break;case"picked-up":case"in-transit":f=v||z||G||C,P=45;const t=(_.getTime()-f.getTime())/(1e3*60);t>60?i="critical":t>50?i="high":t>40&&(i="medium");break}const y=(_.getTime()-f.getTime())/(1e3*60);y>P&&i!=="low"&&q.push({orderId:p.id,status:p.status,timeSinceStatus:Math.floor(y),customerName:p.customer_name||"Cliente",total:p.total,urgencyLevel:i})}),g(q),q.filter(p=>p.urgencyLevel==="critical").forEach(p=>{s==null||s(p),console.error(`üö® ALERTA CR√çTICA: Orden ${p.orderId.slice(-6)} en estado ${p.status} por ${p.timeSinceStatus} minutos`)})}catch(n){console.error("Error checking timeout alerts:",n)}},[r,s]),x=m.useCallback(async n=>{if(!(!r||n.length===0))try{for(const E of n){const{data:_}=await I.from("orders").select("buyer_id, seller_id, driver_id").eq("id",E.orderId).single();if(!_)continue;const q=[];switch(E.status){case"pending":q.push({recipient_id:_.seller_id,type:"order_timeout_critical",title:"üö® ORDEN CR√çTICA",message:`Orden pendiente por ${E.timeSinceStatus} minutos - ACEPTAR URGENTE`,data:{order_id:E.orderId,timeout_minutes:E.timeSinceStatus}}),q.push({recipient_id:_.buyer_id,type:"order_delay",title:"Demora en tu pedido",message:"Tu pedido est√° tardando m√°s de lo esperado. Te mantendremos informado.",data:{order_id:E.orderId}});break;case"accepted":q.push({recipient_id:_.seller_id,type:"preparation_timeout",title:"‚è∞ PREPARACI√ìN LENTA",message:`Orden en preparaci√≥n por ${E.timeSinceStatus} minutos`,data:{order_id:E.orderId,timeout_minutes:E.timeSinceStatus}});break;case"ready":E.timeSinceStatus>20&&q.push({recipient_id:_.buyer_id,type:"pickup_reminder",title:"üì¶ Tu pedido est√° listo",message:`Tu pedido lleva ${E.timeSinceStatus} minutos esperando ser recogido`,data:{order_id:E.orderId,waiting_minutes:E.timeSinceStatus}});break}q.length>0&&await I.from("notifications").insert(q)}}catch(E){console.error("Error sending critical timeout notifications:",E)}},[r]);m.useEffect(()=>{if(!r)return;c(!0),j();const n=setInterval(j,2*60*1e3);return()=>{clearInterval(n),c(!1)}},[r,j]),m.useEffect(()=>{const n=l.filter(E=>E.urgencyLevel==="critical");n.length>0&&x(n)},[l,x]);const h=n=>{switch(n){case"critical":return"bg-red-100 border-red-300 text-red-800";case"high":return"bg-orange-100 border-orange-300 text-orange-800";case"medium":return"bg-yellow-100 border-yellow-300 text-yellow-800";default:return"bg-gray-100 border-gray-300 text-gray-800"}},N=n=>{switch(n){case"critical":return e.jsx(_a,{className:"w-4 h-4"});case"high":return e.jsx(Xe,{className:"w-4 h-4"});case"medium":return e.jsx(me,{className:"w-4 h-4"});default:return e.jsx(Ra,{className:"w-4 h-4"})}},A=n=>{switch(n.status){case"pending":return`Esperando aceptaci√≥n por ${n.timeSinceStatus} min`;case"accepted":return`En preparaci√≥n por ${n.timeSinceStatus} min`;case"ready":return`Listo por ${n.timeSinceStatus} min`;case"assigned":return`Repartidor asignado hace ${n.timeSinceStatus} min`;case"picked-up":case"in-transit":return`En camino por ${n.timeSinceStatus} min`;default:return`En estado ${n.status} por ${n.timeSinceStatus} min`}};return!u||l.length===0?null:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(me,{className:"w-5 h-5 text-orange-600"}),e.jsxs("h3",{className:"text-lg font-semibold text-gray-900",children:["Alertas de tiempo (",l.length,")"]})]}),e.jsx("div",{className:"space-y-2",children:l.map(n=>e.jsx("div",{className:`border rounded-lg p-3 ${h(n.urgencyLevel)}`,children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[N(n.urgencyLevel),e.jsxs("div",{children:[e.jsxs("p",{className:"font-medium",children:[n.customerName," - Q",n.total.toFixed(2)]}),e.jsx("p",{className:"text-sm",children:A(n)}),e.jsxs("p",{className:"text-xs opacity-75",children:["Orden #",n.orderId.slice(-6)]})]})]}),n.urgencyLevel==="critical"&&e.jsxs("div",{className:"flex items-center space-x-1 text-red-600",children:[e.jsx("span",{className:"text-xs font-bold",children:"URGENTE"}),e.jsx("div",{className:"w-2 h-2 bg-red-500 rounded-full animate-pulse"})]})]})},n.orderId))})]})}function Zt(){var G;const{user:s,signOut:r}=ke(),{getCartItemCount:l}=Te(),[g,u]=m.useState("home"),[c,j]=m.useState("dashboard"),[x,h]=m.useState(""),[N,A]=m.useState(""),n=z=>{h(z),j("business-profile")},E=()=>{j("dashboard"),h("")},_=()=>{j("dashboard"),u("home")},q=z=>{A(z),j("order-tracking")},p=()=>{j("dashboard"),A("")},C=(z,v)=>{console.log(`üö® Alerta cr√≠tica para comprador: ${z} - ${v}`)},F=z=>{console.log(`‚è∞ Alerta de timeout: Orden ${z.orderId} - ${z.timeSinceStatus} min`)};return c==="business-profile"?e.jsx(xt,{businessId:x,onBack:E,onShowCart:()=>j("cart")}):c==="cart"?e.jsx(Zr,{onContinueShopping:()=>j("dashboard"),onProceedToCheckout:()=>j("checkout")}):c==="checkout"?e.jsx(dt,{onBack:_,onComplete:()=>{j("dashboard"),u("orders")}}):c==="order-tracking"?e.jsx(Ss,{children:e.jsx(Ks,{orderId:N,onBack:p})}):e.jsx(Ss,{children:e.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-orange-50 to-green-50",children:[e.jsx(er,{showBanner:!0,enableAutoActivation:!1}),e.jsx("div",{className:"container mx-auto px-4",children:typeof window<"u"&&"Notification"in window&&Notification.permission!=="granted"&&e.jsx("div",{className:"flex justify-end mb-2"})}),e.jsx(sr,{onNotification:C}),e.jsx(gt,{onAlert:F}),N&&e.jsx("div",{className:"container mx-auto px-4 mb-4",children:e.jsx(ar,{orderId:N})}),e.jsx("div",{className:"bg-white border-b border-gray-200 shadow-sm sticky top-0 z-30 mb-2",children:e.jsx("div",{className:"container mx-auto px-4 py-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"bg-gradient-to-r from-orange-500 to-orange-600 p-2 rounded-lg",children:e.jsx(de,{className:"w-5 h-5 md:w-6 md:h-6 text-white"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-lg md:text-xl font-bold bg-gradient-to-r from-orange-600 to-red-600 bg-clip-text text-transparent",children:"TRATO"}),e.jsxs("p",{className:"text-xs md:text-sm text-gray-600 hidden sm:block",children:["¬°Hola, ",((G=s==null?void 0:s.email)==null?void 0:G.split("@")[0])||"guichointeriano","!"]})]})]}),e.jsxs(M,{variant:"outline",onClick:r,className:"flex items-center gap-1 text-xs md:text-sm px-2 md:px-4 py-2 min-h-[44px]",children:[e.jsx(rr,{className:"w-4 h-4"}),e.jsx("span",{children:"Cerrar Sesi√≥n"})]})]})})}),e.jsx(ut,{}),e.jsxs("div",{className:"main-content container mx-auto px-4 py-4 md:py-6",style:{paddingBottom:window.innerWidth<=768?"80px":"24px"},children:[e.jsx("div",{className:"block md:hidden",children:e.jsx("div",{className:"mobile-bottom-nav",style:{position:"fixed",bottom:0,left:0,right:0,background:"white",borderTop:"2px solid #e5e7eb",padding:"12px",zIndex:50,boxShadow:"0 -4px 6px -1px rgba(0, 0, 0, 0.1)"},children:e.jsx("div",{className:"grid grid-cols-3 gap-1",children:[{id:"home",label:"Inicio",icon:bs},{id:"orders",label:"Pedidos",icon:xe},{id:"profile",label:"Perfil",icon:Oe}].map(z=>{const v=z.icon,f=g===z.id;return e.jsxs("button",{onClick:()=>u(z.id),style:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",gap:"4px",padding:"8px",borderRadius:"8px",minHeight:"60px",fontSize:"10px",fontWeight:"500",backgroundColor:f?"#fef3c7":"transparent",color:f?"#f97316":"#6b7280",border:"none",cursor:"pointer",transition:"all 0.2s"},children:[e.jsx(v,{className:"w-5 h-5"}),e.jsx("span",{style:{fontSize:"10px",fontWeight:"500",lineHeight:"1.2"},children:z.label})]},z.id)})})})}),e.jsx("div",{className:"hidden md:block",children:e.jsxs(Je,{value:g,onValueChange:u,className:"space-y-6",children:[e.jsx(es,{className:"grid w-full grid-cols-3 lg:w-2/3 mx-auto bg-white border border-gray-200",children:[{id:"home",label:"Inicio",icon:bs},{id:"orders",label:"Pedidos",icon:xe},{id:"profile",label:"Perfil",icon:Oe}].map(z=>{const v=z.icon;return e.jsxs(_e,{value:z.id,className:"flex flex-col items-center gap-1 p-4 data-[state=active]:bg-green-100 data-[state=active]:text-green-700 relative",children:[e.jsx(v,{className:"w-5 h-5"}),e.jsx("span",{className:"text-xs font-medium",children:z.label})]},z.id)})}),e.jsx(je,{value:"home",className:"space-y-6",children:e.jsx(Ts,{onBusinessClick:n,onShowCart:()=>j("cart")})}),e.jsx(je,{value:"orders",className:"space-y-6",children:e.jsx(qs,{onViewOrder:q})}),e.jsx(je,{value:"profile",className:"space-y-6",children:e.jsx(As,{onShowCart:()=>j("cart")})})]})}),e.jsxs("div",{className:"block md:hidden",children:[g==="home"&&e.jsx(Ts,{onBusinessClick:n,onShowCart:()=>j("cart")}),g==="orders"&&e.jsx(qs,{onViewOrder:q}),g==="profile"&&e.jsx(As,{onShowCart:()=>j("cart")})]})]}),c==="order-tracking"&&e.jsx("div",{className:"fixed top-4 left-4 right-4 md:left-auto md:right-4 md:w-auto z-50",children:e.jsx(Q,{className:"mobile-card border-green-200 bg-green-50",children:e.jsx(H,{className:"mobile-card-content",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(oe,{className:"w-5 h-5 text-green-600 flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"mobile-text font-medium text-green-800 mb-1",children:"¬°Orden creada exitosamente!"}),e.jsx("p",{className:"mobile-text-small text-green-600",children:"Puedes seguir el estado de tu pedido aqu√≠"})]})]})})})}),e.jsx(qa,{})]})})}export{Zt as BuyerDashboard};
