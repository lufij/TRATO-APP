import{g as C,s as d,u as Q,h as K,r as $,j as g,f as X,Z as Y}from"./index-9d4LIYkQ.js";import{T as ee}from"./truck-B_KZSvWh.js";import{U as re}from"./users-BMnL9NIw.js";import{C as W}from"./clock-BLcblUBq.js";import{T as te}from"./triangle-alert-BAlJ0FTm.js";/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ae=[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"m12 5 7 7-7 7",key:"xquz4c"}]],ke=C("arrow-right",ae);/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const oe=[["path",{d:"M3.85 8.62a4 4 0 0 1 4.78-4.77 4 4 0 0 1 6.74 0 4 4 0 0 1 4.78 4.78 4 4 0 0 1 0 6.74 4 4 0 0 1-4.77 4.78 4 4 0 0 1-6.75 0 4 4 0 0 1-4.78-4.77 4 4 0 0 1 0-6.76Z",key:"3c2336"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]],we=C("badge-check",oe);/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const se=[["rect",{width:"20",height:"14",x:"2",y:"5",rx:"2",key:"ynyp8z"}],["line",{x1:"2",x2:"22",y1:"10",y2:"10",key:"1b3vmo"}]],xe=C("credit-card",se);/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ie=[["path",{d:"M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z",key:"96xj49"}]],Ee=C("flame",ie);/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ne=[["path",{d:"M15 21v-8a1 1 0 0 0-1-1h-4a1 1 0 0 0-1 1v8",key:"5wwlr5"}],["path",{d:"M3 10a2 2 0 0 1 .709-1.528l7-5.999a2 2 0 0 1 2.582 0l7 5.999A2 2 0 0 1 21 10v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z",key:"1d0kgt"}]],Se=C("house",ne);/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ce=[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"M12 5v14",key:"s699le"}]],$e=C("plus",ce);/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const de=[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}]],Ne=C("rotate-ccw",de);/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const le=[["path",{d:"M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7",key:"1m0v6g"}],["path",{d:"M18.375 2.625a1 1 0 0 1 3 3l-9.013 9.014a2 2 0 0 1-.853.505l-2.873.84a.5.5 0 0 1-.62-.62l.84-2.873a2 2 0 0 1 .506-.852z",key:"ohrbg2"}]],qe=C("square-pen",le);/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ue=[["line",{x1:"10",x2:"14",y1:"2",y2:"2",key:"14vaq8"}],["line",{x1:"12",x2:"15",y1:"14",y2:"11",key:"17fdiu"}],["circle",{cx:"12",cy:"14",r:"8",key:"1e1u0o"}]],pe=C("timer",ue);async function De(s,e){if(console.log("üîÑ Iniciando actualizaci√≥n de stock para orden:",e),console.log("üì¶ Items a procesar:",s.length),s.forEach((o,t)=>{console.log(`   ${t+1}. ${o.product_name}`),console.log(`      - Cantidad: ${o.quantity}`),console.log(`      - Tipo: ${o.product_type||"regular"}`),console.log(`      - Product ID: ${o.product_id}`),console.log(`      - Daily Product ID: ${o.daily_product_id||"N/A"}`)}),!s||s.length===0)return console.log("‚ö†Ô∏è No hay items para procesar"),{success:!1,message:"No hay items para actualizar stock"};try{const o=[];for(const t of s){console.log(`üîç Procesando producto, cantidad: ${t.quantity}, tipo: ${t.product_type||"regular"}`),console.log(`    Product ID: ${t.product_id}, Daily Product ID: ${t.daily_product_id}`);const p=t.product_type==="daily"||!!t.daily_product_id,S=p?"daily_products":"products";let a=null,w=null;if(p&&t.product_id){console.log(`üîç OPCI√ìN 1: Buscando producto del d√≠a por product_id: ${t.product_id}`);const{data:u,error:l}=await d.from("daily_products").select("id, name, stock_quantity, is_available").eq("id",t.product_id).single();!l&&u?(a=u,console.log(`‚úÖ ENCONTRADO por product_id en daily_products: ${a.name}`)):console.log("‚ùå No encontrado por product_id en daily_products:",l==null?void 0:l.message)}if(!a&&p&&t.daily_product_id){console.log(`üîç OPCI√ìN 2: Buscando por daily_product_id (legacy): ${t.daily_product_id}`);const{data:u,error:l}=await d.from("daily_products").select("id, name, stock_quantity, is_available").eq("id",t.daily_product_id).single();!l&&u?(a=u,console.log(`‚úÖ ENCONTRADO por daily_product_id: ${a.name}`)):console.log("‚ùå No encontrado por daily_product_id:",l==null?void 0:l.message)}if(!a&&!p&&t.product_id){console.log(`üîç OPCI√ìN 3: Buscando producto regular por product_id: ${t.product_id}`);const{data:u,error:l}=await d.from("products").select("id, name, stock_quantity, is_available").eq("id",t.product_id).single();!l&&u?(a=u,console.log(`‚úÖ ENCONTRADO por product_id en products: ${a.name}`)):console.log("‚ùå No encontrado por product_id en products:",l==null?void 0:l.message)}if(!a&&p&&t.product_name){console.log(`üîç OPCI√ìN 4: Buscando por nombre en daily_products: ${t.product_name}`);const{data:u,error:l}=await d.from("daily_products").select("id, name, stock_quantity, is_available, expires_at").eq("name",t.product_name).gte("expires_at",new Date().toISOString()).order("created_at",{ascending:!1}).limit(1);!l&&u&&u.length>0?(a=u[0],console.log(`‚úÖ ENCONTRADO por nombre: ${a.name}`)):console.log("‚ùå No encontrado por nombre:",l==null?void 0:l.message)}if(!a&&!p&&t.product_name){console.log(`üîç OPCI√ìN 5: Buscando por nombre en products: ${t.product_name}`);const{data:u,error:l}=await d.from("products").select("id, name, stock_quantity, is_available").eq("name",t.product_name).limit(1);!l&&u&&u.length>0?(a=u[0],console.log(`‚úÖ ENCONTRADO por nombre: ${a.name}`)):console.log("‚ùå No encontrado por nombre:",l==null?void 0:l.message)}if(!a)return console.log("‚ùå PRODUCTO NO ENCONTRADO EN NINGUNA B√öSQUEDA"),console.log("üîç Detalles del item:",{product_id:t.product_id,daily_product_id:t.daily_product_id,product_name:t.product_name,product_type:t.product_type,isDaily:p,tableName:S}),{success:!1,message:`Error al obtener informaci√≥n del producto ${t.product_name}. Producto no encontrado en ninguna tabla.`};const x=a.stock_quantity,N=x-t.quantity;if(console.log(`üìä ${p?"Producto del d√≠a":"Producto regular"} "${a.name}": ${x} ‚Üí ${N} (vendido: ${t.quantity})`),x<t.quantity)return console.error(`‚ùå Stock insuficiente para ${a.name}: tiene ${x}, necesita ${t.quantity}`),{success:!1,message:`Stock insuficiente para ${a.name}. Solo quedan ${x} unidades.`};const T=p?"daily_products":"products";console.log(`üîÑ Actualizando en tabla: ${T}, ID: ${a.id}`);const i={stock_quantity:N,updated_at:new Date().toISOString()};p||(i.is_available=N>0&&a.is_available);const{error:b}=await d.from(T).update(i).eq("id",a.id);if(b)return console.error(`‚ùå Error actualizando stock para ${a.id}:`,b),await me(o,e),{success:!1,message:`Error al actualizar el stock del producto ${a.name}`};o.push({product_id:a.id,old_stock:x,new_stock:N,quantity_sold:t.quantity,product_type:t.product_type||"regular"}),console.log(`‚úÖ Stock actualizado exitosamente para "${a.name}" (${p?"producto del d√≠a":"producto regular"})`)}return await H(e,"stock_decrease",o),console.log("üéâ Actualizaci√≥n de stock completada exitosamente"),{success:!0,message:"Stock actualizado correctamente",updatedProducts:o}}catch(o){return console.error("‚ùå Error inesperado actualizando stock:",o),{success:!1,message:"Error inesperado al actualizar el inventario"}}}async function me(s,e){console.log("üîÑ Iniciando rollback de stock para orden:",e);for(const o of s)try{const t=o.product_type==="daily",p=t?"daily_products":"products";await d.from(p).update({stock_quantity:o.old_stock,updated_at:new Date().toISOString()}).eq("id",o.product_id),console.log(`‚úÖ Rollback exitoso para ${t?"producto del d√≠a":"producto regular"} ${o.product_id}: ${o.new_stock} ‚Üí ${o.old_stock}`)}catch(t){console.error(`‚ùå Error en rollback para producto ${o.product_id}:`,t)}}async function G(s,e){console.log("üîÑ Iniciando restauraci√≥n de stock para orden cancelada:",e);try{const o=[];for(const t of s){const p=t.product_type==="daily",S=p?"daily_products":"products",{data:a,error:w}=await d.from(S).select("id, name, stock_quantity, is_available").eq("id",t.product_id).single();if(w||!a){console.error(`‚ùå Error obteniendo ${p?"producto del d√≠a":"producto regular"} para restaurar ${t.product_id}:`,w);continue}const x=a.stock_quantity,N=x+t.quantity,T={stock_quantity:N,updated_at:new Date().toISOString()};p||(T.is_available=!0);const{error:i}=await d.from(S).update(T).eq("id",t.product_id);if(i){console.error(`‚ùå Error restaurando stock para ${t.product_id}:`,i);continue}o.push({product_id:t.product_id,old_stock:x,new_stock:N,quantity_sold:-t.quantity,product_type:t.product_type||"regular"}),console.log(`‚úÖ Stock restaurado para "${a.name}" (${p?"producto del d√≠a":"producto regular"}): ${x} ‚Üí ${N}`)}return await H(e,"stock_restore",o),{success:!0,message:"Stock restaurado correctamente",updatedProducts:o}}catch(o){return console.error("‚ùå Error inesperado restaurando stock:",o),{success:!1,message:"Error inesperado al restaurar el inventario"}}}async function H(s,e,o){try{console.log("üìù Log de transacci√≥n de stock:",{orderId:s,type:e,timestamp:new Date().toISOString(),products:o})}catch(t){console.warn("‚ö†Ô∏è Error registrando log de stock (no cr√≠tico):",t)}}async function ge(s){console.log("üîç Validando stock antes de crear orden");try{const e=[];for(const o of s){const{data:t,error:p}=await d.from("products").select("id, name, stock_quantity, is_available").eq("id",o.product_id).single();if(p||!t){e.push({product_id:o.product_id,product_name:o.product_name||"Producto desconocido",requested:o.quantity,available:0});continue}(!t.is_available||t.stock_quantity<o.quantity)&&e.push({product_id:o.product_id,product_name:t.name,requested:o.quantity,available:t.stock_quantity})}return e.length>0?{isValid:!1,message:`Stock insuficiente: ${e.map(t=>`${t.product_name}: solicitas ${t.requested}, disponibles ${t.available}`).join("; ")}`,invalidItems:e}:{isValid:!0,message:"Stock suficiente para todos los productos"}}catch(e){return console.error("‚ùå Error validando stock:",e),{isValid:!1,message:"Error al validar disponibilidad de productos"}}}const Z=$.createContext(void 0);function Oe({children:s}){const{user:e}=Q(),{clearCart:o}=K(),[t,p]=$.useState([]),[S,a]=$.useState(!1),[w,x]=$.useState(null),[N,T]=$.useState(null),i=async()=>{if(!e){p([]);return}try{a(!0),x(null);const{error:r}=await d.from("orders").select("count",{count:"exact",head:!0});if((r==null?void 0:r.code)==="PGRST205"){console.log("Orders table does not exist yet"),p([]);return}let n=d.from("orders").select(`
          *,
          order_items (*)
        `);switch(e.role){case"comprador":n=n.eq("buyer_id",e.id);break;case"vendedor":n=n.eq("seller_id",e.id);break;case"repartidor":n=n.or(`driver_id.eq.${e.id},status.eq.ready,status.eq.assigned`);break}const{data:h,error:c}=await n.order("created_at",{ascending:!1});if(c){console.error("Error fetching orders:",c),x("Error al cargar las √≥rdenes");return}const E=await Promise.all((h||[]).map(async f=>{let v="",m="";if(f.seller_id){const{data:k}=await d.from("users").select("name").eq("id",f.seller_id).single();v=(k==null?void 0:k.name)||""}if(f.driver_id){const{data:k}=await d.from("users").select("name").eq("id",f.driver_id).single();m=(k==null?void 0:k.name)||""}return{...f,items:f.order_items||[],seller_name:v,driver_name:m}}));p(E)}catch(r){console.error("Unexpected error fetching orders:",r),x("Error inesperado al cargar las √≥rdenes")}finally{a(!1)}},b=async r=>{if(!e)return{success:!1,message:"Debes iniciar sesi√≥n para crear una orden"};try{a(!0),x(null);const{data:n,error:h}=await d.from("cart_items").select(`
          *,
          products!inner (
            id,
            name,
            price,
            seller_id,
            is_public
          )
        `).eq("user_id",e.id);if(h)return console.error("Error fetching cart items:",h),{success:!1,message:"Error al obtener los productos del carrito"};if(!n||n.length===0)return{success:!1,message:"El carrito est√° vac√≠o"};const c=n.filter(_=>_.products?_.products.is_public?!0:(console.warn(`Product ${_.product_id} is not public`),!1):(console.warn(`Cart item ${_.id} has no associated product`),!1));if(c.length===0)return{success:!1,message:"No hay productos v√°lidos en el carrito"};if(c.length!==n.length)return{success:!1,message:"Algunos productos en tu carrito ya no est√°n disponibles. Por favor actualiza tu carrito."};const E=[...new Set(c.map(_=>_.products.seller_id))];if(E.length>1)return{success:!1,message:"Todos los productos deben ser del mismo vendedor"};const f=E[0];if(!f)return{success:!1,message:"Error: productos sin vendedor asignado"};const v=c.reduce((_,R)=>{const z=R.products.price||R.product_price||0;return _+z*R.quantity},0);let m=0;r.delivery_type==="delivery"&&(m=15);const k=v+m;console.log("üõ°Ô∏è Validando disponibilidad de stock antes de crear orden...");const O=await ge(c.map(_=>({product_id:_.product_id,quantity:_.quantity,product_name:_.products.name})));if(!O.isValid)return console.warn("‚ö†Ô∏è Stock insuficiente:",O.message),{success:!1,message:O.message};console.log("‚úÖ Stock validado correctamente, procediendo con la orden");const I={buyer_id:e.id,seller_id:f,subtotal:v,delivery_fee:m,total:k,delivery_type:r.delivery_type,delivery_address:r.delivery_address,customer_notes:r.customer_notes,phone_number:r.phone_number,customer_name:r.customer_name,status:"pending",estimated_time:30};r.delivery_location?(I.delivery_latitude=r.delivery_location.latitude,I.delivery_longitude=r.delivery_location.longitude,(r.delivery_location.address_id||r.delivery_location.delivery_instructions||r.delivery_location.landmark)&&(I.delivery_location=r.delivery_location)):(I.delivery_latitude=r.delivery_latitude,I.delivery_longitude=r.delivery_longitude);const{data:A,error:V}=await d.from("orders").insert(I).select().single();if(V||!A)return console.error("Error creating order:",V),{success:!1,message:"Error al crear la orden"};const J=c.map(_=>{const R=_.products.price||_.product_price||0,z=_.product_type==="daily";return{order_id:A.id,product_id:z?null:_.product_id,daily_product_id:z?_.product_id:null,product_name:_.products.name||_.product_name||"",product_image:_.product_image,price:R,quantity:_.quantity,product_type:_.product_type||"regular",notes:""}}),{error:F}=await d.from("order_items").insert(J);if(F)return console.error("Error creating order items:",F),await d.from("orders").delete().eq("id",A.id),F.code==="23503"?{success:!1,message:"Error: algunos productos ya no est√°n disponibles"}:{success:!1,message:"Error al crear los items de la orden"};console.log("üì¶ Orden creada exitosamente. Stock se actualizar√° cuando se marque como entregado.");try{await d.from("notifications").insert({recipient_id:f,type:"new_order",title:"Nueva Orden",message:`Nueva orden por Q${k.toFixed(2)} - ${r.delivery_type}`,data:{order_id:A.id}})}catch(_){console.warn("Failed to create notification:",_)}try{await o()}catch(_){console.warn("Failed to clear cart:",_)}return T(A),await i(),{success:!0,message:"Orden creada exitosamente",orderId:A.id}}catch(n){return console.error("Unexpected error creating order:",n),{success:!1,message:"Error inesperado al crear la orden"}}finally{a(!1)}},u=async(r,n,h)=>{if(!e)return{success:!1,message:"Debes iniciar sesi√≥n"};try{a(!0);const c={status:n,updated_at:new Date().toISOString()};switch(n){case"accepted":c.accepted_at=new Date().toISOString();break;case"ready":c.ready_at=new Date().toISOString();break;case"picked-up":c.picked_up_at=new Date().toISOString();break;case"delivered":c.delivered_at=new Date().toISOString();break;case"completed":c.completed_at=new Date().toISOString();break;case"rejected":c.rejection_reason=h||"Sin raz√≥n especificada";break}const{error:E}=await d.from("orders").update(c).eq("id",r);if(E)return console.error("Error updating order status:",E),{success:!1,message:"Error al actualizar el estado de la orden"};if(n==="cancelled"||n==="rejected")try{const{data:v,error:m}=await d.from("order_items").select("product_id, quantity, product_name").eq("order_id",r);if(!m&&v&&v.length>0){console.log(`üì¶ Restaurando stock para orden ${n}...`);for(const k of v){const O=await G(k.product_id,k.quantity);O.success?console.log(`‚úÖ Stock restaurado: ${k.product_name} - Cantidad devuelta: ${k.quantity}`):console.warn(`‚ö†Ô∏è No se pudo restaurar stock para ${k.product_name}:`,O.message)}console.log("üéâ Stock restaurado exitosamente")}}catch(v){console.error("‚ùå Error restaurando stock:",v)}const{data:f}=await d.from("orders").select("*, order_items(*)").eq("id",r).single();if(f){const v=[];switch(n){case"accepted":v.push({recipient_id:f.buyer_id,type:"order_accepted",title:"Orden Aceptada",message:`Tu orden ha sido aceptada y ser√° preparada en ${f.estimated_time} minutos`,data:{order_id:r}});break;case"ready":if(v.push({recipient_id:f.buyer_id,type:"order_ready",title:"Orden Lista",message:f.delivery_type==="pickup"?"Tu orden est√° lista para recoger":"Tu orden est√° lista para entrega",data:{order_id:r}}),f.delivery_type==="delivery"){const{data:m}=await d.from("users").select("id").eq("role","repartidor").eq("is_available",!0);m&&m.forEach(k=>{v.push({recipient_id:k.id,type:"delivery_available",title:"Entrega Disponible",message:`Nueva entrega disponible - Q${f.delivery_fee.toFixed(2)}`,data:{order_id:r}})})}break;case"delivered":v.push({recipient_id:f.buyer_id,type:"order_delivered",title:"Orden Entregada",message:"Tu orden ha sido entregada exitosamente",data:{order_id:r}});break}if(v.length>0)try{await d.from("notifications").insert(v)}catch(m){console.warn("Failed to create notifications:",m)}}return await i(),{success:!0,message:"Estado actualizado exitosamente"}}catch(c){return console.error("Unexpected error updating order status:",c),{success:!1,message:"Error inesperado al actualizar el estado"}}finally{a(!1)}},l=async(r,n)=>{if(!e)return{success:!1,message:"Debes iniciar sesi√≥n"};try{const{error:h}=await d.from("orders").update({driver_id:n,status:"assigned",updated_at:new Date().toISOString()}).eq("id",r);if(h)return console.error("Error assigning driver:",h),{success:!1,message:"Error al asignar repartidor"};const{data:c}=await d.from("orders").select("buyer_id, seller_id").eq("id",r).single();if(c){const E=[{recipient_id:c.buyer_id,type:"driver_assigned",title:"Repartidor Asignado",message:"Un repartidor ha sido asignado a tu orden",data:{order_id:r}},{recipient_id:n,type:"delivery_assigned",title:"Entrega Asignada",message:"Se te ha asignado una nueva entrega",data:{order_id:r}}];try{await d.from("notifications").insert(E)}catch(f){console.warn("Failed to create assignment notifications:",f)}}return await i(),{success:!0,message:"Repartidor asignado exitosamente"}}catch(h){return console.error("Unexpected error assigning driver:",h),{success:!1,message:"Error inesperado al asignar repartidor"}}},y=async(r,n,h,c)=>{if(!e)return{success:!1,message:"Debes iniciar sesi√≥n"};try{console.log("üåü Enviando calificaci√≥n:",{orderId:r,rating:n,type:h,comment:c});const{data:E}=await d.from("orders").select("buyer_id, seller_id, driver_id").eq("id",r).single();if(!E)return{success:!1,message:"Orden no encontrada"};const f=h==="seller"?E.seller_id:E.driver_id;if(!f)return{success:!1,message:`No hay ${h==="seller"?"vendedor":"repartidor"} asignado`};let v;if(e.id===E.buyer_id)v=h==="seller"?"buyer_to_seller":"buyer_to_driver";else if(e.id===E.seller_id)v=h==="seller"?"seller_to_buyer":"seller_to_driver";else return{success:!1,message:"No tienes permisos para calificar esta orden"};console.log("üéØ Tipo de calificaci√≥n:",v);const{data:m}=await d.from("ratings").select("id").eq("order_id",r).eq("rater_id",e.id).eq("rated_id",f).eq("rating_type",v).eq("status","pending").single();if(!m)return{success:!1,message:"No se encontr√≥ una calificaci√≥n pendiente para esta orden"};const{data:k,error:O}=await d.rpc("complete_rating",{p_rating_id:m.id,p_user_id:e.id,p_rating:n,p_comment:c||null});return O?(console.error("Error completing rating:",O),{success:!1,message:"Error al enviar la calificaci√≥n: "+O.message}):k?(console.log("‚úÖ Calificaci√≥n enviada exitosamente"),{success:!0,message:"¬°Calificaci√≥n enviada exitosamente!"}):{success:!1,message:"No se pudo completar la calificaci√≥n"}}catch(E){return console.error("Unexpected error rating order:",E),{success:!1,message:"Error inesperado al enviar la calificaci√≥n"}}},P=async r=>{try{const{data:n,error:h}=await d.from("orders").select(`
          *,
          order_items (*)
        `).eq("id",r).single();return h||!n?(console.error("Error fetching order:",h),null):{...n,items:n.order_items||[]}}catch(n){return console.error("Unexpected error fetching order:",n),null}},M=async(r,n)=>e?await u(r,"cancelled",n):{success:!1,message:"Debes iniciar sesi√≥n"},j=async r=>{if(!e||e.role!=="comprador")return{success:!1,message:"Solo los compradores pueden eliminar pedidos no confirmados"};try{a(!0);const{data:n,error:h}=await d.from("orders").select("status, buyer_id, seller_id, total").eq("id",r).single();if(h||!n)return{success:!1,message:"Orden no encontrada"};if(n.buyer_id!==e.id)return{success:!1,message:"No tienes permisos para eliminar esta orden"};if(n.status!=="pending")return{success:!1,message:"Solo se pueden eliminar pedidos pendientes"};const{data:c,error:E}=await d.from("order_items").select("product_id, quantity, product_name").eq("order_id",r);E&&console.error("Error fetching order items for stock restoration:",E);const{error:f}=await d.from("order_items").delete().eq("order_id",r);if(f)return console.error("Error deleting order items:",f),{success:!1,message:"Error al eliminar los items del pedido"};const{error:v}=await d.from("orders").delete().eq("id",r);if(v)return console.error("Error deleting order:",v),{success:!1,message:"Error al eliminar el pedido"};if(c&&c.length>0){console.log("üì¶ Restaurando stock despu√©s de eliminar orden...");try{for(const m of c){const k=await G(m.product_id,m.quantity);k.success?console.log(`‚úÖ Stock restaurado: ${m.product_name} - Cantidad devuelta: ${m.quantity}`):console.warn(`‚ö†Ô∏è No se pudo restaurar stock para ${m.product_name}:`,k.message)}console.log("üéâ Stock restaurado exitosamente")}catch(m){console.error("‚ùå Error restaurando stock:",m)}}if(n.seller_id)try{await d.from("notifications").insert({recipient_id:n.seller_id,type:"order_cancelled",title:"Pedido Eliminado",message:`Un pedido por Q${n.total.toFixed(2)} fue eliminado por el cliente`,data:{order_id:r,deleted:!0}})}catch(m){console.warn("Failed to create cancellation notification:",m)}return p(m=>m.filter(k=>k.id!==r)),{success:!0,message:"Pedido eliminado exitosamente"}}catch(n){return console.error("Unexpected error deleting order:",n),{success:!1,message:"Error inesperado al eliminar el pedido"}}finally{a(!1)}},U=async()=>{await i()},L=r=>t.filter(n=>n.status===r),q=()=>t.filter(r=>!["completed","cancelled","rejected"].includes(r.status));$.useEffect(()=>{i()},[e]),$.useEffect(()=>{if(!e)return;const r=d.channel("orders").on("postgres_changes",{event:"*",schema:"public",table:"orders",filter:e.role==="comprador"?`buyer_id=eq.${e.id}`:e.role==="vendedor"?`seller_id=eq.${e.id}`:`driver_id=eq.${e.id}`},()=>{i()}).subscribe();return()=>{r.unsubscribe()}},[e]);const D={orders:t,loading:S,error:w,currentOrder:N,createOrder:b,updateOrderStatus:u,assignDriver:l,rateOrder:y,getOrderById:P,refreshOrders:U,getOrdersByStatus:L,getActiveOrders:q,cancelOrder:M,deleteUnconfirmedOrder:j};return g.jsx(Z.Provider,{value:D,children:s})}function Te(){const s=$.useContext(Z);if(s===void 0)throw new Error("useOrder must be used within an OrderProvider");return s}function B(s){if(s){if(s.startsWith("http://")||s.startsWith("https://"))return s;if(s.startsWith("business-logos/")||s.startsWith("avatars/")||s.startsWith("products/")){const e=s.startsWith("business-logos/")?"business-logos":s.startsWith("avatars/")?"avatars":"products",{data:o}=d.storage.from(e).getPublicUrl(s);return o.publicUrl}if(!s.includes("/")){const{data:e}=d.storage.from("business-logos").getPublicUrl(s);return e.publicUrl}return s}}function Ce(s){var e;if(s.logo_url)return B(s.logo_url);if((e=s.user)!=null&&e.avatar_url)return B(s.user.avatar_url)}function Pe(s){if(s.image_url)return B(s.image_url)}function Ie(s){return B(s)}function fe(s){const e=new Date(s),o=-6;return new Date(e.getTime()+o*60*60*1e3)}function Ae(s){return fe(s).toLocaleTimeString("es-ES",{hour:"2-digit",minute:"2-digit",hour12:!0})}function je(s){const e=new Date,t=new Date(s).getTime()-e.getTime();if(t<=0)return{isExpired:!0,formattedTime:"Expirado",hours:0,minutes:0};const p=Math.floor(t/(1e3*60*60)),S=Math.floor(t%(1e3*60*60)/(1e3*60));return{isExpired:!1,formattedTime:`${p}h ${S}m`,hours:p,minutes:S}}function Re({className:s=""}){const[e,o]=$.useState(0),[t,p]=$.useState(!0);$.useEffect(()=>{S();const a=d.channel("online-drivers-changes").on("postgres_changes",{event:"*",schema:"public",table:"drivers"},x=>{console.log("üîÑ Driver status change detected:",x),S()}).subscribe(),w=setInterval(()=>{console.log("‚è∞ Actualizando conteo de repartidores (intervalo)"),S()},15e3);return()=>{a.unsubscribe(),clearInterval(w)}},[]);const S=async()=>{try{console.log("üîç Cargando cantidad de repartidores en l√≠nea...");try{const{data:a,error:w}=await d.rpc("get_online_drivers_count");if(!w&&typeof a=="number"){console.log("‚úÖ Drivers online (funci√≥n RPC):",a),o(a);return}else console.warn("‚ö†Ô∏è Funci√≥n RPC fall√≥:",w==null?void 0:w.message)}catch(a){console.warn("‚ö†Ô∏è Error en RPC:",a)}try{const{count:a,error:w}=await d.from("drivers").select("*",{count:"exact",head:!0}).eq("is_online",!0).eq("is_active",!0).eq("is_verified",!0);if(w)console.warn("‚ö†Ô∏è Consulta directa fall√≥:",w.message);else{console.log("‚úÖ Drivers disponibles (consulta directa):",a),o(a||0);return}}catch(a){console.warn("‚ö†Ô∏è Error en consulta directa:",a)}try{const{data:a,error:w}=await d.from("drivers").select("is_online, is_active, is_verified").limit(50);if(!w&&a){const x=a.filter(N=>N.is_online&&N.is_active&&N.is_verified).length;console.log("‚úÖ Drivers disponibles (fallback):",x),o(x);return}else console.error("‚ùå Fallback tambi√©n fall√≥:",w==null?void 0:w.message)}catch(a){console.error("‚ùå Error en fallback:",a)}console.error("‚ùå Todos los m√©todos fallaron, mostrando 0"),o(0)}catch(a){console.error("‚ùå Error general:",a),o(0)}finally{p(!1)}};return t?null:g.jsx("div",{className:"fixed top-16 right-4 z-50",children:g.jsxs("div",{className:"flex flex-col gap-1",children:[g.jsxs(X,{variant:"default",className:"bg-green-600 hover:bg-green-700 text-white px-2 py-1 shadow-md flex items-center gap-1.5 text-xs font-medium cursor-pointer transition-all duration-200 hover:scale-105",onClick:S,children:[g.jsxs("div",{className:"flex items-center gap-0.5",children:[g.jsx(ee,{className:"w-3 h-3"}),g.jsx(re,{className:"w-3 h-3"})]}),g.jsxs("span",{className:"text-xs leading-tight",children:[e," disponible",e!==1?"s":""]}),e>0&&g.jsx("div",{className:"w-1.5 h-1.5 bg-green-300 rounded-full animate-pulse ml-0.5"})]}),!1]})})}function Ue({onAlert:s}){const{user:e}=Q(),[o,t]=$.useState([]),[p,S]=$.useState(!1),a=$.useCallback(async()=>{if(e)try{let i=d.from("orders").select("*");switch(e.role){case"vendedor":i=i.eq("seller_id",e.id);break;case"comprador":i=i.eq("buyer_id",e.id);break;case"repartidor":i=i.eq("driver_id",e.id);break;default:return}i=i.in("status",["pending","accepted","ready","assigned","picked-up","in-transit"]);const{data:b}=await i;if(!b)return;const u=new Date,l=[];b.forEach(y=>{const P=new Date(y.created_at),M=y.accepted_at?new Date(y.accepted_at):null,j=y.ready_at?new Date(y.ready_at):null,U=y.status==="assigned"?new Date(y.updated_at):null,L=y.picked_up_at?new Date(y.picked_up_at):null;let q=P,D=0,r="low";switch(y.status){case"pending":if(q=P,D=10,e.role==="vendedor"){const c=(u.getTime()-q.getTime())/6e4;c>15?r="critical":c>12?r="high":c>8&&(r="medium")}break;case"accepted":if(q=M||P,D=y.delivery_type==="dine-in"?25:30,e.role==="vendedor"){const c=(u.getTime()-q.getTime())/6e4;c>D+15?r="critical":c>D+10?r="high":c>D&&(r="medium")}break;case"ready":if(q=j||P,y.delivery_type==="pickup"){if(D=20,e.role==="comprador"){const c=(u.getTime()-q.getTime())/6e4;c>30?r="critical":c>25?r="high":c>15&&(r="medium")}}else if(y.delivery_type==="delivery"){D=15;const c=(u.getTime()-q.getTime())/(1e3*60);c>25?r="critical":c>20?r="high":c>15&&(r="medium")}break;case"assigned":if(q=U||j||P,D=15,e.role==="repartidor"){const c=(u.getTime()-q.getTime())/6e4;c>25?r="critical":c>20?r="high":c>15&&(r="medium")}break;case"picked-up":case"in-transit":q=L||U||j||P,D=45;const h=(u.getTime()-q.getTime())/(1e3*60);h>60?r="critical":h>50?r="high":h>40&&(r="medium");break}const n=(u.getTime()-q.getTime())/(1e3*60);n>D&&r!=="low"&&l.push({orderId:y.id,status:y.status,timeSinceStatus:Math.floor(n),customerName:y.customer_name||"Cliente",total:y.total,urgencyLevel:r})}),t(l),l.filter(y=>y.urgencyLevel==="critical").forEach(y=>{s==null||s(y),console.error(`üö® ALERTA CR√çTICA: Orden ${y.orderId.slice(-6)} en estado ${y.status} por ${y.timeSinceStatus} minutos`)})}catch(i){console.error("Error checking timeout alerts:",i)}},[e,s]),w=$.useCallback(async i=>{if(!(!e||i.length===0))try{for(const b of i){const{data:u}=await d.from("orders").select("buyer_id, seller_id, driver_id").eq("id",b.orderId).single();if(!u)continue;const l=[];switch(b.status){case"pending":l.push({recipient_id:u.seller_id,type:"order_timeout_critical",title:"üö® ORDEN CR√çTICA",message:`Orden pendiente por ${b.timeSinceStatus} minutos - ACEPTAR URGENTE`,data:{order_id:b.orderId,timeout_minutes:b.timeSinceStatus}}),l.push({recipient_id:u.buyer_id,type:"order_delay",title:"Demora en tu pedido",message:"Tu pedido est√° tardando m√°s de lo esperado. Te mantendremos informado.",data:{order_id:b.orderId}});break;case"accepted":l.push({recipient_id:u.seller_id,type:"preparation_timeout",title:"‚è∞ PREPARACI√ìN LENTA",message:`Orden en preparaci√≥n por ${b.timeSinceStatus} minutos`,data:{order_id:b.orderId,timeout_minutes:b.timeSinceStatus}});break;case"ready":b.timeSinceStatus>20&&l.push({recipient_id:u.buyer_id,type:"pickup_reminder",title:"üì¶ Tu pedido est√° listo",message:`Tu pedido lleva ${b.timeSinceStatus} minutos esperando ser recogido`,data:{order_id:b.orderId,waiting_minutes:b.timeSinceStatus}});break}l.length>0&&await d.from("notifications").insert(l)}}catch(b){console.error("Error sending critical timeout notifications:",b)}},[e]);$.useEffect(()=>{if(!e)return;S(!0),a();const i=setInterval(a,2*60*1e3);return()=>{clearInterval(i),S(!1)}},[e,a]),$.useEffect(()=>{const i=o.filter(b=>b.urgencyLevel==="critical");i.length>0&&w(i)},[o,w]);const x=i=>{switch(i){case"critical":return"bg-red-100 border-red-300 text-red-800";case"high":return"bg-orange-100 border-orange-300 text-orange-800";case"medium":return"bg-yellow-100 border-yellow-300 text-yellow-800";default:return"bg-gray-100 border-gray-300 text-gray-800"}},N=i=>{switch(i){case"critical":return g.jsx(Y,{className:"w-4 h-4"});case"high":return g.jsx(te,{className:"w-4 h-4"});case"medium":return g.jsx(W,{className:"w-4 h-4"});default:return g.jsx(pe,{className:"w-4 h-4"})}},T=i=>{switch(i.status){case"pending":return`Esperando aceptaci√≥n por ${i.timeSinceStatus} min`;case"accepted":return`En preparaci√≥n por ${i.timeSinceStatus} min`;case"ready":return`Listo por ${i.timeSinceStatus} min`;case"assigned":return`Repartidor asignado hace ${i.timeSinceStatus} min`;case"picked-up":case"in-transit":return`En camino por ${i.timeSinceStatus} min`;default:return`En estado ${i.status} por ${i.timeSinceStatus} min`}};return!p||o.length===0?null:g.jsxs("div",{className:"space-y-3",children:[g.jsxs("div",{className:"flex items-center space-x-2",children:[g.jsx(W,{className:"w-5 h-5 text-orange-600"}),g.jsxs("h3",{className:"text-lg font-semibold text-gray-900",children:["Alertas de tiempo (",o.length,")"]})]}),g.jsx("div",{className:"space-y-2",children:o.map(i=>g.jsx("div",{className:`border rounded-lg p-3 ${x(i.urgencyLevel)}`,children:g.jsxs("div",{className:"flex items-start justify-between",children:[g.jsxs("div",{className:"flex items-center space-x-2",children:[N(i.urgencyLevel),g.jsxs("div",{children:[g.jsxs("p",{className:"font-medium",children:[i.customerName," - Q",i.total.toFixed(2)]}),g.jsx("p",{className:"text-sm",children:T(i)}),g.jsxs("p",{className:"text-xs opacity-75",children:["Orden #",i.orderId.slice(-6)]})]})]}),i.urgencyLevel==="critical"&&g.jsxs("div",{className:"flex items-center space-x-1 text-red-600",children:[g.jsx("span",{className:"text-xs font-bold",children:"URGENTE"}),g.jsx("div",{className:"w-2 h-2 bg-red-500 rounded-full animate-pulse"})]})]})},i.orderId))})]})}export{ke as A,we as B,xe as C,Ee as F,Se as H,Oe as O,$e as P,Ne as R,qe as S,Ue as T,je as a,Pe as b,Re as c,pe as d,De as e,Ae as f,Ce as g,Ie as p,Te as u};
