import{g as N,s as f,r as b,j as n,f as I,u as j,Z as A}from"./index-BjTbJZtF.js";import{T as P}from"./truck-BrXFQt59.js";import{U as R}from"./users-DSw0QBNn.js";import{C as q}from"./clock-BXIPhKIz.js";import{T as M}from"./triangle-alert-KLVDszTy.js";/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const z=[["path",{d:"M3.85 8.62a4 4 0 0 1 4.78-4.77 4 4 0 0 1 6.74 0 4 4 0 0 1 4.78 4.78 4 4 0 0 1 0 6.74 4 4 0 0 1-4.77 4.78 4 4 0 0 1-6.75 0 4 4 0 0 1-4.78-4.77 4 4 0 0 1 0-6.76Z",key:"3c2336"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]],ee=N("badge-check",z);/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const B=[["path",{d:"M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z",key:"96xj49"}]],te=N("flame",B);/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const L=[["path",{d:"M15 21v-8a1 1 0 0 0-1-1h-4a1 1 0 0 0-1 1v8",key:"5wwlr5"}],["path",{d:"M3 10a2 2 0 0 1 .709-1.528l7-5.999a2 2 0 0 1 2.582 0l7 5.999A2 2 0 0 1 21 10v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z",key:"1d0kgt"}]],oe=N("house",L);/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const U=[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"M12 5v14",key:"s699le"}]],ae=N("plus",U);/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const F=[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}]],re=N("rotate-ccw",F);/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const G=[["path",{d:"M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7",key:"1m0v6g"}],["path",{d:"M18.375 2.625a1 1 0 0 1 3 3l-9.013 9.014a2 2 0 0 1-.853.505l-2.873.84a.5.5 0 0 1-.62-.62l.84-2.873a2 2 0 0 1 .506-.852z",key:"ohrbg2"}]],se=N("square-pen",G);/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const H=[["line",{x1:"10",x2:"14",y1:"2",y2:"2",key:"14vaq8"}],["line",{x1:"12",x2:"15",y1:"14",y2:"11",key:"17fdiu"}],["circle",{cx:"12",cy:"14",r:"8",key:"1e1u0o"}]],V=N("timer",H);async function ie(d,r){if(console.log("üîÑ Iniciando actualizaci√≥n de stock para orden:",r),console.log("üì¶ Items a procesar:",d.length),d.forEach((o,e)=>{console.log(`   ${e+1}. ${o.product_name}`),console.log(`      - Cantidad: ${o.quantity}`),console.log(`      - Tipo: ${o.product_type||"regular"}`),console.log(`      - Product ID: ${o.product_id}`),console.log(`      - Daily Product ID: ${o.daily_product_id||"N/A"}`)}),!d||d.length===0)return console.log("‚ö†Ô∏è No hay items para procesar"),{success:!1,message:"No hay items para actualizar stock"};try{const o=[];for(const e of d){console.log(`üîç Procesando producto, cantidad: ${e.quantity}, tipo: ${e.product_type||"regular"}`),console.log(`    Product ID: ${e.product_id}, Daily Product ID: ${e.daily_product_id}`);const c=e.product_type==="daily"||!!e.daily_product_id,y=c?"daily_products":"products";let t=null,p=null;if(c&&e.product_id){console.log(`üîç OPCI√ìN 1: Buscando producto del d√≠a por product_id: ${e.product_id}`);const{data:i,error:s}=await f.from("daily_products").select("id, name, stock_quantity, is_available").eq("id",e.product_id).single();!s&&i?(t=i,console.log(`‚úÖ ENCONTRADO por product_id en daily_products: ${t.name}`)):console.log("‚ùå No encontrado por product_id en daily_products:",s==null?void 0:s.message)}if(!t&&c&&e.daily_product_id){console.log(`üîç OPCI√ìN 2: Buscando por daily_product_id (legacy): ${e.daily_product_id}`);const{data:i,error:s}=await f.from("daily_products").select("id, name, stock_quantity, is_available").eq("id",e.daily_product_id).single();!s&&i?(t=i,console.log(`‚úÖ ENCONTRADO por daily_product_id: ${t.name}`)):console.log("‚ùå No encontrado por daily_product_id:",s==null?void 0:s.message)}if(!t&&!c&&e.product_id){console.log(`üîç OPCI√ìN 3: Buscando producto regular por product_id: ${e.product_id}`);const{data:i,error:s}=await f.from("products").select("id, name, stock_quantity, is_available").eq("id",e.product_id).single();!s&&i?(t=i,console.log(`‚úÖ ENCONTRADO por product_id en products: ${t.name}`)):console.log("‚ùå No encontrado por product_id en products:",s==null?void 0:s.message)}if(!t&&c&&e.product_name){console.log(`üîç OPCI√ìN 4: Buscando por nombre en daily_products: ${e.product_name}`);const{data:i,error:s}=await f.from("daily_products").select("id, name, stock_quantity, is_available, expires_at").eq("name",e.product_name).gte("expires_at",new Date().toISOString()).order("created_at",{ascending:!1}).limit(1);!s&&i&&i.length>0?(t=i[0],console.log(`‚úÖ ENCONTRADO por nombre: ${t.name}`)):console.log("‚ùå No encontrado por nombre:",s==null?void 0:s.message)}if(!t&&!c&&e.product_name){console.log(`üîç OPCI√ìN 5: Buscando por nombre en products: ${e.product_name}`);const{data:i,error:s}=await f.from("products").select("id, name, stock_quantity, is_available").eq("name",e.product_name).limit(1);!s&&i&&i.length>0?(t=i[0],console.log(`‚úÖ ENCONTRADO por nombre: ${t.name}`)):console.log("‚ùå No encontrado por nombre:",s==null?void 0:s.message)}if(!t)return console.log("‚ùå PRODUCTO NO ENCONTRADO EN NINGUNA B√öSQUEDA"),console.log("üîç Detalles del item:",{product_id:e.product_id,daily_product_id:e.daily_product_id,product_name:e.product_name,product_type:e.product_type,isDaily:c,tableName:y}),{success:!1,message:`Error al obtener informaci√≥n del producto ${e.product_name}. Producto no encontrado en ninguna tabla.`};const _=t.stock_quantity,h=_-e.quantity;if(console.log(`üìä ${c?"Producto del d√≠a":"Producto regular"} "${t.name}": ${_} ‚Üí ${h} (vendido: ${e.quantity})`),_<e.quantity)return console.error(`‚ùå Stock insuficiente para ${t.name}: tiene ${_}, necesita ${e.quantity}`),{success:!1,message:`Stock insuficiente para ${t.name}. Solo quedan ${_} unidades.`};const x=c?"daily_products":"products";console.log(`üîÑ Actualizando en tabla: ${x}, ID: ${t.id}`);const a={stock_quantity:h,updated_at:new Date().toISOString()};c||(a.is_available=h>0&&t.is_available);const{error:u}=await f.from(x).update(a).eq("id",t.id);if(u)return console.error(`‚ùå Error actualizando stock para ${t.id}:`,u),await Z(o,r),{success:!1,message:`Error al actualizar el stock del producto ${t.name}`};o.push({product_id:t.id,old_stock:_,new_stock:h,quantity_sold:e.quantity,product_type:e.product_type||"regular"}),console.log(`‚úÖ Stock actualizado exitosamente para "${t.name}" (${c?"producto del d√≠a":"producto regular"})`)}return await D(r,"stock_decrease",o),console.log("üéâ Actualizaci√≥n de stock completada exitosamente"),{success:!0,message:"Stock actualizado correctamente",updatedProducts:o}}catch(o){return console.error("‚ùå Error inesperado actualizando stock:",o),{success:!1,message:"Error inesperado al actualizar el inventario"}}}async function Z(d,r){console.log("üîÑ Iniciando rollback de stock para orden:",r);for(const o of d)try{const e=o.product_type==="daily",c=e?"daily_products":"products";await f.from(c).update({stock_quantity:o.old_stock,updated_at:new Date().toISOString()}).eq("id",o.product_id),console.log(`‚úÖ Rollback exitoso para ${e?"producto del d√≠a":"producto regular"} ${o.product_id}: ${o.new_stock} ‚Üí ${o.old_stock}`)}catch(e){console.error(`‚ùå Error en rollback para producto ${o.product_id}:`,e)}}async function ce(d,r){console.log("üîÑ Iniciando restauraci√≥n de stock para orden cancelada:",r);try{const o=[];for(const e of d){const c=e.product_type==="daily",y=c?"daily_products":"products",{data:t,error:p}=await f.from(y).select("id, name, stock_quantity, is_available").eq("id",e.product_id).single();if(p||!t){console.error(`‚ùå Error obteniendo ${c?"producto del d√≠a":"producto regular"} para restaurar ${e.product_id}:`,p);continue}const _=t.stock_quantity,h=_+e.quantity,x={stock_quantity:h,updated_at:new Date().toISOString()};c||(x.is_available=!0);const{error:a}=await f.from(y).update(x).eq("id",e.product_id);if(a){console.error(`‚ùå Error restaurando stock para ${e.product_id}:`,a);continue}o.push({product_id:e.product_id,old_stock:_,new_stock:h,quantity_sold:-e.quantity,product_type:e.product_type||"regular"}),console.log(`‚úÖ Stock restaurado para "${t.name}" (${c?"producto del d√≠a":"producto regular"}): ${_} ‚Üí ${h}`)}return await D(r,"stock_restore",o),{success:!0,message:"Stock restaurado correctamente",updatedProducts:o}}catch(o){return console.error("‚ùå Error inesperado restaurando stock:",o),{success:!1,message:"Error inesperado al restaurar el inventario"}}}async function D(d,r,o){try{console.log("üìù Log de transacci√≥n de stock:",{orderId:d,type:r,timestamp:new Date().toISOString(),products:o})}catch(e){console.warn("‚ö†Ô∏è Error registrando log de stock (no cr√≠tico):",e)}}async function ne(d){console.log("üîç Validando stock antes de crear orden");try{const r=[];for(const o of d){const{data:e,error:c}=await f.from("products").select("id, name, stock_quantity, is_available").eq("id",o.product_id).single();if(c||!e){r.push({product_id:o.product_id,product_name:o.product_name||"Producto desconocido",requested:o.quantity,available:0});continue}(!e.is_available||e.stock_quantity<o.quantity)&&r.push({product_id:o.product_id,product_name:e.name,requested:o.quantity,available:e.stock_quantity})}return r.length>0?{isValid:!1,message:`Stock insuficiente: ${r.map(e=>`${e.product_name}: solicitas ${e.requested}, disponibles ${e.available}`).join("; ")}`,invalidItems:r}:{isValid:!0,message:"Stock suficiente para todos los productos"}}catch(r){return console.error("‚ùå Error validando stock:",r),{isValid:!1,message:"Error al validar disponibilidad de productos"}}}function Q(d){const r=new Date(d),o=-6;return new Date(r.getTime()+o*60*60*1e3)}function de(d){return Q(d).toLocaleTimeString("es-ES",{hour:"2-digit",minute:"2-digit",hour12:!0})}function le(d){const r=new Date,e=new Date(d).getTime()-r.getTime();if(e<=0)return{isExpired:!0,formattedTime:"Expirado",hours:0,minutes:0};const c=Math.floor(e/(1e3*60*60)),y=Math.floor(e%(1e3*60*60)/(1e3*60));return{isExpired:!1,formattedTime:`${c}h ${y}m`,hours:c,minutes:y}}function ue({className:d=""}){const[r,o]=b.useState(0),[e,c]=b.useState(!0);b.useEffect(()=>{y();const t=f.channel("online-drivers-changes").on("postgres_changes",{event:"*",schema:"public",table:"drivers"},_=>{console.log("üîÑ Driver status change detected:",_),y()}).subscribe(),p=setInterval(()=>{console.log("‚è∞ Actualizando conteo de repartidores (intervalo)"),y()},15e3);return()=>{t.unsubscribe(),clearInterval(p)}},[]);const y=async()=>{try{console.log("üîç Cargando cantidad de repartidores en l√≠nea...");try{const{data:t,error:p}=await f.rpc("get_online_drivers_count");if(!p&&typeof t=="number"){console.log("‚úÖ Drivers online (funci√≥n RPC):",t),o(t);return}else console.warn("‚ö†Ô∏è Funci√≥n RPC fall√≥:",p==null?void 0:p.message)}catch(t){console.warn("‚ö†Ô∏è Error en RPC:",t)}try{const{count:t,error:p}=await f.from("drivers").select("*",{count:"exact",head:!0}).eq("is_online",!0).eq("is_active",!0).eq("is_verified",!0);if(p)console.warn("‚ö†Ô∏è Consulta directa fall√≥:",p.message);else{console.log("‚úÖ Drivers disponibles (consulta directa):",t),o(t||0);return}}catch(t){console.warn("‚ö†Ô∏è Error en consulta directa:",t)}try{const{data:t,error:p}=await f.from("drivers").select("is_online, is_active, is_verified").limit(50);if(!p&&t){const _=t.filter(h=>h.is_online&&h.is_active&&h.is_verified).length;console.log("‚úÖ Drivers disponibles (fallback):",_),o(_);return}else console.error("‚ùå Fallback tambi√©n fall√≥:",p==null?void 0:p.message)}catch(t){console.error("‚ùå Error en fallback:",t)}console.error("‚ùå Todos los m√©todos fallaron, mostrando 0"),o(0)}catch(t){console.error("‚ùå Error general:",t),o(0)}finally{c(!1)}};return e?null:n.jsx("div",{className:"fixed top-16 right-4 z-50",children:n.jsxs("div",{className:"flex flex-col gap-1",children:[n.jsxs(I,{variant:"default",className:"bg-green-600 hover:bg-green-700 text-white px-2 py-1 shadow-md flex items-center gap-1.5 text-xs font-medium cursor-pointer transition-all duration-200 hover:scale-105",onClick:y,children:[n.jsxs("div",{className:"flex items-center gap-0.5",children:[n.jsx(P,{className:"w-3 h-3"}),n.jsx(R,{className:"w-3 h-3"})]}),n.jsxs("span",{className:"text-xs leading-tight",children:[r," disponible",r!==1?"s":""]}),r>0&&n.jsx("div",{className:"w-1.5 h-1.5 bg-green-300 rounded-full animate-pulse ml-0.5"})]}),!1]})})}function pe({onAlert:d}){const{user:r}=j(),[o,e]=b.useState([]),[c,y]=b.useState(!1),t=b.useCallback(async()=>{if(r)try{let a=f.from("orders").select("*");switch(r.role){case"vendedor":a=a.eq("seller_id",r.id);break;case"comprador":a=a.eq("buyer_id",r.id);break;case"repartidor":a=a.eq("driver_id",r.id);break;default:return}a=a.in("status",["pending","accepted","ready","assigned","picked-up","in-transit"]);const{data:u}=await a;if(!u)return;const i=new Date,s=[];u.forEach(l=>{const S=new Date(l.created_at),C=l.accepted_at?new Date(l.accepted_at):null,w=l.ready_at?new Date(l.ready_at):null,T=l.status==="assigned"?new Date(l.updated_at):null,O=l.picked_up_at?new Date(l.picked_up_at):null;let k=S,v=0,m="low";switch(l.status){case"pending":if(k=S,v=10,r.role==="vendedor"){const g=(i.getTime()-k.getTime())/6e4;g>15?m="critical":g>12?m="high":g>8&&(m="medium")}break;case"accepted":if(k=C||S,v=l.delivery_type==="dine-in"?25:30,r.role==="vendedor"){const g=(i.getTime()-k.getTime())/6e4;g>v+15?m="critical":g>v+10?m="high":g>v&&(m="medium")}break;case"ready":if(k=w||S,l.delivery_type==="pickup"){if(v=20,r.role==="comprador"){const g=(i.getTime()-k.getTime())/6e4;g>30?m="critical":g>25?m="high":g>15&&(m="medium")}}else if(l.delivery_type==="delivery"){v=15;const g=(i.getTime()-k.getTime())/(1e3*60);g>25?m="critical":g>20?m="high":g>15&&(m="medium")}break;case"assigned":if(k=T||w||S,v=15,r.role==="repartidor"){const g=(i.getTime()-k.getTime())/6e4;g>25?m="critical":g>20?m="high":g>15&&(m="medium")}break;case"picked-up":case"in-transit":k=O||T||w||S,v=45;const $=(i.getTime()-k.getTime())/(1e3*60);$>60?m="critical":$>50?m="high":$>40&&(m="medium");break}const E=(i.getTime()-k.getTime())/(1e3*60);E>v&&m!=="low"&&s.push({orderId:l.id,status:l.status,timeSinceStatus:Math.floor(E),customerName:l.customer_name||"Cliente",total:l.total,urgencyLevel:m})}),e(s),s.filter(l=>l.urgencyLevel==="critical").forEach(l=>{d==null||d(l),console.error(`üö® ALERTA CR√çTICA: Orden ${l.orderId.slice(-6)} en estado ${l.status} por ${l.timeSinceStatus} minutos`)})}catch(a){console.error("Error checking timeout alerts:",a)}},[r,d]),p=b.useCallback(async a=>{if(!(!r||a.length===0))try{for(const u of a){const{data:i}=await f.from("orders").select("buyer_id, seller_id, driver_id").eq("id",u.orderId).single();if(!i)continue;const s=[];switch(u.status){case"pending":s.push({recipient_id:i.seller_id,type:"order_timeout_critical",title:"üö® ORDEN CR√çTICA",message:`Orden pendiente por ${u.timeSinceStatus} minutos - ACEPTAR URGENTE`,data:{order_id:u.orderId,timeout_minutes:u.timeSinceStatus}}),s.push({recipient_id:i.buyer_id,type:"order_delay",title:"Demora en tu pedido",message:"Tu pedido est√° tardando m√°s de lo esperado. Te mantendremos informado.",data:{order_id:u.orderId}});break;case"accepted":s.push({recipient_id:i.seller_id,type:"preparation_timeout",title:"‚è∞ PREPARACI√ìN LENTA",message:`Orden en preparaci√≥n por ${u.timeSinceStatus} minutos`,data:{order_id:u.orderId,timeout_minutes:u.timeSinceStatus}});break;case"ready":u.timeSinceStatus>20&&s.push({recipient_id:i.buyer_id,type:"pickup_reminder",title:"üì¶ Tu pedido est√° listo",message:`Tu pedido lleva ${u.timeSinceStatus} minutos esperando ser recogido`,data:{order_id:u.orderId,waiting_minutes:u.timeSinceStatus}});break}s.length>0&&await f.from("notifications").insert(s)}}catch(u){console.error("Error sending critical timeout notifications:",u)}},[r]);b.useEffect(()=>{if(!r)return;y(!0),t();const a=setInterval(t,2*60*1e3);return()=>{clearInterval(a),y(!1)}},[r,t]),b.useEffect(()=>{const a=o.filter(u=>u.urgencyLevel==="critical");a.length>0&&p(a)},[o,p]);const _=a=>{switch(a){case"critical":return"bg-red-100 border-red-300 text-red-800";case"high":return"bg-orange-100 border-orange-300 text-orange-800";case"medium":return"bg-yellow-100 border-yellow-300 text-yellow-800";default:return"bg-gray-100 border-gray-300 text-gray-800"}},h=a=>{switch(a){case"critical":return n.jsx(A,{className:"w-4 h-4"});case"high":return n.jsx(M,{className:"w-4 h-4"});case"medium":return n.jsx(q,{className:"w-4 h-4"});default:return n.jsx(V,{className:"w-4 h-4"})}},x=a=>{switch(a.status){case"pending":return`Esperando aceptaci√≥n por ${a.timeSinceStatus} min`;case"accepted":return`En preparaci√≥n por ${a.timeSinceStatus} min`;case"ready":return`Listo por ${a.timeSinceStatus} min`;case"assigned":return`Repartidor asignado hace ${a.timeSinceStatus} min`;case"picked-up":case"in-transit":return`En camino por ${a.timeSinceStatus} min`;default:return`En estado ${a.status} por ${a.timeSinceStatus} min`}};return!c||o.length===0?null:n.jsxs("div",{className:"space-y-3",children:[n.jsxs("div",{className:"flex items-center space-x-2",children:[n.jsx(q,{className:"w-5 h-5 text-orange-600"}),n.jsxs("h3",{className:"text-lg font-semibold text-gray-900",children:["Alertas de tiempo (",o.length,")"]})]}),n.jsx("div",{className:"space-y-2",children:o.map(a=>n.jsx("div",{className:`border rounded-lg p-3 ${_(a.urgencyLevel)}`,children:n.jsxs("div",{className:"flex items-start justify-between",children:[n.jsxs("div",{className:"flex items-center space-x-2",children:[h(a.urgencyLevel),n.jsxs("div",{children:[n.jsxs("p",{className:"font-medium",children:[a.customerName," - Q",a.total.toFixed(2)]}),n.jsx("p",{className:"text-sm",children:x(a)}),n.jsxs("p",{className:"text-xs opacity-75",children:["Orden #",a.orderId.slice(-6)]})]})]}),a.urgencyLevel==="critical"&&n.jsxs("div",{className:"flex items-center space-x-1 text-red-600",children:[n.jsx("span",{className:"text-xs font-bold",children:"URGENTE"}),n.jsx("div",{className:"w-2 h-2 bg-red-500 rounded-full animate-pulse"})]})]})},a.orderId))})]})}export{ee as B,te as F,oe as H,ue as O,ae as P,re as R,se as S,pe as T,V as a,de as f,le as g,ce as r,ie as u,ne as v};
